var csComp;!function(e){var t;!function(t){var r=function(){function e(){}return e}();t.Widget=r;var i=function(){function e(){}return e}();t.WidgetStyle=i;var a=function(){function t(e,t){this.enabled=!0,this.opacity=1,this.background="white",this.renderer=function(e,t){},this.resize=function(e,t,r){},e&&(this.title=e),this.properties={},this.dataSets=[]}return t.serializeableData=function(e){var r={id:e.id,directive:e.directive,template:e.template,title:e.title,name:e.name,timeDependent:e.timeDependent,url:e.url,elementId:e.elementId,enabled:e.enabled,customStyle:e.customStyle,style:e.style,left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height,allowFullscreen:e.allowFullscreen,properties:e.properties,hover:e.hover,range:e.range,collapse:e.collapse,canCollapse:e.canCollapse,data:t.cloneWithout0(e.data)};return r},t.cloneWithout0=function(e){var t=this;if("object"!=typeof e)return e;if(e instanceof Array){var r=[];return e.forEach(function(e){r.push(t.cloneWithout0(e))}),r}var i={};for(var a in e)"_"!==a[0]&&(i[a]=this.cloneWithout0(e[a]));return i},t.prototype.start=function(){},t.prototype.init=function(){this.background="red",this.id||(this.id="widget"+e.Helpers.getGuid().replace("-","")),this.elementId=this.id,this.start()},t.prototype.updateDateRange=function(e){this.range=e},t}();t.BaseWidget=a;var o=function(){function r(){this.mobile=!0,this.showTimeline=!0,this.showLegend=!1,this.showRightmenu=!1,this.showBackgroundImage=!1,this.draggable=!0,this.resizable=!0,this.widgets=[]}return r.serializeableData=function(t){return{id:t.id,name:t.name,editMode:t.editMode,showMap:t.showMap,showTimeline:t.showTimeline,showLeftmenu:t.showLeftmenu,showLegend:t.showLegend,showRightmenu:t.showRightmenu,showBackgroundImage:t.showBackgroundImage,background:t.background,backgroundimage:t.backgroundimage,visiblelayers:t.visiblelayers,baselayer:t.baselayer,viewBounds:t.viewBounds,widgets:e.Helpers.serialize(t.widgets,a.serializeableData),visibleLeftMenuItems:t.visibleLeftMenuItems,mobile:t.mobile}},r.deserialize=function(e,i){var a=this,o=$.extend(new r,e);return o.widgets=[],e.widgets&&e.widgets.forEach(function(e){a.addNewWidget(e,o,i)}),e.timeline&&(o.timeline=$.extend(new t.DateRange,e.timeline)),o},r.addNewWidget=function(t,r,i){return t.id||(t.id=e.Helpers.getGuid()),t.elementId="widget-"+t.id,t.parentDashboard=r,t.style&&"custom"!==t.style?(i.hasOwnProperty("widgetStyles")&&i.widgetStyles.hasOwnProperty(t.style)||(t.style="default"),t.effectiveStyle=i.widgetStyles[t.style]):t.effectiveStyle=t.customStyle,r.widgets.push(t),t},r}();t.Dashboard=o;var s=function(){function e(){}return e}();t.Timeline=s;var n=function(){function e(){}return e}();t.TimedDataSet=n;var l=function(){function e(e,t){this.id=e,this.title=t,this.data=[]}return e}();t.DataSet=l}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.max=100,this.min=0}return t.prototype.activeValueText=function(){return e.Helpers.convertPropertyInfo(this.propertyType,this.activeValue)},t.prototype.addValue=function(e,t){this.timestamps.push(e),this.values.push(t),this.activeValue=t},t.prototype.serialize=function(){return JSON.stringify(t.serializeableData(this),function(e,t){return t},2)},t.serializeableData=function(e){return{id:e.id,title:e.title,type:e.type,propertyTypeKey:e.propertyTypeKey}},t}();t.SensorSet=r;var i=function(){function e(){this.sensors={}}return e.merge_sensor=function(e,t){var i=new r;for(var a in e)i[a]=e[a];for(var a in t)i[a]=t[a];return i},e.serializeableData=function(e){var t={id:e.id,url:e.url,type:e.type,title:e.title,sensors:{}};return t},e.LoadData=function(e,t,r){var i=this;null!=t.url&&e.get(t.url).success(function(e){if(null!=e){if(t.id=e.id,t.hasOwnProperty("sensors"))for(var a in e.sensors)e.sensors.hasOwnProperty(a)&&(t.sensors[a]=i.merge_sensor(t.sensors[a],e.sensors[a]));else t.sensors=e.sensors;t.title=e.title,r()}}).error(function(){console.log("Error on Data source -- do something ?")})},e}();t.DataSource=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.Log=t;var r=function(){function e(){this.gui={},this.logs={}}return e.serialize=function(e){var t={};return t.id=e.id,t.geometry=e.geometry,t.properties=e.properties,t.logs=e.logs,e.timestamps&&(t.timestamps=e.timestamps),e.sensors&&(t.sensors=e.sensors),t},e}();e.Feature=r,function(e){e[e.None=0]="None",e[e.Image=1]="Image",e[e.Point=2]="Point",e[e.Square=3]="Square",e[e.Rectangle=4]="Rectangle",e[e.Line=5]="Line",e[e.Circle=6]="Circle",e[e.Freehand=7]="Freehand",e[e.Polyline=8]="Polyline",e[e.Polygon=9]="Polygon",e[e.MultiPolygon=10]="MultiPolygon"}(e.DrawingModeType||(e.DrawingModeType={}));e.DrawingModeType;!function(e){e[e.none=0]="none",e[e.bar=1]="bar",e[e.text=2]="text"}(e.featureFilterType||(e.featureFilterType={}));e.featureFilterType;!function(e){e[e.manual=0]="manual",e[e.automatic=1]="automatic"}(e.LayerActivationTypes||(e.LayerActivationTypes={}));var i=(e.LayerActivationTypes,function(){function e(){}return e}());e.PropertyInfo=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(e.Feature);e.Feed=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){!function(e){e[e.GeoJson=0]="GeoJson",e[e.Kml=1]="Kml"}(t.LayerType||(t.LayerType={}));var r=(t.LayerType,function(){function r(){this.gui={}}return r.serializeableData=function(r){return{id:r.id,title:r.title,description:r.description,showTitle:r.showTitle,clustering:r.clustering,clusterLevel:r.clusterLevel,maxClusterRadius:r.maxClusterRadius,oneLayerActive:r.oneLayerActive,styleProperty:r.styleProperty,languages:r.languages,layers:e.Helpers.serialize(r.layers,t.ProjectLayer.serializeableData)}},r.deserialize=function(e){var t=$.extend(new r,e);return t.owsurl&&t.loadLayersFromOWS(),t},r.prototype.loadLayersFromOWS=function(e){var t=this;void 0===e&&(e=null),this.layers=[],null==e&&(e=angular.injector(["ng"])),e.invoke(function(e){e.get(t.owsurl).success(function(e){t.parseXML(e)}).error(function(e,r){console.log("Unable to load OWSurl: "+t.owsurl),console.log("          HTTP status: "+r)})})},r.prototype.parseXML=function(e){var t=this,r=this.owsurl.split("?")[0];$(e).find("Layer").each(function(){var e=$(this).children("Name").text();if(null!=e&&""!=e){var i=$(this).children("Title").text(),a=t.buildLayer(r,i,e);t.layers.push(a)}})},r.prototype.buildLayer=function(r,i,a){var o={id:e.Helpers.getGuid(),reference:a,title:i,enabled:!1,group:this};this.owsgeojson?(o.type="geojson",o.url=r+"?service=wfs&request=getFeature&outputFormat=application/json&typeName="+a):(o.type="wms",o.wmsLayers=a,o.url=r);var s=jQuery.extend(new t.ProjectLayer,o);return s},r}());t.ProjectGroup=r;var i=function(){function e(){}return e}();t.GroupFilter=i;var a=function(){function e(e){var t=this;this.availableAspects=["strokeColor","fillColor","strokeWidth","height"],this.colorScales={},this.legends={},this.fixedColorRange=!1,e("WHITE_RED").then(function(e){t.colorScales[e]=["white","red"]}),e("GREEN_RED").then(function(e){t.colorScales[e]=["green","red"]}),e("RED_GREEN").then(function(e){t.colorScales[e]=["red","green"]}),e("BLUE_RED").then(function(e){t.colorScales[e]=["#F04030","#3040F0"]}),e("RED_BLUE").then(function(e){t.colorScales[e]=["#3040F0","#F04030"]}),e("WHITE_BLUE").then(function(e){t.colorScales[e]=["white","blue"]}),e("BLUE_WHITE").then(function(e){t.colorScales[e]=["blue","white"]}),e("WHITE_GREEN").then(function(e){t.colorScales[e]=["white","green"]}),e("GREEN_WHITE").then(function(e){t.colorScales[e]=["green","white"]}),e("WHITE_ORANGE").then(function(e){t.colorScales[e]=["white","#FF5500"]}),e("ORANGE_WHITE").then(function(e){t.colorScales[e]=["#FF5500","white"]}),e("RED_WHITE_BLUE").then(function(e){t.colorScales[e]=["red","white","blue"]})}return e}();t.GroupStyle=a;var o=function(){function e(){}return e}();t.Legend=o;var s=function(){function e(){}return e}();t.LegendEntry=s}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.gui={},this.showFeatureNotifications=!0}return t.serializeableData=function(t){return{id:t.id,title:t.title,description:t.description,type:t.type,renderType:t.renderType,heatmapSettings:t.heatmapSettings,heatmapItems:e.Helpers.serialize(t.heatmapItems,Heatmap.HeatmapItem.serializeableData),url:t.url,typeUrl:t.typeUrl,wmsLayers:t.wmsLayers,opacity:t.opacity,isSublayer:t.isSublayer,BBOX:t.BBOX,refreshBBOX:t.refreshBBOX,refreshTimeInterval:t.refreshTimeInterval,quickRefresh:t.quickRefresh,languages:t.languages,events:t.events,dataSourceParameters:t.dataSourceParameters,defaultFeatureType:t.defaultFeatureType,defaultLegendProperty:t.defaultLegendProperty,useProxy:t.useProxy,isDynamic:t.isDynamic,useLog:t.useLog,gui:{},tags:t.tags,fitToMap:t.fitToMap,minZoom:t.minZoom,maxZoom:t.maxZoom}},t}();t.ProjectLayer=r;var i=function(){function e(){}return e}();t.BaseLayer=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){e.availableZoomLevels=[{title:"decades",value:31536e7},{title:"years",value:31536e6},{title:"weeks",value:6048e5},{title:"days",value:864e5},{title:"hours",value:36e5},{title:"quarters",value:9e5},{title:"minutes",value:6e4},{title:"seconds",value:1e3},{title:"milliseconds",value:1}]}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){!function(e){e[e.Beginner=1]="Beginner",e[e.Intermediate=2]="Intermediate",e[e.Expert=3]="Expert",e[e.Admin=4]="Admin"}(t.Expertise||(t.Expertise={}));var r=t.Expertise,i=function(){function e(){this.leftPanelVisible=!0,this.rightPanelVisible=!1,this.dashboardVisible=!0,this.mapVisible=!0,this.timelineVisible=!0}return e}();t.VisualState=i;var a=function(){function e(){var e=this;this.startDate=function(){return e.focus<e.start&&(e.start=e.focus-e.range/5),new Date(e.start)},this.focusDate=function(){return new Date(e.focus)},this.endDate=function(){return e.focus>e.end&&(e.end=e.focus+e.range/5),new Date(e.end)}}return e.deserialize=function(t){var r=$.extend(new e,t);return("undefined"==typeof r.focus||null===r.focus)&&(r.focus=Date.now()),r},e.prototype.setFocus=function(e,r,i){var a=this;this.focus=e.getTime(),r&&(this.start=r.getTime()),i&&(this.end=i.getTime());var o=this.end-this.start;this.range!==o&&(this.range=o,t.availableZoomLevels.some(function(e){return a.zoomLevel=e.value,a.zoomLevelName=e.title,e.value<a.range/10}))},e}();t.DateRange=a;var o=function(){function e(){this.widgetStyles={}}return e}();t.Solution=o;var s=function(){function e(){}return e}();t.SolutionProject=s;var n=function(){function i(){this.expertMode=r.Expert,this.markers={}}return i.prototype.serialize=function(){return JSON.stringify(i.serializeableData(this),function(e,t){switch(e){case"timestamp":case"mcas":case"$$hashKey":case"div":return void 0;default:return t}},2)},i.serializeFeatureType=function(e){return{name:e.name,style:e.style,propertyTypeKeys:e.propertyTypeKeys,showAllProperties:e.showAllProperties}},i.serializeableData=function(r){return{id:r.id,title:r.title,description:r.description,logo:r.logo,otpServer:r.otpServer,url:r.url,connected:r.connected,startPosition:r.startposition,timeLine:r.timeLine,opacity:r.opacity,mcas:r.mcas,datasources:e.Helpers.serialize(r.datasources,t.DataSource.serializeableData),dashboards:e.Helpers.serialize(r.dashboards,t.Dashboard.serializeableData),viewBounds:r.viewBounds,collapseAllLayers:r.collapseAllLayers,userPrivileges:r.userPrivileges,languages:r.languages,expertMode:r.expertMode,baselayers:r.baselayers,featureTypes:r.featureTypes,propertyTypeData:r.propertyTypeData,groups:e.Helpers.serialize(r.groups,t.ProjectGroup.serializeableData),layerDirectory:r.layerDirectory}},i.prototype.deserialize=function(e){var r=jQuery.extend(new i,e);r.solution=e.solution,e.opacity||(e.opacity=100),e.timeLine&&(r.timeLine=a.deserialize(e.timeLine)),e.dashboards&&(r.dashboards=[],e.dashboards.forEach(function(i){r.dashboards.push(t.Dashboard.deserialize(i,e.solution))})),r.mcas=[];for(var o in e.mcas){var s=new Mca.Models.Mca;r.mcas.push(s.deserialize(e.mcas[o]))}return r.propertyTypeData||(r.propertyTypeData={}),r.mcas||(r.mcas=[]),e.groups&&(r.groups=[],e.groups.forEach(function(e){r.groups.push(t.ProjectGroup.deserialize(e))})),null==r.id&&(r.id=r.title),r},i}();t.Project=n}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function t(){}return t.serialize=function(t){var r={featureTypes:{},propertyTypeData:{}};for(var i in t.featureTypes)r.featureTypes[i]=e.Project.serializeFeatureType(t.featureTypes[i]);for(var a in t.propertyTypeData)r.propertyTypeData[a]=t.propertyTypeData[a];return JSON.stringify(r)},t}();e.TypeResource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var ColorExt;!function(e){var t=function(){function e(){}return e.hsv2rgb=function(e,t,r){var i,a,o=[];if(0===t)i=[r,r,r];else switch(e/=60,a=Math.floor(e),o=[r*(1-t),r*(1-t*(e-a)),r*(1-t*(1-(e-a)))],a){case 0:i=[r,o[2],o[0]];break;case 1:i=[o[1],r,o[0]];break;case 2:i=[o[0],r,o[2]];break;case 3:i=[o[0],o[1],r];break;case 4:i=[o[2],o[0],r];break;default:i=[r,o[0],o[1]]}return"#"+i.map(function(e){return("0"+Math.round(255*e).toString(16)).slice(-2)}).join("")},e.toColor=function(t,r,i,a,o){var s=a+Math.floor(t/(i-r)*(o-a));return e.hsv2rgb(s,1,1)},e.rgbToHue=function(e){if(e){if("#"===e[0]&&(e=e.substr(1)),6!==e.length)return void console.log("Wrong rgb format: "+e);for(var t=parseInt(e.substring(0,2),16)/255,r=parseInt(e.substring(2,4),16)/255,i=parseInt(e.substring(4,6),16)/255,a=Math.atan2(Math.sqrt(3)*(r-i),2*(t-r-i));0>a;)a+=2*Math.PI;for(;a>=2*Math.PI;)a-=2*Math.PI;return a=180*a/Math.PI}},e.rgbToHex=function(e){return"#"+e.map(function(e){return("0"+e.toString(16)).slice(-2)}).join("")},e.colorNameToHex=function(e){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return"undefined"!=typeof t[e.toLowerCase()]&&t.hasOwnProperty(e.toLowerCase())?t[e.toLowerCase()]:"#000000"},e}();e.Utils=t}(ColorExt||(ColorExt={}));var csComp;!function(e){var t;!function(e){var t=1e-10,r=function(){function e(e){this.level=e,this.count=0,this.s=null}return e.prototype.addSegment=function(e,t){for(var r=this.s,i=null,a=null,o=!1,s=!1;r&&(null===i&&(this.pointsEqual(e,r.head.p)?(i=r,o=!0):this.pointsEqual(e,r.tail.p)&&(i=r)),null===a&&(this.pointsEqual(t,r.head.p)?(a=r,s=!0):this.pointsEqual(t,r.tail.p)&&(a=r)),null==a||null==i);)r=r.next;var n=(null!=i?1:0)|(null!=a?2:0);switch(n){case 0:var l={p:e,prev:null},c={p:t,next:null};l.next=c,c.prev=l,i={head:l,tail:c,next:this.s,prev:null,closed:!1},this.s&&(this.s.prev=i),this.s=i,++this.count;break;case 1:var p={p:t};o?(p.next=i.head,p.prev=null,i.head.prev=p,i.head=p):(p.next=null,p.prev=i.tail,i.tail.next=p,i.tail=p);break;case 2:var p={p:e};s?(p.next=a.head,p.prev=null,a.head.prev=p,a.head=p):(p.next=null,p.prev=a.tail,a.tail.next=p,a.tail=p);break;case 3:if(i===a){var p={p:i.tail.p,next:i.head,prev:null};i.head.prev=p,i.head=p,i.closed=!0;break}switch((o?1:0)|(s?2:0)){case 0:this.reverseList(i);case 1:a.tail.next=i.head,i.head.prev=a.tail,a.tail=i.tail,this.remove_seq(i);break;case 3:this.reverseList(i);case 2:i.tail.next=a.head,a.head.prev=i.tail,i.tail=a.tail,this.remove_seq(a)}}},e.prototype.remove_seq=function(e){e.prev?e.prev.next=e.next:this.s=e.next,e.next&&(e.next.prev=e.prev),--this.count},e.prototype.pointsEqual=function(e,r){var i=e.x-r.x,a=e.y-r.y;return t>i*i+a*a},e.prototype.reverseList=function(e){for(var t=e.head;t;){var r=t.next;t.next=t.prev,t.prev=r,t=r}var r=e.head;e.head=e.tail,e.tail=r},e}(),i=function(){function e(e){this.h=new Array(5),this.sh=new Array(5),this.xh=new Array(5),this.yh=new Array(5),e&&(this.drawContour=e)}return e.prototype.contour=function(e,r,i,a,o,s,n,l,c,p){var u=this.h,h=this.sh,d=this.xh,f=this.yh;this.drawContour;this.contours={};for(var y,m,g,v,S,$,b=function(e,t){return(u[t]*d[e]-u[e]*d[t])/(u[t]-u[e])},w=function(e,t){return(u[t]*f[e]-u[e]*f[t])/(u[t]-u[e])},T=0,L=0,E=0,C=0,M=[0,1,1,0],F=[0,0,1,1],P=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]],x=o-1;x>=a;x--)for(var O=r;i>O;O++){if(e[O][x]===p||e[O+1][x]===p||e[O][x+1]===p||e[O+1][x+1]===p)return;var D,k;if(D=Math.min(e[O][x],e[O][x+1]),k=Math.min(e[O+1][x],e[O+1][x+1]),S=Math.min(D,k),D=Math.max(e[O][x],e[O][x+1]),k=Math.max(e[O+1][x],e[O+1][x+1]),$=Math.max(D,k),!($<c[0]&&S>c[l-1]))for(var A=0;l>A;A++)if(c[A]>=S&&c[A]<=$){for(var I=4;I>=0;I--)I>0?(u[I]=e[O+M[I-1]][x+F[I-1]]-c[A],d[I]=s[O+M[I-1]],f[I]=n[x+F[I-1]]):(u[0]=.25*(u[1]+u[2]+u[3]+u[4]),d[0]=.5*(s[O]+s[O+1]),f[0]=.5*(n[x]+n[x+1])),u[I]>t?h[I]=1:u[I]<-t?h[I]=-1:h[I]=0;for(I=1;4>=I;I++)if(y=I,m=0,g=4!=I?I+1:1,v=P[h[y]+1][h[m]+1][h[g]+1],0!=v){switch(v){case 1:T=d[y],E=f[y],L=d[m],C=f[m];break;case 2:T=d[m],E=f[m],L=d[g],C=f[g];break;case 3:T=d[g],E=f[g],L=d[y],C=f[y];break;case 4:T=d[y],E=f[y],L=b(m,g),C=w(m,g);break;case 5:T=d[m],E=f[m],L=b(g,y),C=w(g,y);break;case 6:T=d[g],E=f[g],L=b(y,m),C=w(y,m);break;case 7:T=b(y,m),E=w(y,m),L=b(m,g),C=w(m,g);break;case 8:T=b(m,g),E=w(m,g),L=b(g,y),C=w(g,y);break;case 9:T=b(g,y),E=w(g,y),L=b(y,m),C=w(y,m)}this.drawContour(T,E,L,C,c[A],A)}}}},e.prototype.drawContour=function(e,t,i,a,o,s){var n=this.contours[s];n||(n=this.contours[s]=new r(o)),n.addSegment({x:e,y:t},{x:i,y:a})},Object.defineProperty(e.prototype,"contourList",{get:function(){var e=[],t=this.contours;for(var r in t)for(var i=t[r].s,a=t[r].level;i;){var o=i.head,s=[];for(s.level=a,s.k=r;o&&o.p;)s.push(o.p),o=o.next;e.push(s),i=i.next}return e.sort(function(e,t){return e.k-t.k}),e},enumerable:!0,configurable:!0}),e}();e.Conrec=i}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={})),Date.prototype.getJulian=function(){return this/864e5+2440587.5},Date.prototype.getGMST=function(){var e=this.getJulian(),t=e-2451545;return(18.697374558+24.06570982441908*t)%24},Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),r=this.getDate().toString();return e+(t[1]?t:"0"+t[0])+(r[1]?r:"0"+r[0])};var csComp;!function(e){var t;!function(e){var t=function(){function e(){this.theKeys=[],this.theValues=[]}return e.prototype.initialize=function(e){for(var t=0;t<e.length;t++)this[e[t].key]=e[t].value,this.theKeys.push(e[t].key),this.theValues.push(e[t].value)},e.prototype.add=function(e,t){this[e]=t,this.theKeys.push(e),this.theValues.push(t)},e.prototype.remove=function(e){var t=this.theKeys.indexOf(e,0);this.theKeys.splice(t,1),this.theValues.splice(t,1),delete this[e]},e.prototype.clear=function(){for(var e=this.theKeys.length;e>=0;e--){var t=this.theKeys[e];this.remove(t)}},e.prototype.count=function(){return this.theKeys.length},e.prototype.keys=function(){return this.theKeys},e.prototype.values=function(){return this.theValues},e.prototype.containsKey=function(e){return"undefined"!=typeof this[e]},e.prototype.toLookup=function(){return this},e}();e.Dictionary=t}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var esriJsonConverter;!function(e){var t=function(){function e(){this.esriCon={},this.gCon={}}return e.prototype.ringIsClockwise=function(e){var t,r=0,i=0,a=e.length,o=e[i];for(i;a-1>i;i++)t=e[i+1],r+=(t[0]-o[0])*(t[1]+o[1]),o=t;return r>=0},e.prototype.esriGeometryToGcGeometry=function(e){var t,r,i,a,o,s,n;if(e){if((e.x&&"NaN"!==e.x||0===e.x)&&(e.y&&"NaN"!==e.y||0===e.y))a="Point",i=[e.x,e.y];else if(e.points&&e.points.length)a="MultiPoint",i=e.points;else if(e.paths&&e.paths.length)o=e.paths,1===o.length?(a="LineString",i=o[0]):(a="MultiLineString",i=o);else if(e.rings&&e.rings.length){for(s=[],o=e.rings,r=0;r<o.length;r++)n=o[r],this.ringIsClockwise(n)?s.push([n]):s.length>0&&s[s.length-1].push(n);s.length>1?(i=s,a="MultiPolygon"):(i=s.pop(),a="Polygon")}return t=i&&a?{type:a,coordinates:i}:null}return t},e.prototype.esriFeatureToGcFeature=function(e){var t,r,i,a=null;if(e&&(a={type:"Feature"},e.geometry&&(a.geometry=this.esriGeometryToGcGeometry(e.geometry)),e.attributes)){r={},i=e.attributes;for(t in e.attributes)r[t]=e.attributes[t];a.properties=r}return a},e.prototype.toGeoJson=function(e){var t,r,i,a;if(e)if(e.features)for(t={type:"FeatureCollection",features:[]},i=e.features,r=0;r<i.length;r++)a=this.esriFeatureToGcFeature(i[r]),a&&t.features.push(a);else t=e.geometry?this.esriFeatureToGcFeature(e):this.esriGeometryToGcGeometry(e);return t},e.prototype.isCompatible=function(e,t){var r=!1;return("esriGeometryPoint"!==e&&"esriGeometryMultipoint"!==e||"Point"!==t&&"MultiPoint"!==t)&&("esriGeometryPolyline"!==e||"LineString"!==t&&"MultiLineString"!==t)?"esriGeometryPolygon"!==e||"Polygon"!==t&&"MultiPolygon"!==t||(r=!0):r=!0,r},e.prototype.gcGeomTypeToEsriGeomInfo=function(e){var t,r;return"Point"===e?t="esriGeometryPoint":"MultiPoint"===e?(t="esriGeometryMultipoint",r="points"):"LineString"===e||"MultiLineString"===e?(t="esriGeometryPolyline",r="paths"):("Polygon"===e||"MultiPolygon"===e)&&(t="esriGeometryPolygon",r="rings"),{type:t,geomHolder:r}},e.prototype.gcPolygonCoordinatesToEsriPolygonCoordinates=function(e){var t,r,i,a=[];for(t=0,r=e.length;r>t;t++)i=e[t],0==t!=this.ringIsClockwise(i)&&(i=i.reverse()),a.push(i);return a},e.prototype.gcCoordinatesToEsriCoordinates=function(e){var t,r,i;if("MultiPoint"===e.type||"MultiLineString"===e.type)i=e.coordinates;else if("Point"===e.type||"LineString"===e.type)i=[e.coordinates];else if("Polygon"===e.type)i=this.gcPolygonCoordinatesToEsriPolygonCoordinates(e.coordinates);else if("MultiPolygon"===e.type)for(i=[],t=0,r=e.coordinates.length;r>t;t++)i.push(this.gcPolygonCoordinatesToEsriPolygonCoordinates(e.coordinates[t])[0]);return i},e.prototype.gcGeometryToEsriGeometry=function(e){var t,r,i,a,o,s;if("GeometryCollection"===e.type)for(i=[e.geometries.shift()],r=this.gcGeomTypeToEsriGeomInfo(i[0].type),a=0;a<e.geometries.length;a++)this.isCompatible(r.type,e.geometries[a].type)&&i.push(e.geometries[a]);else r=this.gcGeomTypeToEsriGeomInfo(e.type),i=[e];if("esriGeometryPoint"===r.type&&i.length>1&&(r=this.gcGeomTypeToEsriGeomInfo("MultiPoint")),t={spatialReference:{wkid:4326}},"esriGeometryPoint"===r.type)0===i[0].coordinates.length?(t.x=null,t.y=null):(t.x=i[0].coordinates[0],t.y=i[0].coordinates[1]);else for(t[r.geomHolder]=[],a=0;a<i.length;a++)for(s=this.gcCoordinatesToEsriCoordinates(i[a]),o=0;o<s.length;o++)t[r.geomHolder].push(s[o]);return t},e.prototype.gcFeatureToEsriFeature=function(e){var t,r,i;if(e&&(t={},e.geometry&&(t.geometry=this.gcGeometryToEsriGeometry(e.geometry)),e.properties)){i={};for(r in e.properties)i[r]=e.properties[r];t.attributes=i}return t},e.prototype.toEsri=function(e){var t,r,i,a;if(e)if("FeatureCollection"===e.type)for(t={features:[]},i=e.features,r=0;r<i.length;r++)a=this.gcFeatureToEsriFeature(i[r]),a&&t.features.push(a);else t="Feature"===e.type?this.gcFeatureToEsriFeature(e):this.gcGeometryToEsriGeometry(e);return t},e}();e.esriJsonConverter=t}(esriJsonConverter||(esriJsonConverter={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.getBoundingBox=function(e){var t={};e=e.features;for(var r=0;r<e.length;r++){var i=d3.geo.bounds(e[r]);t.xMin=t.xMin<i[0][0]?t.xMin:i[0][0],t.xMax=t.xMax>i[1][0]?t.xMax:i[1][0],t.yMin=t.yMin<i[0][1]?t.yMin:i[0][1],t.yMax=t.yMax>i[1][1]?t.yMax:i[1][1]}return t.southWest=[t.yMin,t.xMin],t.northEast=[t.yMax,t.xMax],t},e.convertTopoToGeoJson=function(e){var t="string"==typeof e?JSON.parse(e):e,r={};r.featureTypes=e.featureTypes,r.features=[];for(var i in t.objects){var a=topojson.feature(t,t.objects[i]);a.features?a.features.forEach(function(e){return r.features.push(e)}):r.features.push(a)}return r},e.deg2rad=function(e){var t=2*Math.PI/360;return e*t},e.rad2deg=function(e){var t=360/(2*Math.PI);return e*t},e.convertRDToWGS84=function(e,t){var r=155e3,i=463e3,a=52.156160556,o=5.387638889,s=3236.0331637,n=5261.3028966,l=-32.5915821,c=105.9780241,p=-.2472814,u=2.4576469,h=-.8501341,d=-.8192156,f=-.0655238,y=-.0560092,m=-.0171137,g=.0560089,v=.0052771,S=-.0025614,$=-3859e-7,b=.001277,w=3314e-7,T=2574e-7,L=371e-7,E=-973e-7,C=143e-7,M=293e-7,F=-9e-6,P=291e-7,x=(e-r)*Math.pow(10,-5),O=(t-i)*Math.pow(10,-5),D=s*O+l*Math.pow(x,2)+p*Math.pow(O,2)+h*Math.pow(x,2)*O+f*Math.pow(O,3);D+=v*Math.pow(x,4)+m*Math.pow(x,2)*Math.pow(O,2)+L*Math.pow(O,4)+w*Math.pow(x,4)*O,D+=$*Math.pow(x,2)*Math.pow(O,3)+C*Math.pow(x,4)*Math.pow(O,2)+F*Math.pow(x,2)*Math.pow(O,4);var k=a+D/3600,A=n*x+c*x*O+d*Math.pow(x,3)+u*x*Math.pow(O,2)+y*Math.pow(x,3)*O;A+=g*x*Math.pow(O,3)+T*Math.pow(x,5)+S*Math.pow(x,3)*Math.pow(O,2)+b*x*Math.pow(O,4),A+=M*Math.pow(x,5)*O+E*Math.pow(x,3)*Math.pow(O,3)+P*x*Math.pow(O,5);var I=o+A/3600,R=k+(-96.862-11.714*(k-52)-.125*(I-5))/1e5,_=I+(-37.902+.329*(k-52)-14.667*(I-5))/1e5;return{latitude:R,longitude:_}},e.log10=function(e){return Math.LOG10E*Math.log(e)},e.convertDegreesToMeters=function(t){var r=e.deg2rad(t),i=111132.92,a=-559.82,o=1.175,s=-.0023,n=111412.84,l=-93.5,c=.118,p=i+a*Math.cos(2*r)+o*Math.cos(4*r)+s*Math.cos(6*r),u=n*Math.cos(r)+l*Math.cos(3*r)+c*Math.cos(5*r);return{latitudeLength:p,longitudeLength:u}},e.createPolygonFeature=function(e,t){if(null===e)throw new Error("No coordinates passed");for(var r=0;r<e.length;r++)for(var i=e[r],a=0;a<i[i.length-1].length;a++)i.length<4&&new Error("Each LinearRing of a Polygon must have 4 or more Positions."),i[i.length-1][a]!==i[0][a]&&new Error("First and last Position are not equivalent.");var o={type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:t};return o.properties||(o.properties={}),o},e.createFeatureCollection=function(e){return{type:"FeatureCollection",features:e}},e.createPointFeature=function(e,t,r,i){var a={type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:r};return i&&i!=={}&&(a.sensors=i),a},e.createLineFeature=function(e,t){if(null===e)throw new Error("No coordinates passed");for(var r=0;r<e.length;r++){var i=e[r];i.length<2&&new Error("Each LineString of a Polygon must have 2 or more Positions.")}var a={type:"Feature",geometry:{type:"LineString",coordinates:e},properties:t};return a.properties||(a.properties={}),a},e.createPropertyType=function(e,t){if(e){var r={label:e,title:e,type:"text",visibleInCallOut:!0,canEdit:!0,isSearchable:!1};return t&&(r.section=t),r}},e.convertMileToKm=function(e){return e&&!isNaN(e)?1.609344*e:void 0},e.convertKmToMile=function(e){return e&&!isNaN(e)?.621371192*e:void 0},e.pointInsidePolygon=function(e,t){for(var r=e[0],i=e[1],a=t[0],o=!1,s=0,n=a.length-1;s<a.length;n=s++){var l=a[s][0],c=a[s][1],p=a[n][0],u=a[n][1],h=c>i!=u>i&&(p-l)*(i-c)/(u-c)+l>r;h&&(o=!o)}return o},e.pointInsideMultiPolygon=function(t,r){for(var i=!1,a=0;a<r.length;a++){var o=r[a];e.pointInsidePolygon(t,o)&&(i=!i)}return i},e}();e.GeoExtensions=t}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){function r(e,t){if("undefined"==typeof e||null===e||0===e.length)return null;var r=[];return e.forEach(function(e){r.push(t(e))}),r}function i(e){var t=this;if("object"!=typeof e)return e;if(e instanceof Array){var r=[];return e.forEach(function(e){r.push(t.cloneWithoutUnderscore(e))}),r}var i={};for(var a in e)"_"!==a[0]&&(i[a]=this.cloneWithoutUnderscore(e[a]));return i}function a(e){if("point"===e.geometry.type.toLowerCase()){var t={nameLabel:"Name",drawingMode:"Point",strokeWidth:1,strokeColor:"#0033ff",fillOpacity:1,opacity:1,fillColor:"#FFFF00",stroke:!0,rotate:0,cornerRadius:50,iconHeight:32,iconWidth:32};return t}var r={nameLabel:"Name",drawingMode:"Polygon",strokeWidth:1,strokeColor:"#0033ff",fillOpacity:.75,opacity:.75,fillColor:"#FFFF00",stroke:!0,iconUri:"cs/images/marker.png"};return r}function o(t,r,i){if(i=i.replace(".",""),r=r.replace("."+i,"")+"."+i,navigator.msSaveBlob){var a=document.createElement("a");a.addEventListener("click",function(e){var a=new Blob([t],{type:"text/"+i+";charset=utf-8;"});navigator.msSaveBlob(a,r)},!1),document.body.appendChild(a),a.click(),document.body.removeChild(a)}else if(e.Helpers.supportsDataUri()){var o=document.createElement("a");document.body.appendChild(o),o.href="data:text/"+i+";charset=utf-8,"+encodeURI(t),o.target="_blank",o.download=r,o.click(),document.body.removeChild(o)}else{var s=window.open("",i,"");s.document.body.innerHTML="<pre>"+t+"</pre>"}}function s(){var e="Microsoft Internet Explorer"===navigator.appName,t=!!navigator.userAgent.match(/Trident\/7\./);return!(e||t)}function n(e){var t=l(e),r=e.map(function(e){var r=e-t,i=r*r;return i}),i=l(r),a=Math.sqrt(i);return{avg:t,stdDev:a}}function l(e){var t=e.reduce(function(e,t){return e+t},0),r=t/e.length;return r}function c(e){return p(e.fType,e)}function p(t,r){var i="";return r.hasOwnProperty("properties")?r.properties.hasOwnProperty("Name")?i=r.properties.Name:r.properties.hasOwnProperty("name")?i=r.properties.name:r.properties.hasOwnProperty("naam")&&(i=r.properties.naam):null!=t&&null!=t.style&&t.style.nameLabel&&(i=r.properties[t.style.nameLabel]),
e.StringExt.isNullOrEmpty(i)||$.isNumeric(i)||(i=i.replace(/&amp;/g,"&")),i}function u(e,t,r){var i=[];if(null!=e.propertyTypeKeys){var a=e.propertyTypeKeys.split(";");a.forEach(function(r){if(t&&t.hasOwnProperty(r))i.push(t[r]);else if(null!=e.propertyTypeData){var a=$.grep(e.propertyTypeData,function(e){return e.label===r});a.length>=1&&i.push(a)}})}if(e.showAllProperties&&r&&r.properties)for(var o in r.properties)!i.some(function(e){return e.label==o});if(null!=e.propertyTypeData)if(e.propertyTypeData.forEach)e.propertyTypeData.forEach(function(e){i.push(e)});else for(var s in e.propertyTypeData)e.propertyTypeData.hasOwnProperty(s)&&i.push(e.propertyTypeData[s]);return i}function h(t){var r=[];for(var i in t.properties)if(t.properties.hasOwnProperty(i)){var a=[];a.label=i,a.title=i.replace("_"," "),a.isSearchable=!0,a.visibleInCallOut=!0,a.canEdit=!1;var o=t.properties[i];e.StringExt.isDate(o)?a.type="date":e.StringExt.isNumber(o)?a.type="number":e.StringExt.isBoolean(o)?a.type="boolean":e.StringExt.isArray(o)?a.type="tags":e.StringExt.isBbcode(o)?a.type="bbcode":a.type="text",r.push(a)}return r}function d(e,t){for(var r=t;e.hasOwnProperty(r);)t+=r,r+=1;return r}function f(t,r,i){var a=r;for(var o in t.properties){var s;if(i&&i.propertyTypeData)for(var n in i.propertyTypeData)i.propertyTypeData[n].label===o&&(s=n);if(!s){if(!t.properties.hasOwnProperty(o))continue;var l={};l.label=o,l.title=o.replace("_"," ");var c=t.properties[o];if(e.StringExt.isNumber(c)?l.type="number":e.StringExt.isBoolean(c)?l.type="boolean":e.StringExt.isBbcode(c)&&(l.type="bbcode"),i){var p=d(i.propertyTypeData,o);p===o&&delete l.label,i.propertyTypeData[p]=l}else r.propertyTypeData||(r.propertyTypeData=[]),r.propertyTypeData[o]=l}}return a}function y(e,t){var r={};return r.style=a(e),this.addPropertyTypes(e,r,t),r}function m(t,r){var i;if(e.StringExt.isNullOrEmpty(r))return r;if(!t.type)return r;switch(t.type){case"bbcode":e.StringExt.isNullOrEmpty(t.stringFormat)||(r=String.format(t.stringFormat,r)),i=XBBCODE.process({text:r}).html;break;case"number":i=$.isNumeric(r)?t.stringFormat?String.format(t.stringFormat,parseFloat(r)):r.toString():r;break;case"options":i=$.isNumeric(r)?t.options[r]:r;break;case"rank":var a=r.split(",");if(2!=a.length)return r;i=t.stringFormat?String.format(t.stringFormat,a[0],a[1]):String.format("{0} / {1}",a[0],a[1]);break;case"hierarchy":var o=r.split(";"),s=o[0];o[1];i=s.toString();break;case"date":var n=new Date(Date.parse(r));i=n.toLocaleString();break;case"duration":if($.isNumeric(r)){var l=new Date(0),c=new Date(r),p=c.getHours()-l.getHours(),u=c.getMinutes()-l.getMinutes(),h=c.getSeconds()-l.getSeconds();i=("0"+p).slice(-2)+"h"+("0"+u).slice(-2)+"m"+("0"+h).slice(-2)+"s"}else i=r;break;default:i=r}return i}function g(e,r){if(e.properties.hasOwnProperty("Name"))return e;if(e.properties.hasOwnProperty("name"))return e.properties.Name=e.properties.name,e;if(e.fType&&e.fType.style&&e.fType.style.nameLabel){var i=e.fType.style.nameLabel;if(i&&e.properties.hasOwnProperty(i))return r&&r.hasOwnProperty(i)?e.properties.Name=m(r[i],e.properties[i]):e.properties.Name=e.properties[i],e}if(null!=e.fType.propertyTypeData)for(var a=0;a<e.fType.propertyTypeData.length;a++){var o=e.fType.propertyTypeData[a];if("Name"===o.label&&o.stringFormat)return e.properties.Name=t.convertStringFormat(e,o.stringFormat),e}for(var s in e.properties)return e.properties.Name=s.toString(),e;return e.properties.Name=t.getGuid(),e}function v(e,r){for(var i=t.indexes(r,"{"),a=t.indexes(r,"}"),o=r,s=0;s<i.length;s++){var n=r.substring(i[s]+1,a[s]);o=o.replace("{"+n+"}",e.properties[n])}return o}function S(e,t){if(!e)return[];for(var r=[],i=0;i<e.length;i++)e.substr(i,t.length)===t&&r.push(i);return r}function b(){var e=(this.S4()+this.S4()+"-"+this.S4()+"-4"+this.S4().substr(0,3)+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()).toLowerCase();return e}function w(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function T(e){var t={type:"",features:[],featureTypes:{}};return e.project.groups.forEach(function(e){null!=e.filterResult&&e.filterResult.forEach(function(e){return t.features.push(e)})}),0===t.features.length&&(t.features=e.project.features),t.features.forEach(function(r){if(!t.featureTypes.hasOwnProperty(r.featureTypeName)){var i=e.getFeatureType(r);i.name||(i.name=r.featureTypeName.replace("_Default","")),t.featureTypes[r.featureTypeName]=i,i.propertyTypeKeys&&(i.propertyTypeData=[],i.propertyTypeKeys.split(";").forEach(function(t){e.propertyTypeData.hasOwnProperty(t)&&i.propertyTypeData.push(e.propertyTypeData[t])}))}}),t}function L(t,r,i,a,o,s){var n=new e.Services.RightPanelTab;return n.container=t,n.data=i,n.title=a,n.directive=r,n.popover=o||"",n.icon=s||"tachometer",n}function E(e,t,r,i){var a=e.split(t)[0],o=e.split(t)[1],s=o.split(r),n={};return s.forEach(function(e){var t=e.split(i);n[t[0]]=isNaN(+t[1])?t[1]:+t[1]}),n.baseUrl=a,n}function C(e,t,r,i){var a=e.baseUrl+t;for(var o in e)e.hasOwnProperty(o)&&"baseUrl"!==o&&e[o]&&(a=a+o+i+e[o]+r);return a=a.substring(0,a.length-1)}function M(e,r){var i,a,o="<div ",s={},n=e.effectiveStyle.iconUri;e.effectiveStyle.hasOwnProperty("strokeWidth")&&e.effectiveStyle.strokeWidth>0?(i=e.effectiveStyle.iconWidth+2*e.effectiveStyle.strokeWidth,a=e.effectiveStyle.iconHeight+2*e.effectiveStyle.strokeWidth):(i=e.effectiveStyle.iconWidth,a=e.effectiveStyle.iconHeight),s.background=e.effectiveStyle.fillColor,s.width=i+"px",s.height=i+"px",s["border-radius"]=e.effectiveStyle.cornerRadius+"%",s["border-style"]="solid",s["border-color"]=e.effectiveStyle.strokeColor,s["border-width"]=e.effectiveStyle.strokeWidth+"px",s.opacity=e.effectiveStyle.opacity,o+=" style='display: inline-block;vertical-align: middle;text-align: center;";for(var l in s)s.hasOwnProperty(l)&&(o+=l+":"+s[l]+";");o+="'>",null!=e.effectiveStyle.innerTextProperty&&e.properties.hasOwnProperty(e.effectiveStyle.innerTextProperty)?o+="<span style='font-size:12px;vertical-align:-webkit-baseline-middle'>"+e.properties[e.effectiveStyle.innerTextProperty]+"</span>":null!=n&&(null!=n&&n.indexOf("{")>=0&&(n=t.convertStringFormat(e,n)),o+="<img src='"+n+"' style='width:"+e.effectiveStyle.iconWidth+"px;height:"+e.effectiveStyle.iconHeight+"px;display:block",e.effectiveStyle.rotate&&e.effectiveStyle.rotate>0&&(o+=";transform:rotate("+e.effectiveStyle.rotate+"deg)"),o+="' />"),o+="</div>";var c={};return c.html=o,c.iconPlusBorderWidth=i,c.iconPlusBorderHeight=a,c}t.serialize=r,t.cloneWithoutUnderscore=i,t.getDefaultFeatureStyle=a,t.saveData=o,t.supportsDataUri=s,t.standardDeviation=n,t.average=l,t.getFeatureTitle=c,t.featureTitle=p,t.getPropertyTypes=u,t.getMissingPropertyTypes=h,t.findUniqueKey=d,t.addPropertyTypes=f,t.createDefaultType=y,t.convertPropertyInfo=m,t.setFeatureName=g,t.convertStringFormat=v,t.indexes=S,t.getGuid=b,t.S4=w,t.loadMapLayers=T,t.createRightPanelTab=L,t.parseUrlParameters=E,t.joinUrlParameters=C,t.createIconHtml=M}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.PieData=t;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(t);e.AsterPieData=r;var i=function(){function e(){}return e.drawHistogram=function(t,r){var i=null!=r&&r.hasOwnProperty("id")?r.id:"myHistogram",a=null!=r&&r.hasOwnProperty("numberOfBins")?r.numberOfBins:10,o=null!=r&&r.hasOwnProperty("width")?r.width:200,s=null!=r&&r.hasOwnProperty("height")?r.height:150,n=null!=r&&r.hasOwnProperty("xLabel")?r.xLabel:"",l=null!=r&&r.hasOwnProperty("selectedValue")?r.selectedValue:null,c={top:0,right:6,bottom:24,left:6};o-=c.left+c.right,s-=c.top+c.bottom;var p="the_SVG_ID";if(e.clearSvg(p),!(t.length<a)){var u=d3.format(",.0f"),h=Math.max.apply(null,t),d=Math.min.apply(null,t),f=h-d,y=e.getScale(f/a,h),m=0;Math.abs(y)>0&&(n+=" (x10^"+y+")",m=Math.pow(10,y));var g=function(e){return m>0?d3.round(e/m,0).toString():d3.round(e,0).toString()},v=d3.scale.linear().domain([0,a]).range([d,h]),S=d3.range(a+1).map(v),$=d3.scale.linear().domain([d,h]).range([0,o]),b=d3.svg.axis().scale($).tickValues(S).tickFormat(g).orient("bottom"),w=d3.layout.histogram().bins(a)(t),T=d3.scale.linear().domain([0,d3.max(w,function(e){return e.y})]).range([s,0]),L=d3.select("#"+i).append("svg").attr("id",p).attr("width",o+c.left+c.right).attr("height",s+c.top+c.bottom).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+c.left+","+c.top+")"),E=L.selectAll(".bar").data(w).enter().append("g").attr("class",function(e,t){return null!=l&&e.x<l&&l<e.x+w[t].dx?"bar highlight":"bar"}).attr("transform",function(e){return"translate("+$(e.x)+","+T(e.y)+")"});E.append("rect").attr("x",1).attr("width",$(d+w[0].dx)-1).attr("height",function(e){return s-T(e.y)});var C=function(e){return s-T(e)>6?u(e):""};E.append("text").attr("dy",".75em").attr("y",6).attr("x",$(d+w[0].dx)/2).attr("text-anchor","middle").text(function(e){return C(e.y)}),L.append("text").attr("class","x label").attr("text-anchor","end").attr("x",o).attr("y",s/2-6).text(n),L.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call(b)}},e.getScale=function(e,t){for(var r=-5;5>r;r++){var i=Math.pow(10,r),a=d3.round(e/i,0),o=d3.round(t/i,0);if(a>0&&10>a&&o>0&&100>o)return r}return 0},e.drawMcaPlot=function(t,r){var i=null!=r&&r.hasOwnProperty("id")?r.id:"myHistogram",a=null!=r&&r.hasOwnProperty("numberOfBins")?r.numberOfBins:10,o=null!=r&&r.hasOwnProperty("width")?r.width:200,s=null!=r&&r.hasOwnProperty("height")?r.height:150,n=null!=r&&r.hasOwnProperty("xLabel")?r.xLabel:"",l=null!=r&&r.hasOwnProperty("xy")?r.xy:null,c=null!=r&&r.hasOwnProperty("featureValue")?r.featureValue:null,p={top:0,right:6,bottom:24,left:6};o-=p.left+p.right,s-=p.top+p.bottom;var u=i+"_histogram";e.clearSvg(u);var h,d,f,y=d3.format(",.0f");null!=l?(h=l.x[l.x.length-1],d=l.x[0],f=h-d,h+=f/10,d-=f/10):(h=Math.max.apply(null,t),d=Math.min.apply(null,t)),f=h-d;var m=e.getScale(f/a,h),g=0;n+=" (",Math.abs(m)>0&&(n+="x10^"+m,g=Math.pow(10,m));var v=function(e){return g>0?d3.round(e/g,0).toString():d3.round(e,0).toString()},S=d3.scale.linear().domain([0,a]).range([d,h]),$=d3.range(a+1).map(S),b=d3.scale.linear().domain([d,h]).range([0,o]),w=d3.svg.axis().scale(b).tickValues($).tickFormat(v).orient("bottom"),T=t.filter(function(e){return e>=d&&h>=e});if(T.length<3){var L=d3.select("#"+i).append("svg").attr("id",u).attr("width",o+p.left+p.right).attr("height",s+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")");return void L.append("text").attr("class","x label").attr("text-anchor","center").attr("x",o/2).attr("y",s/2+6).text("Χ NO DATA IN RANGE")}n+=" Σ"+T.length;var E=d3.layout.histogram().bins(a)(T),C=d3.scale.linear().domain([0,d3.max(E,function(e){return e.y})]).range([s,0]),M=d3.select("#"+i).append("svg").attr("id",u).attr("width",o+p.left+p.right).attr("height",s+p.top+p.bottom).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+p.left+","+p.top+")"),F=M.selectAll(".bar").data(E).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+b(e.x)+","+C(e.y)+")"});F.append("rect").attr("x",1).attr("width",b(d+E[0].dx)-1).attr("height",function(e){return s-C(e.y)});var P=function(e){return s-C(e)>6?y(e):""};if(F.append("text").attr("dy",".75em").attr("y",6).attr("x",b(d+E[0].dx)/2).attr("text-anchor","middle").text(function(e){return P(e.y)}),n+=")",M.append("text").attr("class","x label").attr("text-anchor","end").attr("x",o).attr("y",s/2-6).text(n),M.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call(w),null!=l){var x=[];x.push({x:d,y:l.y[0]});for(var O=0;O<l.x.length;O++)x.push({x:l.x[O],y:l.y[O]});x.push({x:h,y:l.y[l.y.length-1]});var D=d3.scale.linear().domain([0,d3.max(x,function(e){return e.y})]).range([s-1,1]),k=d3.svg.line().x(function(e){return b(e.x)}).y(function(e){return D(e.y)}).interpolate("linear");M.append("svg:path").attr("d",k(x)).attr("stroke","red").attr("stroke-width",2).attr("fill","none"),null!=c&&(x=[],x.push({x:c,y:0}),x.push({x:c,y:s}),M.append("svg:path").attr("d",k(x)).attr("stroke","blue").attr("stroke-width",2).attr("fill","none"))}},e.drawPie=function(t,r,i,a,o){if(void 0===i&&(i="mcaPieChart"),void 0===a&&(a="Reds"),void 0===o&&(o="the_SVG_ID"),e.clearSvg(o),r){var s=t,n=t,l=Math.min(s,n)/2,c=0,p=d3.layout.pie().sort(null).value(function(e){return e.weight}),u=d3.tip().attr("class","d3-tip").offset([0,0]).html(function(e){return"<strong>"+e.data.label+": </strong><span style='color:orangered'>"+Math.round(100*e.data.weight)+"%</span>"}),h=d3.svg.arc().innerRadius(c).outerRadius(l),d=d3.svg.arc().innerRadius(c).outerRadius(l),f=d3.select("#"+i).append("svg").attr("id",o).attr("width",s).attr("height",n).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+s/2+","+n/2+")"),y=chroma.scale(a).domain([0,r.length-1],r.length);f.selectAll(".solidArc").data(p(r)).enter().append("path").attr("fill",function(e,t){return e.data.color||y(t).hex()}).attr("class","solidArc").attr("stroke","gray").attr("d",h).on("mouseover",function(e,t){u.show(e,t)}).on("mouseout",u.hide),f.selectAll(".outlineArc").data(p(r)).enter().append("path").attr("fill","none").attr("stroke","gray").attr("class","outlineArc").attr("d",d)}},e.drawAsterPlot=function(t,r,i,a,o){if(void 0===i&&(i="mcaPieChart"),void 0===a&&(a="Reds"),void 0===o&&(o="the_SVG_ID"),e.clearSvg(o),r){var s=t,n=t,l=Math.min(s,n)/2,c=.3*l,p=d3.layout.pie().sort(null).value(function(e){return e.weight}),u=d3.tip().attr("class","d3-tip").offset([0,0]).html(function(e){return"<strong>"+e.data.label+": </strong> <span style='color:orangered'>"+Math.round(100*e.data.weight)+"% x "+Math.round(e.data.score)+"&nbsp; = "+Math.round(e.data.weight*e.data.score)+"</span>"}),h=d3.svg.arc().innerRadius(c).outerRadius(function(e){return(l-c)*(e.data.score/100)+c}),d=d3.svg.arc().innerRadius(c).outerRadius(l),f=d3.select("#"+i).append("svg").attr("id",o).attr("width",s).attr("height",n).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+s/2+","+n/2+")");try{f.call(u)}catch(y){console.log("Error: "+y.message)}var m=chroma.scale(a).domain([0,r.length-1],r.length),g=(f.selectAll(".solidArc").data(p(r)).enter().append("path").attr("fill",function(e,t){return e.data.color||m(t).hex()}).attr("class","solidArc").attr("stroke","gray").attr("d",h).on("mouseover",function(e,t){u.show(e,t)}).on("mouseout",u.hide),f.selectAll(".outlineArc").data(p(r)).enter().append("path").attr("fill","none").attr("stroke","gray").attr("class","outlineArc").attr("d",d),0),v=0;r.forEach(function(e){g+=e.weight,v+=e.weight*e.score}),f.append("svg:text").attr("class","aster-score").attr("dy",".35em").attr("text-anchor","middle").text(Math.round(v/g))}},e.clearSvg=function(e){var t=d3.select("#"+e);t&&t.remove()},e.pieColors=["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],e}();e.Plot=i}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){function t(e){return!a(e)&&!e}function r(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var i=t.length;i--;)e=e.replace(new RegExp("\\{"+i+"\\}","gm"),t[i]);return e}function i(e){return moment(e,moment.ISO_8601).isValid()}function a(e){return!isNaN(parseFloat(e))&&isFinite(e)}function o(e){return"true"===e||"false"===e}function s(e){return e&&e.constructor===Array}function n(e){return!1}e.isNullOrEmpty=t,e.format=r,e.isDate=i,e.isNumber=a,e.isBoolean=o,e.isArray=s,e.isBbcode=n}(t=e.StringExt||(e.StringExt={}))}(csComp||(csComp={}));var StringFormat;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("stringy",["$compile",function(e){return{require:"ngModel",terminal:!1,restrict:"A",scope:{},link:function(e,t,r,i){e.$watch(function(){return i.$modelValue},function(e){t[0].innerText=String.format("{0:0,0}",i.$modelValue)})}}}])}(StringFormat||(StringFormat={})),String.prototype.score=function(e,t){"use strict";if(this===e)return 1;if(""===e)return 0;var r,i,a,o,s,n=0,l=this,c=l.toLowerCase(),p=l.length,u=e.toLowerCase(),h=e.length,d=0,f=1;if(t&&(o=1-t),t)for(s=0;h>s;s+=1)a=c.indexOf(u[s],d),-1===a?f+=o:(d===a?r=.7:(r=.1," "===l[a-1]&&(r+=.8)),l[a]===e[s]&&(r+=.1),n+=r,d=a+1);else for(s=0;h>s;s+=1){if(a=c.indexOf(u[s],d),-1===a)return 0;d===a?r=.7:(r=.1," "===l[a-1]&&(r+=.8)),l[a]===e[s]&&(r+=.1),n+=r,d=a+1}return i=.5*(n/p+n/h)/f,u[0]===c[0]&&.85>i&&(i+=.15),i};var csComp;!function(e){var t;!function(e){function t(e,t){if(t.activeLegend){var r="#000000",i=t.activeLegend,a=(i.id,i.legendEntries.length);if(0==a)return r;if("discretestrings"==i.legendKind.toLowerCase()){for(var o=0;a>o;){var s=i.legendEntries[o];if(e==s.stringValue)return s.color;o++}return r}return r}}function r(e){if(e){var t=e&&e.style&&e.style.iconUri?e.style.iconUri:"cs/images/marker.png";return t.indexOf("{")>=0&&(t=t.replace("{","").replace("}","")),e&&null!=e.style&&null!=e.style.drawingMode&&"point"!=e.style.drawingMode.toLowerCase()?t.indexOf("_Media")<0?t:"cs/images/polygon.png":e&&null!=e.style&&null!=t?t:"cs/images/marker.png"}}function i(e,t){var r="#000000",i=(t.id,t.legendEntries.length);if(0===i)return r;if("discretestrings"===t.legendKind.toLowerCase()){for(var a=0;i>a;){var o=t.legendEntries[a];if(e===o.stringValue)return o.color;a++}return r}return r}function a(e,t,r){void 0===r&&(r="#000000");var i=(t.id,t.legendEntries.length);if(0==i)return r;var a=t.legendEntries[0],o=t.legendEntries[i-1];if("interpolated"===t.legendKind.toLowerCase()){if(e<a.value)return a.color;if(e>o.value)return o.color;for(var s=0;i-1>s;){if(a=t.legendEntries[s],o=t.legendEntries[s+1],e>=a.value&&e<=o.value){var n=chroma.bezier([a.color,o.color]),l=n((e-a.value)/(o.value-a.value)).hex();return l}s++}return r}if("discrete"===t.legendKind.toLowerCase()){if(e<a.interval.min)return t.legendEntries[0].color;if(e>o.interval.max)return t.legendEntries[i-1].color;for(var s=0;i>s;){var c=t.legendEntries[s];if(e>=c.interval.min&&e<=c.interval.max)return c.color;s++}return r}return r}function o(e,t){if(t.activeLegend)return a(e,t.activeLegend);if(e>t.info.max)return t.colors[t.colors.length-1];if(e<t.info.min)return t.colors[0];var r=d3.scale.linear().domain([t.info.min,t.info.max]).range(t.colors),i=r(e).toString();return i}function s(e,t){return void 0===t&&(t="#f00"),e?4==e.length||7==e.length?e:9===e.length?"#"+e.substr(3,6):t:t}e.getColorFromStringValue=t,e.getImageUri=r,e.getColorFromStringLegend=i,e.getColorFromLegend=a,e.getColor=o,e.getColorString=s}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},FSM;!function(e){var t=function(){function e(e){this.fsm=e}return e.prototype.to=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.toStates=e,this.fsm.addTransitions(this)},e.prototype.toAny=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(e[r]);this.toStates=t,this.fsm.addTransitions(this)},e}();e.Transitions=t;var r=function(){function e(e,t,r){this.fsm=e,this.from=t,this.to=r}return e}();e.TransitionFunction=r;var i=function(e){function t(t){e.call(this),this.fsm=t}return __extends(t,e),t.prototype.on=function(e,t){var r=this;this.forEach(function(i){t&&r.fsm.on(i.to,t),r.fsm.addEvent(e,i.from,i.to)})},t}(Array);e.TransitionFunctions=i;var a=function(){function e(e){this._transitionFunctions=[],this._onCallbacks={},this._exitCallbacks={},this._enterCallbacks={},this._triggers={},this.currentState=e,this._startState=e}return e.prototype.addTransitions=function(e){var t=this,a=new i(this);return e.fromStates.forEach(function(i){e.toStates.forEach(function(e){i===e||t._validTransition(i,e)||a.push(new r(t,i,e))})}),a.forEach(function(e){return t._transitionFunctions.push(e)}),a},e.prototype.addEvent=function(e,t,r){var i=t.toString();this._triggers[i]||(this._triggers[i]={}),this._triggers[i][e.toString()]=r},e.prototype.trigger=function(e){if("undefined"!=typeof e){var t=e.toString(),r=this.currentState.toString();this._triggers.hasOwnProperty(r)&&this._triggers[r].hasOwnProperty(t)&&this.go(this._triggers[r][t])}},e.prototype.on=function(e,t){var r=e.toString();return this._onCallbacks[r]||(this._onCallbacks[r]=[]),this._onCallbacks[r].push(t),this},e.prototype.onEnter=function(e,t){var r=e.toString();return this._enterCallbacks[r]||(this._enterCallbacks[r]=[]),this._enterCallbacks[r].push(t),this},e.prototype.onExit=function(e,t){var r=e.toString();return this._exitCallbacks[r]||(this._exitCallbacks[r]=[]),this._exitCallbacks[r].push(t),this},e.prototype.from=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var i=new t(this);return i.fromStates=e,i},e.prototype.fromAny=function(e){var r=[];for(var i in e)e.hasOwnProperty(i)&&r.push(e[i]);var a=new t(this);return a.fromStates=r,a},e.prototype._validTransition=function(e,t){return this._transitionFunctions.some(function(r){return r.from===e&&r.to===t})},e.prototype.canGo=function(e){return this.currentState===e||this._validTransition(this.currentState,e)},e.prototype.go=function(e){if(!this.canGo(e))throw new Error("Error no transition function exists from state "+this.currentState.toString()+" to "+e.toString());this._transitionTo(e)},e.prototype.onTransition=function(e,t){},e.prototype.reset=function(){this.currentState=this._startState},e.prototype._transitionTo=function(e){var t=this;this._exitCallbacks[this.currentState.toString()]||(this._exitCallbacks[this.currentState.toString()]=[]),this._enterCallbacks[e.toString()]||(this._enterCallbacks[e.toString()]=[]),this._onCallbacks[e.toString()]||(this._onCallbacks[e.toString()]=[]);var r=this._exitCallbacks[this.currentState.toString()].reduce(function(r,i){return r&&i.call(t,e)},!0),i=this._enterCallbacks[e.toString()].reduce(function(e,r){return e&&r.call(t,t.currentState)},!0);if(r&&i){var a=this.currentState;this.currentState=e,this._onCallbacks[this.currentState.toString()].forEach(function(r){r.call(t,a,e)}),this.onTransition(a,e)}},e}();e.FiniteStateMachine=a}(FSM||(FSM={}));var csComp;!function(e){!function(e){e[e.Js=0]="Js",e[e.Css=1]="Css"}(e.FileType||(e.FileType={}));var t=e.FileType,r=function(){function e(){}return e.twoDigitStr=function(e){var t;return t=e.toString(),1===t.length&&(t="0"+t),t},e.loadJsCssfile=function(r,i,a){if(!(e.loadedFiles.indexOf(r)>0))switch(e.loadedFiles.push(r),i){case t.Js:var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",r),a&&(o.onload=function(e){a(e)}),document.getElementsByTagName("head")[0].appendChild(o);break;case t.Css:var s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",r),a&&(s.onload=function(e){a(e)}),document.getElementsByTagName("head")[0].appendChild(s)}},e.loadedFiles=[],e}();e.Utils=r}(csComp||(csComp={}));var Translations;!function(e){var t=function(){function e(){}return e.locale={CANCEL_BTN:"Cancel",OK_BTN:"OK",FROM:"from",TO:"to",NAVIGATE:"Start",CREATE_SCATTER:"Create scatter with",EXPAND_ALL:"Expand all",COLLAPSE_ALL:"Collapse all",SELECT_ALL:"Select all",DESELECT_ALL:"Deselect all",CHOOSE_DROPDOWN:"Choose...",ENABLE_LOCATION_FILTER:"Enable location filter",DISABLE_LOCATION_FILTER:"Disable location filter",SELECT_A_FEATURE:"Select a feature",SELECT_FEATURE_FOR_WIDGET:"Please select a feature to show the widget.",SELECT_FEATURE_FOR_STYLE:"Please select a feature to before setting the style.",NO_RELATIONS_FOUND:"No relations can be shown for the selected feature. Either the zoom level is too low, there are too many features in the view or there are no relations defined.",BASESTYLES:"Baselayers",MAP:"Maps",MAP_LABEL:"Map",TABLE_LABEL:"Table",LAYERS:"Layers",DIRECTORY:"Available layers",CREATELAYER:"Create new layer",ADDFEATURES:"Add items",ADDTYPE:"Add new type",DONE:"done",FILTERS:"Filters",FILTER_INFO:'At the moment, no filters have been selected. In order to add a filter, click on an icon or area on the map, and click on the filter icon (<span class="fa fa-filter"></span>) in the right menu. This will create a filter for the selected property.',STYLES:"Styles",STYLE_INFO:'At the moment, no style has been selected. In order to add a style, click on an icon or area on the map, and click on the style icon (<span class="smallStyleIcon"></span>) in the right menu. This will create a filter for the selected property.',FEATURES:"Features",LEGEND:"Legend",SEARCH:"Search",HIDE_PANEL:"Hide this panel",EDIT_INDICATORS:"Edit indicators",RELATED_FEATURES:"Show related features",FEATURE_INFO:"Show information about the selected feature",MAP_FEATURES:"Map features",NEARBY_FEATURES:"Nearby features",TOGGLE_MENU:"Toggle menu visibility",DASHBOARD_SELECTION:"Dashboard selection",SETTINGS:"Settings",SPEEDS_TAOUFIK:"speed colors Taoufik",SPEEDS_GOOGLEMAPS:"speed colors Google Maps",VERWARMINGSSYSTEEM:"Heating system",PERCENTAGES_V1:"percentages v1",ORANGE_RED:"orange - red",WHITE_RED:"white - red",RED_WHITE:"red - white",RED_WHITE_BLUE:"red - white - blue",GREEN_RED:"green - red",RED_GREEN:"red - green",BLUE_RED:"blue - red",RED_BLUE:"red - blue",WHITE_BLUE:"white - blue",BLUE_WHITE:"blue - white",WHITE_GREEN:"white - green",GREEN_WHITE:"green - white",WHITE_ORANGE:"white - orange",ORANGE_WHITE:"orange - white",SAVE:"save",CONFIG:"config",EDIT:"edit",APPLY:"apply",REMOVE:"remove",EXPERTMODE:{BEGINNER:"Novice",INTERMEDIATE:"Intermediate",EXPERT:"Expert",ADMIN:"Admin",EXPLANATION:"Select your expertise in order to unlock more functionality."},LAYER_SERVICE:{RELOAD_PROJECT_TITLE:"Data is reloaded",RELOAD_PROJECT_MSG:"After switching the language, we need to reload all the map data. Our appologies for the inconvenience."},HEATMAP:{NAME:"Heatmaps",DESCRIPTION:'<h4>Heatmap</h4><p  style="text-align: left; margin-left:5px;">Heatmap highlights areas on the map that fulfill multiple selected criteria.',INFO:"At the moment, no map layers are loaded that contain a heatmap. Open another map layer to use it.",INFO_EXPERT:"At the moment, no map layers are loaded that contain a heatmap. Open another map layer to use it, or create a new heatmap using the wizard.",SHOW_FEATURE_MSG:"Select a feature on the map to see the heatmap.",TOTAL_RESULT:"Combined result",DELETE_MSG:'Delete "{0}"',DELETE_MSG2:"Are you sure?",EDITOR_TITLE:"Heatmap Editor",MAIN_FEATURE:"Select the main feature",PROPERTIES:"Select the properties",INTENSITY_SCALE:"Intensity scale",RESOLUTION:"Resolution",TITLE:"Title... *",TITLE_TAG:"Title",SCALE_MIN_TITLE:"[Min. scale]",SCALE_MAX_TITLE:"[Max. scale]",MIN_MAX_ZOOM:"Min./Max. zoom",AT_LOCATION_VALUE:"[Weight at location]",DISTANCE_MAX_VALUE:"[Ideal distance]",LOST_INTEREST_VALUE:"[Lost interest distance]",LINEAR_ASC_DESC:"Linearly increasing, then decreasing function.",ADD_HEATMAP:"Add a new heatmap.",DELETE_HEATMAP:"Delete the heatmap.",EDIT_HEATMAP:"Edit the heatmap.",EXPORT_HEATMAP:"Export the heatmap."},MCA:{NAME:"Multi-Criteria Analysis (MCA)",DESCRIPTION:'<h4>Multi-Criteria Analysis</h4><p  style="text-align: left; margin-left:5px;">MCA, is a method that combines multiple properties of a feature on the map into a new property. It achieves this by:<ol><li>Scaling each property to a range between 0 (no value) and 1 (maximum value).</li><li>Weighing each property relative to the others, where a weight less than 0 indicates you wish to avoid it, 0 is ignored, and a value greater than 0 is prefered.</li></ol> In fact, it is a kind of linear regression.',INFO:"At the moment, no map layers are loaded that contain a multi-criteria analysis. Open another map layer to see it.",INFO_EXPERT:"At the moment, no map layers are loaded that contain a multi-criteria analysis. Open another map layer to use it, or create a new MCA using the wizard.",SHOW_FEATURE_MSG:"Select a feature on the map to see the effects of the Multi-Criteria Analysis (MCA).",TOTAL_RESULT:"Combined result",DELETE_MSG:'Delete "{0}"',DELETE_MSG2:"Are you sure?",HAS_CATEGORY:"  Has category? ",HAS_RANK:"  Include rank? ",EDITOR_TITLE:"MCA Editor",MAIN_FEATURE:"Select the main feature",PROPERTIES:"Select the properties",INCLUDE_RANK:"  Show rank? ",RANK_TITLE:"[Rank title...]",TITLE:"Title... *",CATEGORY_MSG:"[Category...]",TOGGLE_SPARKLINE:"Show or hide bar charts and scoring function.",SCALE_MIN_TITLE:"[Min. scale]",SCALE_MAX_TITLE:"[Max. scale]",MIN_VALUE:"[Minimum (μ-2σ)]",MAX_VALUE:"[Maximum (μ+2σ)]",MIN_CUTOFF_VALUE:"[Ignore when below this value]",MAX_CUTOFF_VALUE:"[Ignore when above this value]",LINEAR:"Linearly increasing function between min and max.",SIGMOID:"Tangentially increasing function between min and max",GAUSSIAN:"Normal distribution increasing function between min and max.",ADD_MCA:"Add a new MCA.",DELETE_MCA:"Delete the MCA.",EDIT_MCA:"Edit the MCA.",SET_STYLE:"Set style"},PROJECTSETTINGS:{TITLE:"Project Settings",DESCRIPTION:"Settings"},CHOOSE_CATEGORY:"Choose category...",SHOW5:"Show 5 items",SHOW10:"Show 10 items",SHOW15:"Show 15 items",SHOW20:"Show 20 items",SHOW25:"Show 25 items",SHOW30:"Show 30 items",SHOW35:"Show 35 items",SHOW40:"Show 40 items"},e}();e.English=t}(Translations||(Translations={}));var Translations;!function(e){var t=function(){function e(){}return e.locale={CANCEL_BTN:"Annuleren",OK_BTN:"OK",FROM:"van",TO:"tot",NAVIGATE:"Start",REMOVE:"Verwijder",CREATE_SCATTER:"Creeer spreidingsdiagram",EXPAND_ALL:"Alles uitklappen",COLLAPSE_ALL:"Alles inklappen",SELECT_ALL:"Selecteer alles",DESELECT_ALL:"Deselecteer alles",ENABLE_LOCATION_FILTER:"Activeer locatiefilter",SELECT_A_FEATURE:"Selecteer een feature",DISABLE_LOCATION_FILTER:"Deactiveer locatiefilter",SELECT_FEATURE_FOR_WIDGET:"Selecteer een gebied om de widget te tonen.",SELECT_FEATURE_FOR_STYLE:"Selecteer een gebied om de stijl te activeren.",NO_RELATIONS_FOUND:"Geen relaties voor het geselecteerde item gevonden. Ofwel het zoomniveau is te laag, er zijn teveel items zichtbaar of er zijn geen relaties gedefiniëerd.",CHOOSE_DROPDOWN:"Kies...",BASESTYLES:"Basiskaarten",MAP:"Kaarten",MAP_LABEL:"Kaart",TABLE_LABEL:"Tabel",LAYERS:"Kaartlagen",DIRECTORY:"Beschikbare lagen",CREATELAYER:"Nieuwe laag maken",ADDFEATURES:"Objecten toevoegen",ADDTYPE:"Nieuwe type toevoegen",FILTERS:"Filters",FILTER_INFO:'Momenteel zijn er geen filters geselecteerd. Klik op een icoon of gebied op de kaart, en klik op het filter icoontje (<span class="fa fa-filter"></span>) in het rechter menu om een filter toe te voegen. Dan wordt er een filter aangemaakt voor de geselecteerde eigenschap.',STYLES:"Stijlen",STYLE_INFO:'Momenteel zijn er geen stijlen geselecteerd. Klik op een icoon of gebied op de kaart, en klik op het stijl icoontje (<span class="smallStyleIcon"></span>) in het rechter menu om een stijl toe te voegen. Dan wordt er een stijl aangemaakt voor de geselecteerde eigenschap.',FEATURES:"Features",LEGEND:"Legenda",SEARCH:"Zoeken",HIDE_PANEL:"Verberg dit paneel",EDIT_INDICATORS:"Wijzig indicatoren",RELATED_FEATURES:"Toon gerelateerde features",FEATURE_INFO:"Toon informatie over de geselecteerde feature",MAP_FEATURES:"Kaartfeatures",NEARBY_FEATURES:"Dichtbijgelegen features",DASHBOARD_SELECTION:"Dashboardselectie",SETTINGS:"Instellingen",TOGGLE_MENU:"Wissel de zichtbaarheid van het menu",SPEEDS_TAOUFIK:"snelheden legenda Taoufik",SPEEDS_GOOGLEMAPS:"snelheden legenda Google Maps",VERWARMINGSSYSTEEM:"Verwarmingssysteem",PERCENTAGES_V1:"percentages v1",ORANGE_RED:"oranje - rood",WHITE_RED:"wit - rood",RED_WHITE_BLUE:"rood - wit - blauw",
RED_WHITE:"rood - wit",GREEN_RED:"groen - rood",RED_GREEN:"rood - groen",BLUE_RED:"blauw - rood",RED_BLUE:"rood - blauw",WHITE_BLUE:"wit - blauw",BLUE_WHITE:"wit - groen",WHITE_GREEN:"wit - groen",GREEN_WHITE:"groen - wit",WHITE_ORANGE:"wit - oranje",ORANGE_WHITE:"oranje - wit",SAVE:"opslaan",APPLY:"toepassen",DONE:"klaar",CONFIG:"config",EDIT:"aanpassen",EXPERTMODE:{BEGINNER:"Beginner",INTERMEDIATE:"Gevorderd",EXPERT:"Expert",ADMIN:"Admin",EXPLANATION:"Selecteer uw expertise om meer functionaliteit te kunnen gebruiken."},LAYER_SERVICE:{RELOAD_PROJECT_TITLE:"Data wordt opnieuw geladen",RELOAD_PROJECT_MSG:"Na het wisselen van de taal moet de kaartdata opnieuw ingelezen worden. Excuses voor het ongemak."},HEATMAP:{NAME:"Heatmaps",DESCRIPTION:'<h4>Toelichting heatmap</h4><div style="text-align: left; margin-left:5px;"><p>Heatmap laat gebieden op de kaart oplichten die voldoen aan bepaalde criteria.',INFO:"Momenteel zijn er geen kaartlagen geopend die heatmaps bevatten.",INFO_EXPERT:"Momenteel zijn er geen kaartlagen geopend die heatmaps bevatten. Open een kaartlaag en maak een nieuwe heatmap aan met behulp van de wizard.",SHOW_FEATURE_MSG:"Selecteer een feature op de kaart om de heatmap resultaten in detail te bekijken.",TOTAL_RESULT:"Gecombineerd resultaat",DELETE_MSG:'Verwijder "{0}"',DELETE_MSG2:"Weet u het zeker?",EDITOR_TITLE:"Heatmap Editor",MAIN_FEATURE:"Selecteer het type feature",PROPERTIES:"Selecteer de eigenschappen",RESOLUTION:"Resolutie",INTENSITY_SCALE:"Intensiteitsschaal",TITLE:"Titel... *",TITLE_TAG:"Titel",TOGGLE_SPARKLINE:"Toon of verberg de histogram en score functie.",SCALE_MIN_TITLE:"[Schaal max]",SCALE_MAX_TITLE:"[Schaal min]",MIN_MAX_ZOOM:"Min./Max. zoom",AT_LOCATION_VALUE:"[Waarde op locatie]",DISTANCE_MAX_VALUE:"[Ideale afstand]",LOST_INTEREST_VALUE:"[Negeer vanaf afstand]",LINEAR_ASC_DESC:"Linear toenemende, dan afnemende functie.",ADD_HEATMAP:"Maak een nieuwe heatmap.",DELETE_HEATMAP:"Verwijder de heatmap.",EDIT_HEATMAP:"Bewerk de heatmap.",EXPORT_HEATMAP:"Exporteer de heatmap."},MCA:{NAME:"Multi-Criteria Analyse (MCA)",DESCRIPTION:'<h4>Toelichting MCA</h4><div style="text-align: left; margin-left:5px;"><p>Multi-Criteria Analysis (MCA) is een methode die verschillende eigenschappen van een locatie of gebied op de kaart combineerd tot een nieuwe eigenschap. Dit gaat als volgt: <ol><li>Schaal iedere eigenschap tussen 0 (geen waarde) en 1 (maximum waarde).</li><li>Weeg iedere eigenschap relatief t.o.v. de andere gekozen eigenschappen, waar een gewicht onder 0 betekent dat je de eigenschap wil vermijden, 0 wordt genegeerd, en een waarde groter dan 0 betekent dat je dit wil bereiken.</li></ol>Met andere woorden, het is een vorm van lineare regressie.</p></div>',INFO:"Momenteel zijn er geen kaartlagen geopend die multi-criteria analyses bevatten. Open hiervoor een andere kaartlaag.",INFO_EXPERT:"Momenteel zijn er geen kaartlagen geopend die multi-criteria analyses bevatten. Open een kaartlaag en maak een nieuwe MCA aan met behulp van de wizard.",SHOW_FEATURE_MSG:"Selecteer een feature op de kaart om de Multi-Criteria Analyse (MCA) resultaten in detail te bekijken.",TOTAL_RESULT:"Gecombineerd resultaat",DELETE_MSG:'Verwijder "{0}"',DELETE_MSG2:"Weet u het zeker?",HAS_CATEGORY:"  Specificeer categorie? ",EDITOR_TITLE:"MCA Editor",MAIN_FEATURE:"Selecteer het type feature",PROPERTIES:"Selecteer de eigenschappen",INCLUDE_RANK:"  Toon een rangorde? ",RANK_TITLE:"[Titel voor de rangorde]",TITLE:"Titel... *",CATEGORY_MSG:"[Categorie...]",TOGGLE_SPARKLINE:"Toon of verberg de histogram en score functie.",SCALE_MIN_TITLE:"[Schaal max]",SCALE_MAX_TITLE:"[Schaal min]",MIN_VALUE:"[Ondergrens (μ-2σ)]",MAX_VALUE:"[Bovengrens (μ+2σ)]",MIN_CUTOFF_VALUE:"[Niet meewegen onder]",MAX_CUTOFF_VALUE:"[Niet meewegen boven]",LINEAR:"Linear toenemende functie tussen onder- en bovengrens.",SIGMOID:"Tangentieel toenemende functie tussen onder- en bovengrens.",GAUSSIAN:"Normale verdeling tussen onder- en bovengrens.",ADD_MCA:"Maak een nieuwe MCA.",DELETE_MCA:"Verwijder de MCA.",EDIT_MCA:"Bewerk de MCA.",SET_STYLE:"Activeer stijl"},PROJECTSETTINGS:{TITLE:"Project instellingen",DESCRIPTION:"Instellingen"},CHOOSE_CATEGORY:"Kies categorie...",SHOW5:"Toon 5 regels",SHOW10:"Toon 10 regels",SHOW15:"Toon 15 regels",SHOW20:"Toon 20 regels",SHOW25:"Toon 25 regels",SHOW30:"Toon 30 regels",SHOW35:"Toon 35 regels",SHOW40:"Toon 40 regels"},e}();e.Dutch=t}(Translations||(Translations={}));var Accessibility;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("accessibility",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Accessibility/Accessibility.tpl.html",replace:!0,transclude:!0,controller:e.AccessibilityCtrl}}])}(Accessibility||(Accessibility={}));var Accessibility;!function(e){var t=function(){function e(){this.id="accessibilityActions"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){console.log("accessibility:feature selected")},e.prototype.getFeatureActions=function(e){var t={title:"Show accessibility"};t.callback=this.showAccessibility;var r={title:"Remove accessibility"};r.callback=this.removeAccessibility;var i={title:"Plan route from"};i.callback=this.planRouteFrom;var a={title:"Plan route to"};return a.callback=this.planRouteTo,[t,r,i,a]},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.showAccessibility=function(e,t){console.log("accessibility:showAccessibility");var r=t.findLayer("accessibility");if(r){var i=r.url.split("&"),a=-1;if(i.some(function(e,t){return"fromPlace"===e.substring(0,9)?(a=t,!0):!1}),"Point"!==e.geometry.type)return void console.log("Can only create accessibility layer from a Point");if(i[a]="fromPlace="+e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0],r.url=i.join("&"),r.enabled)r.layerSource&&r.layerSource.refreshLayer(r);else{t.addLayer(r);var o=csComp.Helpers.createRightPanelTab("rightpanel","accessibility",r,"Accessibility options");t.$messageBusService.publish("rightpanel","activate",o)}}},e.prototype.removeAccessibility=function(e,t){console.log("accessibility:removeAccessibility");var r=t.findLayer("accessibility");if(r){var i=t.visual.rightPanelVisible;r.enabled&&t.removeLayer(r),delete r.data,t.visual.rightPanelVisible=i}},e.planRoute=function(e,t,r){var i=t.findLayer("tripplanner");if(i){var a=csComp.Helpers.parseUrlParameters(i.url,"?","&","=");a[r]=e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0],i.url=csComp.Helpers.joinUrlParameters(a,"?","&","="),i.enabled?i.layerSource&&i.layerSource.refreshLayer(i):t.addLayer(i);var o=csComp.Helpers.createRightPanelTab("rightpanel","tripplanner",i,"Route planner");t.$messageBusService.publish("rightpanel","activate",o)}},e.prototype.planRouteFrom=function(t,r){console.log("accessibility:planRouteFrom"),e.planRoute(t,r,"fromPlace")},e.prototype.planRouteTo=function(t,r){console.log("accessibility:planRouteTo"),e.planRoute(t,r,"toPlace")},e.prototype.init=function(e){var t=this;console.log("init AccessibilityActionService"),this.layerService=e,this.layerService.$messageBusService.serverSubscribe("accessibility","msg",function(e,r){"restart"===r.data&&(t.layerService.$messageBusService.notify("restarting server","restarting",csComp.Services.NotifyLocation.TopRight),location.reload())})},e}();e.AccessibilityModel=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.urlKeys=["arriveBy","fromPlace","date","time","mode","walkSpeed","bikeSpeed","precisionMeters","cutoffSec"],this.scope=e,e.vm=this,this.layer=e.$parent.data,this.cutoffTimes=[],this.urlParameters={},this.bikeSpeedKm,this.walkSpeedKm,this.urlKeys.forEach(function(e){s.urlParameters[e]=0}),this.transportModes={},this.transportModes.Walking="WALK",this.transportModes.Biking="BICYCLE"}return e.prototype.refreshAccessibility=function(){if(this.$layerService.lastSelectedFeature){var e=this.$layerService.lastSelectedFeature;e.geometry&&"Point"===e.geometry.type&&(this.urlParameters.fromPlace=e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0])}this.urlParameters.mode=this.transportMode,this.urlParameters.time=encodeURIComponent(this.time),this.walkSpeedKm&&(this.urlParameters.walkSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.walkSpeedKm)),this.bikeSpeedKm&&(this.urlParameters.bikeSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.bikeSpeedKm));var t=this.urlAddress+"?";for(var r in this.urlParameters)this.urlParameters.hasOwnProperty(r)&&"cutoffSec"!==r&&(t=t+r+"="+this.urlParameters[r]+"&");this.cutoffTimes.forEach(function(e){t=t+"&cutoffSec="+60*e}),console.log(t),this.layer.url=t,this.layer.enabled?this.layer.layerSource&&this.layer.layerSource.refreshLayer(this.layer):this.$layerService.addLayer(this.layer),this.$layerService.visual.rightPanelVisible=!0},e.prototype.parseUrl=function(){var e=this;this.urlParameters={},this.urlAddress=this.layer.url.split("?")[0];var t=this.layer.url.split("?")[1],r=t.split("&");r.forEach(function(t){var r=t.split("=");"cutoffSec"===r[0]&&e.cutoffTimes.push(+r[1]/60),e.urlParameters[r[0]]=isNaN(+r[1])?r[1]:+r[1]});var i=new Date(Date.now());this.time=("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),this.urlParameters.date=i.getMonth()+1+"-"+i.getDate()+"-"+i.getFullYear(),this.transportMode=this.urlParameters.mode,this.urlParameters.hasOwnProperty("walkSpeed")&&(this.walkSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.walkSpeed).toFixed(2)),this.urlParameters.hasOwnProperty("bikeSpeed")&&(this.bikeSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.bikeSpeed).toFixed(2)),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.addCutoffTime=function(){this.cutoffTimes.push(0),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.removeCutoffTime=function(e){e<this.cutoffTimes.length&&e>-1&&this.cutoffTimes.splice(e,1),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.AccessibilityCtrl=r}(Accessibility||(Accessibility={}));var BaseMapList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("baseMapList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/BaseMapList/BaseMapList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.BaseMapListCtrl}}])}(BaseMapList||(BaseMapList={}));var BaseMapList;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$layerService=t,this.$mapService=r,this.$messageBusService=i,e.vm=this}return e.prototype.selectBaseLayer=function(e){var t=this.$layerService.$mapService.getBaselayer(e);this.$layerService.activeMapRenderer.changeBaseLayer(t),this.$layerService.$mapService.changeBaseLayer(e)},e.$inject=["$scope","layerService","mapService","messageBusService"],e}();e.BaseMapListCtrl=t}(BaseMapList||(BaseMapList={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("barChart",["$filter",function(e){return{terminal:!0,restrict:"EA",scope:{data:"=",update:"="},link:function(e,t,r){var i=d3.select(t[0]);i.append("div").attr("class","chart").selectAll("div").data(e.data).enter().append("div").transition().ease("elastic").style("width",function(e){return e+"%"}).text(function(e){return e+"%"})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("bulletChart",["$filter",function(e){function t(e,t){if(e.data){var r=d3.bullet().width(e.width).height(e.height);$(t[0]).empty();var i=d3.select(t[0]),a=[];e.data&&(a=JSON.parse(e.data));var o=i.append("div").attr("class","chart").selectAll("div").data(a).enter().append("svg").attr("class","bullet").attr("width",e.width+15).attr("height",+e.height+40).append("g").attr("transform","translate(7,20)").call(r,!1),s=o.append("g").style("text-anchor","begin").attr("transform","translate(0,-5)");s.append("text").attr("class","title").text(function(e){return e.title}),s.append("text").attr("class","subtitle").attr("dy","1em").text(function(e){return e.subtitle})}}return{terminal:!0,restrict:"EA",scope:{data:"=",update:"=",width:"=",height:"@",margin:"@"},link:function(e,r,i){t(e,r),e.$watch("data",function(){t(e,r)}),e.$watch("update",function(){t(e,r)})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t=function(){function e(){}return e.max=function(e){for(var t=e[0],r=0,i=1;i<e.length;i++)e[i]>t&&(r=i,t=e[i]);return{maxIndex:r,max:t}},e.min=function(e){for(var t=e[0],r=0,i=1;i<e.length;i++)e[i]<t&&(r=i,t=e[i]);return{minIndex:r,min:t}},e.timestampToString=function(e){var t=new Date(e),r=String.format("{0}-{1:00}-{2:00}",t.getFullYear(),t.getUTCMonth()+1,t.getUTCDate());return r},e.windowResize=function(e){if(void 0!==e){var t=window.onresize;window.onresize=function(r){"function"==typeof t&&t(r),e(r)}}},e.initializeMargin=function(e,t){var r=e.$eval(t.margin)||{left:50,top:50,bottom:50,right:50};"object"!=typeof r&&(r={left:r,top:r,bottom:r,right:r}),e.margin=r},e.getD3Selector=function(e,t){if(e.id)return"#"+e.id;var r;return e["data-chartid"]?r=e["data-chartid"]:(r="chartid"+Math.floor(1000000001*Math.random()),angular.element(t).attr("data-chartid",r)),"[data-chartid="+r+"]"},e.initializeLegendMargin=function(e,t){var r=e.$eval(t.legendmargin)||{left:0,top:5,bottom:5,right:0};"object"!=typeof r&&(r={left:r,top:r,bottom:r,right:r}),e.legendmargin=r},e.defaultColor=function(){var e=d3.scale.category20().range();return function(t,r){return t.color||e[r%e.length]}},e.configureLegend=function(t,r,i){t.legend&&i.showlegend&&"true"===i.showlegend&&(e.initializeLegendMargin(r,i),t.legend.margin(r.legendmargin),t.legend.width(void 0===i.legendwidth?400:+i.legendwidth),t.legend.height(void 0===i.legendheight?20:+i.legendheight),t.legend.key(void 0===i.legendkey?function(e){return e.key}:r.legendkey()),t.legend.color(void 0===i.legendcolor?e.defaultColor():r.legendcolor()),t.legend.align(void 0===i.legendalign?!0:"true"===i.legendalign),t.legend.rightAlign(void 0===i.legendrightalign?!0:"true"===i.legendrightalign),t.legend.updateState(void 0===i.legendupdatestate?!0:"true"===i.legendupdatestate),t.legend.radioButtonMode(void 0===i.legendradiobuttonmode?!1:"true"===i.legendradiobuttonmode))},e.checkElementID=function(t,r,i,a,o){e.configureLegend(a,t,r);var s=e.getD3Selector(r,i);angular.isArray(o)&&0===o.length&&d3.select(s+" svg").remove(),d3.select(s+" svg").empty()&&d3.select(s).append("svg"),d3.select(s+" svg").attr("viewBox","0 0 "+t.width+" "+t.height).datum(o).transition().duration(void 0===r.transitionduration?250:+r.transitionduration).call(a)},e.updateDimensions=function(t,r,i,a){if(a){a.width(t.width).height(t.height);var o=e.getD3Selector(r,i);d3.select(o+" svg").attr("viewBox","0 0 "+t.width+" "+t.height),e.windowResize(a),t.chart.update()}},e}();e.ChartHelpers=t}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("circularChart",[function(){return{terminal:!0,restrict:"EA",scope:{value:"=",max:"=",title:"=",update:"=",valueString:"=",color:"=",valueClass:"@",titleClass:"@",animationDuration:"@",width:"@",height:"@",margin:"@"},link:function(e,t,r){var i=function(){if(null!=e.value&&null!=e.max){var r=(e.margin||{top:15,right:5,bottom:0,left:10},e.width||100),i=e.height||70,a=e.color||"purple",o=e.animationDuration||0;$(t[0]).empty();var s={hddrives:[e.value,e.max-e.value]},r=e.width,i=e.height,n=Math.min(r,i)/2,l=d3.scale.ordinal().range([a,"lightgray"]),c=d3.layout.pie().sort(null),p=d3.svg.arc().innerRadius(n-100).outerRadius(n-80),u=d3.select(t[0]).append("svg").attr("width",r).attr("height",i).append("g").attr("transform","translate("+r/3+","+i/3+")");u.selectAll("path").data(c(s.hddrives)).enter().append("path").attr("class","arc").attr("fill",function(e,t){return l(t)}).transition().delay(function(e,t){return t*o}).duration(o).attrTween("d",function(e){var t=d3.interpolate(e.startAngle+.1,e.endAngle);return function(r){return e.endAngle=t(r),p(e)}});u.append("text").attr("dy","-0.25em").style("text-anchor","middle").attr("class",e.valueClass).text(function(t){return e.valueString}),u.append("text").attr("dy","1em").style("text-anchor","middle").attr("class",e.titleClass).text(function(t){return e.title})}};i(),e.$watch("value",function(){i()}),e.$watch("color",function(){i()}),e.$watch("update",function(){i()})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("singlevalueChart",["$filter",function(e){return{terminal:!0,restrict:"EA",scope:{data:"="},link:function(e,t,r){var i=d3.select(t[0]);i.append("div").attr("class","chart").selectAll("div").data(e.value).enter().append("div").transition().ease("elastic").style("width",function(e){return e+"%"}).text(function(e){return e+"%"})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("sparklineChart",["$filter",function(t){return{terminal:!0,restrict:"EA",scope:{timestamps:"=",sensor:"=",property:"=",update:"=",focusTime:"=",showaxis:"=",closed:"=",width:"@",height:"@",margin:"@"},link:function(t,r,i){var a=function(){if(null!=t.timestamps&&null!=t.sensor&&t.timestamps.length>0){var i=t.margin||{top:15,right:5,bottom:0,left:10},a=t.width||100,o=t.height||70;console.log("heigth:"+o);var s="undefined"!=typeof t.showaxis&&t.showaxis,n="undefined"!=typeof t.closed&&t.closed,l=12;$(r[0]).empty();for(var c=d3.select(r[0]).append("svg:svg").attr("width",a).attr("height",o),p=s?{top:0,right:0,bottom:20,left:10}:{top:0,right:0,bottom:0,left:0},u=d3.scale.linear().range([i.left+p.left,a-i.left-i.right-p.left-p.right]),h=d3.scale.linear().range([o-i.bottom-p.bottom,i.top+p.top+l]),d=d3.bisector(function(e){return e.time}).left,f=d3.svg.line().interpolate(n?"linear-closed":"cardinal").x(function(e){return u(e.time)}).y(function(e){return h(e.measurement)}),y=[],m=0;m<t.timestamps.length;m++){var g=t.property?t.property:"value",v=$.isArray(t.sensor[m])?t.sensor[m][g]:t.sensor[m];y.push({time:t.timestamps[m],measurement:v})}u.domain(d3.extent(y,function(e){return e.time})),h.domain(d3.extent(y,function(e){return e.measurement}));var S=[];n&&y.length>0&&S.push({time:y[0].time,measurement:0}),y.forEach(function(e){return S.push(e)}),n&&y.length>0&&S.push({time:y[y.length-1].time,measurement:0});var b=c.append("svg:path").attr("d",f(S)).attr("class","sparkline-path").style("fill",n?"steelblue":"none"),w=y.map(function(e){return e.measurement}),T=e.ChartHelpers.min(w),L=e.ChartHelpers.max(w);if(c.append("circle").attr("class","sparkcircle-max").attr("cx",u(y[L.maxIndex].time)).attr("cy",h(L.max)).attr("r",4),c.append("circle").attr("class","sparkcircle-min").attr("cx",u(y[T.minIndex].time)).attr("cy",h(T.min)).attr("r",4),s){var E=6,C=d3.min(u.range()),M=C-E,F=d3.max(u.range()),P=d3.max(h.range()),x=d3.min(h.range()),O=P+E;c.append("line").attr("x1",M).attr("y1",x).attr("x2",C).attr("y2",x).attr("stroke","black"),c.append("text").attr("x",M-2).attr("y",x).attr("dy",".35em").style("text-anchor","end").text(),c.append("line").attr("x1",M).attr("y1",P).attr("x2",C).attr("y2",P).attr("stroke","black"),c.append("text").attr("x",M-2).attr("y",P).attr("dy",".35em").style("text-anchor","end").text(d3.min(h.domain())),c.append("line").attr("x1",C).attr("y1",O).attr("x2",C).attr("y2",P).attr("stroke","black"),c.append("text").attr("x",C).attr("y",O+9).attr("dy",".35em").style("text-anchor","start").text(e.ChartHelpers.timestampToString(d3.min(u.domain()))),c.append("line").attr("x1",F).attr("y1",O).attr("x2",F).attr("y2",P).attr("stroke","black"),c.append("text").attr("x",F).attr("y",O+9).attr("dy",".35em").style("text-anchor","end").text(e.ChartHelpers.timestampToString(d3.max(u.domain())))}var D=c.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0).attr("opacity",0).attr("stroke","black"),k=c.append("text").attr("x",0).attr("y",0).attr("dy",".35em").attr("opacity",0).style("text-anchor","end").text(""),A=c.append("text").attr("x",0).attr("y",0).attr("dy",".35em").attr("opacity",0).text(""),I=b.node(),R=I.getTotalLength();c.on("mouseout",function(){D.attr("opacity",0),k.attr("opacity",0),A.attr("opacity",0)}).on("mousemove",function(){for(var t,i=r[0].getBoundingClientRect().left,a=d3.event.clientX-i,o=a,s=R;;){t=Math.floor((o+s)/2);var n=I.getPointAtLength(t);if((t===s||t===o)&&n.x!==a)break;if(n.x>a)s=t;else{if(!(n.x<a))break;o=t}}var l=u.invert(d3.mouse(this)[0]),c=d(y,l,1);if(c>0&&c<y.length)var p=y[c-1],f=y[c],m=l-p.time>f.time-l?f:p;else m=0>=c?y[0]:y[y.length-1];a=u(m.time),D.attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",d3.max(h.range())+(E||0)).attr("opacity",1),k.attr("x",a-6).attr("y",4).attr("dy",".35em").attr("opacity",1).text(m===y[0]?"":e.ChartHelpers.timestampToString(m.time)),A.attr("x",a+6).attr("y",4).attr("dy",".35em").attr("opacity",1).text(m.measurement)})}};a(),t.$watchCollection("sensor",function(){a()}),t.$watch("update",function(){a()})}}}])}(Charts||(Charts={}));var Directives;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("clock",["dateFilter",function(e){return{restrict:"E",scope:{time:"@",format:"@"},link:function(t,r,i){function a(){r.html(e(t.time,t.format))}t.$watch("time",function(e){a()})}}}])}(t=e.Clock||(e.Clock={}))}(Directives||(Directives={}));var Helpers;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("contextMenu",function(e){var t=function(e,t,r){if(!i)var i=angular.element;i(t.currentTarget).addClass("context");var a=i("<div>");a.addClass("dropdown clearfix");var o=i("<ul>");o.addClass("dropdown-menu"),o.attr({role:"menu"}),o.css({display:"block",position:"absolute",left:t.pageX+"px",top:t.pageY+"px"}),angular.forEach(r,function(r,s){var n=i("<li>");if(null===r)n.addClass("divider");else{var l=i("<a>");l.attr({tabindex:"-1",href:"#"}),l.text("string"==typeof r[0]?r[0]:r[0].call(e,e)),n.append(l),n.on("click",function(o){o.preventDefault(),e.$apply(function(){i(t.currentTarget).removeClass("context"),a.remove(),r[1].call(e,e)})})}o.append(n)}),a.append(o);var s=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight);a.css({width:"100%",height:s+"px",position:"absolute",top:0,left:0,zIndex:9999}),i(document).find("body").append(a),a.on("mousedown",function(e){i(e.target).hasClass("dropdown")&&(i(t.currentTarget).removeClass("context"),a.remove())}).on("contextmenu",function(e){i(e.currentTarget).removeClass("context"),e.preventDefault(),a.remove()})};return function(e,r,i){r.on("contextmenu",function(r){e.$apply(function(){r.preventDefault();var a=e.$eval(i.contextMenu);if(!(a instanceof Array))throw'"'+i.contextMenu+'" not an array';t(e,r,a)})})}})}(t=e.ContextMenu||(e.ContextMenu={}))}(Helpers||(Helpers={}));var DataTable;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("datatable",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DataTable/DataTable.tpl.html",replace:!0,transclude:!0,controller:e.DataTableCtrl}}])}(DataTable||(DataTable={}));var DataTable;!function(e){var t=function(){function e(e,t,r,i){this.displayValue=e,this.originalValue=t,this.type=r,this.header=i}return e}();e.TableField=t;var r=function(){function e(e,t,r,i,a,o,s,n){var l=this;this.$scope=e,this.$http=t,this.$sce=r,this.$translate=i,this.$timeout=a,this.$layerService=o,this.$localStorageService=s,this.$messageBusService=n,this.mapLabel="map",this.numberOfItems=10,this.layerOptions=[],this.propertyTypes=[],this.headers=[],this.rows=[],e.vm=this,this.layerOptions&&this.layerOptions.length>0&&i("MAP_FEATURES").then(function(e){l.layerOptions[0].title=e}),this.bindToStorage("vm.numberOfItems",10),this.numberOfItems=s.get("vm.numberOfItems"),this.bindToStorage("vm.selectedLayerId",this.mapLabel),null!=this.$layerService.project&&null!=this.$layerService.project.groups&&(this.updateLayerOptions(),this.loadLayer(),this.selectAllBool=!1,i("SELECT_ALL").then(function(e){l.selectAllText=e}),n.publish("timeline","isEnabled","false"))}return e.prototype.bindToStorage=function(e,t){null===this.$localStorageService.get(e)&&this.$localStorageService.set(e,t),this.$localStorageService.bind(this.$scope,e)},e.prototype.updateLayerOptions=function(){var e=this,t={group:"",id:this.mapLabel,title:""};if(this.layerOptions.push(t),this.$translate("CHOOSE_CATEGORY").then(function(e){t.title=e}),null!=this.$layerService.project&&null!=this.$layerService.project.groups){this.$layerService.project.groups.forEach(function(t){t.layers.forEach(function(r){e.layerOptions.push({group:t.title,id:r.id,title:r.title})})});for(var r in this.$layerService.loadedLayers){if(null==this.selectedLayerId)return;var i=this.$layerService.loadedLayers[r];i.enabled&&(this.selectedLayerId=i.id)}}},e.prototype.loadLayer=function(){var e=this;if(!this.selectedLayerId||this.selectedLayerId===this.mapLabel)return this.loadMapLayers();var t=this.findLayerById(this.selectedLayerId);return null==t?this.loadMapLayers():void async.series([function(r){null!=t.typeUrl?e.$layerService.loadTypeResources(t.typeUrl,!0,function(){r()}):r()},function(r){e.$http.get(t.url).success(function(i){e.dataset=i,null==i.featureTypes&&(i.featureTypes={}),i.features&&(i.features.forEach(function(r){r.properties.hasOwnProperty("FeatureTypeId")?r.featureTypeName=r.properties.FeatureTypeId:i.featureTypes.hasOwnProperty("Default")?r.featureTypeName="Default":null!=t.defaultFeatureType&&""!=t.defaultFeatureType&&(r.featureTypeName=t.defaultFeatureType),r.featureTypeName in i.featureTypes||(i.featureTypes[r.featureTypeName]=e.$layerService.getFeatureType(r))}),e.updatepropertyType(i)),r()}).error(function(i,a,o,s){e.$messageBusService.notify("ERROR opening "+t.title,"Could not get the data."),r()})}])},e.prototype.loadMapLayers=function(){var e=this;this.selectedLayerId=this.mapLabel;var t={type:"",features:[],featureTypes:{}};this.$layerService.project.groups.forEach(function(e){null!=e.filterResult&&e.filterResult.forEach(function(e){return t.features.push(e)})}),0===t.features.length&&(t.features=this.$layerService.project.features),t.features.forEach(function(r){r.featureTypeName in t.featureTypes||(t.featureTypes[r.featureTypeName]=e.$layerService.getFeatureType(r))}),this.dataset=t,this.updatepropertyType(t)},e.prototype.updatepropertyType=function(e){var t=this;this.propertyTypes=[],this.headers=[],this.rows=[];var r,i=[],a=[];for(var o in e.featureTypes){if(r=e.featureTypes[o],null!=r.propertyTypeData&&r.propertyTypeData.forEach(function(e){r.style.nameLabel==e.label?a.splice(0,0,e):a.push(e)}),null!=r.propertyTypeKeys){var s=r.propertyTypeKeys.split(";");s.forEach(function(e){var i=null;if(e in t.$layerService.propertyTypeData)i=t.$layerService.propertyTypeData[e];else if(null!=r.propertyTypeData){var o=$.grep(r.propertyTypeData,function(t){return t.label===e});o.length>=1&&(i=o[0])}null!=i&&(r.style.nameLabel==i.label?a.splice(0,0,i):a.push(i))})}else null!=r.propertyTypeData&&r.propertyTypeData.forEach(function(e){r.style.nameLabel==e.label?a.splice(0,0,e):a.push(e)});a.forEach(function(e){(e.visibleInCallOut||"Name"===e.label)&&i.indexOf(e.title)<0&&(i.push(e.title),t.propertyTypes.push(e))})}this.propertyTypes.push(csComp.Helpers.GeoExtensions.createPropertyType("Lat")),this.propertyTypes.push(csComp.Helpers.GeoExtensions.createPropertyType("Lon"));for(var n=3,l=0;n>l;l++)this.headers.push(i[l]);this.rows=this.getRows()},e.prototype.toggleSelection=function(e){var t=this.headers.indexOf(e);t>-1?this.headers.splice(t,1):this.headers.push(e),this.rows=this.getRows()},e.prototype.findLayerById=function(e){for(var t=0;t<this.$layerService.project.groups.length;t++)for(var r=this.$layerService.project.groups[t],i=0;i<r.layers.length;i++){var a=r.layers[i];if(a.id==e)return a}return null},e.prototype.getRows=function(){var e=this,r=[this.headers.length];this.propertyTypes.forEach(function(t){var i=e.headers.indexOf(t.title);i>=0&&(r[i]=t)});var i,a=[];return this.dataset&&this.dataset.features&&this.dataset.features.forEach(function(e){var o=[];r.forEach(function(r){if("Lat"===r.label)i="Point"===e.geometry.type?e.geometry.coordinates[1]:"",a=i;else if("Lon"===r.label)i="Point"===e.geometry.type?e.geometry.coordinates[0]:"",a=i;else{var a=e.properties[r.label];i=csComp.Helpers.convertPropertyInfo(r,a)}o.push(new t(i,a,r.type,r.title))}),a.push(o)}),a},e.prototype.sortOrderClass=function(e,t){var r;return r=null!=t&&e==this.sortingColumn?"fa fa-sort-"+(t?"desc":"asc"):"fa fa-sort"},e.prototype.orderBy=function(e,t){this.sortingColumn=e,this.rows=this.rows.sort(function(r,i){var a;return a="number"==r[e].type?r[e].originalValue>i[e].originalValue:r[e].originalValue.toLowerCase()>i[e].originalValue.toLowerCase(),a==t?1:-1})},e.prototype.downloadGeoJson=function(){var e=this,t='{"type": "FeatureCollection","featureTypes": '+JSON.stringify(this.dataset.featureTypes,function(e,t){return"$$hashKey"===e?void 0:t});t+=', "features": [',this.dataset.features.forEach(function(e){var r=new csComp.Services.Feature;r.type=e.type,r.properties=e.properties,r.geometry=e.geometry,t+=JSON.stringify(r)+","}),t=t.substring(0,t.length-1)+"]}";var r=this.mapLabel;if(this.selectedLayerId!==this.mapLabel){var i=this.findLayerById(this.selectedLayerId);i&&(r=i.title.replace(" ","_"))}this.$timeout(function(){e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(t,r,"json")},0)},e.prototype.downloadCsv=function(){var e=this,t=[];t.push(this.headers.join(";"));for(var r=0;r<this.rows.length;r++)t.push(this.rows[r].map(function(e){return e.originalValue}).join(";"));var i=t.join("\r\n"),a=this.mapLabel;if(this.selectedLayerId!==this.mapLabel){var o=this.findLayerById(this.selectedLayerId);o&&(a=o.title.replace(" ","_"))}this.$timeout(function(){e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(i,a,"csv")},0)},e.prototype.selectAll=function(){var e=this;this.selectAllBool?(this.$translate("SELECT_ALL").then(function(t){e.selectAllText=t}),this.propertyTypes.forEach(function(t){var r=e.headers.indexOf(t.title);r>-1&&e.headers.splice(r,1)}),this.rows=this.getRows()):(this.$translate("DESELECT_ALL").then(function(t){e.selectAllText=t}),this.propertyTypes.forEach(function(t){e.headers.indexOf(t.title)<=-1&&e.headers.push(t.title)}),this.rows=this.getRows()),this.selectAllBool=!this.selectAllBool},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.$inject=["$scope","$http","$sce","$translate","$timeout","layerService","localStorageService","messageBusService"],
e}();e.DataTableCtrl=r}(DataTable||(DataTable={}));var ExpertMode;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("expertMode",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/ExpertMode/ExpertMode.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.ExpertModeCtrl}}])}(ExpertMode||(ExpertMode={}));var ExpertMode;!function(e){var t=csComp.Services.Expertise,r=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$localStorageService=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,e.vm=this,e.expertMode=i.expertMode,a.subscribe("expertMode",function(t,r){"newExpertise"===t&&(e.expertMode=r)}),e.$watch("expertMode",function(){o.setExpertMode(e.expertMode)})}return e.prototype.getCssClass=function(){switch(this.$mapService.expertMode){case t.Beginner:return"beginnerUserIcon";case t.Intermediate:return"intermediateUserIcon";case t.Expert:return"expertUserIcon";case t.Admin:return"adminExpertUserIcon"}},e.prototype.setExpertMode=function(e){this.$messageBus.publish("expertMode","newExpertise",e)},e.$inject=["$scope","localStorageService","layerService","mapService","messageBusService"],e}();e.ExpertModeCtrl=r}(ExpertMode||(ExpertMode={}));var FeatureList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/FeatureList/FeatureList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.FeatureListCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(FeatureList||(FeatureList={}));var FeatureList;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$layerService=t,this.$mapService=r,e.vm=this,e.numberOfItems=10}return e.$inject=["$scope","layerService","mapService"],e}();e.FeatureListCtrl=t}(FeatureList||(FeatureList={}));var FeatureProps;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureprops",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FeatureProps/FeatureProps.tpl.html",replace:!0,transclude:!0,controller:e.FeaturePropsCtrl}}])}(FeatureProps||(FeatureProps={}));var FeatureProps;!function(e){var t=(function(){function e(e){this.position=e,this.closeButton=!0,this.autoPan=!0}return e}(),function(){function e(e,t,r,i,a,o,s,n,l,c,p,u){this.key=e,this.value=t,this.property=r,this.canFilter=i,this.canStyle=a,this.feature=o,this.isFilter=s,this.isSensor=n,this.description=l,this.propertyType=c,this.timestamps=p,this.sensor=u,this.cors={}}return e}());e.CallOutProperty=t;var r=function(){function e(e){this.propertyTypes={},this.properties=[],this.sectionIcon=e}return e.prototype.showSectionIcon=function(){return!csComp.StringExt.isNullOrEmpty(this.sectionIcon)},e.prototype.addProperty=function(e,r,i,a,o,s,n,l,c){var p=s.sensors&&s.sensors.hasOwnProperty(i);p?this.properties.push(new t(e,r,i,a,o,s,n,p,l?l:null,c,s.timestamps,s.sensors[i])):this.properties.push(new t(e,r,i,a,o,s,n,p,l?l:null,c))},e.prototype.hasProperties=function(){return null!=this.properties&&this.properties.length>0},e}();e.CallOutSection=r;var i=function(){function e(e,t,i,a,o){this.type=e,this.feature=t,this.propertyTypeData=i,this.layerservice=a,this.mapservice=o,this.sections={},this.sectionKeys=[],this.hasInfoSection=!1,this.setTitle(),this.setIcon(t);var s,n=new r("fa-info"),l=new r("fa-filter"),c=new r("fa-link");if(null!=e){var p=csComp.Helpers.getPropertyTypes(e,i);if(0===p.length)for(var u in a.propertyTypeData)p.push(a.propertyTypeData[u]);e.showAllProperties||this.mapservice.isAdminExpert;for(var h in t.properties){var d=a.getPropertyType(t,h);if(d){var f=this.getOrCreateCallOutSection(d.section)||n;if(f.propertyTypes.hasOwnProperty(d.label))return;f.propertyTypes[d.label]=d;var y=t.properties[d.label];if("hierarchy"===d.type){var m=this.calculateHierarchyValue(d,t,i,a);y=m+";"+t.properties[d.calculation]}if(s=csComp.Helpers.convertPropertyInfo(d,y),!d.canEdit&&csComp.StringExt.isNullOrEmpty(s))return;var g="number"===d.type||"text"===d.type||"options"===d.type||"date"===d.type||"boolean"===d.type,v="number"===d.type||"options"===d.type||"color"===d.type;null!=d.filterType&&(g="none"!=d.filterType.toLowerCase()),d.visibleInCallOut&&f.addProperty(d.title,s,d.label,g,v,t,!1,d.description,d),"hierarchy"===d.type&&c.addProperty(d.title,s,d.label,g,v,t,!1,d.description,d),l.addProperty(d.title,s,d.label,g,v,t,!1,d.description)}}}n.properties.length>0?(this.hasInfoSection=!0,this.sections["Aaa Info"]=n,this.sectionKeys.push("Aaa Info")):this.hasInfoSection=!1,c.properties.length>0&&(this.sections.hierarchy=c,this.sectionKeys.push("hierarchy")),this.sectionKeys=this.sectionKeys.sort()}return e.prototype.calculateHierarchyValue=function(e,t,r,i){var a=[],o=-1,s=csComp.Helpers.getPropertyTypes(t.fType,r);for(var n in s){var l=s[n];"relation"===l.type&&e.targetrelation===l.label&&(a[l.label]=l.count,"count"===e.calculation&&(o=l.count))}if("ratio"===e.calculation){var c=t.properties[e.subject];i.project.features.forEach(function(t){t.properties.hasOwnProperty(e.target)&&t.properties[e.target]===c&&t.properties.hasOwnProperty(e.targetproperty)&&(o=+t.properties[e.targetproperty]/a[e.targetrelation])})}return o},e.prototype.sectionCount=function(){return this.sectionKeys.length},e.prototype.firstSection=function(){var e=this.sections[this.sectionKeys[0]];return e},e.prototype.lastSection=function(){var e=this.sections[this.sectionKeys[this.sectionKeys.length-1]];return e},e.prototype.getOrCreateCallOutSection=function(e){return e?e in this.sections?this.sections[e]:(this.sections[e]=new r,this.sectionKeys.push(e),this.sections[e]):null},e.prototype.setTitle=function(){this.title=csComp.Helpers.featureTitle(this.type,this.feature)},e.prototype.setIcon=function(e){this.icon=null==this.type||null==this.type.style||!this.type.style.hasOwnProperty("iconUri")||this.type.style.iconUri.toLowerCase().indexOf("_media")>=0?"":this.type.style.iconUri.indexOf("{")>=0?csComp.Helpers.convertStringFormat(e,this.type.style.iconUri):this.type.style.iconUri},e}();e.CallOut=i;var a=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$location=t,this.$sce=r,this.$mapService=i,this.$layerService=a,this.$messageBusService=o,this.$translate=s,this.stats=[],this.updateAllStatsDelay=_.debounce(this.updateAllStats,500),this.updateStatsDelay=function(e){_.debounce(n.getPropStats,500,!0)},this.sidebarMessageReceived=function(e){switch(e){case"toggle":n.$scope.showMenu=!n.$scope.showMenu;break;case"show":n.$scope.showMenu=!0;break;case"hide":n.$scope.showMenu=!1}"$apply"!=n.$scope.$root.$$phase&&"$digest"!=n.$scope.$root.$$phase&&n.$scope.$apply()},this.featureMessageReceived=function(e,t){switch(e){case"onFeatureDeselect":0===n.$layerService.selectedFeatures.length?n.$layerService.visual.rightPanelVisible=!1:n.updateAllStats();break;case"onFeatureSelect":n.displayFeature(n.$layerService.lastSelectedFeature),n.$scope.feature=n.$layerService.lastSelectedFeature,n.$layerService.visual.rightPanelVisible=!0,n.updateAllStats();break;case"onRelationsUpdated":n.setShowSimpleTimeline(),n.displayFeature(t),n.updateHierarchyLinks(t),n.$scope.feature=t,n.$scope.autocollapse(!0);break;case"onFeatureUpdated":n.displayFeature(n.$layerService.lastSelectedFeature),n.$scope.feature=n.$layerService.lastSelectedFeature}"$apply"!=n.$scope.$root.$$phase&&"$digest"!=n.$scope.$root.$$phase&&n.$scope.$apply()},this.timestamps=new Array,this.setDropdownTitle(),this.scope=e,e.vm=this,e.showMenu=!1,e.featureTabActivated=function(e,t){o.publish("FeatureTab","activated",{sectionTitle:e,section:t})},console.log("init featurepropsctrl"),o.subscribe("feature",this.featureMessageReceived);var l=function(){var e=0;return $("#featureTabs>li").each(function(){var t=$(this).outerWidth();e+=t}),e};e.autocollapse=function(e){void 0===e&&(e=!1);var t=$("#featureTabs");t.outerWidth()<l()||parseFloat(t.css("margin-left"))<0?($("#leftArr").show(),$("#rightArr").show(),e&&t.animate({"margin-left":"20px"},"slow")):($("#leftArr").hide(),$("#rightArr").hide(),e&&t.animate({"margin-left":"0px"},"slow"))},e.autocollapse(!0),e.tabs=$("#featureTabs"),e.tabScrollDelta=e.tabs.outerWidth(),this.displayFeature(this.$layerService.lastSelectedFeature),this.$scope.feature=this.$layerService.lastSelectedFeature,this.$messageBusService.subscribe("timeline",function(e,t){"updateFeatures"===e&&n.$scope.callOut&&n.updateAllStatsDelay()})}return e.prototype.updateAllStats=function(){var e=this;if(this.$scope.callOut)for(var t in this.$scope.callOut.sections){var r=this.$scope.callOut.sections[t];r.properties.forEach(function(t){t.showMore&&e.updateStatsDelay(t)})}},e.prototype.saveFeatureType=function(){var e=this.$layerService.findResourceByFeature(this.$scope.feature);e&&this.$layerService.saveResource(e)},e.prototype.savePropertyType=function(e){console.log("saving property"),console.log(e);var t=this.$layerService.findResourceByFeature(this.$scope.feature);this.$layerService.saveResource(t),this.displayFeature(this.$scope.feature)},e.prototype.selectProperty=function(e,t){this.lastSelectedProperty=e,t.stopPropagation()},e.prototype.saveFeature=function(){this.$layerService.unlockFeature(this.$scope.feature),this.$layerService.saveFeature(this.$scope.feature,!0),this.$layerService.updateFeature(this.$scope.feature),this.displayFeature(this.$layerService.lastSelectedFeature)},e.prototype.startEditFeature=function(){this.$scope.feature.gui.editMode=!0,this.$layerService.updateFeature(this.$scope.feature)},e.prototype.editFeature=function(){var e=csComp.Helpers.createRightPanelTab("featuretype","featuretype",this.$layerService.lastSelectedFeature,"Edit group");this.$messageBusService.publish("rightpanel","activate",e),this.$layerService.updateFeature(this.$layerService.lastSelectedFeature)},e.prototype.setFilter=function(e,t){this.$layerService.setPropertyFilter(e),t.stopPropagation()},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.prototype.openLayer=function(e){if(null!=e.feature&&e.feature.properties.hasOwnProperty(e.propertyType.label)){var t=e.feature.properties[e.propertyType.label];alert(t)}},e.prototype.setCorrelation=function(e,t){t.stopPropagation();var r=this.$layerService.getPropertyValues(e.feature.layer,e.property);for(var i in this.$scope.callOut.sections){var a=this.$scope.callOut.sections[i];a.properties.forEach(function(t){if(t.property!=e.property){var i=vg.util.cor(r,e.property,t.property);t.cors[e.property]={property:e.property,value:i}}})}},e.prototype.getPropStats=function(e){if(e.showMore){console.log("stats: calc stats for "+e.property),-1===this.stats.indexOf(e.property)&&this.stats.push(e.property);var t=this.$layerService.getPropertyValues(e.feature.layer,e.property),r=(e.property,vg.util.summary(t,[e.property]));e.stats=r[0],e.stats.sum=e.stats.count*e.stats.mean}else this.stats.indexOf(e.property)>=0&&(this.stats=this.stats.filter(function(t){return t!=e.property}))},e.prototype.displayFeature=function(e){var t=this;if(e&&(this.featureType=e.fType,this.featureType.id,"undefined"!=typeof e.sensors&&"undefined"==typeof e.timestamps&&(e.timestamps=this.$layerService.findLayer(e.layerId).timestamps),this.$scope.callOut=new i(this.featureType,e,this.$layerService.propertyTypeData,this.$layerService,this.$mapService),this.stats.length>0))for(var r in this.$scope.callOut.sections){var a=this.$scope.callOut.sections[r];a.properties.forEach(function(e){e.showMore=t.stats.indexOf(e.property)>=0,t.getPropStats(e)})}},e.prototype.removeFeature=function(){this.$layerService.removeFeature(this.$scope.feature,!0)},e.prototype.updateHierarchyLinks=function(e){var t=this;e&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){"hierarchy"==r.type&&r.enabled&&r.data&&r.data.features&&r.data.features[0].fType.propertyTypeData.forEach(function(r){if("hierarchy"==r.type&&r.targetlayer==e.layerId){var i=t.$layerService.getFeatureType(e),a=csComp.Helpers.getPropertyTypes(e.fType,t.$layerService.propertyTypeData),o=!1;a.forEach(function(e){e.label===r.label&&(o=!0)}),o||i.propertyTypeData.push(r)}})})})},e.prototype.showSensorData=function(e){console.log(e)},e.prototype.setShowSimpleTimeline=function(){if(this.$mapService.timelineVisible||"undefined"==typeof this.$layerService.lastSelectedFeature||null==this.$layerService.lastSelectedFeature)return void(this.showSimpleTimeline=!1);var e=this.$layerService.lastSelectedFeature;this.showSimpleTimeline="undefined"!=typeof e.sensors&&null!==e.sensors,this.showSimpleTimeline&&this.setTimestamps()},e.prototype.setTimestamps=function(){var e=this.$layerService.lastSelectedFeature,t=this.$layerService.findLayer(e.layerId);if(!("undefined"!=typeof t.timestamps&&null!=t.timestamps||"undefined"!=typeof e.timestamps&&null!=e.timestamps))return[];var r=this.timestamps=new Array;(t.timestamps||e.timestamps).forEach(function(e){var t=new Date(e),i=String.format("{0}-{1:00}-{2:00}",t.getFullYear(),t.getUTCMonth()+1,t.getUTCDate());(t.getUTCHours()>0||t.getUTCMinutes()>0)&&(i+=String.format(" {0:00}:{1:00}",t.getUTCHours(),t.getUTCMinutes())),r.push({title:i,timestamp:e})});var i=this.$layerService.project.timeLine.focus;if(i>r[r.length-1].timestamp)this.focusTime=r[r.length-1].title,this.setTime(r[r.length-1]);else if(i<r[0].timestamp)this.focusTime=r[0].title,this.setTime(r[0]);else for(var a=1;a<r.length;a++)if(!(i>r[a].timestamp)){this.focusTime=r[a].title,this.setTime(r[a]);break}return r},e.prototype.zoomToDate=function(e){var t=new Date(e.toString());this.$layerService.project.timeLine.isLive=!1,this.$layerService.project.timeLine.setFocus(t),this.$messageBusService.publish("timeline","setFocus",t)},e.prototype.setTime=function(e){this.focusTime=e.title,this.$layerService.project.timeLine.setFocus(new Date(e.timestamp)),this.$messageBusService.publish("timeline","focusChange",e.timestamp)},e.prototype.getFormattedDate=function(e,t){if(e){var r;return r=t&&t.hasOwnProperty("stringFormat")?t.stringFormat:"DD MMMM YYYY","Invalid date"===moment(e).format(r)?moment(e,"YYYYMMDD").format(r):moment(e).format(r)}},e.prototype.setDropdownTitle=function(){var e=this;this.$translate("CHOOSE_DROPDOWN").then(function(t){"string"==typeof t&&t.length>0?e.defaultDropdownTitle=t:e.defaultDropdownTitle="..."})},e.$inject=["$scope","$location","$sce","mapService","layerService","messageBusService","$translate"],e}();e.FeaturePropsCtrl=a}(FeatureProps||(FeatureProps={}));var FeatureRelations;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featurerelations",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FeatureRelations/FeatureRelations.tpl.html",replace:!0,transclude:!0,controller:e.FeatureRelationsCtrl}}])}(FeatureRelations||(FeatureRelations={}));var FeatureRelations;!function(e){var t=(function(){function e(e){this.position=e,this.closeButton=!0,this.autoPan=!0}return e}(),function(){function e(){this.relations=[]}return e}());e.RelationGroup=t;var r=function(){function e(){}return e}();e.Relation=r;var i=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$location=t,this.$sce=r,this.$mapService=i,this.$layerService=a,this.$messageBusService=o,this.$translate=s,this.relations=[],this.sidebarMessageReceived=function(e){switch(e){case"toggle":n.$scope.showMenu=!n.$scope.showMenu;break;case"show":n.$scope.showMenu=!0;break;case"hide":n.$scope.showMenu=!1}"$apply"!=n.$scope.$root.$$phase&&"$digest"!=n.$scope.$root.$$phase&&n.$scope.$apply()},this.featureMessageReceived=function(e,t){switch(e){case"onFeatureSelect":n.initRelations(),n.$messageBusService.publish("feature","onRelationsUpdated",t)}"$apply"!=n.$scope.$root.$$phase&&"$digest"!=n.$scope.$root.$$phase&&n.$scope.$apply()},this.scope=e,e.vm=this,e.showMenu=!1,this.initRelations()}return e.prototype.selectRelation=function(e){this.$layerService.selectFeature(e.target),this.$mapService.zoomTo(e.target)},e.prototype.createNearbyRelation=function(e){var i=new t,a=this.$layerService.activeMapRenderer.getZoom();if(11>a)return i;this.$translate("NEARBY_FEATURES").then(function(e){i.title=e}),i.id=csComp.Helpers.getGuid(),i.relations=[];var o=this.$mapService.map.getBounds(),s=!1;if(this.$layerService.project.features.every(function(t){if(t.id!=e.id&&("Point"==t.geometry.type&&o.contains(new L.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]))||"Polygon"==t.geometry.type&&o.contains(new L.LatLng(t.geometry.coordinates[0][0][1],t.geometry.coordinates[0][0][0])))){var a=new r;a.subject=e,a.target=t,a.title=csComp.Helpers.featureTitle(t.fType,t),a.icon=null==t.fType||null==t.fType.style||!t.fType.style.hasOwnProperty("iconUri")||t.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?"":csComp.Helpers.convertStringFormat(t,t.fType.style.iconUri),i.relations.push(a)}return i.relations.length>40?(s=!0,!1):!0}),s)return i.relations.length=0,i;var n;return"Point"==e.geometry.type?n=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]):"Polygon"==e.geometry.type&&(n=new L.LatLng(e.geometry.coordinates[0][0][1],e.geometry.coordinates[0][0][0])),n&&i.relations.sort(function(e,t){var r,i;return"Point"==e.target.geometry.type&&(r=new L.LatLng(e.target.geometry.coordinates[1],e.target.geometry.coordinates[0])),"Polygon"==e.target.geometry.type&&(r=new L.LatLng(e.target.geometry.coordinates[0][0][1],e.target.geometry.coordinates[0][0][0])),"Point"==t.target.geometry.type&&(i=new L.LatLng(t.target.geometry.coordinates[1],t.target.geometry.coordinates[0])),"Polygon"==t.target.geometry.type&&(i=new L.LatLng(t.target.geometry.coordinates[0][0][1],t.target.geometry.coordinates[0][0][0])),r&&i?n.distanceTo(r)-n.distanceTo(i):void 0}),i.relations.length>10&&i.relations.splice(10),i},e.prototype.initRelations=function(){this.relations=[];var e=this.$layerService.lastSelectedFeature;if(null!=e.fType){this.$scope.title=csComp.Helpers.featureTitle(e.fType,e),null==e.fType||null==e.fType.style||!e.fType.style.hasOwnProperty("iconUri")||e.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?this.$scope.icon="":this.$scope.icon=csComp.Helpers.convertStringFormat(e,e.fType.style.iconUri);var i=csComp.Helpers.getPropertyTypes(e.fType,this.$layerService.propertyTypeData);for(var a in i){var o=i[a];if("relation"==o.type){var s=new t;s.title=o.title,s.id=csComp.Helpers.getGuid(),s.relations=[],o.target&&(this.$layerService.project.features.forEach(function(t){if(e.properties.hasOwnProperty(o.subject)&&t.properties.hasOwnProperty(o.target)&&t.properties[o.target]==e.properties[o.subject]&&e.id!==t.id){var i=new r;i.subject=e,i.target=t,i.title=csComp.Helpers.featureTitle(t.fType,t),i.icon=null==t.fType||null==t.fType.style||!t.fType.style.hasOwnProperty("iconUri")||t.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?"":t.fType.style.iconUri,s.relations.push(i)}}),s.relations.length>0&&(o.count=0,s.relations.forEach(function(t){t.target.fType.name===e.fType.name&&(o.count+=1)}))),s.relations.length>0&&this.relations.push(s)}}var n=this.createNearbyRelation(e);n.relations.length>0&&this.relations.push(n),this.showRelations=this.relations.length>0,this.showRelations?$("#linkedData").show():$("#linkedData").hide()}},e.prototype.getRelations=function(){return this.relations},e.$inject=["$scope","$location","$sce","mapService","layerService","messageBusService","$translate"],e}();e.FeatureRelationsCtrl=i}(FeatureRelations||(FeatureRelations={}));var FilterList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("filterList",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FilterList/FilterList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.FilterListCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(FilterList||(FilterList={}));var FilterList;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this,this.noFilters=!0,this.locationFilterActive=!1,this.$messageBus.subscribe("filters",function(e){console.log("update filters"),i.noFilters=!0,i.locationFilterActive=!1,i.$layerService.project.groups.forEach(function(e){e.filters.length>0&&i.noFilters&&(i.noFilters=!1),e.filters.forEach(function(e){"location"===e.filterType&&i.locationFilterActive===!1&&(i.locationFilterActive=!0)})})})}return e.prototype.setLocationFilter=function(e){this.locationFilterActive||this.$layerService.setLocationFilter(e)},e.$inject=["$scope","layerService","messageBusService"],e}();e.FilterListCtrl=t}(FilterList||(FilterList={}));var Heatmap;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("heatmap",["$window","$compile",function(t,r,i){return{terminal:!0,restrict:"EA",scope:{},templateUrl:"directives/Heatmap/Heatmap.tpl.html",compile:function(e){var t=r(e);return function(e){t(e)}},replace:!0,transclude:!0,controller:e.HeatmapCtrl}}])}(Heatmap||(Heatmap={}));var Heatmap;!function(e){"use strict";var t=function(){function t(e,r,i,a,o,s,n,l){var c=this;this.$scope=e,this.$modal=r,this.$translate=i,this.$timeout=a,this.$localStorageService=o,this.$layerService=s,this.$mapService=n,this.messageBusService=l,this.heatmap=L.geoJson([]),this.heatmapModels=[],this.expertMode=!0,this.moveListenerInitialized=!1,this.projLayer=new csComp.Services.ProjectLayer,e.vm=this,l.subscribe("layer",function(e,t){switch(e){case"deactivate":t.type&&"heatmap"===t.type&&t.id===c.projLayer.id&&t!=c.projLayer&&(c.$layerService.removeLayer(c.projLayer),delete c.heatmapModel,c.initializeHeatmap());break;case"activated":t.type&&"heatmap"===t.type&&c.updateAvailableHeatmaps(),t.type&&"geojson"===t.type&&c.heatmapModel&&c.heatmapModel.heatmapSettings.referenceList.length>0&&t.reference&&t.reference==c.heatmapModel.heatmapSettings.referenceList[c.heatmapModel.heatmapSettings.referenceList.length-1]&&c.updateHeatmap()}}),l.subscribe("project",function(e){switch(e){case"loaded":c.expertMode=null!=s.project&&s.project.hasOwnProperty("userPrivileges")&&s.project.userPrivileges.hasOwnProperty("heatmap")&&s.project.userPrivileges.heatmap.hasOwnProperty("expertMode")&&s.project.userPrivileges.heatmap.expertMode,c.updateAvailableHeatmaps(),c.initializeHeatmap()}}),i("HEATMAP.DELETE_MSG").then(function(e){t.confirmationMsg1=e}),i("HEATMAP.DELETE_MSG2").then(function(e){t.confirmationMsg2=e})}return t.prototype.updateAvailableHeatmaps=function(){var t=this;if(this.heatmapModel){for(var r=0;r<this.heatmapModels.length;r++)if(this.heatmapModel.id==this.heatmapModels[r].id){this.heatmapModels.splice(r,1);break}this.heatmapModels.push(this.heatmapModel)}else this.heatmapModels=[],this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){if("heatmap"===r.type){var i=new e.HeatmapModel(r.title);i.deserialize(r),t.heatmapModels.push(i),r.enabled&&(t.heatmapModel=i)}})})},t.prototype.createHeatmap=function(){this.heatmapModel=new e.HeatmapModel("Heatmap"),this.projLayer.data&&this.$layerService.removeLayer(this.projLayer),this.projLayer.type="heatmap",this.projLayer.renderType="heatmap",this.projLayer.enabled=!0,this.projLayer.group=new csComp.Services.ProjectGroup,this.projLayer.group.oneLayerActive=!0,this.projLayer.group.layers=[],this.projLayer.group.filters=[],this.projLayer.group.styles=[],this.projLayer.group.markers=[],this.projLayer.heatmapSettings=new e.HeatmapSettings,this.projLayer.heatmapItems=[],this.projLayer.id=csComp.Helpers.getGuid(),this.projLayer.quickRefresh=!1,this.heatmap=L.geoJson([]),this.showHeatmapEditor(this.heatmapModel)},t.prototype.editHeatmap=function(e){this.showHeatmapEditor(e)},t.prototype.exportHeatmap=function(e){var t=this;this.heatmapModel.heatmapSettings.referenceList=[],this.heatmapModel.heatmapItems.forEach(function(e){e.isSelected&&t.$layerService.project.groups.forEach(function(e){"Features"==e.title&&e.layers.forEach(function(e){e.enabled&&t.heatmapModel.heatmapSettings.addReference(e.reference)})})}),console.log("\n-----------------\nExported heatmap starts here: \n"),console.log(e.serialize()),console.log("\n-----------------\nExported heatmap ends here. \n"),this.messageBusService.notify("Heatmap exported successfully","Your heatmap was exported to the console successfully.",csComp.Services.NotifyLocation.TopLeft)},t.prototype.removeHeatmap=function(e){var r=this;if(e){var i=String.format(t.confirmationMsg1,e.title);this.messageBusService.confirm(i,t.confirmationMsg2,function(t){t&&r.$timeout(function(){r.deleteHeatmap(e),r.updateAvailableHeatmaps()},0)}),this.scopeApply()}},t.prototype.deleteHeatmap=function(e){var t=this;if(e){var r=this.heatmapModels.indexOf(e);r>=0&&this.heatmapModels.splice(r,1),this.$layerService.removeLayer(this.projLayer),this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(e){e.layers.forEach(function(e){"heatmap"===e.type&&e.id===t.projLayer.id&&t.$layerService.removeLayer(e)})}),delete this.heatmapModel,delete this.projLayer,this.projLayer=new csComp.Services.ProjectLayer,this.initializeHeatmap()}},t.prototype.showHeatmapEditor=function(t){var r=this,i=this.$modal.open({templateUrl:"directives/Heatmap/HeatmapEditorView.tpl.html",controller:e.HeatmapEditorCtrl,resolve:{heatmap:function(){return t}}});i.result.then(function(e){r.heatmapModel=e;var t=r.heatmapModels.indexOf(e);t>=0&&r.heatmapModels.splice(t,1),r.heatmapModels.push(e),r.updateHeatmap(),console.log("Updated heatmap")},function(){console.log("Modal dismissed at: "+new Date),delete r.heatmapModel})},t.prototype.scopeApply=function(){"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.getVotingClass=function(e){return null==e||null==this.heatmapModel||0===e.userWeight||e.userWeight<-5||e.userWeight>5?"disabledHeatmap":e.userWeight>0?"prefer":"avoid"},t.prototype.weightUpdated=function(){this.heatmapModel&&(this.heatmapModel.updateWeights(),this.projLayer.quickRefresh=!0,this.$layerService.addLayer(this.projLayer))},t.prototype.intensityScaleUpdated=function(){this.heatmapModel&&this.updateHeatmapWithoutRerendering()},t.prototype.resolutionUpdated=function(){this.heatmapModel&&this.updateHeatmap()},t.prototype.updateHeatmapWithoutRerendering=function(){this.projLayer.quickRefresh=!0,this.$layerService.addLayer(this.projLayer)},t.prototype.updateHeatmap=function(){var e=this;if(this.heatmapModel){this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(t){t.layers.forEach(function(t){"heatmap"===t.type&&t.id===e.heatmapModel.id&&t.mapLayer&&(e.$layerService.map.map.removeLayer(t.mapLayer),t.enabled=!0)})}),this.projLayer.quickRefresh=!1,this.projLayer.heatmapItems=this.heatmapModel.heatmapItems,this.projLayer.heatmapSettings=this.heatmapModel.heatmapSettings,this.projLayer.id=this.heatmapModel.id;var t=this.$mapService.getMap().getZoom();if(t<this.heatmapModel.heatmapSettings.minZoom||t>this.heatmapModel.heatmapSettings.maxZoom)return console.log("Heatmap is not supported for the current zoom level."),void this.$layerService.loadRequiredLayers(this.projLayer);this.$layerService.removeLayer(this.projLayer),this.$layerService.addLayer(this.projLayer)}},t.prototype.initializeHeatmap=function(){var t=this;this.projLayer.type="heatmap",this.projLayer.renderType="heatmap",this.projLayer.enabled=!1,this.projLayer.group=new csComp.Services.ProjectGroup,this.projLayer.group.oneLayerActive=!0,this.projLayer.group.layers=[],this.projLayer.group.filters=[],this.projLayer.group.styles=[],this.projLayer.group.markers=[],this.projLayer.mapLayer=new L.LayerGroup,this.projLayer.heatmapSettings=new e.HeatmapSettings,this.projLayer.heatmapItems=[],this.projLayer.data=JSON,this.projLayer.id="",this.projLayer.quickRefresh=!1,this.moveListenerInitialized||(this.$layerService.map.map.addEventListener("moveend",function(e){t.updateHeatmap()}),this.moveListenerInitialized=!0)},t.$inject=["$scope","$modal","$translate","$timeout","localStorageService","layerService","mapService","messageBusService"],t}();e.HeatmapCtrl=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){"use strict";var t=function(){function t(t,r,i,a,o,s){var n=this;this.$scope=t,this.$modalInstance=r,this.$layerService=i,this.$translate=a,this.messageBusService=o,this.heatmap=s,this.scoringFunctions=[],t.vm=this,this.scoringFunctions.push(new e.ScoringFunction(e.ScoringFunctionType.LinearAscendingDescending)),a("HEATMAP.LINEAR_ASC_DESC").then(function(e){n.scoringFunctions[0].title=e}),this.dataset=csComp.Helpers.loadMapLayers(i),s||(s=new e.HeatmapModel("Heatmap"));for(var l in this.dataset.featureTypes)if(this.dataset.featureTypes.hasOwnProperty(l)){var c=this.dataset.featureTypes[l];s.addHeatmapItem(new e.HeatmapItem(c.name,c));if(!c.propertyTypeData)continue;c.propertyTypeData.forEach(function(t){if("options"==t.type){var r=0;t.options.forEach(function(i){var a=new e.HeatmapItem(i,c);a.propertyLabel=t.label,a.propertyTitle=t.title,a.optionIndex=r++,s.addHeatmapItem(a)})}})}}return t.prototype.save=function(){this.$modalInstance.close(this.heatmap)},t.prototype.cancel=function(){this.$modalInstance.dismiss("cancel")},t.prototype.toggleItemDetails=function(e){this.showItem=this.showItem==e?-1:e,console.log("Toggle item")},t.$inject=["$scope","$modalInstance","layerService","$translate","messageBusService","heatmap"],t}();e.HeatmapEditorCtrl=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function t(t,r,i,a,o,s,n,l,c){void 0===i&&(i=0),void 0===a&&(a=1),void 0===o&&(o=!1),void 0===s&&(s=new e.IdealityMeasure),this.title=t,this.featureType=r,this.weight=i,this.userWeight=a,this.isSelected=o,this.idealityMeasure=s,this.propertyTitle=n,this.propertyLabel=l,this.optionIndex=c,this.heatspots=[],this.setScale(52)}return t.serializeableData=function(e){return{title:e.title,featureType:e.featureType,propertyTitle:e.propertyTitle,propertyLabel:e.propertyLabel,optionIndex:e.optionIndex,userWeight:e.userWeight,weight:e.weight,idealityMeasure:e.idealityMeasure,isSelected:e.isSelected}},t.prototype.calculateHeatspots=function(e,t,r,i,a,o,s){return this.isSelected&&this.featureType.name.replace("_Default","")===e.fType.name?(0===this.heatspots.length&&this.calculateHeatspot(t,r),this.propertyLabel?e.properties.hasOwnProperty(this.propertyLabel)&&e.properties[this.propertyLabel]===this.optionIndex?this.pinHeatspotToGrid(e,i,a,o,s):null:this.pinHeatspotToGrid(e,i,a,o,s)):null},t.prototype.calculateHeatspot=function(t,r){var i=this.idealityMeasure.lostInterestDistance,a=Math.floor(i/t),o=Math.floor(i/r),s=t*r,n=a*o;this.heatspots=new Array(n),this.heatspots.push(new e.Heatspot(0,0,this.idealityMeasure.atLocation));for(var l=-o;o>=l;l++)for(var c=-a;a>=c;c++){var p=Math.sqrt(l*l*s+c*c*s),u=this.idealityMeasure.computeIdealityAtDistance(p);0==l&&0==c||0==u||this.heatspots.push(new e.Heatspot(l,c,u))}},t.prototype.pinHeatspotToGrid=function(e,t,r,i,a){
if("Point"!==e.geometry.type)return null;var o=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),s=i.pad(a);if(!s.contains(o))return null;var n=[],l=Math.floor((o.lng-i.getNorthWest().lng)/(i.getNorthEast().lng-i.getNorthWest().lng)*t),c=Math.floor((o.lat-i.getSouthWest().lat)/(i.getNorthWest().lat-i.getSouthWest().lat)*r);return this.heatspots.forEach(function(t){n.push(t.AddLocation(l,c,e.properties.Name))}),n},t.prototype.setScale=function(e){var r=csComp.Helpers.GeoExtensions.convertDegreesToMeters(e);t.meterToLatDegree=1/r.latitudeLength,t.meterToLonDegree=1/r.longitudeLength},t.prototype.select=function(){if(this.reset(),this.isSelected=!this.isSelected,this.isSelected)switch(this.featureType.style.drawingMode.toLowerCase()){case"point":case"image":this.idealityMeasure=new e.IdealityMeasure}else this.idealityMeasure=null},t.prototype.reset=function(){this.heatspots=[]},t.prototype.toString=function(){return this.propertyTitle?this.propertyTitle+"."+this.title+" ("+this.featureType.name+")":this.title},t.twoPi=2*Math.PI,t}();e.HeatmapItem=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function t(t){this.title=t,this.heatmapItems=[],this.id="",this.horizCells=0,this.vertCells=0,this.cellWidth=0,this.cellHeight=0,this.dLat=0,this.dLng=0,this.title=t,this.heatmapSettings=new e.HeatmapSettings}return t.prototype.calculate=function(e,t,r){var i=this,a=(new Date).getTime();console.log("Calculating heatmap");var o=t.map.getBounds(),s=o.getNorthWest(),n=o.getNorthEast();this.SW=o.getSouthWest();var l=s.distanceTo(n),c=s.distanceTo(this.SW),p=csComp.Helpers.loadMapLayers(e),u=0;p.features.forEach(function(e){i.heatmapItems.forEach(function(e){e.idealityMeasure.lostInterestDistance>u&&(u=e.idealityMeasure.lostInterestDistance)})});var h,d=(l+2*u)/l,f=(c+2*u)/c,y=Math.max(d,f),m=l/c;switch(this.heatmapSettings.resolution){case 1:h=1e3;break;case 2:h=4e3;break;case 3:h=7e3;break;default:h=4e3}this.horizCells=Math.floor(Math.sqrt(h*m)),this.vertCells=Math.floor(this.horizCells/m),this.cellWidth=l/this.horizCells,this.cellHeight=c/this.vertCells,this.dLat=(n.lat-this.SW.lat)/this.vertCells,this.dLng=(n.lng-this.SW.lng)/this.horizCells;var g=0;this.intensityGrid=[],this.contributorGrid=[];for(var v=0;v<this.horizCells;v++){this.intensityGrid[v]=[],this.contributorGrid[v]=[];for(var S=0;S<this.vertCells;S++)this.intensityGrid[v][S]={},this.contributorGrid[v][S]={}}p.features.forEach(function(e){i.heatmapItems.forEach(function(t){var r=t.calculateHeatspots(e,i.cellWidth,i.cellHeight,i.horizCells,i.vertCells,o,y);r&&r.forEach(function(e){0!=e.intensity&&e.i>=0&&e.i<i.horizCells&&e.j>=0&&e.j<i.vertCells&&(i.intensityGrid[e.i][e.j].hasOwnProperty(t.toString())?i.intensityGrid[e.i][e.j][t.toString()]+=e.intensity:i.intensityGrid[e.i][e.j][t.toString()]=e.intensity,i.contributorGrid[e.i][e.j][e.contributor]=e.intensity,g+=1)})})});var $=(new Date).getTime();console.log("Created "+g+" heatspots in "+($-a).toFixed(1)+" ms"),this.drawIntensityGrid(r);var b=(new Date).getTime();console.log("Calculated "+v*S+" cells in "+(b-a).toFixed(1)+" ms")},t.prototype.drawIntensityGrid=function(e){var t=this.heatmapSettings.intensityScale/3*(this.heatmapSettings.intensityScale/3);e.clearLayers();var r={};this.heatmapItems.forEach(function(e){r[e.toString()]=e.weight});for(var i=0;i<this.horizCells;i++)for(var a=0;a<this.vertCells;a++){var o=0;for(var s in this.intensityGrid[i][a])this.intensityGrid[i][a].hasOwnProperty(s)&&(o+=r[s]*this.intensityGrid[i][a][s]);if(0!=o){var n=[[this.SW.lng+this.dLng*i,this.SW.lat+this.dLat*a],[this.SW.lng+this.dLng*(i+1),this.SW.lat+this.dLat*a],[this.SW.lng+this.dLng*(i+1),this.SW.lat+this.dLat*(a+1)],[this.SW.lng+this.dLng*i,this.SW.lat+this.dLat*(a+1)]],l={type:"Feature",geometry:{type:"Polygon",coordinates:[n]},properties:{Name:"Heatmap cell ("+i.toString()+", "+a.toString()+")",gridX:i,gridY:a,totalIntensity:(o*t).toFixed(3),contributors:JSON.stringify(this.contributorGrid[i][a],function(e,t){return t.toFixed?Number(t.toFixed(3)):t}),intensities:JSON.stringify(this.intensityGrid[i][a])}};e.addData(l)}}},t.prototype.updateWeights=function(){var e=0;this.heatmapItems.forEach(function(t){t.isSelected&&(e+=Math.abs(t.userWeight))}),this.heatmapItems.forEach(function(t){t.isSelected&&(0!=e?t.weight=t.userWeight/e:t.weight=0)})},t.prototype.addHeatmapItem=function(e){for(var t=e.featureType,r=e.title,i=0;i<this.heatmapItems.length;i++){var a=this.heatmapItems[i];if(a.featureType.name===t.name&&a.title===r)return}this.heatmapItems.push(e)},t.prototype.deserialize=function(t){var r=this;this.id=t.id;var i=t.heatmapSettings;this.heatmapSettings=new e.HeatmapSettings(i.referenceList,i.minZoom,i.maxZoom,i.intensityScale,i.resolution),this.heatmapItems=[];var a=t.heatmapItems;a.forEach(function(t){var i=new e.IdealityMeasure(t.idealityMeasure.idealDistance,t.idealityMeasure.atLocation,t.idealityMeasure.lostInterestDistance);if(t.propertyTitle)var a=new e.HeatmapItem(t.title,t.featureType,t.weight,t.userWeight,t.isSelected,i,t.propertyTitle,t.propertyLabel,t.optionIndex);else var a=new e.HeatmapItem(t.title,t.featureType,t.weight,t.userWeight,t.isSelected,i);r.addHeatmapItem(a)})},t.prototype.serialize=function(){var t=[];this.heatmapItems.forEach(function(r){if(r.isSelected){if(r.reset(),r.propertyTitle)var i=new e.HeatmapItem(r.title,{name:r.featureType.name},r.weight,r.userWeight,r.isSelected,r.idealityMeasure,r.propertyTitle,r.propertyLabel,r.optionIndex);else var i=new e.HeatmapItem(r.title,{name:r.featureType.name},r.weight,r.userWeight,r.isSelected,r.idealityMeasure);t.push(i)}});var r='{"id": "ID",\n"reference": "REFERENCE",\n"languages": {\n"nl": {"title": ';return r+=JSON.stringify(this.title),r+=',\n"description": "BESCHRIJVING"\n},\n"en": {"title": ',r+=JSON.stringify(this.title),r+=',\n"description": "DESCRIPTION"\n}\n},\n"description": "DESCRIPTION",\n',r+='"type":"Heatmap"',r+=',\n"heatmapSettings":'+JSON.stringify(this.heatmapSettings,null," "),r+=',\n"heatmapItems":',r+=JSON.stringify(t,null," "),r+=',\n"enabled":',r+=JSON.stringify(!1),r+=',\n"opacity":',r+=JSON.stringify(100),r+="\n}"},t}();e.HeatmapModel=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function e(e,t,r,i,a){void 0===e&&(e=[]),void 0===t&&(t=10),void 0===r&&(r=15),void 0===i&&(i=3),void 0===a&&(a=2),this.referenceList=e,this.minZoom=t,this.maxZoom=r,this.intensityScale=i,this.resolution=a}return e.prototype.addReference=function(e){this.referenceList.indexOf(e)<0&&this.referenceList.push(e)},e}();e.HeatmapSettings=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function e(e,t,r,i){this.i=e,this.j=t,this.intensity=r,this.contributor=i}return e.prototype.AddLocation=function(t,r,i){return new e(this.i+t,this.j+r,this.intensity,i)},e}();e.Heatspot=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){!function(e){e[e.LinearAscendingDescending=0]="LinearAscendingDescending"}(e.ScoringFunctionType||(e.ScoringFunctionType={}));var t=e.ScoringFunctionType,r=function(){function e(e){"undefined"!=typeof e&&null!=e&&(this.type=e),this.title=t[e].toString()}return Object.defineProperty(e.prototype,"cssClass",{get:function(){return t[this.type].toLowerCase()},enumerable:!0,configurable:!0}),e}();e.ScoringFunction=r;var i=function(){function e(){}return e}();e.ScoringFunctions=i;var a=function(){function e(e,t,r){void 0===e&&(e=500),void 0===t&&(t=.1),void 0===r&&(r=2e3),this.idealDistance=e,this.atLocation=t,this.lostInterestDistance=r}return e.prototype.computeIdealityAtDistance=function(e){var t=0;return e<this.idealDistance?t=this.atLocation>=1?1:this.atLocation+(1-this.atLocation)*e/this.idealDistance:e<this.lostInterestDistance&&(t=1-(e-this.idealDistance)/(this.lostInterestDistance-this.idealDistance)),t},e}();e.IdealityMeasure=a}(Heatmap||(Heatmap={}));var KanbanBoard;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanboardEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/KanbanBoard/KanbanBoard-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var l=e.$parent;this.widget=l.data,this.propertyTypes=[];e.data=this.widget.data,this.allLayers=i.allLayers(),e.data&&e.data.columns&&e.data.columns.length>0&&(e.selectedColumn=e.data.columns[0]),console.log(e.data)}return e.prototype.selectColumn=function(){console.log(this.$scope.selectedColumn)},e.prototype.selectLayer=function(){console.log(this.layer),this.$messageBus.publish("typesource","","")},e.prototype.colorUpdated=function(e,t){t.color=e},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.KanbanBoardEditCtrl=i}(KanbanBoard||(KanbanBoard={}));var KanbanColumn;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanboard",[function(){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/KanbanBoard/KanbanBoard.tpl.html",replace:!1,transclude:!1,controller:e.KanbanBoardCtrl}}])}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t=function(){function e(){}return e}();e.KanbanConfig=t;var r=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.feeds=[],this.featureTypes={},e.vm=this;var a=e.$parent;this.kanban=a.widget.data,this.kanban.hasOwnProperty("canAdd")||(this.kanban.canAdd=!0),this.$messageBus.subscribe("typesource",function(e){i.initLayer()}),this.initLayer()}return e.prototype.addFeature=function(e){var t=new csComp.Services.Feature;t.properties={};var r=this.featureTypes[e];if(r.properties)for(var i in r.properties)t.properties[i]=JSON.parse(JSON.stringify(r.properties[i]));t.properties.date=new Date,t.properties.updated=new Date,t.properties.featureTypeId=e,t.properties.hasOwnProperty("Name")||(t.properties.Name=r.name),this.layer.data.features.push(t),this.$layerService.initFeature(t,this.layer),this.$layerService.editFeature(t)},e.prototype.initLayer=function(){if(console.log("kanban:loaded project"),this.kanban&&this.kanban.columns&&this.kanban.columns.length>0){var e=this.kanban.columns[0].filters.layerId;if(this.layer=this.$layerService.findLayer(e),this.layer&&this.layer.typeUrl&&this.$layerService.typesResources.hasOwnProperty(this.layer.typeUrl)){if(this.kanban.featureTypesToAdd){this.featureTypes={};for(var t in this.$layerService.typesResources[this.layer.typeUrl].featureTypes)this.kanban.featureTypesToAdd.indexOf(t)>-1&&(this.featureTypes[t]=this.$layerService.typesResources[this.layer.typeUrl].featureTypes[t])}else this.featureTypes=this.$layerService.typesResources[this.layer.typeUrl].featureTypes;console.log("feature types")}}},e.$inject=["$scope","layerService","messageBusService"],e}();e.KanbanBoardCtrl=r}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanColumn",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{column:"="},templateUrl:"directives/KanbanBoard/KanbanColumn.tpl.html",replace:!1,transclude:!1,controller:e.KanbanColumnCtrl}}])}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t=function(){function e(){}return e}();e.ColumnFilter=t;var r=function(){function e(){}return e}();e.Column=r;var i=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.mapService=i,this.sortOptions=[],e.vm=this,this.column=e.column,e.fields=this.column.fields,e.fields.hasOwnProperty("prio")&&(this.sortOptions=this.sortOptions.concat(["High priority","Low Priority"])),e.fields.hasOwnProperty("date")&&(this.sortOptions=this.sortOptions.concat(["New","Old"])),e.fields.hasOwnProperty("updated")&&(this.sortOptions=this.sortOptions.concat(["Updated"])),this.sortOptions=this.sortOptions.concat(["Title"]),this.initLayers(),this.column.hasOwnProperty("canShare")||(this.column.canShare=!0),this.column.orderBy?this.setOrder(this.column.orderBy):this.setOrder(this.sortOptions[0]),e.columnFilter=function(t){var r=!0;if(!e.column)return!1;if(r&&a.column.filters.layerId!==t.layerId)return!1;if(a.column.filters.roles&&a.column.filters.roles.length>0&&t.properties.hasOwnProperty("roles")&&a.column.filters.roles.forEach(function(e){_.contains(t.properties.roles,e)||(r=!1)}),r&&a.column.filters.tags&&a.column.filters.tags.length>0&&a.column.filters.tags.length>0){if(!t.properties.hasOwnProperty("tags"))return!1;var i=t.properties.tags,o=!1;a.column.filters.tags.some(function(e){switch(e[0]){case"!":case"~":var t=e.substr(1,e.length-1);_.contains(i,t)&&(r=!1);break;case"-":o=!0;break;default:_.contains(i,e)||(r=!1)}return!r}),r&&o?(o=!1,a.column.filters.tags.some(function(e){switch(e[0]){case"-":var t=e.substr(1,e.length-1);_.contains(i,t)&&(o=!0)}return o})):o=!0,r=r&&o}return r},setInterval(function(){a.updateTime()},1e3)}return e.prototype.getClass=function(e){return"undefined"==typeof e.properties?"":e.properties.hasOwnProperty("question")?e.properties.hasOwnProperty("answered")&&e.properties.answered===!0?"isAnsweredQuestion":"isQuestion":""},e.prototype.clickPrio=function(e){},e.prototype.createForm=function(e){var t=this;e.gui.questions?(delete e.gui.questions,this.$layerService.unlockFeature(e)):this.$layerService.lockFeature(e)&&(e.gui.questions=[],e.properties[this.column.fields.question].forEach(function(r){var i=t.$layerService.getPropertyType(e,r);e.gui.questions.push({property:r,ptype:i})}))},e.prototype.sendForm=function(e){e.properties.answered=!0,delete e.gui.questions,this.$layerService.unlockFeature(e),this.$layerService.saveFeature(e,!0)},e.prototype.saveCategory=function(e,t,r){e.properties.answered=!0,e.properties[t]=r,delete e.gui.questions,this.$layerService.unlockFeature(e),this.$layerService.saveFeature(e,!0)},e.prototype.updateTime=function(){this.$layerService.project.features.forEach(function(e){if(e.properties.hasOwnProperty("date")){var t=e.properties.date;e.hasOwnProperty("gui")||(e.gui=new Object),e.gui.relativeTime=moment(t).fromNow()}return""})},e.prototype.toggleRole=function(e,t){e.properties.hasOwnProperty("roles")||(e.properties.roles=[]),-1===e.properties.roles.indexOf(t)?e.properties.roles.push(t):e.properties.roles=e.properties.roles.filter(function(e){return e!=t}),this.$layerService.saveFeature(e,!0)},e.prototype.logFilter=function(e){},e.prototype.startAction=function(e,t){this.$messageBus.publish("kanbanaction",e,t)},e.prototype.getPrioColor=function(e){var t=["white","black","red","orange","blue","green"];return e.properties.hasOwnProperty(this.column.fields.prio)?{"background-color":t[parseInt(e.properties[this.column.fields.prio])]}:{"background-color":"white"}},e.prototype.setOrder=function(e){switch(this.$scope.columnOrderTitle=e,this.column.orderBy=e,e){case"High priority":this.$scope.columnOrderBy="properties."+this.$scope.fields.prio;break;case"Low Priority":this.$scope.columnOrderBy="-properties."+this.$scope.fields.prio;break;case"New":this.$scope.columnOrderBy="-properties."+this.$scope.fields.date;break;case"Old":this.$scope.columnOrderBy="properties."+this.$scope.fields.date;break;case"Updated":this.$scope.columnOrderBy="-properties."+this.$scope.fields.updated;break;case"Title":this.$scope.columnOrderBy="properties."+this.$scope.fields.title}},e.prototype.updateFeature=function(e){this.$layerService.saveFeature(e,!0)},e.prototype.selectFeature=function(e){this.$messageBus.publish("kanban","onItemSelect",e),e.properties.hasOwnProperty(this.column.fields.question)?this.createForm(e):this.$layerService.selectFeature(e)},e.prototype.editFeature=function(e){this.$layerService.editFeature(e)},e.prototype.searchFeature=function(e){this.mapService.zoomTo(e,15)},e.prototype.initLayers=function(){var e=this.$scope.column,t=e.filters.layerId;this.layer=this.$layerService.findLayer(t),this.layer&&this.$layerService.addLayer(this.layer,function(e){})},e.$inject=["$scope","layerService","messageBusService","mapService"],e}();e.KanbanColumnCtrl=i}(KanbanColumn||(KanbanColumn={}));var LanguageSwitch;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("languageSwitch",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/LanguageSwitch/LanguageSwitch.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LanguageSwitchCtrl}}]).provider("$languages",function(){this.languages=[],this.$get=function(){return this.languages},this.setLanguages=function(e){this.languages=e}})}(LanguageSwitch||(LanguageSwitch={}));var LanguageSwitch;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$translate=t,this.$languages=r,this.$layerService=i,this.$messageBus=a,e.vm=this;for(var o=0,s=0;s<r.length;s++)if(r[s].key===t.preferredLanguage()){o=s;break}this.language=r[o]}return e.prototype.switchLanguage=function(e){this.language=e,this.$translate.use(e.key),this.$messageBus.publish("language","newLanguage",e.key)},e.$inject=["$scope","$translate","$languages","layerService","messageBusService"],e}();e.LanguageSwitchCtrl=t}(LanguageSwitch||(LanguageSwitch={}));var LayersDirective;!function(e){"use strict";var t=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$http=t,this.$modalInstance=r,this.layerService=i,this.translate=a,this.messageBusService=o,e.vm=this,this.project=this.layerService.project,this.project.layerDirectory&&t.get(this.project.layerDirectory).success(function(e){s.layers=e}).error(function(){console.log("AddLayerCtrl: error calling $http")})}return e.prototype.addGroup=function(){var e=this;if(!this.layerService.project.groups.some(function(t){return t.title==e.groupTitle})){var t=new csComp.Services.ProjectGroup;t.title=this.groupTitle,t.description=this.groupDescription,this.layerService.project.groups.push(t),this.layerService.initGroup(t),this.done()}},e.prototype.selectProjectLayer=function(e){this.selectedLayer=e},e.prototype.addProjectLayer=function(){var e=this.layerService.findGroupById(this.layerGroup);e&&(this.layerService.initLayer(e,this.selectedLayer),e.layers.push(this.selectedLayer)),this.done()},e.prototype.addLayer=function(){var e=this.layerService.findGroupById(this.layerGroup);if(e){var t=new csComp.Services.ProjectLayer;t.title=this.layerTitle,this.layerService.initLayer(e,t),e.layers.push(t);var r=csComp.Helpers.createRightPanelTab("edit","layeredit",t,"Edit layer");this.messageBusService.publish("rightpanel","activate",r)}this.done()},e.prototype.done=function(){this.$modalInstance.close("done")},e.prototype.cancel=function(){console.log("cancel"),this.$modalInstance.dismiss("cancel")},e.$inject=["$scope","$http","$modalInstance","layerService","$translate","messageBusService"],e}();e.AddLayerCtrl=t}(LayersDirective||(LayersDirective={}));var LayersDirective;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layersDirective",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/LayersList/LayersDirective.tpl.html",replace:!0,transclude:!0,controller:e.LayersDirectiveCtrl}}])}(LayersDirective||(LayersDirective={}));var LayersDirective;!function(e){var t=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$mapService=i,this.$dashboardService=a,this.$modal=o,this.$http=s,this.state="layers",this.updateLayerOpacity=_.debounce(function(e){console.log("update opacity"),e&&(e.renderType&&"gridlayer"===e.renderType.toLowerCase()?n.$layerService.updateCanvasOverlay(e):n.$layerService.updateLayerFeatures(e))},500),e.vm=this,e.options=function(e){return e.enabled?e.layerSource?e.layerSource.layerMenuOptions(e):void 0:null},this.allCollapsed=!1,this.$messageBusService.subscribe("project",function(e,t){n.project=t,"loaded"===e&&t&&(t.hasOwnProperty("collapseAllLayers")&&t.collapseAllLayers===!0?n.allCollapsed=!0:n.allCollapsed=!1)}),this.$messageBusService.subscribe("layerdrop",function(e,t){n.dropLayer(t)})}return e.prototype.dropLayer=function(e){this.initGroups(),this.initResources(),$('#leftPanelTab a[data-target="#layers"]').tab("show"),this.state="createlayer",this.newLayer=e,this.newGroup=e.id,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.editGroup=function(e){var t=csComp.Helpers.createRightPanelTab("edit","groupedit",e,"Edit group","Edit group");this.$messageBusService.publish("rightpanel","activate",t)},e.prototype.editLayer=function(e){var t=csComp.Helpers.createRightPanelTab("edit","layeredit",e,"Edit layer","Edit layer");this.$messageBusService.publish("rightpanel","activate",t)},e.prototype.createType=function(){if(this.layer.typeUrl&&this.$layerService.typesResources.hasOwnProperty(this.layer.typeUrl)){var e=this.$layerService.typesResources[this.layer.typeUrl],t={drawingMode:"point",fillColor:"red"},r={id:"test",name:"test",style:t},i=r.id;e.featureTypes[i]=r,console.log(e)}},e.prototype.initGroups=function(){var e=this;this.groups=[],this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(t){return e.groups.push(t)});var t=new csComp.Services.ProjectGroup;t.id="<new>",t.title="<new group>",this.groups.push(t)},e.prototype.initDrag=function(e,t){var r,i,a=this;interact("#layerfeaturetype-"+e).draggable({max:1/0,onstart:function(e){r=0,i=0,e.interaction.x=parseInt(e.target.getAttribute("data-x"),10)||0,e.interaction.y=parseInt(e.target.getAttribute("data-y"),10)||0},onmove:function(e){e.interaction.x+=e.dx,e.interaction.y+=e.dy,e.target.style.left=e.interaction.x+"px",e.target.style.top=e.interaction.y+"px"},onend:function(r){setTimeout(function(){var i=r.clientX,o=r.clientY,s=a.$layerService.activeMapRenderer.getLatLon(i,o-50);console.log(s);var n=new csComp.Services.Feature;n.layerId=t.id,n.geometry={type:"Point",coordinates:[s.lon,s.lat]},n.properties={featureTypeId:e,Name:e},t.data.features.push(n),a.$layerService.initFeature(n,t),a.$layerService.activeMapRenderer.addFeature(n),a.$layerService.saveFeature(n)},100),r.target.setAttribute("data-x",0),r.target.setAttribute("data-y",0),r.target.style.left="0px",r.target.style.top="0px",console.log(e)}})},e.prototype.selectProjectLayer=function(e){this.selectedLayer=e},e.prototype.exitDirectory=function(){this.selectedLayer=null,this.layerTitle="",this.state="layers"},e.prototype.addProjectLayer=function(){if("<new>"===this.layerResourceType){this.selectedLayer.typeUrl="api/resources/"+this.selectedLayer.title;var e={id:this.selectedLayer.title,title:this.selectedLayer.title,featureTypes:{},propertyTypeData:{}};e.featureTypes.Default={name:"Default",style:{drawingMode:"Point"}},this.$layerService.saveResource(e)}else this.selectedLayer.typeUrl=this.layerResourceType;var t;"<new>"==this.layerGroup?(t=new csComp.Services.ProjectGroup,t.title=this.newGroup,this.$layerService.project.groups.push(t),this.$layerService.initGroup(t)):t=this.$layerService.findGroupById(this.layerGroup),t&&(this.$layerService.initLayer(t,this.selectedLayer),t.layers.push(this.selectedLayer)),this.selectedLayer=null,this.state="layers"},e.prototype.startAddingFeatures=function(e){this.state="editlayer",e.layerSource.startAddingFeatures(e),this.layer=e,!this.layer.typeUrl},e.prototype.stopAddingFeatures=function(e){if(this.state="layers",e.gui.featureTypes)for(var t in e.gui.featureTypes)interact("#layerfeaturetype-"+t).onstart=null,interact("#layerfeaturetype-"+t).onmove=null,interact("#layerfeaturetype-"+t).onend=null;e.layerSource.stopAddingFeatures(e)},e.prototype.setLayerOpacity=function(e){this.updateLayerOpacity(e)},e.prototype.openLayerMenu=function(e){$(".left-menu").contextmenu("show",e)},e.prototype.loadAvailableLayers=function(){var e=this;this.mylayers=[],this.project.groups&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){return e.mylayers.push(t.url)})}),this.project.layerDirectory&&$.getJSON(this.project.layerDirectory,function(t){e.directory=[];for(var r in t)e.directory.push(t[r])})},e.prototype.openDirectory=function(){this.initGroups(),this.loadAvailableLayers(),this.initResources(),this.state="directory"},e.prototype.initResources=function(){var e=this;this.resources={},this.project.groups&&(this.project.groups.forEach(function(t){t.layers&&t.layers.forEach(function(t){t.typeUrl&&!e.resources.hasOwnProperty(t.typeUrl)&&(e.resources[t.typeUrl]={title:t.typeUrl})})}),this.resources["<new>"]={title:"<new type file>"},this.layerResourceType="<new>")},e.prototype.createLayer=function(){this.initGroups(),this.loadAvailableLayers(),this.initResources(),this.$layerService.project.groups&&this.$layerService.project.groups.length>0?this.layerGroup=this.$layerService.project.groups[0].id:(this.layerGroup=new csComp.Services.ProjectGroup,this.layerGroup.id="<new>",this.layerGroup.title="<new group>",this.$layerService.project.groups=[]),this.state="createlayer",this.newLayer=new csComp.Services.ProjectLayer,this.newLayer.type="dynamicgeojson"},e.prototype.addLayer=function(){var e;if("<new>"==this.layerGroup?(e=new csComp.Services.ProjectGroup,e.title=this.newGroup,this.$layerService.project.groups.push(e),this.$layerService.initGroup(e)):e=this.$layerService.findGroupById(this.layerGroup),e){this.$layerService.initLayer(e,this.newLayer),e.layers.push(this.newLayer);var t=this.newLayer;if("dynamicgeojson"===this.newLayer.type){if(this.newLayer.url="api/layers/"+t.title,"<new>"===this.layerResourceType){this.newLayer.typeUrl="api/resources/"+this.newLayer.title;var r={id:this.newLayer.title,title:this.newLayer.title,featureTypes:{},propertyTypeData:{}};this.newLayer.data&&this.newLayer.data.features&&this.newLayer.data.features.length>0&&(r.featureTypes.Default=csComp.Helpers.createDefaultType(this.newLayer.data.features[0],r)),this.$http.post("api/resources",r).success(function(e){}).error(function(e){console.log("error adding resource")})}else this.newLayer.typeUrl=this.layerResourceType;var i={id:t.title,title:t.title,isDynamic:!0,type:t.type,storage:"file",description:t.description,typeUrl:t.typeUrl,tags:t.tags,url:t.url,features:[]};this.newLayer.data&&(i.features=this.newLayer.data.features),this.$http.post("/api/layers",i).success(function(e){console.log(e)}).error(function(){console.log("error adding layer")})}"<new>"===this.layerResourceType,this.$layerService.addLayer(this.newLayer)}this.exitDirectory()},e.prototype.toggleLayer=function(e){$(".left-menu").on("click",function(e){$(this).contextmenu({x:e.offsetX,y:e.offsetY})}),this.$layerService.toggleLayer(e),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.collapseAll=function(){this.$layerService.collapseAll(),this.allCollapsed=!0,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.expandAll=function(){this.$layerService.expandAll(),this.allCollapsed=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","layerService","messageBusService","mapService","dashboardService","$modal","$http"],e}();e.LayersDirectiveCtrl=t}(LayersDirective||(LayersDirective={}));var Legend;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("legendDirective",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Legend/Legend.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LegendCtrl}}])}(Legend||(Legend={}));var Legend;!function(e){var t=function(){function e(){}return e}();e.LegendData=t;var r=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.passcount=1,e.vm=this;var a=e.$parent;if(this.widget=a.widget,this.widget&&this.widget.data&&(e.data=this.widget.data),this.widget&&this.widget.data&&this.widget.data.hasOwnProperty("propertyTypeKey"))var o=this.$layerService.propertyTypeData[e.data.propertyTypeKey];e.data&&"lastSelectedStyle"===e.data.mode&&(e.legend=this.createLegend(),e.$parent.hasOwnProperty("widget")&&(e.legend.hasOwnProperty("legendEntries")?e.$parent.widget.enabled=!0:e.$parent.widget.enabled=!1),this.subscribeHandle||(this.subscribeHandle=this.$messageBus.subscribe("updatelegend",function(t,r){switch(t){case"removelegend":i.$messageBus.unsubscribe(i.subscribeHandle);break;default:o&&o.legend&&(e.legend=o.legend),(e.data.mode="lastSelectedStyle")&&(e.legend=i.createLegend(),e.$parent.hasOwnProperty("widget")&&(e.legend.hasOwnProperty("legendEntries")?e.$parent.widget.enabled=!0:e.$parent.widget.enabled=!1)),"$apply"!=i.$scope.$root.$$phase&&"$digest"!=i.$scope.$root.$$phase&&i.$scope.$apply()}})))}return e.prototype.createLegend=function(){var e,t=new csComp.Services.Legend;if(this.$layerService.project.groups.forEach(function(t){t.styles.forEach(function(t){t.enabled&&(e=t)})}),!e)return t;var r=this.$layerService.propertyTypeData[e.property];return r?(t.id=r.label+"legendcolors",t.legendKind="interpolated",t.description=r.title,t.legendEntries=[],e.activeLegend&&e.activeLegend.legendEntries?e.activeLegend.legendEntries.forEach(function(e){t.legendEntries.push(e)}):(t.legendEntries.push(this.createLegendEntry(e,r,e.info.min)),t.legendEntries.push(this.createLegendEntry(e,r,(e.info.min+e.info.max)/4)),t.legendEntries.push(this.createLegendEntry(e,r,2*(e.info.min+e.info.max)/4)),t.legendEntries.push(this.createLegendEntry(e,r,3*(e.info.min+e.info.max)/4)),t.legendEntries.push(this.createLegendEntry(e,r,e.info.max)),t.legendEntries=t.legendEntries.sort(function(e,t){return e.value-t.value})),t):t},e.prototype.createLegendEntry=function(e,t,r){var i=new csComp.Services.LegendEntry;return i.label=csComp.Helpers.convertPropertyInfo(t,r),i.label===r.toString()&&(e.info.max>100?i.label=String.format("{0:#,#}",r):i.label=String.format("{0:#,#.#}",r)),i.value=r,i.color=csComp.Helpers.getColor(r,e),i},e.prototype.getStyle=function(e,t,r){var i={"float":"left",position:"relative",top:"10px",background:"linear-gradient(to bottom, "+t.color+", "+e.legendEntries[e.legendEntries.length-r-2].color+")","border-left":"1px solid black","border-right":"1px solid black"};return 0===r?i["border-top"]="1px solid black":r===e.legendEntries.length-2&&(i["border-bottom"]="1px solid black"),i},e.$inject=["$scope","layerService","messageBusService"],e}();e.LegendCtrl=r}(Legend||(Legend={}));var LegendList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("legendList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/LegendList/LegendList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.LegendListCtrl}}])}(LegendList||(LegendList={}));var LegendList;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$mapService=r,this.$messageBusService=i,this.$sce=a,e.vm=this,i.subscribe("project",function(e){switch(e){case"loaded":o.updateLegendItems()}}),i.subscribe("layer",function(e){switch(e){case"activated":case"deactivate":o.updateLegendItems()}}),this.updateLegendItems(),e.legendItems=[],e.numberOfItems=10}return e.prototype.updateLegendItems=function(){this.updateLegendItemsUsingFeatures();
},e.prototype.updateLegendStatically=function(){var e=this,t=this.$layerService.project;if(t){if(!t.hasOwnProperty("groups"))return void console.log("Creating legend failed: no groups found");var r=[],i={};t.groups.forEach(function(t){t.hasOwnProperty("layers")&&t.layers.forEach(function(t){if(t.enabled&&t.hasOwnProperty("typeUrl")&&t.hasOwnProperty("defaultFeatureType")){var a=t.typeUrl+"#"+t.defaultFeatureType,o=e.$layerService.getFeatureTypeById(a);!i.hasOwnProperty(a)&&o&&o.hasOwnProperty("legendItems")&&o.legendItems.forEach(function(e){r.push({title:e.title,uri:e.uri||"",html:e.html||""})}),i[a]=!0}})}),this.$scope.legendItems=r}},e.prototype.updateLegendItemsUsingFeatureTypes=function(){var e=[],t=[];for(var r in this.$layerService._featureTypes){var i=this.$layerService._featureTypes[r],a=csComp.Helpers.getImageUri(i),o="",s=this.getName(r,i),n=s+a;t.indexOf(n)<0&&(t.push(n),e.push({title:s,uri:a,html:o}))}e.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),this.$scope.legendItems=e},e.prototype.updateLegendItemsUsingFeatures=function(){var e=this,t=!0,r={},i=[],a=[];return this.$layerService.project&&0!==this.$layerService.project.features.length?(this.$layerService.project.features.forEach(function(o){var s=o.fType;if(s||(s=e.$layerService.getFeatureType(o)),!r.hasOwnProperty(s.name)){if(s&&s.hasOwnProperty("legendItems"))return s.legendItems.forEach(function(e){i.push({title:e.title,uri:e.uri||"",html:e.html||""})}),t=!1,void(r[s.name]=!0);var n=s&&s.style&&s.style.hasOwnProperty("iconUri")?csComp.Helpers.convertStringFormat(o,s.style.iconUri):csComp.Helpers.getImageUri(s);n.indexOf("_Media")>=0&&(o.effectiveStyle.iconUri="cs/images/polygon.png");var l=csComp.Helpers.createIconHtml(o,s).html,c=s.name||o.layer.title||(s.id?s.id.split("#").pop():"undefined"),p=c+n;a.indexOf(p)<0&&(a.push(p),i.push({title:c,uri:n,html:l}))}}),t&&i.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),void(this.$scope.legendItems=i)):void(this.$scope.legendItems=i)},e.prototype.getName=function(e,t){return t.name||e.split("#").pop()},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.$inject=["$scope","layerService","mapService","messageBusService","$sce"],e}();e.LegendListCtrl=t}(LegendList||(LegendList={}));var MapElement;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("map",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{mapid:"="},templateUrl:"directives/MapElement/MapElement.tpl.html",link:function(e,t,r){},replace:!1,transclude:!0,controller:e.MapElementCtrl}}])}(MapElement||(MapElement={}));var MapElement;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.mapService=r,this.$messageBusService=i,this.locale="en-us",this.options=["test","boe"],e.vm=this,this.initMap(),e.initMap=function(){return a.initMap()}}return e.prototype.initMap=function(){this.$layerService.selectRenderer("leaflet")},e.$inject=["$scope","layerService","mapService","messageBusService"],e}();e.MapElementCtrl=t}(MapElement||(MapElement={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Mca;!function(e){var t;!function(e){!function(e){e[e.Manual=0]="Manual",e[e.Ascending=1]="Ascending",e[e.Descending=2]="Descending",e[e.AscendingSigmoid=3]="AscendingSigmoid",e[e.DescendingSigmoid=4]="DescendingSigmoid",e[e.GaussianPeak=5]="GaussianPeak",e[e.GaussianValley=6]="GaussianValley"}(e.ScoringFunctionType||(e.ScoringFunctionType={}));var t=e.ScoringFunctionType,r=function(){function e(e){"undefined"!=typeof e&&null!=e&&(this.type=e),this.title=t[e].toString()}return Object.defineProperty(e.prototype,"cssClass",{get:function(){return t[this.type].toLowerCase()},enumerable:!0,configurable:!0}),e.createScores=function(e){var r;switch(e){default:case t.Ascending:r="[0,0 10,1]";break;case t.Descending:r="[0,1 10,0]";break;case t.AscendingSigmoid:r="[0,0.11 1,0.12 2,0.14 3,0.18 4,0.28 5,0.5 6,0.72 7,0.82 8,0.86 9,0.88 10,0.89]";break;case t.DescendingSigmoid:r="[0,0.89 1,0.88 2,0.86 3,0.82 4,0.72 5,0.5 6,0.28 7,0.18 8,0.14 9,0.12 10,0.11]";break;case t.GaussianPeak:r="[0,0 2,0.04 3,0.25 4,0.7 5,1 6,0.7 7,0.25 8,0.04 9,0]";break;case t.GaussianValley:r="[0,1 2,0.96 3,0.75 4,0.3 5,0 6,0.3 7,0.75 8,0.96 9,0]"}return r},e}();e.ScoringFunction=r;var i=function(){function e(){}return e}();e.ScoringFunctions=i;var a=function(){function e(){this.userWeight=1,this.propValues=[],this.criteria=[],this.isPlaUpdated=!1,this.isPlaScaled=!1,this.x=[],this.y=[]}return e.prototype.deserialize=function(t){var r=this;return this.title=t.title,this.description=t.description,this.label=t.label,this.color=t.color,this.userWeight=t.userWeight,this.weight=t.weight,this.isPlaScaled=t.isPlaScaled,this.scores=t.scores,this.minCutoffValue=t.minCutoffValue,this.maxCutoffValue=t.maxCutoffValue,this.minValue=t.minValue,this.maxValue=t.maxValue,t.criteria.forEach(function(t){r.criteria.push((new e).deserialize(t))}),this},e.prototype.requiresMinimum=function(){return this.scores&&this.scores.indexOf("min")>=0},e.prototype.requiresMaximum=function(){return this.scores&&this.scores.indexOf("max")>=0},e.prototype.getTitle=function(){return this.title?this.title:this.label},e.prototype.updatePla=function(e){var t=this;if(!this.isPlaUpdated){if(this.criteria.length>0)return this.criteria.forEach(function(t){t.updatePla(e)}),void(this.isPlaUpdated=!0);if(null!=this.scores){var r=this.scores;this.propValues=[],(this.requiresMaximum()||this.requiresMinimum()||this.isPlaScaled)&&e.forEach(function(e){if(e.properties.hasOwnProperty(t.label)){var r=e.properties[t.label];$.isNumeric(r)&&t.propValues.push(r)}});var i=this.maxValue,a=this.minValue;if((this.isPlaScaled||this.requiresMaximum())&&(i=i||Math.max.apply(null,this.propValues),r.replace("max",i.toPrecision(3))),(this.isPlaScaled||this.requiresMinimum())&&(a=a||Math.min.apply(null,this.propValues),r.replace("min",a.toPrecision(3))),this.isPlaScaled){var o=csComp.Helpers.standardDeviation(this.propValues);i=i||Math.min(i,o.avg+2*o.stdDev),a=a||Math.max(a,o.avg-2*o.stdDev)}var s,n,l=r.split(/[^\d\.]+/).filter(function(e){return e.length>0}),c=i-a;if(null!=this.minValue||null!=this.maxValue?(s=c/10,n=a):(s=.08*c,n=a+.1*c),l.length%2!==0)throw Error(this.label+" does not have an even (x,y) pair in scores.");for(var p=0;p<l.length/2;p++){var u=parseFloat(l[2*p]);if(this.isPlaScaled&&(u=s*u+n),p>0&&this.x[p-1]>u)throw Error(this.label+": x should increment continuously.");this.x.push(u);var h=parseFloat(l[2*p+1]);0>h?h=0:h>1&&(h=1),this.y.push(h)}this.isPlaUpdated=!0}}},e.prototype.getScore=function(e){if(!this.isPlaUpdated)throw"Error: PLA must be updated for criterion "+this.title+"!";if(0!==this.criteria.length){var t=0;return this.criteria.forEach(function(r){t+=r.weight>0?r.weight*r.getScore(e):Math.abs(r.weight)*(1-r.getScore(e))}),this.weight>0?this.weight*t:Math.abs(this.weight)*(1-t)}if(!e.properties.hasOwnProperty(this.label))return 0;var r=e.properties[this.label];if(this.maxCutoffValue<=r||r<=this.minCutoffValue)return 0;if(r<this.x[0])return this.y[0];var i=this.x.length-1;if(r>this.x[i])return this.y[i];for(var a=0;a<this.x.length;a++)if(r<this.x[a]){var o=this.x[a-1],s=this.x[a],n=this.y[a-1],l=this.y[a];return(l-n)*(r-o)/(s-o)}return 0},e}();e.Criterion=a;var o=function(e){function t(){e.call(this),this.userWeightMax=5,this.featureIds=[],this.weight=1,this.isPlaUpdated=!1}return __extends(t,e),Object.defineProperty(t.prototype,"rankLabel",{get:function(){return this.label+"#"},enumerable:!0,configurable:!0}),t.prototype.deserialize=function(t){return this.section=t.section,this.stringFormat=t.stringFormat,this.rankTitle=t.rankTitle,this.rankDescription=t.rankDescription,this.rankFormat=t.rankFormat,this.userWeightMax=t.userWeightMax,this.featureIds=t.featureIds,this.minCutoffValue=t.minCutoffValue,this.maxCutoffValue=t.maxCutoffValue,this.minValue=t.minValue,this.maxValue=t.maxValue,this.scaleMinValue=t.scaleMinValue,this.scaleMaxValue=t.scaleMaxValue,e.prototype.deserialize.call(this,t),this},t.prototype.update=function(){this.calculateWeights(),this.setColors()},t.prototype.calculateWeights=function(e){e||(e=this.criteria);var t=0;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];i.criteria.length>0&&this.calculateWeights(i.criteria),t+=Math.abs(i.userWeight)}if(t>0)for(var a in e)if(e.hasOwnProperty(a)){var o=e[a];o.weight=o.userWeight/t}},t.prototype.setColors=function(){var e=chroma.scale("RdYlBu").domain([0,this.criteria.length-1],this.criteria.length),t=0,r=0;this.criteria.forEach(function(i){t+=i.criteria.length,i.color||(i.color=e(r++).hex())});var i=chroma.scale("PRGn").domain([0,t-1],t);r=0,this.criteria.forEach(function(e){e.criteria.forEach(function(e){e.color||(e.color=i(r++).hex())})})},t}(a);e.Mca=o}(t=e.Models||(e.Models={}))}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mca",["$window","$compile","$templateCache",function(t,r){return{terminal:!0,restrict:"EA",scope:{},templateUrl:"directives/MCA/Mca.tpl.html",compile:function(e){var t=r(e);return function(e){t(e)}},replace:!0,transclude:!0,controller:e.McaCtrl}}])}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t=function(){function t(r,i,a,o,s,n,l){var c=this;this.$scope=r,this.$modal=i,this.$translate=a,this.$timeout=o,this.$localStorageService=s,this.$layerService=n,this.messageBusService=l,this.features=[],this.availableMcas=[],this.showAsterChart=!1,this.showDialog=!1,this.expertMode=!1,this.showSparkline=!1,this.featureMessageReceived=function(e,t){if(null!=c.mca){switch(e){case"onFeatureSelect":c.updateSelectedFeature(t,!0);break;case"onFeatureDeselect":c.showFeature=!1,c.selectedFeature=null,c.drawChart()}c.scopeApply()}},r.vm=this,l.subscribe("layer",function(e){switch(e){case"deactivate":case"activated":c.updateAvailableMcas(),c.calculateMca()}}),l.subscribe("project",function(r){switch(r){case"loaded":c.expertMode=null!=n.project&&n.project.hasOwnProperty("userPrivileges")&&n.project.userPrivileges.hasOwnProperty("mca")&&n.project.userPrivileges.mca.hasOwnProperty("expertMode")&&n.project.userPrivileges.mca.expertMode,("undefined"==typeof n.project.mcas||null==n.project.mcas)&&(n.project.mcas=[]);var i=c.$localStorageService.get(t.mcas);if("undefined"==typeof i||null===i)return;i.forEach(function(t){n.project.mcas.push((new e.Models.Mca).deserialize(t))})}}),l.subscribe("feature",this.featureMessageReceived),a("MCA.DELETE_MSG").then(function(e){t.confirmationMsg1=e}),a("MCA.DELETE_MSG2").then(function(e){t.confirmationMsg2=e})}return t.prototype.getVotingClass=function(e){return null==e||null==this.mca||0===e.userWeight||e.userWeight<-this.mca.userWeightMax||e.userWeight>this.mca.userWeightMax?"disabledMca":e.userWeight>0?"prefer":"avoid"},t.prototype.createDummyMca=function(){var t=new e.Models.Mca;t.title="Mijn Zelfredzaamheid",t.description="Analyse van de zelfredzaamheid van een gemeente.",t.label="mca_zelfredzaamheid",t.stringFormat="{0:0.0}",t.rankTitle="Positie",t.rankDescription="Relatieve positie in de lijst.",t.rankFormat="{0} van {1}",t.userWeightMax=5,t.featureIds=["cities_Default"];var r=new e.Models.Criterion;r.label="p_00_14_jr",r.scores="[0,0 20,1]",r.userWeight=1,t.criteria.push(r),r=new e.Models.Criterion,r.label="p_15_24_jr",r.scores="[0,0 20,1]",r.userWeight=1,t.criteria.push(r),r=new e.Models.Criterion,r.label="p_65_eo_jr",r.scores="[0,0 25,1]",r.userWeight=3,t.criteria.push(r),this.$layerService.project.mcas.push(t),t=new e.Models.Mca,t.title="test",t.label="mca_test",t.stringFormat="{0:0.0}",t.rankTitle="Rang",t.rankFormat="{0} van {1}",t.userWeightMax=3,t.featureIds=["cities_Default"],r=new e.Models.Criterion,r.label="p_15_24_jr",r.scores="[0,0 20,1]",r.userWeight=1,t.criteria.push(r),r=new e.Models.Criterion,r.label="p_65_eo_jr",r.scores="[0,0 25,1]",r.userWeight=3,t.criteria.push(r),this.$layerService.project.mcas.push(t)},t.prototype.toggleMcaChartType=function(){this.showAsterChart=!this.showAsterChart,this.drawChart(this.mca.criteria[0])},t.prototype.toggleSparkline=function(){this.showSparkline=!this.showSparkline,this.showSparkline&&this.drawChart()},t.prototype.weightUpdated=function(e){this.selectedCriterion=e,this.addMca(this.mca),this.updateMca(e)},t.prototype.updateMca=function(e){this.selectedCriterion=e,this.features=[],this.calculateMca(),this.drawChart(e)},t.prototype.editMca=function(e){this.showMcaEditor(e)},t.prototype.createMca=function(){this.showMcaEditor(new e.Models.Mca)},t.prototype.showMcaEditor=function(t){var r=this,i=this.$modal.open({templateUrl:"directives/MCA/McaEditorView.tpl.html",controller:e.McaEditorCtrl,resolve:{mca:function(){return t}}});i.result.then(function(e){r.showSparkline=!1,r.addMca(e),r.updateMca()},function(){})},t.prototype.removeMca=function(e){var r=this;if(e){var i=String.format(t.confirmationMsg1,e.title);this.messageBusService.confirm(i,t.confirmationMsg2,function(t){t&&r.$timeout(function(){r.deleteMca(e),r.mca&&r.updateMca()},0)}),this.scopeApply()}},t.prototype.getMcaIndex=function(e){for(var t=-1,r=this.$layerService.project.mcas,i=0;i<r.length;i++)if(r[i].title===e.title){t=i;break}return t},t.prototype.addMca=function(e){e&&(this.deleteMca(e),this.$layerService.project.mcas.push(e),this.addMcaToLocalStorage(e),this.updateAvailableMcas(e))},t.prototype.deleteMca=function(e){if(e){var t=this.getMcaIndex(e);if(!(0>t)){var r=this.$layerService.project.mcas;t>=0&&r.splice(t,1),this.removeMcaFromLocalStorage(e),this.updateAvailableMcas()}}},t.prototype.addMcaToLocalStorage=function(e){var r=this.$localStorageService.get(t.mcas);("undefined"==typeof r||null===r)&&(r=[]),this.removeMcaFromLocalStorage(e),r.push(e),this.$localStorageService.set(t.mcas,r)},t.prototype.removeMcaFromLocalStorage=function(e){var r=this.$localStorageService.get(t.mcas);if("undefined"!=typeof r&&null!==r){for(var i=-1,a=0;a<r.length;a++)if(r[a].title===e.title){i=a;break}0>i||(r.splice(i,1),this.$localStorageService.set(t.mcas,r))}},t.prototype.scopeApply=function(){"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.updateSelectedFeature=function(e,r){if(void 0===r&&(r=!1),"undefined"==typeof e||null==e)return void(this.featureIcon="");if(this.selectedFeature=e,this.featureIcon=null!=this.selectedFeature.fType&&null!=this.selectedFeature.fType.style?this.selectedFeature.fType.style.iconUri:"",e.properties.hasOwnProperty(this.mca.label)){this.showFeature=!0,this.properties=[];var i=t.createPropertyType(this.mca),a=csComp.Helpers.convertPropertyInfo(i,e.properties[i.label]);this.properties.push(new FeatureProps.CallOutProperty(i.title,a,i.label,!0,!0,e,!1,!1,i.description,i)),this.mca.rankTitle&&(i=t.createRankPropertyType(this.mca),a=csComp.Helpers.convertPropertyInfo(i,e.properties[i.label]),this.properties.push(new FeatureProps.CallOutProperty(i.title,a,i.label,!1,!1,e,!1,!1,i.description,i))),r&&this.drawChart()}},t.prototype.drawChart=function(e){var t=this;if(this.selectedCriterion=e,this.showChart=!0,this.showFeature?this.showAsterChart?this.drawAsterPlot(e):this.drawHistogram(e):this.drawPieChart(e),this.showSparkline){var r=0;this.mca.criteria.forEach(function(e){var i="histogram_"+r++;if(0===e.criteria.length){var a=e.y;e.userWeight<0&&(a=a.map(function(e){return 1-e})),csComp.Helpers.Plot.drawMcaPlot(e.propValues,{id:i,width:220,height:70,xy:{x:e.x,y:a},featureValue:t.selectedFeature?t.selectedFeature.properties[e.label]:null})}else{var o=0;e.criteria.forEach(function(r){var a=r.y;e.userWeight<0&&(a=a.map(function(e){return 1-e})),csComp.Helpers.Plot.drawMcaPlot(r.propValues,{id:i+"_"+o++,width:220,height:70,xy:{x:r.x,y:a},featureValue:t.selectedFeature?t.selectedFeature.properties[r.label]:null})})}})}},t.prototype.getParentOfSelectedCriterion=function(e){var t,r=this;return this.mca.update(),"undefined"==typeof e||this.mca.criteria.indexOf(e)>=0?(this.selectedCriterion=null,t=this.mca.criteria):this.mca.criteria.forEach(function(i){i.criteria.indexOf(e)>=0&&(r.selectedCriterion=i,t=i.criteria)}),t},t.prototype.drawHistogram=function(e){var r=this;if(this.mca&&this.selectedFeature){var i=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof i&&null!=i){var a=[],o={id:t.mcaChartId,numberOfBins:10,width:240,height:100,selectedValue:this.selectedFeature.properties[this.mca.label]};this.features.forEach(function(e){if(e.properties.hasOwnProperty(r.mca.label)){var t=e.properties[r.mca.label];$.isNumeric(t)&&a.push(t)}}),csComp.Helpers.Plot.drawHistogram(a,o)}}},t.prototype.drawAsterPlot=function(e){var r=this;if(this.mca&&this.selectedFeature){var i=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof i&&null!=i){var a=[],o=0;i.forEach(function(e){var t=e.getScore(r.selectedFeature),i=new csComp.Helpers.AsterPieData;i.id=o++,i.label=e.getTitle(),i.weight=Math.abs(e.weight),i.color=e.color,i.score=100*(e.weight>0?t:1-t),a.push(i)}),csComp.Helpers.Plot.drawAsterPlot(100,a,t.mcaChartId)}}},t.prototype.drawPieChart=function(e){if(this.mca){var r=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof r&&null!=r){var i=[],a=0;r.forEach(function(e){var t=new csComp.Helpers.PieData;t.id=a++,t.label=e.getTitle(),t.weight=Math.abs(e.weight),t.color=e.color,i.push(t)}),csComp.Helpers.Plot.drawPie(100,i,t.mcaChartId)}}},t.prototype.updateAvailableMcas=function(e){var t=this;this.showChart=!1,this.mca=e,this.availableMcas=[],this.$layerService.project.mcas.forEach(function(e){e.featureIds.forEach(function(r){if(t.availableMcas.indexOf(e)<0&&t.$layerService._featureTypes.hasOwnProperty(r)){t.availableMcas.push(e);var i=t.$layerService._featureTypes[r];t.applyPropertyInfoToCriteria(e,i)}})}),null==e&&this.availableMcas.length>0&&(this.mca=this.availableMcas[0],this.updateMca())},t.prototype.calculateMca=function(){var e=this;if(this.mca){var t=this.mca;t.featureIds.forEach(function(r){if(e.$layerService._featureTypes.hasOwnProperty(r)&&(e.addPropertyInfo(r,t),e.$layerService.project.features.forEach(function(t){null!=t.featureTypeName&&t.featureTypeName===r&&e.features.push(t)}),0!==e.features.length)){t.updatePla(e.features),t.update();var i=[],a=0;if(e.features.forEach(function(r){var o=t.getScore(r);if(t.rankTitle){var s={score:o,index:a++};i.push(s)}r.properties[t.label]=100*o,e.$layerService.calculateFeatureStyle(r),e.$layerService.activeMapRenderer.updateFeature(r)}),t.rankTitle){i.sort(function(e,t){return t.score-e.score});for(var o=e.features.length,s=t.scaleMinValue?Math.abs(t.scaleMaxValue-t.scaleMinValue)+1:o,n=Math.ceil(o/s),l=t.scaleMinValue?t.scaleMaxValue>t.scaleMinValue?function(e){return t.scaleMaxValue-Math.round(e/n)}:function(e){return t.scaleMinValue+Math.round(e/n)}:function(e){return e},c=-1,p=1,u=0;o>u;u++){var h=i[u];h.score!==c&&(p=u+1),c=h.score,e.features[h.index].properties[t.label+"#"]=l(p)+","+s}}}}),this.updateSelectedFeature(this.selectedFeature,!1),this.selectedFeature&&this.messageBusService.publish("feature","onFeatureSelect",this.selectedFeature),this.groupStyle&&this.$layerService.updateStyle(this.groupStyle)}},t.prototype.applyPropertyInfoToCriteria=function(e,t){var r=csComp.Helpers.getPropertyTypes(t,this.$layerService.propertyTypeData);0!==r.length&&e.criteria.forEach(function(e){var t=e.label;r.forEach(function(r){r.label===t&&(e.title=r.title,e.description=r.description)})})},t.prototype.addPropertyInfo=function(e,r,i){void 0===i&&(i=!1);for(var a=this.$layerService._featureTypes[e],o=csComp.Helpers.getPropertyTypes(a,this.$layerService.propertyTypeData),s=-1,n=o.length-1;n>=0;n--)if(o[n].label===r.label){s=n;break}if(i||0>s){var l=t.createPropertyType(r);0>s?(a.propertyTypeData||(a.propertyTypeData=[]),a.propertyTypeData.push(l)):o[s]=l}if(r.rankTitle){for(s=-1,n=o.length-1;n>=0;n--)if(o[n].label===r.rankLabel){s=n;break}(i||0>s)&&(l=t.createRankPropertyType(r),0>s?a.propertyTypeData.push(l):o[s]=l)}},t.prototype.setStyle=function(e){this.groupStyle&&null!=this.groupStyle.group&&null!=this.groupStyle.group.styles&&this.groupStyle.group.styles.filter(function(e){return"fillColor"===e.visualAspect})[0].property===this.mca.label?this.$layerService.updateStyle(this.groupStyle):(this.groupStyle=this.$layerService.setStyle(e,!1),this.groupStyle.colors=["#F04030","#3040F0"],this.$layerService.updateStyle(this.groupStyle))},t.createPropertyType=function(e){var t={title:e.title,label:e.label,type:"number",maxValue:1,minValue:0,description:e.description,stringFormat:e.stringFormat,visibleInCallOut:!0,section:e.section||"MCA"};return t},t.createRankPropertyType=function(e){var t={title:e.rankTitle,label:e.rankLabel,type:"rank",description:e.rankDescription,stringFormat:e.rankFormat,visibleInCallOut:!0,section:e.section||"MCA"};return t},t.mcaChartId="mcaChart",t.mcas="MCAs",t.$inject=["$scope","$modal","$translate","$timeout","localStorageService","layerService","messageBusService"],t}();e.McaCtrl=t}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t=function(){function t(t,r,i,a,o,s){var n=this;this.$scope=t,this.$modalInstance=r,this.$layerService=i,this.$translate=a,this.messageBusService=o,this.mca=s,this.propInfos=[],this.headers=[],this.scoringFunctions=[],t.vm=this,this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.Ascending)),this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.AscendingSigmoid)),this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.GaussianPeak)),a("MCA.LINEAR").then(function(e){n.scoringFunctions[0].title=e}),a("MCA.SIGMOID").then(function(e){n.scoringFunctions[1].title=e}),a("MCA.GAUSSIAN").then(function(e){n.scoringFunctions[2].title=e}),this.dataset=csComp.Helpers.loadMapLayers(this.$layerService),o.subscribe("layer",function(){n.dataset=csComp.Helpers.loadMapLayers(n.$layerService)}),this.mcaTitle=s.title,this.rankTitle=s.rankTitle,this.scaleMin=s.scaleMinValue,this.scaleMax=s.scaleMaxValue,this.selectedFeatureType=0===s.featureIds.length?"":this.dataset.featureTypes[s.featureIds[0]],this.selectedFeatureType?(this.updatePropertyInfo(this.selectedFeatureType),this.updatePropertyInfoUponEdit(s)):this.selectFirstFeatureType()}return t.prototype.updatePropertyInfoUponEdit=function(e,t){var r=this;e.criteria.forEach(function(e){if(e.label){var i=r.propInfos;for(var a in i)if(i.hasOwnProperty(a)){var o=i[a];if(o.label===e.label){o.isSelected=!0,o.minCutoffValue=e.minCutoffValue,o.maxCutoffValue=e.maxCutoffValue,o.minValue=e.minValue,o.maxValue=e.maxValue,o.userWeight=e.userWeight,t&&(o.category=t);break}}}else r.updatePropertyInfoUponEdit(e,e.title)})},t.prototype.loadPropertyTypes=function(){this.updatePropertyInfo(this.selectedFeatureType)},t.prototype.selectFirstFeatureType=function(){var e=this.dataset.featureTypes;for(var t in e)if(e.hasOwnProperty(t))return this.selectedFeatureType=e[t],void this.updatePropertyInfo(this.selectedFeatureType)},t.prototype.updatePropertyInfo=function(e){var t=this;this.propInfos=[],this.headers=[];var r=[],i=[];if(i.push({label:"Name",visibleInCallOut:!0,title:"Naam",type:"text",filterType:"text",isSelected:!1,scoringFunctionType:this.scoringFunctions[0].type}),null!=e.propertyTypeKeys){var a=e.propertyTypeKeys.split(";");a.forEach(function(r){if(t.$layerService.propertyTypeData.hasOwnProperty(r))i.push(t.$layerService.propertyTypeData[r]);else if(null!=e.propertyTypeData){var a=$.grep(e.propertyTypeData,function(e){return e.label===r});a.length>=1&&i.push(a)}})}else null!=e.propertyTypeData&&e.propertyTypeData.forEach(function(e){return i.push(e)});i.forEach(function(e){e.visibleInCallOut&&"number"===e.type&&e.label.indexOf("mca_")<0&&r.indexOf(e.title)<0&&(r.push(e.title),t.propInfos.push({title:e.title,label:e.label,stringFormat:e.stringFormat,isSelected:!1,maxValue:e.maxValue,minValue:e.minValue,defaultValue:e.defaultValue,description:e.description}))})},t.prototype.toggleSelection=function(e){var t=this.headers.indexOf(e);t>-1?this.headers.splice(t,1):this.headers.push(e)},t.prototype.isDisabled=function(){return"undefined"==typeof this.mcaTitle||0===this.mcaTitle.length?!0:0!==this.propInfos.length&&this.propInfos.reduce(function(e,t){return e||t.isSelected})?!1:!0},t.prototype.save=function(){var t=new e.Models.Mca;t.title=this.mcaTitle||"New MCA criterion",t.label="mca_"+t.title.replace(" ","_"),t.stringFormat="{0:0.0}",this.rankTitle&&(t.rankTitle=this.rankTitle||"Rank",t.rankFormat="{0} / {1}"),this.scaleMin&&this.scaleMax&&(t.scaleMinValue=this.scaleMin,t.scaleMaxValue=this.scaleMax),t.userWeightMax=5;var r=this.dataset.featureTypes;for(var i in r)r.hasOwnProperty(i)&&r[i]===this.selectedFeatureType&&(t.featureIds=[i]);this.propInfos.forEach(function(r){if(r.isSelected){var i=new e.Models.Criterion;if(i.label=r.label,i.title=r.title,i.isPlaScaled=!0,i.description=r.description,i.userWeight=r.userWeight||1,i.minCutoffValue=r.minCutoffValue?+r.minCutoffValue:void 0,i.maxCutoffValue=r.maxCutoffValue?+r.maxCutoffValue:void 0,i.minValue=r.minValue?+r.minValue:void 0,i.maxValue=r.maxValue?+r.maxValue:void 0,r.scoringFunctionType===e.Models.ScoringFunctionType.Manual?i.scores=r.scores:i.scores=e.Models.ScoringFunction.createScores(r.scoringFunctionType),r.category){var a;for(var o in t.criteria)if(t.criteria.hasOwnProperty(o)){var s=t.criteria[o];if(s.title===r.category){a=s;break}}null==a&&(a=new e.Models.Criterion,a.title=r.category,a.isPlaUpdated=!1,t.criteria.push(a)),a.criteria.push(i)}else t.criteria.push(i)}}),this.$modalInstance.close(t)},t.prototype.cancel=function(){this.mcaTitle="",this.rankTitle="",this.headers=[],this.$modalInstance.dismiss("cancel")},t.prototype.toggleItemDetails=function(e){this.showItem=this.showItem==e?-1:e},t.$inject=["$scope","$modalInstance","layerService","$translate","messageBusService","mca"],t}();e.McaEditorCtrl=t}(Mca||(Mca={}));var Mobile;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mobile",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Mobile/Mobile.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.MobileCtrl}}])}(Mobile||(Mobile={}));var Mobile;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.localStorageService=i,this.geoService=a,e.vm=this,this.$messageBus.subscribe("project",function(e,t){"loaded"===e&&(o.availableLayers=[],t.groups.forEach(function(e){e.layers.forEach(function(e){e.tags&&e.tags.indexOf("mobile")>=0&&o.availableLayers.push(e)})}),console.log("available layers"),console.log(o.availableLayers))}),r.subscribe("geo",function(e,t){switch(e){case"pos":var r=new csComp.Services.Feature;r.geometry={type:"Point",coordinates:[]},r.geometry.coordinates=[t.coords.longitude,t.coords.latitude],r.properties={Name:"test"},o.$layerService.activeMapRenderer.addFeature(r),o.$layerService.saveFeature(r)}}),this.geoService.start({})}return e.$inject=["$scope","layerService","messageBusService","localStorageService","geoService"],e}();e.MobileCtrl=t}(Mobile||(Mobile={}));var Navigate;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("navigate",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Navigate/Navigate.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.NavigateCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(Navigate||(Navigate={}));var Navigate;!function(e){var t=function(){function e(){}return e}();e.RecentFeature=t;var r=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.localStorageService=i,this.geoService=a,this.RecentLayers=[],this.mobileLayers=[],this.RecentFeatures=[],this.lastPost={longitude:0,latitude:0},e.vm=this,this.$messageBus.subscribe("project",function(e,t){"loaded"===e&&(o.initRecentLayers(),o.initRecentFeatures(),o.$layerService.isMobile&&o.initMobileLayers(t))})}return e.prototype.leave=function(e){this.mobileLayer&&this.MyFeature&&(this.$layerService.removeFeature(this.MyFeature,!0),this.$layerService.activeMapRenderer.removeFeature(this.MyFeature),this.MyFeature=null),this.mobileLayer=null},e.prototype.join=function(e){var t=this;this.localStorageService.set("username",this.UserName),async.series([function(r){e.enabled?r():t.$layerService.addLayer(e,function(){r()})},function(r){t.mobileLayer=e;var i=new csComp.Services.Feature;i.layerId=t.mobileLayer.id,i.geometry={type:"Point",coordinates:[]},i.geometry.coordinates=[t.lastPost.longitude,t.lastPost.latitude],i.id=t.UserName,i.properties={Name:t.UserName},t.$layerService.initFeature(i,t.mobileLayer),t.$layerService.activeMapRenderer.addFeature(i),t.$layerService.saveFeature(i),t.MyFeature=i}])},e.prototype.initMobileLayers=function(e){var t=this;this.UserName=this.localStorageService.get("username"),this.UserName||(this.UserName="mobile user"),this.mobileLayers=[],e.groups.forEach(function(e){e.layers.forEach(function(e){e.tags&&e.tags.indexOf("mobile")>=0&&t.mobileLayers.push(e)})}),this.$layerService.isMobile&&(this.$messageBus.subscribe("geo",function(e,r){switch(e){case"pos":t.mobileLayer&&t.MyFeature&&(t.lastPost=r.coords,t.MyFeature.geometry.coordinates=[r.coords.longitude,r.coords.latitude],t.$layerService.activeMapRenderer.updateFeature(t.MyFeature),t.$layerService.saveFeature(t.MyFeature))}}),this.geoService.start({}))},e.prototype.updateRecentFeaturesList=function(){var e=this;setTimeout(function(){var t=e.localStorageService.get("recentfeatures");t&&(e.RecentFeatures=t,e.RecentFeatures.forEach(function(t){var r=e.$layerService.findLayer(t.layerId);r&&r.enabled&&(t.feature=e.$layerService.findFeature(r,t.id))}))},0)},e.prototype.selectFeature=function(e){this.$layerService.selectFeature(e,!1,!0)},e.prototype.initRecentFeatures=function(){var e=this;this.updateRecentFeaturesList(),this.$messageBus.subscribe("feature",function(t,r){if("onFeatureSelect"===t){e.RecentFeatures=e.RecentFeatures.filter(function(e){return e.id!=r.id});var i={id:r.id,name:csComp.Helpers.getFeatureTitle(r),layerId:r.layerId,feature:r};e.RecentFeatures.splice(0,0,i),e.RecentFeatures.length>5&&e.RecentFeatures.pop();var a=[];e.RecentFeatures.forEach(function(e){return a.push({id:e.id,name:e.name,layerId:e.layerId})}),e.localStorageService.set("recentfeatures",a),"$apply"!=e.$scope.$root.$$phase&&"$digest"!=e.$scope.$root.$$phase&&e.$scope.$apply()}})},e.prototype.toggleLayer=function(e){this.$layerService.toggleLayer(e)},e.prototype.initRecentLayers=function(){var e=this,t=this.localStorageService.get("recentlayers");t&&t.forEach(function(t){var r=e.$layerService.findLayer(t);r&&e.RecentLayers.push(r)}),this.$messageBus.subscribe("layer",function(r,i){"activated"===r&&(e.RecentLayers=e.RecentLayers.filter(function(e){return e.id!=i.id}),e.RecentLayers.splice(0,0,i),e.RecentLayers.length>5&&e.RecentLayers.pop(),t=[],e.RecentLayers.forEach(function(e){return t.push(e.id)}),e.localStorageService.set("recentlayers",t),"$apply"!=e.$scope.$root.$$phase&&"$digest"!=e.$scope.$root.$$phase&&e.$scope.$apply()),
e.updateRecentFeaturesList()})},e.$inject=["$scope","layerService","messageBusService","localStorageService","geoService"],e}();e.NavigateCtrl=r}(Navigate||(Navigate={}));var Search;!function(e){var t=function(){function e(){}return e}();e.NavigateSteps=t;var r=function(){function e(){}return e}();e.NavigateState=r}(Search||(Search={}));var OfflineSearch;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("offlineSearch",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/OfflineSearch/OfflineSearch.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.OfflineSearchCtrl}}])}(OfflineSearch||(OfflineSearch={}));var OfflineSearch;!function(e){var t=function(){function e(e,t,r,i,a,o){this.groupTitle=e,this.index=t,this.id=r,this.title=i,this.path=a,this.type=o,this.featureNames=[]}return e}();e.Layer=t;var r=function(){function e(e,t,r){this.v=Array(2),"number"==typeof e?(this.v[0]=e,this.v[1]=t):this.v=e}return Object.defineProperty(e.prototype,"layerIndex",{get:function(){return this.v[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"featureIndex",{get:function(){return this.v[1]},enumerable:!0,configurable:!0}),e.prototype.toJSON=function(){return this.v},e}();e.Entry=r;var i=function(){function e(){}return e}();e.KeywordIndex=i;var a=function(){function e(e,t){this.project=e,this.options=t,this.layers=[],this.keywordIndex={}}return e}();e.OfflineSearchResult=a}(OfflineSearch||(OfflineSearch={}));var OfflineSearch;!function(e){var t=function(){function e(e,t,r,i){this.title=e,this.layerTitle=t,this.groupTitle=r,this.entry=i,this.firstInGroup=!1}return e.prototype.toString=function(){return this.title},Object.defineProperty(e.prototype,"fullTitle",{get:function(){return this.groupTitle+" >> "+this.layerTitle+" >> "+this.title},enumerable:!0,configurable:!0}),e}();e.OfflineSearchResultViewModel=t;var r=function(){function r(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,this.isReady=!1,e.vm=this,a.subscribe("project",function(e){switch(e){case"loaded":var t=r.projectUrl.url.replace("project.json","offline_search_result.json");o.loadSearchResults(t)}}),a.subscribe("language",function(e,t){switch(e){case"newLanguage":}})}return r.prototype.loadSearchResults=function(t){var r=this;this.$http.get(t).success(function(t){r.offlineSearchResult=t;var i=t.keywordIndex,a={};for(var o in i)i.hasOwnProperty(o)&&i[o].forEach(function(t){a.hasOwnProperty(o)||(a[o]=[]),a[o].push(new e.Entry(t))});r.offlineSearchResult.keywordIndex=a,r.isReady=!0}).error(function(){console.log("OfflineSearch: error with $http ")})},r.prototype.getLocation=function(e,r){if(void 0===r&&(r=15),!this.isReady||null===e||e.length<3)return[];var i=e.toLowerCase().split(" "),a=i[i.length-1],o=this.offlineSearchResult.options.stopWords.filter(function(e){return e.indexOf(a)>-1});o.length>0&&i.splice(i.length-1,1),this.offlineSearchResult.options.stopWords.forEach(function(e){for(;i.indexOf(e)>-1;)i.splice(i.indexOf(e),1)});var s;for(var n in i){var l=this.getKeywordHits(i[n]);s=s?this.mergeResults(s,l):l}for(var c=[],p=this.offlineSearchResult.layers,u=r,h=0;u>0&&h<s.length;)for(var d=s[h++],f=Math.min(u,d.entries.length),y=0;f>y;y++){var m=d.entries[y],g=p[m.layerIndex];u--,c.push(new t(g.featureNames[m.featureIndex],g.title,g.groupTitle,m))}var v={};c.forEach(function(e){var t=e.groupTitle+" >> "+e.layerTitle;v.hasOwnProperty(t)||(v[t]=[]),v[t].push(e)}),c=[];for(var S in v)if(v.hasOwnProperty(S)){var $=!0;v[S].forEach(function(e){e.firstInGroup=$,c.push(e),$=!1})}return c},r.prototype.mergeResults=function(e,t){var r=[];return e.forEach(function(e){t.forEach(function(t){e.entries.forEach(function(i){t.entries.forEach(function(a){i.layerIndex===a.layerIndex&&i.featureIndex===a.featureIndex&&r.push({score:e.score*t.score,key:e.key+" "+t.key,entries:[i]})})})})}),r=r.sort(function(e,t){return t.score-e.score})},r.prototype.getKeywordHits=function(e){var t=[],r=this.offlineSearchResult.keywordIndex,i=Object.getOwnPropertyNames(r);return i.forEach(function(i){var a=i.score(e,null);.5>a||t.push({score:a,key:i,entries:r[i]})}),t=t.sort(function(e,t){return t.score-e.score})},r.prototype.onSelect=function(e){var t=this,r=e.entry.layerIndex,i=this.offlineSearchResult.layers[r],a=this.$layerService.findLayer(i.id);if(console.log(e),a){if(a.enabled)return void this.selectFeature(i.id,e.entry.featureIndex);var o=this.$messageBus.subscribe("layer",function(r,i){"activated"===r&&a.url===i.url&&(t.selectFeature(i.id,e.entry.featureIndex),t.$messageBus.unsubscribe(o))});this.$layerService.addLayer(a);var s=$("#layergroup_"+a.groupId);s.collapse("show")}},r.prototype.selectFeature=function(e,t){var r=this.$layerService.findFeatureByIndex(e,t);null!=r&&(this.$mapService.zoomTo(r),this.$layerService.selectFeature(r))},r.$inject=["$scope","$http","layerService","mapService","messageBusService"],r}();e.OfflineSearchCtrl=r}(OfflineSearch||(OfflineSearch={}));var ProjectHeaderSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("projectHeaderSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/ProjectSelection/ProjectHeaderSelection.tpl.html",link:function(e,t,r){},replace:!0,transclude:!0,controller:e.ProjectHeaderSelectionCtrl}}])}(ProjectHeaderSelection||(ProjectHeaderSelection={}));var ProjectHeaderSelection;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this}return e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.ProjectHeaderSelectionCtrl=t}(ProjectHeaderSelection||(ProjectHeaderSelection={}));var ProjectSettings;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("projectSettings",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/ProjectSettings/ProjectSettings.tpl.html",replace:!0,controller:e.ProjectSettingsCtrl}}])}(ProjectSettings||(ProjectSettings={}));var ProjectSettings;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$timeout=t,this.$layerService=r,e.vm=this}return e.prototype.saveSettings=function(){var e=this;this.$timeout(function(){var t=e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(t,"project","json")},0)},e.prototype.updateProject=function(){var e=this;console.log("Updating project"),this.$timeout(function(){var t=e.$layerService.project.serialize(),r=e.$layerService.projectUrl.url;console.log("URL: "+r),$.ajax({url:r,type:"PUT",data:t,contentType:"application/json",complete:e.updateProjectReady})},0)},e.prototype.updateProjectReady=function(e){"OK"!=e.success().statusText?console.error("Error update project.json: "+JSON.stringify(e)):console.log("Project.json updated succesfully!")},e.$inject=["$scope","$timeout","layerService"],e}();e.ProjectSettingsCtrl=t}(ProjectSettings||(ProjectSettings={}));var Helpers;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("resize",["$window",function(e){return{terminal:!1,restrict:"A",scope:{resizeX:"@",resizeY:"@"},link:function(t,r,i){t.onResizeFunction=function(){if(t.resizeX){var i=e.innerWidth;r.width(i-t.resizeX+"px")}if(t.resizeY){var a=e.innerHeight;r.height(a-t.resizeY+"px")}},t.onResizeFunction(),angular.element(e).bind("resize",function(){t.onResizeFunction(),t.$apply()})}}}])}(t=e.Resize||(e.Resize={}))}(Helpers||(Helpers={}));var ShowModal;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("showModal",["$parse",function(e){return{restrict:"A",link:function(t,r,i){t.showModalDialog=function(e,t){t||(t=r);var i=$(t);e?i.appendTo("body").modal("show"):i.modal("hide")},t.$watch(i.showModal,function(e,r){t.showModalDialog(e,i.$$element)}),$(r).bind("hide.bs.modal",function(){e(i.showModal).assign(t,!1),t.$$phase||t.$root.$$phase||t.$apply()})}}}])}(ShowModal||(ShowModal={}));var StyleList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.filter("reverse",function(){return function(e){return e.slice().reverse()}}).directive("styleList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/StyleList/StyleList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.StyleListCtrl}}])}(StyleList||(StyleList={}));var StyleList;!function(e){var t=function(){function e(){this.properties=[]}return e}();e.Section=t;var r=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.messageBus=r,e.vm=this,r.subscribe("layer",function(e){switch(e){case"activated":case"deactivate":i.initWizard()}})}return e.prototype.initWizard=function(){var e=this;this.$layerService.project.groups&&this.$layerService.project.groups.length>0&&(this.$layerService.project.groups.forEach(function(r){if(r.layers){var i=[],a={};r.layers.forEach(function(t){if(t.enabled){var r=e.$layerService.findResourceByLayer(t);-1===i.indexOf(r)&&i.push(r)}}),i.forEach(function(e){for(var r in e.propertyTypeData){var i=e.propertyTypeData[r];if("number"===i.type){var o=i.section?i.section:"i";a.hasOwnProperty(o)||(a[o]=new t),a[o].properties.push(i)}}}),_.keys(a).length>0&&(r.gui.sections=a),console.log(r.title),console.log(r.gui.sections)}}),this.selectedGroup=this.$layerService.project.groups[0])},e.prototype.setStyle=function(e,t){this.$layerService.setGroupStyle(e,t)},e.prototype.getStyle=function(e,t,r){return{"float":"left",position:"relative",top:"10px",background:"linear-gradient(to bottom, "+t.color+", "+e.legendEntries[e.legendEntries.length-r-2].color+")"}},e.$inject=["$scope","layerService","messageBusService"],e}();e.StyleListCtrl=r}(StyleList||(StyleList={}));var Timeline;!function(e){var t=function(){function e(){this.timelineOptions={width:"100%",height:"100px",editable:!1,layout:"box"}}return e.prototype.setTimelineOptions=function(e){this.timelineOptions=e},e.prototype.$get=function(){var e=this;return{getTimelineOptions:function(){return e.timelineOptions},setTimelineOptions:function(t){return e.setTimelineOptions}}},e}(),r="csComp";try{e.myModule=angular.module(r)}catch(i){e.myModule=angular.module(r,[])}e.myModule.provider("TimelineService",t).directive("timeline",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Timeline/Timeline.tpl.html",replace:!0,transclude:!0,controller:e.TimelineCtrl}}])}(Timeline||(Timeline={}));var Timeline;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$mapService=r,this.$messageBusService=i,this.TimelineService=a,this.locale="en-us",this.expanded=!1,this.isPinned=!0,this.expandButtonBottom=52,this.items=new vis.DataSet,this.ids=[],this.setFocusContainerDebounce=_.debounce(function(e){o.updateFocusTimeContainer(e),console.log("Moved timeline and focuscontainer to "+e)},300,!0),this.loadLocales(),this.options={width:"100%",editable:!1,margin:0,height:"54px"},this.debounceUpdate=_.debounce(this.updateFeatures,500),e.vm=this,this.$messageBusService.subscribe("project",function(e,t){setTimeout(function(){o.updateFocusTime(),o.updateDragging(),o.myTimer(),o.$layerService.project.timeLine.isLive&&o.goLive()},0)}),this.initTimeline(),this.$messageBusService.subscribe("timeline",function(e,t){o.update(e,t)}),this.$messageBusService.subscribe("feature",function(e,t){"onFeatureSelect"===e&&t&&-1!=o.ids.indexOf(t.id)&&o.$scope.timeline.setSelection(t.id)}),this.$messageBusService.subscribe("language",function(e,t){switch(e){case"newLanguage":o.initTimeline()}})}return e.prototype.update=function(e,t){switch(e){case"updateTimerange":this.$scope.timeline.setWindow(t.start,t.end),this.updateFocusTime();break;case"loadProjectTimeRange":if("undefined"==typeof this.$layerService.project||null===this.$layerService.project||"undefined"==typeof this.$layerService.project.timeLine||null===this.$layerService.project.timeLine)return;this.$scope.timeline.setWindow(this.$layerService.project.timeLine.start,this.$layerService.project.timeLine.end),this.updateFocusTime();break;case"setFocus":this.setFocusContainerDebounce(t);break;case"updateFeatures":this.debounceUpdate()}},e.prototype.updateFeatures=function(){var e=this;console.log("timeline:updating features");var t=[],r=!1;this.$layerService.project.features.forEach(function(i){if(r=!0,i.layer.showOnTimeline&&i.properties.hasOwnProperty("date")&&(t.push(i.id),-1===e.ids.indexOf(i.id))){var a={id:i.id,group:"all",content:i.properties.Name,start:new Date(i.properties.date)};e.items.update(a),e.ids.push(i.id)}}),this.ids.forEach(function(i){if(r=!0,-1===t.indexOf(i)){e.items.remove(i);e.ids=e.ids.filter(function(e){return i!=e})}}),r&&this.$scope.timeline.redraw()},e.prototype.initTimeline=function(){for(var e=this,t=document.getElementById("timeline");t.firstChild;)t.removeChild(t.firstChild);this.$layerService.timeline=this.$scope.timeline=new vis.Timeline(t,this.items,this.options),this.$layerService.timeline.redraw(),this.$layerService.project&&null!==this.$layerService.project.timeLine&&(this.$scope.timeline.setWindow(this.$layerService.project.timeLine.start,this.$layerService.project.timeLine.end),this.$layerService.project.timeLine.isLive&&this.goLive()),this.updateDragging(),this.updateFocusTime(),this.$scope.timeline.on("select",function(t){if(t.items&&t.items.length>0){var r=t.items[0],i=e.$layerService.findFeatureById(r);i&&e.$layerService.selectFeature(i)}}),this.$scope.timeline.addEventListener("rangechange",_.throttle(function(t){return e.onRangeChanged(t)},200))},e.prototype.updateDragging=function(){var e=this;this.$layerService.project&&this.$layerService.project.timeLine.isLive?$("#focustimeContainer").draggable("disable"):($("#focustimeContainer").draggable({axis:"x",containment:"parent",drag:_.throttle(function(){return e.updateFocusTime()},200)}),$("#focustimeContainer").draggable("enable"))},e.prototype.expandToggle=function(){this.expanded=!this.expanded,this.options.height=this.expanded?150:54,this.expandButtonBottom=this.expanded?149:52,this.$layerService.timeline.setOptions(this.options),this.$layerService.timeline.redraw()},e.prototype.onRangeChanged=function(e){this.updateFocusTime()},e.prototype.start=function(){var e=this;this.stop(),this.isPlaying=!0,this.timer&&(this.timer=null),this.timer=setInterval(function(){e.myTimer()},500)},e.prototype.goLive=function(){this.stop(),this.$layerService.project.timeLine.isLive=!0,this.isPlaying=!1,this.$layerService.project.timeLine.isLive&&(this.myTimer(),this.start()),this.updateDragging()},e.prototype.stopLive=function(){this.$layerService.project&&(this.stop(),this.$layerService.project.timeLine.isLive=!1,this.isPlaying=!1,this.updateDragging())},e.prototype.myTimer=function(){var e=this.$scope.timeline;if(this.$layerService.project.timeLine.isLive){var t=e._toScreen(new Date);$("#focustimeContainer").css("left",t-65),this.isPinned&&e.moveTo(new Date,{animation:{duration:500,easingFunction:"linear"}}),this.updateFocusTime()}else if(this.isPlaying){var r=e.getWindow(),i=(r.end.getTime()-r.start.getTime())/200;e.setWindow(r.start.getTime()+i,r.end.getTime()+i,{animation:{duration:500,easingFunction:"linear"}}),this.updateFocusTime()}},e.prototype.mouseEnter=function(){this.updateFocusTime(),isNaN(this.focusDate.getTime())||(this.showControl=!0)},e.prototype.mouseLeave=function(){this.isPlaying||(this.showControl=!1)},e.prototype.pin=function(){this.isPinned=!0},e.prototype.unPin=function(){this.isPinned=!1},e.prototype.pinToNow=function(){this.isPinned=!0,this.start()},e.prototype.stop=function(){this.isPlaying=!1,this.timer&&clearInterval(this.timer)},e.prototype.updateFocusTimeContainer=function(e){this.$scope.timeline.moveTo(e),this.$scope.timeline.redraw(),"$apply"!=this.$scope.$$phase&&"$digest"!=this.$scope.$$phase&&this.$scope.$apply();var t=this.$scope.timeline._toScreen(e);$("#focustimeContainer").css("left",t-$("#focustimeContainer").width()/2)},e.prototype.updateFocusTime=function(){var e=this;this.$layerService.project&&setTimeout(function(){var t=e.$scope.timeline;t.showCustomTime=!0;var r=e.$scope.timeline.getWindow(),i=$("#focustimeContainer").position().left+$("#focustimeContainer").width()/2;if(e.$layerService.project.timeLine.isLive?e.focusDate=new Date:e.focusDate=new Date(e.$scope.timeline._toTime(i)),e.startDate=r.start,e.endDate=r.end,null!=e.$layerService.project&&null!=e.$layerService.project.timeLine){var a=e.$layerService.project.timeLine;a.setFocus(e.focusDate,e.startDate,e.endDate);var o=e.focusDate.toLocaleString(e.locale,{month:"long"});switch(a.zoomLevelName){case"decades":e.line1=e.focusDate.getFullYear().toString(),e.line2="";break;case"years":e.line1=e.focusDate.getFullYear().toString(),e.line2=o;break;case"weeks":e.line1=e.focusDate.getFullYear().toString(),e.line2=moment(e.focusDate).format("DD")+" "+o;break;case"milliseconds":e.line1=moment(e.focusDate).format("MM - DD - YYYY"),e.line2=moment(e.focusDate).format("HH:mm:ss.SSS");break;default:e.line1=moment(e.focusDate).format("MM - DD - YYYY"),e.line2=moment(e.focusDate).format("HH:mm:ss")}}"$apply"!=e.$scope.$$phase&&"$digest"!=e.$scope.$$phase&&e.$scope.$apply(),e.$messageBusService.publish("timeline","focusChange",e.focusDate)},0)},e.prototype.loadLocales=function(){"undefined"==typeof vis?(vis={},vis.locales={}):"undefined"==typeof vis.locales&&(vis.locales={}),vis.locales.en={MONTHS:["January","February","March","April","May","June","July","August","September","October","November","December"],MONTHS_SHORT:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],DAYS:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],DAYS_SHORT:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ZOOM_IN:"Zoom in",ZOOM_OUT:"Zoom out",MOVE_LEFT:"Move left",MOVE_RIGHT:"Move right",NEW:"New",CREATE_NEW_EVENT:"Create new event"},vis.locales.en_US=vis.locales.en,vis.locales.en_UK=vis.locales.en,vis.locales.fr={MONTHS:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],MONTHS_SHORT:["Jan","Fev","Mar","Avr","Mai","Jun","Jul","Aou","Sep","Oct","Nov","Dec"],DAYS:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],DAYS_SHORT:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],ZOOM_IN:"Zoomer",ZOOM_OUT:"Dézoomer",MOVE_LEFT:"Déplacer à gauche",MOVE_RIGHT:"Déplacer à droite",NEW:"Nouveau",CREATE_NEW_EVENT:"Créer un nouvel évènement"},vis.locales.fr_FR=vis.locales.fr,vis.locales.fr_BE=vis.locales.fr,vis.locales.fr_CA=vis.locales.fr,vis.locales.de={MONTHS:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],MONTHS_SHORT:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],DAYS:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],DAYS_SHORT:["Son","Mon","Die","Mit","Don","Fre","Sam"],ZOOM_IN:"Vergrößern",ZOOM_OUT:"Verkleinern",MOVE_LEFT:"Nach links verschieben",MOVE_RIGHT:"Nach rechts verschieben",NEW:"Neu",CREATE_NEW_EVENT:"Neues Ereignis erzeugen"},vis.locales.de_DE=vis.locales.de,vis.locales.de_CH=vis.locales.de,vis.locales.nl={MONTHS:["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"],MONTHS_SHORT:["jan","feb","mrt","apr","mei","jun","jul","aug","sep","okt","nov","dec"],DAYS:["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"],DAYS_SHORT:["zo","ma","di","wo","do","vr","za"],ZOOM_IN:"Inzoomen",ZOOM_OUT:"Uitzoomen",MOVE_LEFT:"Naar links",MOVE_RIGHT:"Naar rechts",NEW:"Nieuw",CREATE_NEW_EVENT:"Nieuwe gebeurtenis maken"},vis.locales.nl_NL=vis.locales.nl,vis.locales.nl_BE=vis.locales.nl},e.$inject=["$scope","layerService","mapService","messageBusService","TimelineService"],e}();e.TimelineCtrl=t}(Timeline||(Timeline={}));var TripPlanner;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("tripplanner",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/TripPlanner/TripPlanner.tpl.html",replace:!0,transclude:!0,controller:e.TripPlannerCtrl}}])}(TripPlanner||(TripPlanner={}));var TripPlanner;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.urlKeys=["arriveBy","fromPlace","toPlace","intermediatePlaces","date","time","mode","maxWalkDistance","walkSpeed","bikeSpeed","maxTimeSec","precisionMeters","zDataType","coordinateOrigin"],this.scope=e,e.vm=this,this.layer=e.$parent.data,this.tabs=[],this.tabs.push({icon:"fa-edit",title:"Edit"}),this.tabs.push({icon:"fa-map-marker",title:"Route"}),this.activeTab="Edit",this.urlParameters={},this.urlKeys.forEach(function(e){o.urlParameters[e]=0}),this.bikeSpeedKm,this.walkSpeedKm,this.transportModes={},this.transportModes.Walking="WALK",this.transportModes.Biking="BICYCLE",this.transportModes["Public transport"]="TRANSIT"}return e.prototype.planRoute=function(){this.urlParameters.time=encodeURIComponent(this.time),this.urlParameters.mode=this.transportMode,this.walkSpeedKm&&(this.urlParameters.walkSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.walkSpeedKm)),this.bikeSpeedKm&&(this.urlParameters.bikeSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.bikeSpeedKm)),this.layer.url=csComp.Helpers.joinUrlParameters(this.urlParameters,"?","&","="),this.layer.enabled?this.layer.layerSource&&this.layer.layerSource.refreshLayer(this.layer):this.$layerService.addLayer(this.layer),this.$layerService.visual.rightPanelVisible=!0},e.prototype.parseUrl=function(){this.urlParameters=csComp.Helpers.parseUrlParameters(this.layer.url,"?","&","=");var e=new Date(Date.now());this.time=("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2),this.urlParameters.date=e.getMonth()+1+"-"+e.getDate()+"-"+e.getFullYear(),this.transportMode=this.urlParameters.mode,this.urlParameters.hasOwnProperty("walkSpeed")&&(this.walkSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.walkSpeed).toFixed(2)),this.urlParameters.hasOwnProperty("bikeSpeed")&&(this.bikeSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.bikeSpeed).toFixed(2)),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.featureTabActivated=function(e){var t=this;if(console.log("activated tab"+e),"Route"===e){var r=this.$layerService.findLayer("tripplanner");if(!r)return;if(!r.data.features||0===r.data.features.length)return;this.itineraries=[],r.data.features.forEach(function(e){t.itineraries.push(e.properties)}),this.activeTab="Route"}else this.activeTab="Edit"},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.TripPlannerCtrl=t}(TripPlanner||(TripPlanner={}));var Voting;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("voting",["$timeout",function(e){return{restrict:"EA",require:"^ngModel",scope:{min:"=",max:"=",ngModel:"=",ngChange:"&"},template:'<div style="line-height: 12px; vertical-align: top; margin: 0; background: rgba(0, 0, 0, 0.1); border-radius: 6px; padding: 4px 6px;"><a href="" data-ng-click="decrement()" data-ng-disabled="ngModel <= min" style="float: left;"><i class="fa" data-ng-class="{true: \'fa-minus-square\', false: \'fa-minus-square-o\'}[ngModel > min]"></i></a><span style="float: left; width:28px; text-align: center;">{{ngModel}}</span><a href="" data-ng-click="increment()" data-ng-disabled="ngModel >= max"><i class="fa" data-ng-class="{true: \'fa-plus-square\' , false: \'fa-plus-square-o\' }[ngModel < max]"></i></a></div>',link:function(t){t.increment=function(){t.ngModel>=t.max||(t.ngModel++,e(t.ngChange,0))},t.decrement=function(){t.ngModel<=t.min||(t.ngModel--,e(t.ngChange,0))}}}}])}(Voting||(Voting={}));var csComp;!function(e){var t;!function(t){var r=function(){function e(e,t){this.action=e,this.data=t}return e}();t.ClientMessage=r;var i=function(){function e(e,t){this.topic=e,this.callback=t}return e}();t.MessageBusHandle=i;var a=function(){function e(){this._listeners=[]}return e.prototype.add=function(e){this._listeners.push(e)},e.prototype.remove=function(e){if("function"==typeof e){for(var t=0,r=this._listeners.length;r>t;r++)if(this._listeners[t]===e){this._listeners.splice(t,1);break}}else this._listeners=[]},e.prototype.trigger=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];for(var r={},i=this._listeners.slice(0),a=0,o=i.length;o>a;a++)i[a].apply(r,e||[])},e}();t.TypedEvent=a;var o=function(){function e(e,t,r){this.id=e,this.url=t,this.bus=r,this.cache={},this.subscriptions={},this.events=new a}return e.prototype.unsubscribe=function(e,t){if(this.subscriptions.hasOwnProperty(e)){var r=this.subscriptions[e];r.callbacks=r.callbacks.filter(function(e){return e!=t}),0==r.callbacks.length&&(this.socket.emit(e,{action:"unsubscribe"}),this.socket.removeListener(e,r.serverCallback),r.serverCallback=null,delete this.subscriptions[e])}},e.prototype.reSubscribeAll=function(){console.log("resubscribing...");for(var e in this.subscriptions){console.log("reconnecting "+e);var t=this.subscriptions[e];this.socket.emit("subscribe",{id:t.id,target:t.target,type:t.type})}},e.prototype.disconnectAll=function(){console.log("resubscribing...");for(var e in this.subscriptions){var t=this.subscriptions[e];t.callbacks.forEach(function(e){return e(t.id,{action:"unsubscribed"})})}},e.prototype.subscribe=function(e,t,r){var i,a=this,o=[];for(var s in this.subscriptions)this.subscriptions[s].target==e&&this.subscriptions[s].type==t&&o.push(this.subscriptions[s]);return null==o||0==o.length?(i=new l(e,t),this.socket.emit("subscribe",{id:i.id,target:i.target,type:i.type}),i.callbacks.push(r),this.subscriptions[i.id]=i,i.serverCallback=function(r){"key"===t&&a.bus.publish("keyupdate",e,r),i.callbacks.forEach(function(e){return e(i.id,r)})},this.socket.on(i.id,i.serverCallback)):(i=o[0],i.callbacks.push(r)),i},e.prototype.connect=function(e){var t=this;this.isConnected||this.isConnecting||"undefined"==typeof io||(this.socket=io(),this.isConnecting=!0,this.socket.on("connect",function(){console.log("socket.io connected"),t.isConnecting=!1,t.isConnected=!0,t.events.trigger("connected"),t.reSubscribeAll(),e()}),this.socket.on("disconnect",function(){t.isConnecting=!1,t.isConnected=!1,t.disconnectAll(),t.events.trigger("disconnected")}),this.socket.on("reconnect_attempt",function(){console.log("socket.io reconnect attempt"),t.isConnecting=!0,t.isConnected=!1}),this.socket.on("reconnect_failed",function(){console.log("socket.io reconnect failed"),t.isConnecting=!1}))},e.prototype.disconnect=function(){},e}();t.Connection=o,function(e){e[e.BottomRight=0]="BottomRight",e[e.BottomLeft=1]="BottomLeft",e[e.TopRight=2]="TopRight",e[e.TopLeft=3]="TopLeft"}(t.NotifyLocation||(t.NotifyLocation={}));var s=t.NotifyLocation;!function(e){e[e.Normal=0]="Normal",e[e.Info=1]="Info",e[e.Error=2]="Error",e[e.Success=3]="Success"}(t.NotifyType||(t.NotifyType={}));var n=t.NotifyType,l=function(){function t(t,r){this.target=t,this.type=r,this.callbacks=[],this.id=e.Helpers.getGuid()}return t}();t.ServerSubscription=l;var c=function(){function e(e){this.$translate=e,this.connections={},this.notifications=[],PNotify.prototype.options.styling="fontawesome"}return e.prototype.getConnection=function(e){return this.connections.hasOwnProperty(e)?this.connections[e]:null},e.prototype.initConnection=function(e,t,r){null==e&&(e="");var i=this.getConnection(e);null==i&&(i=new o(e,t,this),this.connections[i.id]=i),this.connections[e].connect(function(){r()})},e.prototype.serverPublish=function(e,t,r){void 0===r&&(r="");var i=this.getConnection(r);return null==i?null:void i.socket.emit(e,t)},e.prototype.serverSendMessage=function(e,t){void 0===t&&(t="");var r=this.getConnection(t);return null==r?null:void r.socket.emit("msg",e)},e.prototype.serverSendMessageAction=function(e,t,i){void 0===i&&(i="");var a=new r(e,t);this.serverSendMessage(a,i)},e.prototype.serverSubscribe=function(e,t,r,a){void 0===a&&(a="");var o=this.getConnection(a);if(null==o)return null;var s=o.subscribe(e,t,r);return new i(s.id,r)},e.prototype.serverUnsubscribe=function(e,t){if(void 0===t&&(t=""),e){var r=this.getConnection(t);return null==r?null:void r.unsubscribe(e.topic,e.callback)}},e.prototype.notifyWithTranslation=function(e,t,r){var i=this;void 0===r&&(r=s.BottomRight),this.$translate(e).then(function(e){i.$translate(t).then(function(t){i.notify(e,t,r)})})},e.prototype.notify=function(e,t,r,i){if(void 0===r&&(r=s.TopRight),void 0===i&&(i=n.Normal),console.log("notify : "+e),this.notifications){this.notifications=this.notifications.filter(function(e){return e.state&&"closed"!==e.state});var a;if(this.notifications.some(function(r){if("closed"===r.state)return!1;if(r.options.title===e){var i=!1,o=r.options.text.split("\n");return o.some(function(e,r,a){if(e.replace(/(\ \<\d+\>$)/,"")===t){var o,s=e.replace(/(\ \<\d+\>$)/,""),n=e.match(/(\ \<\d+\>$)/);return o=n?+n[0].match(/\d+/)+1:2,a[r]=s+" <"+o+">",i=!0,!0}return!1}),i||o.push(t),a=o.join("\n"),r.update({text:a}),!0}return!1}),a)return}var o,l="ui-pnotify-sharp",c={dir1:"",dir2:""};switch(r){case s.BottomLeft:o="stack-bottomleft",c.dir1="up",c.dir2="right";break;case s.TopLeft:o="stack-topleft",c.dir1="down",c.dir2="right";break;default:o="stack-topright",c.dir1="down",c.dir2="left"}var p={title:e,text:t,cornerclass:l,addclass:o,stack:c};switch(i){default:p.icon="fa fa-info";break;case n.Info:p.icon="fa fa-info-circle",p.type="info";break;case n.Error:p.icon="fa fa-exclamation-triangle",p.type="error";break;case n.Success:p.icon="fa fa-thumbs-o-up",p.type="success"}var u={title:e,text:t,cornerclass:"ui-pnotify-sharp",shadow:!1,nonblock:{nonblock:!0,nonblock_opacity:.2},buttons:{closer:!1,sticker:!1},type:"info",hide:!0},h=new PNotify(u);this.notifications.push(h)},e.prototype.confirm=function(e,t,r){var i={title:e,text:t,hide:!1,confirm:{confirm:!0},buttons:{closer:!1,sticker:!1},history:{history:!1},icon:"fa fa-question-circle",cornerclass:"ui-pnotify-sharp",addclass:"stack-topright",stack:{dir1:"down",dir2:"left",firstpos1:25,firstpos2:25}};new PNotify(i).get().on("pnotify.confirm",function(){r(!0)}).on("pnotify.cancel",function(){r(!1)})},e.prototype.notifyBottom=function(e,t){var r={dir1:"up",dir2:"right",spacing1:0,spacing2:0},i={title:"Over Here",text:"Check me out. I'm in a different stack.",addclass:"stack-bar-bottom",cornerclass:"",width:"70%",stack:r};new PNotify(i)},e.prototype.notifyData=function(e){new PNotify(e)},e.prototype.publish=function(t,r,i){e.cache[t]&&e.cache[t].forEach(function(e){return e(r,i)})},e.prototype.subscribe=function(t,r){return e.cache[t]||(e.cache[t]=new Array),e.cache[t].push(r),new i(t,r)},e.prototype.unsubscribe=function(t){var r=t.topic,i=t.callback;e.cache[r]&&e.cache[r].forEach(function(t,a){return t==i?void e.cache[r].splice(a,1):void 0})},e.cache={},e.$inject=["$translate"],e}();t.MessageBusService=c;var p=function(){function e(){}return e.prototype.bind=function(e,t){this.myEvents=this.myEvents||{},this.myEvents[e]=this.myEvents[e]||[],this.myEvents[e].push(t)},e.prototype.unbind=function(e,t){
this.myEvents=this.myEvents||{},e in this.myEvents!=!1&&this.myEvents[e].splice(this.myEvents[e].indexOf(t),1)},e.prototype.unbindEvent=function(e){this.myEvents=this.myEvents||{},this.myEvents[e]=[]},e.prototype.unbindAll=function(){this.myEvents=this.myEvents||{};for(var e in this.myEvents)this.myEvents[e]=!1},e.prototype.trigger=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(this.myEvents=this.myEvents||{},e in this.myEvents!=!1)for(var i=0;i<this.myEvents[e].length;i++)this.myEvents[e][i].apply(this,Array.prototype.slice.call(arguments,1))},e.prototype.registerEvent=function(e){this[e]=function(t,r){return"function"==typeof t&&(r&&this.unbindEvent(e),this.bind(e,t)),this}},e.prototype.registerEvents=function(e){var t=this;e.forEach(function(e){t.registerEvent(e)})},e}();t.EventObj=p;var u="csComp";try{t.myModule=angular.module(u)}catch(h){t.myModule=angular.module(u,[])}t.myModule.service("messageBusService",e.Services.MessageBusService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;this.ctrl=e,this.options=e.$scope.data.generator,this.mb.subscribe("feature",function(e,r){switch(e){case"onFeatureSelect":t.selectFeature(r)}}),e.initChart()},e.prototype.selectFeature=function(e){if(!this.options.hasOwnProperty("featureType")||this.options.featureType===e.fType.name){var t=[];if(this.options.hasOwnProperty("properties")){var r=parseInt(this.ctrl.widget.width.toLowerCase().replace("px","").replace("%",""))-50,i=parseInt(this.ctrl.widget.height.toLowerCase().replace("px","").replace("%",""))-50;this.options.properties instanceof Array?t=this.options.properties:this.options.properties instanceof String&&(t=[this.options.properties]);t.forEach(function(t){e.sensors.hasOwnProperty(t)})}this.ctrl.$scope.data.spec={width:r,height:i,padding:{top:10,left:30,bottom:30,right:10},data:[{name:"table",values:[{x:0,y:28,c:0},{x:0,y:55,c:1},{x:1,y:43,c:0},{x:1,y:91,c:1},{x:2,y:81,c:0},{x:2,y:53,c:1},{x:3,y:19,c:0},{x:3,y:87,c:1},{x:4,y:52,c:0},{x:4,y:48,c:1},{x:5,y:24,c:0},{x:5,y:49,c:1},{x:6,y:87,c:0},{x:6,y:66,c:1},{x:7,y:17,c:0},{x:7,y:27,c:1},{x:8,y:68,c:0},{x:8,y:16,c:1},{x:9,y:49,c:0},{x:9,y:15,c:1}]},{name:"stats",source:"table",transform:[{type:"aggregate",groupby:["x"],summarize:[{field:"y",ops:["sum"]}]}]}],scales:[{name:"x",type:"ordinal",range:"width",points:!0,domain:{data:"table",field:"x"}},{name:"y",type:"linear",range:"height",nice:!0,domain:{data:"stats",field:"sum_y"}},{name:"color",type:"ordinal",range:"category10",domain:{data:"table",field:"c"}}],axes:[{type:"x",scale:"x"},{type:"y",scale:"y"}],marks:[{type:"group",from:{data:"table",transform:[{type:"stack",groupby:["x"],sortby:["c"],field:"y"},{type:"facet",groupby:["c"]}]},marks:[{type:"area",properties:{enter:{interpolate:{value:"monotone"},x:{scale:"x",field:"x"},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:"c"}},update:{fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}}]}]},this.ctrl.updateChart()}},e.prototype.stop=function(){alert("stop")},e}();e.propertySensordataGenerator=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function e(){this.icon="tachometer",this.popover=""}return e}();t.RightPanelTab=r;var i=function(){function r(t,r,i,a,o,s,n,l,c){var p=this;this.$rootScope=t,this.$compile=r,this.$injector=i,this.$location=a,this.$timeout=o,this.$translate=s,this.$messageBusService=n,this.$layerService=l,this.$mapService=c,this.widgetTypes={},this.chartGenerators={},this.mainDashboard=new e.Services.Dashboard,this.dashboards=[],this.dashboards.main=this.mainDashboard,this.chartGenerators["property-sensordata"]=function(){return new e.Services.propertySensordataGenerator(p.$layerService,p)},this.$messageBusService.subscribe("dashboard",function(e,t){}),this.$messageBusService.subscribe("rightpanel",function(e,t){switch(e){case"activate":p.activateTab(t);break;case"deactivate":p.deactivateTab(t);break;case"deactiveContainer":p.deactivateTabContainer(t)}}),this.widgetTypes.indicators={id:"indicators",icon:"bower_components/csweb/dist-bower/images/widgets/indicators.png",description:"Showing sensor data using charts"},this.widgetTypes.charts={id:"charts",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom chart"},this.widgetTypes.markdownwidget={id:"markdownwidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom markdown or html content"},this.widgetTypes.mcawidget={id:"mcawidget",icon:"bower_components/csweb/dist-bower/images/widgets/mca.png",description:"Show available MCA's"},this.widgetTypes.iframewidget={id:"iframewidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom iframe"},this.widgetTypes.kanbanboard={id:"kanbanboard",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show kanbanboard"},this.widgetTypes.navigator={id:"navigatorwidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show navigator"},this.widgetTypes.postman={id:"postman",icon:"bower_components/csweb/dist-bower/images/widgets/Script.png",description:"POST messages"},this.widgetTypes.simtimecontroller={id:"simtimecontroller",icon:"bower_components/csweb/dist-bower/images/widgets/Media-Play.png",description:"Show simulation time controller"},this.widgetTypes.simstate={id:"simstate",icon:"bower_components/csweb/dist-bower/images/widgets/ServerStatus.png",description:"Show status of simulation services."}}return r.prototype.leftMenuVisible=function(e){var t=this.$layerService.project.activeDashboard;return t.visibleLeftMenuItems?t.visibleLeftMenuItems.indexOf(e)>=0:!0},r.prototype.selectDashboard=function(e,t){this.$messageBusService.publish("updatelegend","removelegend"),this.$layerService.project.activeDashboard=e,this.$messageBusService.publish("dashboard-"+t,"activated",e),this.$location.search("dashboard",e.id)},r.prototype.activateTab=function(e){var r=this;if(e.hasOwnProperty("container")){this.$layerService.visual.rightPanelVisible=!0;var i=e.container+"-content";$("#"+e.container+"-tab").remove();var a=$("#"+i);try{a&&a.remove()}catch(o){}var s="";""===e.popover||this.$mapService.expertMode!==t.Expertise.Beginner&&this.$mapService.expertMode!==t.Expertise.Intermediate||(s="popover='"+e.popover+"' popover-placement='left' popover-trigger='mouseenter' popover-append-to-body='true'"),$("#rightpanelTabs").append(this.$compile("<li id='"+e.container+"-tab' class='rightPanelTab rightPanelTabAnimated' "+s+"><a id='"+e.container+"-tab-a' data-target='#"+i+"' data-toggle='tab'><span class='fa fa-"+e.icon+" fa-lg'></span></a></li>")(this.$rootScope)),$("#rightpanelTabPanes").append("<div class='tab-pane' style='width:355px' id='"+i+"'></div>"),$("#"+e.container+"-tab-a").click(function(){r.$layerService.visual.rightPanelVisible=!0,console.log("rp visible"),r.$rootScope.$apply()});var n=this.$rootScope;n.data=e.data;var l=this.$compile("<"+e.directive+"></"+e.directive+">")(n);$("#"+i).append(l),$("#rightpanelTabs a[data-target='#"+i+"']").tab("show")}},r.prototype.deactivateTabContainer=function(e){this.$layerService.visual.rightPanelVisible=!1;var t=e+"-content";$("#"+e+"-tab").remove();try{var r=$("#"+t);r&&r.remove()}catch(i){}},r.prototype.deactivateTab=function(e){e.hasOwnProperty("container")&&this.deactivateTabContainer(e.container)},r.prototype.editWidget=function(t){this.activeWidget=t,this.editWidgetMode=!0;var r=e.Helpers.createRightPanelTab("widget","widgetedit",t,"Edit widget","Edit widget","th-large");if(this.$messageBusService.publish("rightpanel","activate",r),t._ctrl&&t._ctrl.startEdit(),this.$injector.has(t.directive+"EditDirective")){var i=e.Helpers.createRightPanelTab("widget-content",t.directive+"-edit",t,"Edit widget","Edit widget","cog");this.$messageBusService.publish("rightpanel","activate",i)}},r.prototype.stopEditWidget=function(){this.activeWidget=null,this.editWidgetMode=!1,$("#widgetEdit").removeClass("active")},r.prototype.removeWidget=function(){var e=this;this.activeWidget&&this.mainDashboard&&(this.mainDashboard.widgets=this.mainDashboard.widgets.filter(function(t){return t.id!=e.activeWidget.id}),this.activeWidget=null,$('#leftPanelTab a[data-target="#basewidgets"]').tab("show"))},r.$inject=["$rootScope","$compile","$injector","$location","$timeout","$translate","messageBusService","layerService","mapService"],r}();t.DashboardService=i;var a="csComp";try{t.myModule=angular.module(a)}catch(o){t.myModule=angular.module(a,[])}t.myModule.service("dashboardService",e.Services.DashboardService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function e(){}return e}();t.Coordinates=r;var i=function(){function e(){}return e}();t.Geoposition=i;var a=function(){function e(e,t,r,i){this.bus=e,this.$rootScope=t,this.$window=r,this.$q=i,this.geolocation_msgs={"errors.location.unsupportedBrowser":"Browser does not support location services","errors.location.permissionDenied":"You have rejected access to your location","errors.location.positionUnavailable":"Unable to determine your location","errors.location.timeout":"Service timeout has been reached"}}return e.prototype.getLocation=function(){return this.position},e.prototype.start=function(e){var t=this;e||(e={enableHighAccuracy:!0,maximumAge:3e3}),this.$window.navigator&&this.$window.navigator.geolocation&&this.$window.navigator.geolocation.watchPosition(function(e){t.position=e,t.bus.publish("geo","pos",e)},function(e){switch(alert(e),e.code){case 1:break;case 2:break;case 3:}},e)},e.$inject=["messageBusService","$rootScope","$window","$q"],e}();t.GeoService=a;var o="csComp";try{t.myModule=angular.module(o)}catch(s){t.myModule=angular.module(o,[])}t.myModule.service("geoService",e.Services.GeoService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var ContourAction;!function(e){var t=function(){function e(){this.id="ContourActionModel"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.getFeatureActions=function(e){return[]},e.prototype.getFeatureHoverActions=function(e){if(!e)return[];var t={title:"show"};t.callback=this.showContour;var r={title:"hide"};return r.callback=this.hideContour,[t,r]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.showContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour);var r=t.getFeatureType(e);if(r&&r.hasOwnProperty("contourProperty")&&e.properties.hasOwnProperty(r.contourProperty)){var i=JSON.parse(e.properties[r.contourProperty]);t.currentContour=L.geoJson(i),t.currentContour.addTo(t.map.map)}},e.prototype.hideContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour)},e.prototype.init=function(e){console.log("init ContourActionService")},e}();e.ContourActionModel=t}(ContourAction||(ContourAction={}));var csComp;!function(e){var t;!function(e){"use strict";var t=function(){function e(){this.id="LayerActions"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.getFeatureActions=function(e){if(e.layer.isDynamic){var t={title:"Edit"};return t.callback=this.setAsFilter,[t]}return[]},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.setAsFilter=function(e,t){t.editFeature(e)},e.prototype.init=function(e){console.log("init LayerActions"),this.layerService=e},e}();e.LayerActions=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";!function(e){e[e.Context=0]="Context",e[e.Hover=1]="Hover"}(t.ActionType||(t.ActionType={}));var r=t.ActionType,i=function(){function i(r,i,a,o,s,n,l,c){var p=this;this.$location=r,this.$compile=i,this.$translate=a,this.$messageBusService=o,this.$mapService=s,this.$rootScope=n,this.geoService=l,this.$http=c,this.loadedLayers=new e.Helpers.Dictionary,this.actionServices=[],this.visual=new t.VisualState,this.mb=o,this.map=s,this.openSingleProject=!1,this.emptySolutionUrl="data/api/defaultSolution.json",this.accentColor="",this.title="",this.typesResources={},this._featureTypes={},this.propertyTypeData={},this.selectedFeatures=[],this.currentLocale=a.preferredLanguage(),this.mapRenderers={},this.visual=new t.VisualState,this.mapRenderers.leaflet=new t.LeafletRenderer,this.mapRenderers.leaflet.init(this),this.mapRenderers.cesium=new t.CesiumRenderer,this.mapRenderers.cesium.init(this),this.initLayerSources(),this.throttleTimelineUpdate=_.throttle(this.updateAllLogs,500),o.subscribe("timeline",function(e){switch(e){case"focusChange":p.updateSensorData(),p.throttleTimelineUpdate()}}),o.subscribe("language",function(e,t){switch(e){case"newLanguage":p.currentLocale=t,o.notifyWithTranslation("LAYER_SERVICE.RELOAD_PROJECT_TITLE","LAYER_SERVICE.RELOAD_PROJECT_MSG"),p.openProject(p.projectUrl)}}),o.subscribe("mapbbox",function(e,t){if("update"===e)for(var r in p.loadedLayers){var i=p.loadedLayers[r];i.refreshBBOX&&(i.BBOX=t,i.layerSource.refreshLayer(i))}}),o.subscribe("geo",function(e,t){switch(e){case"pos":}}),this.addActionService(new t.LayerActions);var u=_.throttle(function(e){for(var t in p.loadedLayers){var r=p.loadedLayers[t];r.timeDependent&&r.layerSource.refreshLayer(r)}},1e3);o.subscribe("timeline",function(e,t){"focusChange"===e&&u(t)}),this.checkMobile(),this.enableDrop()}return i.prototype.enableDrop=function(){var e=this,t=window;if(t.File&&t.FileList&&t.FileReader){console.log("enable drop");var r=$("body");r.on("dragenter",function(t){t.stopPropagation(),t.preventDefault(),$(e).css("border","2px solid #0B85A1")}),r.on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),r.on("drop",function(t){$(e).css("border","2px dotted #0B85A1"),t.preventDefault();var i=t.originalEvent,a=i.dataTransfer.files;a.length>1?e.$messageBusService.notify("File upload","Only one file at a time permitted"):e.handleFileUpload(a,r)})}},i.prototype.handleFileUpload=function(t,r){for(var i=this,a=0;a<t.length;a++){var o=t[a];console.log(o);var s=new FileReader;s.onload=function(t){var r=t.target.result,a=JSON.parse(r);if(a&&a.type&&["featurecollection","geojson","dynamicgeojson"].indexOf(a.type.toLowerCase())>=0){var s=new e.Services.ProjectLayer,n=o.name.toLowerCase().replace(".json","").replace(".geojson","");s.id=n,s.title=n,s.type="dynamicgeojson",s.groupId=i.project.groups[0].id,s.group=i.project.groups[0],s.data=a,i.$messageBusService.publish("layerdrop","new",s)}else i.$messageBusService.notify("File upload","File format not recognized")},s.readAsText(o)}},i.prototype.checkMobile=function(){screen.width<=719&&(this.isMobile=!0)},i.prototype.getActions=function(e,t){if(e&&"number"==typeof t){var i=[];return t===r.Context?(this.actionServices.forEach(function(t){var r=t.getFeatureActions(e);r&&(i=i.concat(r))}),i.forEach(function(t){t.feature=e})):t===r.Hover&&(this.actionServices.forEach(function(t){var r=t.getFeatureHoverActions(e);r&&(i=i.concat(r))}),i.forEach(function(t){t.feature=e})),i}},i.prototype.addActionService=function(e){var t=!1;this.actionServices.some(function(r){return r.id===e.id?(t=!0,!0):!1}),t?console.log("Actionservice "+e.id+" already exists."):(this.actionServices.push(e),e.init(this))},i.prototype.removeActionService=function(e){e.stop()},i.prototype.findDashboardById=function(e){var t;return this.project.dashboards.some(function(r){return r.id!==e?!1:(t=r,!0)}),t},i.prototype.findWidgetById=function(e,t){var r,i;if(t){if(r=this.findDashboardById(t),!r)return null;r.widgets.some(function(t){return t.id!==e?!1:(i=t,!0)})}else this.project.dashboards.some(function(t){return t.widgets.some(function(t){return t.id!==e?!1:(i=t,!0)}),i?!0:!1});return i},i.prototype.initLayerSources=function(){this.layerSources={};var e=new t.GeoJsonSource(this,this.$http);this.layerSources.geojson=e,this.layerSources.topojson=e,this.layerSources.dynamicgeojson=new t.DynamicGeoJsonSource(this,this.$http),this.layerSources.esrijson=new t.EsriJsonSource(this,this.$http);var r=new t.KmlDataSource(this,this.$http);this.layerSources.kml=r,this.layerSources.gpx=r,this.layerSources.wms=new t.WmsSource(this),this.layerSources.tilelayer=new t.TileLayerSource(this),this.layerSources.heatmap=new t.HeatmapSource(this),this.layerSources.hierarchy=new t.HierarchySource(this,this.$http),this.layerSources.grid=new t.GridDataSource(this,this.$http),this.layerSources.daynight=new t.NightDayDataSource(this,this.$http),this.layerSources.rss=new t.RssDataSource(this,this.$http),this.layerSources.database=new t.DatabaseSource(this),this.checkFeatureSubLayers()},i.prototype.removeSubLayers=function(t){var r=this;if(t&&t.fType){var i=e.Helpers.getPropertyTypes(t.fType,this.propertyTypeData);i.forEach(function(e){if("layer"===e.type&&t.properties.hasOwnProperty(e.label)){var i=t.properties[e.label];if(r.loadedLayers.containsKey(i)){r.loadedLayers[i];r.removeLayer(r.loadedLayers[i],!0)}}})}},i.prototype.checkFeatureSubLayers=function(){var r=this;this.$messageBusService.subscribe("feature",function(i,a){if(a&&a.fType){var o=e.Helpers.getPropertyTypes(a.fType,r.propertyTypeData);switch(i){case"onFeatureDeselect":break;case"onFeatureSelect":o.forEach(function(e){if("matrix"===e.type&&e.layerProps&&"automatic"===e.layerProps.activation&&a.properties.hasOwnProperty(e.label)){var i=a.properties[e.label];r.project.features.forEach(function(t){if(t.layer==a.layer&&t.properties.hasOwnProperty(e.targetid)&&i.hasOwnProperty(t.properties[e.targetid])){var r=i[t.properties[e.targetid]];for(var o in r)t.properties[o]=r[o]}}),r.updateGroupFeatures(a.layer.group)}if("layer"===e.type&&a.properties.hasOwnProperty(e.label)){e.layerProps&&"automatic"===e.layerProps.activation&&r.removeSubLayers(a.layer.lastSelectedFeature),a.layer.lastSelectedFeature=a;var o=a.properties[e.label],s=r.findLayer(o);s?r.addLayer(s):("string"==typeof o?(s=new t.ProjectLayer,s.url=o):s=o,s.id||(s.id=o),s.groupId="Wegen",s.group?"string"==typeof s.group&&(s.group=r.findGroupById(s.group)):s.groupId?s.group=r.findGroupById(s.groupId):s.group=a.layer.group,s.type||(s.type=a.layer.type),s.title||(s.title=a.properties.Name+" "+e.title),s.defaultFeatureType||(s.defaultFeatureType="link"),s.typeUrl||(s.typeUrl="api/resources/smartcycling"),s.group.layers.push(s)),r.addLayer(s)}})}}})},i.prototype.loadRequiredLayers=function(e){var t=this,r=e.type.toLowerCase();if(this.layerSources.hasOwnProperty(r)&&this.layerSources[r].requiresLayer){var i=this.layerSources[r].getRequiredLayers(e)||[];i.forEach(function(e){t.addLayer(e)})}},i.prototype.addLayer=function(e,t,r){var i=this;if(void 0===r&&(r=null),(!this.loadedLayers.containsKey(e.id)||e.quickRefresh&&0!=e.quickRefresh)&&!e.isLoading){e.isLoading=!0,this.$messageBusService.publish("layer","loading",e);var a=[];async.series([function(t){e.group.oneLayerActive&&e.group.layers.forEach(function(t){t.id!==e.id&&t.enabled&&a.push(t)}),t(null,null)},function(t){console.log("loading types : "+e.typeUrl),e.typeUrl?i.loadTypeResources(e.typeUrl,e.dynamicResource||!1,function(){return t(null,null)}):t(null,null)},function(a){i.loadRequiredLayers(e),"featurecollection"===e.type.toLowerCase()&&(e.type="geojson");var o=e.type.toLowerCase();return i.layerSources.hasOwnProperty(o)?(e.layerSource=i.layerSources[o],"database"===e.type&&i.$messageBusService.serverSubscribe(e.id,"layer",function(e,t){console.log(t),"layer-update"===t.action&&(t.data.group||(t.data.group=i.findGroupByLayerId(t.data)),i.addLayer(t.data,function(){}))}),e.layerSource.addLayer(e,function(r){t&&t(e),r.enabled&&(i.loadedLayers[e.id]=r,i.updateSensorData(),i.updateAllLogs(),i.activeMapRenderer.addLayer(e),e.defaultLegendProperty&&i.checkLayerLegend(e,e.defaultLegendProperty),i.checkLayerTimer(e),i.$messageBusService.publish("updatelegend","updatedstyle")),i.$messageBusService.publish("layer","activated",e)},r),i.$messageBusService.publish("timeline","updateFeatures"),void a(null,null)):(e.isLoading=!1,void a(null,null))},function(e){a.forEach(function(e){i.removeLayer(e),e.enabled=!1}),e(null,null)}])}},i.prototype.saveResource=function(t){console.log("saving feature type"),this.$http.post("/api/resources",e.Helpers.cloneWithoutUnderscore(t)).success(function(e){console.log("resource saved")}).error(function(e){console.log("error saving resource")})},i.prototype.expandGroup=function(e){if(e&&e.group){var t="#layergroup_"+e.group.id;$(t).collapse("show"),$('*[data-target="'+t+'"]').removeClass("collapsed"),"$apply"!==this.$rootScope.$root.$$phase&&"$digest"!==this.$rootScope.$root.$$phase&&this.$rootScope.$apply()}},i.prototype.collapseAll=function(){this.project.groups.forEach(function(e){var t=!1;if(e.layers.some(function(e){return e.enabled&&(t=!0),e.enabled}),!t){var r="#layergroup_"+e.id;$(r).collapse("hide"),$('*[data-target="'+r+'"]').addClass("collapsed")}})},i.prototype.expandAll=function(){this.project.groups.forEach(function(e){var t="#layergroup_"+e.id;$(t).hasClass("in")||($(t).collapse("show"),$('*[data-target="'+t+'"]').removeClass("collapsed"))})},i.prototype.loadTypeResources=function(e,t,r){var i=this;if(e)if("string"==typeof e)if(!this.typesResources.hasOwnProperty(e)||t){var a=!1;this.$http.get(e).success(function(t){if(a=!0,!t||"string"==typeof t&&"null"!==t)i.$messageBusService.notify("Error loading resource type",e);else{var o=t;o&&(o.url=e,i.initTypeResources(o),i.$messageBusService.publish("typesource",e,o))}r()}).error(function(t){i.$messageBusService.notify("ERROR loading TypeResources","While loading: "+e),console.log(t)}),setTimeout(function(){a||r()},3e3)}else this.initTypeResources(this.typesResources[e]),r();else r()},i.prototype.allLayers=function(){var e=[];return null==this.project||null==this.project.groups?[]:(this.project.groups.forEach(function(t){t.layers&&(e=e.concat(t.layers))}),e)},i.prototype.initTypeResources=function(e){this.typesResources[e.url]=e,e.title||(e.title=e.url);var t=e.featureTypes;if(t)for(var r in t){var i=e.url+"#"+r,a=t[r];a.id=i,this.initFeatureType(a),this._featureTypes[i]=a}if(e.propertyTypeData)for(var o in e.propertyTypeData){var s=e.propertyTypeData[o];s.id=e.url+"#"+o,this.initPropertyType(s),s.label||(s.label=o),this.propertyTypeData[o]=s}},i.prototype.checkLayerLegend=function(r,i){var a=this,o=this.propertyTypeData[i];if(o&&o.legend){var s;r.group.styles&&r.group.styles.length>0?s=r.group.styles[0]:(s=new t.GroupStyle(this.$translate),r.group.styles.push(s)),s.title=o.title,s.id=e.Helpers.getGuid(),s.activeLegend=o.legend,s.group=r.group,s.property=o.label,s.legends[o.title]=o.legend,s.colorScales[o.title]=["purple","purple"],s.enabled=!0,s.visualAspect=o.legend.visualAspect?o.legend.visualAspect:"strokeColor",this.saveStyle(r.group,s),this.project.features.forEach(function(e){e.layer===r&&(a.calculateFeatureStyle(e),a.activeMapRenderer.updateFeature(e))}),this.mb.publish("updatelegend","title",i)}else this.project.features.some(function(e){if(e.properties.hasOwnProperty(i)){var t=a.getPropertyType(e,i);return a.setStyle({feature:e,property:i,key:t.title||i}),!0}return!1})},i.prototype.checkLayerTimer=function(e){e.refreshTimeInterval&&(e.enabled?e.timerToken||(e.timerToken=setInterval(function(){e.layerSource.refreshLayer(e)},1e3*e.refreshTimeInterval),console.log("Timer started for "+e.title+": "+e.timerToken)):e.timerToken&&(clearInterval(e.timerToken),e.timerToken=null))},i.prototype.removeStyle=function(e){var t=e.group;t.styles=t.styles.filter(function(t){return t.id!==e.id}),this.$messageBusService.publish("updatelegend","updatedstyle"),this.updateGroupFeatures(t)},i.prototype.updatePropertyStyle=function(e,t,r){var i;if(i=r.style.legends[e],i&&i.legendEntries.length>0){var a=i.legendEntries[0],o=i.legendEntries[i.legendEntries.length-1];r.style.colors=[a.color,o.color]}else r.style.colors=t;r.style.activeLegend=i,this.$messageBusService.publish("updatelegend","updatedstyle")},i.prototype.updateStyle=function(e){if(null!=e)if(e.property&&"gridlayer"===e.property){if(!e.group||!e.group.layers)return;e.group.layers.forEach(function(t){if(t.mapLayer&&t.enabled){var r=t.mapLayer.getLayers();r.forEach(function(t){t.redraw&&"function"==typeof t.redraw&&(t.params({minColor:e.colors[0],maxColor:e.colors[1],areColorsUpdated:!0}),t.redraw())})}})}else null!=e.group&&null!=e.group.styles[0]&&(e.group.styles[0].fixedColorRange?e.info=e.group.styles[0].info:e.info=this.calculatePropertyInfo(e.group,e.property),e.canSelectColor=e.visualAspect.toLowerCase().indexOf("color")>-1,this.updateGroupFeatures(e.group))},i.prototype.updateGroupFeatures=function(e){var t=this;e&&this.project.features.forEach(function(r){r.layer.group==e&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},i.prototype.updateLayerFeatures=function(e){var t=this;e&&this.project.features.forEach(function(r){r.layer.id===e.id&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},i.prototype.updateCanvasOverlay=function(e){if(e&&e.mapLayer){var t=e.mapLayer.getLayers();t.forEach(function(t){if(t.redraw&&"function"==typeof t.redraw){var r=+e.opacity/100;r=Math.min(1,Math.max(0,r)),t.params({opacity:r}),t.redraw()}})}},i.prototype.updateFeatureTypes=function(e){var t=this;this.project.features.forEach(function(r){r.featureTypeName===e.id&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},i.prototype.selectRenderer=function(e){this.activeMapRenderer&&this.activeMapRenderer.title===e||(this.activeMapRenderer&&this.activeMapRenderer.disable(),this.mapRenderers.hasOwnProperty(e)&&(this.activeMapRenderer=this.mapRenderers[e],this.activeMapRenderer.enable()))},i.prototype.editFeature=function(e){e.gui.editMode=!0,this.selectFeature(e)},i.prototype.deselectFeature=function(e){e.isSelected=!1,this.calculateFeatureStyle(e),this.activeMapRenderer.updateFeature(e)},i.prototype.selectFeature=function(t,r,i){var a=this;void 0===r&&(r=!1),void 0===i&&(i=!1),i?t.isSelected=!0:t.isSelected=!t.isSelected,t.gui.title=e.Helpers.getFeatureTitle(t),this.actionServices.forEach(function(e){t.isSelected?e.selectFeature(t):e.deselectFeature(t)}),null==this.lastSelectedFeature||this.lastSelectedFeature===t||r||(this.deselectFeature(this.lastSelectedFeature),this.$messageBusService.publish("feature","onFeatureDeselect",this.lastSelectedFeature)),t.isSelected&&(this.lastSelectedFeature=t),this.calculateFeatureStyle(t),this.activeMapRenderer.updateFeature(t),r?t.isSelected?-1===this.selectedFeatures.indexOf(t)&&this.selectedFeatures.push(t):this.selectedFeatures.indexOf(t)>=0&&(this.selectedFeatures=this.selectedFeatures.filter(function(e){return e.id!==t.id})):(this.selectedFeatures.forEach(function(e){e!=t&&a.deselectFeature(e)}),this.selectedFeatures=t.isSelected?[t]:[]),t.isSelected?this.$messageBusService.publish("feature","onFeatureSelect",t):this.$messageBusService.publish("feature","onFeatureDeselect",t)},i.prototype.updateAllLogs=function(){var e=this;null!=this.project&&null!=this.project.timeLine&&null!=this.project.features&&this.project.features.forEach(function(t){t.layer.isDynamic&&t.layer.useLog&&e.updateLog(t)})},i.prototype.lookupLog=function(e,t){if(!e||0==e.length)return{};var r=e;if(t<=r[0].ts)return r[0];if(t>=r[e.length-1].ts)return r[r.length-1];for(var i={},a=0;a<r.length;a++)if(r[a].ts>t){i=r[a];break}return i},i.prototype.updateLog=function(e){var t=this.project.timeLine.focus,r=!1;if(e.logs&&!this.isLocked(e)){for(var i in e.logs){var a=this.lookupLog(e.logs[i],t);"~geometry"===i?a.value!=e.geometry&&(e.geometry=a.value,r=!0):e.properties.hasOwnProperty(i)?e.properties[i]!=a.value&&(e.properties[i]=a.value,r=!0):(e.properties[i]=a.value,r=!0)}r&&(this.calculateFeatureStyle(e),this.updateFeature(e))}},i.prototype.updateFeature=function(e){this.activeMapRenderer.updateFeature(e),e===this.lastSelectedFeature&&this.$messageBusService.publish("feature","onFeatureUpdated")},i.prototype.updateSensorData=function(){var e=this;if(null!=this.project&&null!=this.project.timeLine&&null!=this.project.features){var t=this.project.timeLine.focus,r={};this.project.datasources&&this.project.datasources.forEach(function(e){for(var r in e.sensors){var i=e.sensors[r];if(i.timestamps)if(1==i.timestamps.length)i.activeValue=i.values[0];else for(var a=1;a<i.timestamps.length;a++)if(i.timestamps[a]<t){i.activeValue=i.values[a];break}}}),this.project.features.forEach(function(i){var a=i.layer;if(null!=a&&(i.sensors||i.coordinates)){var o=function(e,t){for(var r=1;r<t.length;r++)if(t[r]>e)return r;return t.length-1},s=0;if(i.timestamps?s=o(t,i.timestamps):a.timestamps&&(r.hasOwnProperty(i.layerId)?s=r[i.layerId]:(s=o(t,a.timestamps),r[i.layerId]=s)),i.coordinates&&i.geometry&&i.coordinates.length>s&&i.coordinates[s]!=i.geometry.coordinates&&(i.geometry.coordinates=i.coordinates[s],a.group.markers.hasOwnProperty(i.id))){var n=a.group.markers[i.id];n.setLatLng(new L.LatLng(i.geometry.coordinates[1],i.geometry.coordinates[0]))}if(i.sensors){for(var l in i.sensors){var c=i.sensors[l],p=c[s];i.properties[l]=p}e.calculateFeatureStyle(i),e.activeMapRenderer.updateFeature(i),i.isSelected&&e.$messageBusService.publish("feature","onFeatureUpdated",i)}}})}},i.prototype.filterProperties=function(e){var t=[];return null!=e.filters&&e.filters.length>0&&e.filters.forEach(function(e){t.push(e.property)}),t},i.prototype.initFeature=function(t,r,i,a){if(void 0===i&&(i=!1),void 0===a&&(a=!0),!t._isInitialized){t._isInitialized=!0,t.gui={},t.logs||(t.logs={}),null==t.properties&&(t.properties={}),t.index=r.count++,null==t.id&&(t.id=e.Helpers.getGuid()),t.layerId=r.id,t.layer=r,this.project.features.push(t),r.group.ndx.add([t]),t.fType=this.getFeatureType(t);var o=this.findResourceByFeature(t);this.initFeatureType(t.fType),e.Helpers.addPropertyTypes(t,t.fType,o),t.properties.hasOwnProperty("Name")||e.Helpers.setFeatureName(t,this.propertyTypeData),this.calculateFeatureStyle(t),t.propertiesOld={},r.useLog&&this.trackFeature(t),i&&"$apply"!=this.$rootScope.$root.$$phase&&"$digest"!=this.$rootScope.$root.$$phase&&this.$rootScope.$apply(),a&&this.$messageBusService.publish("timeline","updateFeatures")}return t.type},i.prototype.removeFeature=function(e,t){if(void 0===t&&(t=!1),this.project.features=this.project.features.filter(function(t){return t!=e}),e.layer.data.features=e.layer.data.features.filter(function(t){return t!=e}),e.layer.group.filterResult&&(e.layer.group.filterResult=e.layer.group.filterResult.filter(function(t){return t!=e})),e.layer.group.ndx.remove([e]),this.activeMapRenderer.removeFeature(e),t){var r=new a;r.layerId=e.layerId,r.action=o.deleteFeature,r.item=e.id,this.$messageBusService.serverSendMessageAction("layer",r)}},i.prototype.calculateFeatureStyle=function(t){var r=e.Helpers.getDefaultFeatureStyle(t),i=this.getFeatureType(t);i.style&&(i.style.nameLabel&&(r.nameLabel=i.style.nameLabel),i.style.iconUri&&(r.iconUri=i.style.iconUri),i.style.fillOpacity&&(r.fillOpacity=i.style.fillOpacity),i.style.opacity&&(r.opacity=i.style.opacity),i.style.fillColor&&(r.fillColor=e.Helpers.getColorString(i.style.fillColor)),"undefined"!=typeof i.style.stroke&&(r.stroke=i.style.stroke),i.style.strokeColor&&(r.strokeColor=e.Helpers.getColorString(i.style.strokeColor,"#fff")),"undefined"!=typeof i.style.strokeWidth&&(r.strokeWidth=i.style.strokeWidth),i.style.selectedStrokeColor&&(r.selectedStrokeColor=e.Helpers.getColorString(i.style.selectedStrokeColor,"#000")),i.style.selectedFillColor&&(r.selectedFillColor=e.Helpers.getColorString(i.style.selectedFillColor)),
i.style.selectedStrokeWidth&&(r.selectedStrokeWidth=i.style.selectedStrokeWidth),i.style.iconWidth&&(r.iconWidth=i.style.iconWidth),i.style.iconHeight&&(r.iconHeight=i.style.iconHeight),i.style.modelUri&&(r.modelUri=i.style.modelUri),i.style.modelScale&&(r.modelScale=i.style.modelScale),i.style.modelMinimumPixelSize&&(r.modelMinimumPixelSize=i.style.modelMinimumPixelSize),i.style.innerTextProperty&&(r.innerTextProperty=i.style.innerTextProperty),i.style.innerTextSize&&(r.innerTextSize=i.style.innerTextSize),i.style.cornerRadius&&(r.cornerRadius=i.style.cornerRadius),i.style.rotateProperty&&t.properties.hasOwnProperty(i.style.rotateProperty)&&(r.rotate=Number(t.properties[i.style.rotateProperty]))),t.gui.style={},r.opacity=t.layer.isTransparent?0:r.opacity*(t.layer.opacity/100),r.fillOpacity=t.layer.isTransparent?0:r.fillOpacity*(t.layer.opacity/100),t.layer.group.styles.forEach(function(i){if(i.enabled&&t.properties.hasOwnProperty(i.property)){var a=Number(t.properties[i.property]);if(isNaN(a)){var o=t.properties[i.property];switch(i.visualAspect){case"strokeColor":r.strokeColor=e.Helpers.getColorFromStringValue(o,i),t.gui.style[i.property]=r.strokeColor;break;case"fillColor":r.fillColor=e.Helpers.getColorFromStringValue(o,i),t.gui.style[i.property]=r.fillColor}}else switch(i.visualAspect){case"strokeColor":r.strokeColor=e.Helpers.getColor(a,i),t.gui.style[i.property]=r.strokeColor;break;case"fillColor":r.fillColor=e.Helpers.getColor(a,i),t.gui.style[i.property]=r.fillColor;break;case"strokeWidth":r.strokeWidth=(a-i.info.min)/(i.info.max-i.info.min)*10+1;break;case"height":r.height=(a-i.info.min)/(i.info.max-i.info.min)*25e3}}}),t.isSelected&&(r.strokeWidth=r.selectedStrokeWidth||3,r.strokeColor=r.selectedStrokeColor||"black",r.selectedFillColor&&(r.fillColor=r.selectedFillColor)),t.effectiveStyle=r},i.prototype.initFeatureType=function(e){var t=this;if(!e._isInitialized){if(e._isInitialized=!0,this.initIconUri(e),null!=e.languages&&this.currentLocale in e.languages){var r=e.languages[this.currentLocale];r.name&&(e.name=r.name)}if(null!=e.propertyTypeData&&0!=e.propertyTypeData.length)if(e.propertyTypeData.forEach)e.propertyTypeData.forEach(function(e){t.initPropertyType(e)});else for(var i in e.propertyTypeData)e.propertyTypeData.hasOwnProperty(i)&&this.initPropertyType(e.propertyTypeData[i])}},i.prototype.initIconUri=function(e){if(e.style.iconUri){var t=/^(http[s]?:\/\/[:a-zA-Z0-9_\.]+)\/.*$/g,r=t.exec(e.id);r&&r.length>1&&(e.style.iconUri=r[1]+"/"+e.style.iconUri)}},i.prototype.initPropertyType=function(e){this.setDefaultPropertyType(e),null!=e.languages&&this.localizePropertyType(e)},i.prototype.setDefaultPropertyType=function(e){e.type||(e.type="text"),"undefined"==typeof e.title&&(e.title=e.label),"undefined"==typeof e.canEdit&&(e.canEdit=!1),"undefined"==typeof e.visibleInCallOut&&(e.visibleInCallOut=!0),"undefined"==typeof e.isSearchable&&"text"===e.type&&(e.isSearchable=!0)},i.prototype.localizePropertyType=function(e){if(null!=e.languages&&this.currentLocale in e.languages){var t=e.languages[this.currentLocale];t.title&&(e.title=t.title),t.description&&(e.description=t.description),t.section&&(e.section=t.section),null!=t.options&&(e.options=t.options)}},i.prototype.findResourceByLayer=function(e){return e&&e.typeUrl&&this.typesResources.hasOwnProperty(e.typeUrl)?this.typesResources[e.typeUrl]:null},i.prototype.findResourceByFeature=function(e){if(e.layer&&e.layer.typeUrl){var t=e.layer.typeUrl;return this.typesResources.hasOwnProperty(t)?this.typesResources[t]:null}return null},i.prototype.findFilter=function(e,t){null==e.filters&&(e.filters=[]);var r=e.filters.filter(function(e){return e.property===t});return r.length>0?r[0]:null},i.prototype.findFeatureByIndex=function(e,t){for(var r=0;r<this.project.features.length;r++){var i=this.project.features[r];if(t===i.index&&e===i.layerId)return i}},i.prototype.findFeatureById=function(e){return _.find(this.project.features,function(t){return t.id===e})},i.prototype.findFeature=function(e,t){return e.data&&e.data.features?_.find(e.data.features,function(e){return e.id===t}):null},i.prototype.findGroupById=function(e){for(var t=0;t<this.project.groups.length;t++)if(this.project.groups[t].id===e)return this.project.groups[t];return null},i.prototype.findGroupByLayerId=function(e){if(!e.id)return null;var t;return this.project.groups.some(function(r){return r.layers&&r.layers.some(function(i){return i.id===e.id?(t=r,!0):!1}),t?!0:!1}),t},i.prototype.findFeatureByName=function(e){for(var t=0;t<this.project.features.length;t++){var r=this.project.features[t];if(r.hasOwnProperty("Name")&&e===r.properties.Name)return r}},i.prototype.findLoadedLayer=function(e){return this.loadedLayers.containsKey(e)?this.loadedLayers[e]:null},i.prototype.findLayer=function(e){if(this.loadedLayers.containsKey(e))return this.loadedLayers[e];var t;return this.project.groups.forEach(function(r){r.layers.forEach(function(r){r.id===e&&(t=r)})}),t},i.prototype.setGroupStyle=function(r,i){var a=this,o=new t.GroupStyle(this.$translate);o.id=e.Helpers.getGuid(),o.title=i.title,o.visualAspect="fillColor",o.canSelectColor=o.visualAspect.toLowerCase().indexOf("color")>-1,o.info=this.calculatePropertyInfo(r,i.label),o.enabled=!0,o.property=i.label,o.group=r,o.colors=["white","#FF5500"],this.saveStyle(r,o),this.project.features.forEach(function(e){e.layer.group==r&&(a.calculateFeatureStyle(e),a.activeMapRenderer.updateFeature(e))})},i.prototype.setStyle=function(r,i,a,o){var s=this;void 0===i&&(i=!1);var n=r.feature;if(null!=n){var l,c=this.getFeatureType(n);if(o)l=o,l.info=this.calculatePropertyInfo(n.layer.group,r.property);else{l=new t.GroupStyle(this.$translate),l.id=e.Helpers.getGuid(),l.title=r.key,l.meta=r.meta,l.visualAspect=c.style&&c.style.drawingMode&&"line"==c.style.drawingMode.toLowerCase()?"strokeColor":"fillColor",l.canSelectColor=l.visualAspect.toLowerCase().indexOf("color")>-1,l.property=r.property,a?(l.info=a,l.fixedColorRange=!0):null==l.info&&(l.info=this.calculatePropertyInfo(n.layer.group,r.property)),l.enabled=!0,l.group=n.layer.group,l.meta=r.meta;var p=this.propertyTypeData[r.property];p&&p.legend&&(l.activeLegend=p.legend,l.legends[p.title]=p.legend,l.colorScales[p.title]=["purple","purple"]),c.style&&c.style.fillColor?l.colors=["white","#FF5500"]:l.colors=["red","white","blue"]}return this.saveStyle(n.layer.group,l),this.project.features.forEach(function(e){e.layer.group==n.layer.group&&(s.calculateFeatureStyle(e),s.activeMapRenderer.updateFeature(e))}),i&&$('#leftPanelTab a[data-target="#styles"]').tab("show"),l}return null},i.prototype.toggleStyle=function(e,t,r,i){var a=this;void 0===r&&(r=!1);var o=e.feature.layer.group.styles;o.some(function(t){return t.property===e.property})?o.filter(function(t){return t.property===e.property}).forEach(function(e){return a.removeStyle(e)}):this.setStyle(e,r,i),this.$messageBusService.publish("updatelegend","updatedstyle")},i.prototype.saveStyle=function(e,t){var r=e.styles.filter(function(e){return e.visualAspect===t.visualAspect});if(r.length>0){var i=e.styles.indexOf(r[0]);e.styles.splice(i,1)}e.styles.push(t)},i.prototype.addFilter=function(e,r){var i=this.findFilter(e,r);if(null==i){var a=new t.GroupFilter;a.property=r,a.title=r,a.rangex=[0,1],e.filters.push(a)}else{var o=e.filters.indexOf(i);-1!==o&&e.filters.slice(o,1)}$('#leftPanelTab a[data-target="#filters"]').tab("show")},i.prototype.setFilter=function(e,t){e.group=t,t.filters.push(e),$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(t.id)},i.prototype.setLocationFilter=function(r){if(!r.filters.some(function(e){return"location"===e.filterType})){var i=new t.GroupFilter;i.id=e.Helpers.getGuid(),i.group=r,i.filterType="location",i.title="Location",i.rangex=[0,1],r.filters.push(i),$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(r.id)}},i.prototype.setFeatureAreaFilter=function(r){this.project.groups.forEach(function(i){if(i.id!==r.layer.group.id&&!i.filters.some(function(e){return"area"===e.filterType})){var a=new t.GroupFilter;a.id=e.Helpers.getGuid(),a.group=i,a.filterType="area",a.title="Area",a.rangex=[0,1],a.value=r,i.filters.push(a),i.filterResult=i.filterResult||[]}}),this.triggerUpdateFilter(r.layer.group.id)},i.prototype.resetFeatureAreaFilter=function(){var e=this;this.project.groups.forEach(function(t){t.filters.some(function(t){return"area"===t.filterType?(e.removeFilter(t),!0):!1})})},i.prototype.setPropertyFilter=function(r){var i=r.property,a=r.feature;if(null!=a){var o=a.layer;if(null!=o){var s=this.findFilter(o.group,i);if(null==s){var n=new t.GroupFilter;if(n.property=i,n.id=e.Helpers.getGuid(),n.group=o.group,n.meta=r.propertyType,n.filterType="bar",null!=n.meta)if(null!=n.meta.filterType)n.filterType=n.meta.filterType;else switch(n.meta.type){case"boolean":n.filterType="boolean";break;case"date":n.filterType="date";break;case"number":case"options":n.filterType="bar";break;default:n.filterType="text",n.stringValue=r.value,n.value=r.value}n.title=r.key,n.rangex=[0,1],o.group.filters.push(n)}else this.removeFilter(s)}$('#leftPanelTab a[data-target="#filters"]').tab("show")}this.triggerUpdateFilter(o.group.id)},i.prototype.createScatterFilter=function(r,i,a){console.log("create scatter "+i+"-"+a);var o=new t.GroupFilter;o.property=i,o.property2=a,o.id=e.Helpers.getGuid(),o.group=r,o.filterType="scatter",o.title="Scatter",o.rangex=[0,1],r.filters.push(o),$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(r.id)},i.prototype.triggerUpdateFilter=function(e){this.mb.publish("filters","updated",e)},i.prototype.removeFilter=function(e){e.group.filterResult=e.dimension.filterAll().top(1/0),e.dimension.dispose(),e.group.filters=e.group.filters.filter(function(t){return t!=e}),this.resetMapFilter(e.group),this.updateMapFilter(e.group),this.triggerUpdateFilter(e.group.id)},i.prototype.getPropertyType=function(e,t){var r;if(e.fType&&e.fType.propertyTypeData&&(r=_.find(e.fType.propertyTypeData,function(e){return e.label===t})),!r&&e.fType.propertyTypeKeys&&e.layer.typeUrl&&this.typesResources.hasOwnProperty(e.layer.typeUrl)){var i=this.typesResources[e.layer.typeUrl];e.fType.propertyTypeKeys.split(";").forEach(function(e){i.propertyTypeData.hasOwnProperty(e)&&i.propertyTypeData[e].label===t&&(r=i.propertyTypeData[e])})}if(!r&&e.layer.typeUrl&&this.typesResources.hasOwnProperty(e.layer.typeUrl)){var a=this.typesResources[e.layer.typeUrl];r=_.find(a.propertyTypeData,function(e){return e.label===t})}return r},i.prototype.getFeatureTypeId=function(e){e.hasOwnProperty("layer")||(e.layer=new t.ProjectLayer);var r=e.properties.FeatureTypeId||e.properties.featureTypeId||e.layer.defaultFeatureType||"Default";return/^http:\/\//.test(r.toLowerCase())?r:e.layer.typeUrl?e.layer.typeUrl+"#"+r:e.layer.url?e.layer.url+"#"+r:this.project.url+"#"+r},i.prototype.getFeatureTypeById=function(e){return this._featureTypes.hasOwnProperty(e)?this._featureTypes[e]:void 0},i.prototype.getFeatureType=function(e){e.featureTypeName||(e.featureTypeName=this.getFeatureTypeId(e));var t=e.featureTypeName.indexOf("_{")>=0;if(!t&&e.fType)return e.fType;var r=e.featureTypeName;if(t){var i=/_{([a-zA-Z_0-9]+)}/g,a=i.exec(r);if(a)for(var o=1;o<a.length;o++){var s=a[o];r=e.properties.hasOwnProperty(s)?r.replace("{"+s+"}",e.properties[s]):r.replace("_{"+s+"}","")}}return this._featureTypes.hasOwnProperty(r)||this.createMissingFeatureType(e),e.fType=this._featureTypes[r],e.fType},i.prototype.createMissingFeatureType=function(t){var r=this,i=Object.getOwnPropertyNames(this._featureTypes),a=i.map(function(e){return r._featureTypes[e]}).filter(function(e){return e.name==t.featureTypeName});a.length>0?this._featureTypes[t.featureTypeName]=a[0]:this._featureTypes[t.featureTypeName]=e.Helpers.createDefaultType(t,null)},i.prototype.resetFilters=function(){dc.filterAll(),dc.redrawAll()},i.prototype.getGroupFeatures=function(e){var t=[];e.layers.forEach(function(e){e.enabled&&t.push(e.id)});var r=this.project.features.filter(function(e){return t.indexOf(e.layerId)>-1});return r},i.prototype.rebuildFilters=function(e){e.ndx=crossfilter([]);var t=this.getGroupFeatures(e);e.ndx.add(t)},i.prototype.removeLayer=function(e,t){var r=this;void 0===t&&(t=!1);var i=e.group;e.enabled=!1,e.isLoading=!1,e.gui.more=!1,this.checkLayerTimer(e),this.loadedLayers.remove(e.id),e.layerSource||(e.layerSource=this.layerSources[e.type.toLowerCase()]),e.layerSource.removeLayer(e),null!=this.lastSelectedFeature&&this.lastSelectedFeature.layerId===e.id&&(this.lastSelectedFeature=null,this.visual.rightPanelVisible=!1,this.$messageBusService.publish("feature","onFeatureDeselect")),this.selectedFeatures.length>0&&(this.selectedFeatures=this.selectedFeatures.filter(function(t){return t.layerId!==e.id})),this.activeMapRenderer.removeLayer(e),this.project.features=this.project.features.filter(function(t){return t.layerId!==e.id});e.id+"_",this._featureTypes;(0===i.layers.filter(function(e){return e.enabled}).length||i.oneLayerActive===!0)&&(i.filters.forEach(function(e){null!=e.dimension&&e.dimension.dispose()}),i.filters=[],i.styles.forEach(function(e){r.removeStyle(e)}),i.styles=[]),this.rebuildFilters(i),t&&(e.group.layers=e.group.layers.filter(function(t){return t!=e})),"$apply"!=this.$rootScope.$root.$$phase&&"$digest"!=this.$rootScope.$root.$$phase&&this.$rootScope.$apply(),this.$messageBusService.publish("layer","deactivate",e),this.$messageBusService.publish("rightpanel","deactiveContainer","edit"),this.$messageBusService.publish("timeline","updateFeatures")},i.prototype.openSolution=function(e,r,i){var a=this;this.loadedLayers.clear();var o=this.$location.search();o.hasOwnProperty("project")&&(e=this.emptySolutionUrl,this.openSingleProject=!0),this.$http.get(e).success(function(e){if(e.maxBounds&&(a.maxBounds=e.maxBounds,a.$mapService.map.setMaxBounds(new L.LatLngBounds(L.latLng(e.maxBounds.southWest[0],e.maxBounds.southWest[1]),L.latLng(e.maxBounds.northEast[0],e.maxBounds.northEast[1])))),e.viewBounds&&a.activeMapRenderer.fitBounds(e.viewBounds),e.baselayers&&e.baselayers.forEach(function(e){var r=new t.BaseLayer;null!=e.subdomains&&(r.subdomains=e.subdomains),null!=e.maxZoom&&(r.maxZoom=e.maxZoom),null!=e.minZoom&&(r.minZoom=e.minZoom),null!=e.attribution&&(r.attribution=e.attribution),null!=e.id&&(r.id=e.id),null!=e.title&&(r.title=e.title),null!=e.subtitle&&(r.subtitle=e.subtitle),null!=e.preview&&(r.preview=e.preview),null!=e.url&&(r.url=e.url),null!=e.cesium_url&&(r.cesium_url=e.cesium_url),null!=e.cesium_maptype&&(r.cesium_maptype=e.cesium_maptype),a.$mapService.baseLayers[e.title]=r,e.isDefault&&(a.activeMapRenderer.changeBaseLayer(r),a.$mapService.changeBaseLayer(e.title))}),a.openSingleProject){var s="api/projects/"+o.project;a.$http.get(s).success(function(e){e&&a.parseProject(e,{title:e.title,url:e.url,dynamic:!0},[])}).error(function(e){a.$messageBusService.notify("ERROR loading project","while loading: "+s)})}if(e.projects&&e.projects.length>0){var n=e.projects.filter(function(e){return e.title===i})[0];null!=n?a.openProject(n,r):a.openProject(e.projects[0],r)}if(e.widgetStyles||(e.widgetStyles={}),!e.widgetStyles.hasOwnProperty("default")){var l=new t.WidgetStyle;l.background="red",e.widgetStyles["default"]=l}a.solution=e}).error(function(){a.$messageBusService.notify("ERROR loading solution","while loading: "+e)})},i.prototype.clearLayers=function(){var e=this;null!=this.project&&null!=this.project.groups&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){t.enabled&&(e.removeLayer(t),t.enabled=!1)})})},i.prototype.openProject=function(e,t,r){var i=this;this.projectUrl=e;var a=[];t&&t.split(";").forEach(function(e){a.push(e.toLowerCase())}),this.clearLayers(),this._featureTypes={},this.propertyTypeData={};var o=this.$location.search();o.hasOwnProperty("dashboard")&&(this.startDashboardId=o.dashboard),r?this.parseProject(r,e,a):this.$http.get(e.url).success(function(t){i.parseProject(t,e,a)}).error(function(){i.$messageBusService.notify("ERROR loading project","while loading: "+e.url)})},i.prototype.parseProject=function(r,i,a){var o=this;if(r.solution=this.solution,this.project=(new t.Project).deserialize(r),this.project.timeLine?this.$messageBusService.publish("timeline","updateTimerange",this.project.timeLine):this.project.timeLine=new t.DateRange,this.project.viewBounds&&this.activeMapRenderer.fitBounds(this.project.viewBounds),this.initTypeResources(this.project),this.project.dashboards)this.project.dashboards.forEach(function(t){t.id||(t.id=e.Helpers.getGuid()),t.widgets&&t.widgets.length>0&&t.widgets.forEach(function(t){t.id||(t.id=e.Helpers.getGuid()),t.enabled||(t.enabled=!0)})});else{this.project.dashboards=[];var s=new t.Dashboard;s.id="map",s.name="Home",s.showMap=!0,s.showLeftmenu=!0,s.widgets=[],this.project.dashboards.push(s);var n=new t.Dashboard;n.id="datatable",n.name="Table",n.showMap=!1,n.showLeftmenu=!1,n.showRightmenu=!1,n.showTimeline=!1,n.widgets=[{id:"datatable_id",directive:"datatable",elementId:"widget-datatable_id",enabled:!0,width:"100%",height:"100%"}],this.project.dashboards.push(n)}if(async.series([function(e){o.project.typeUrls&&o.project.typeUrls.length>0?async.eachSeries(o.project.typeUrls,function(e,t){o.loadTypeResources(e,!1,function(){return t(null)})},function(){e(null,null)}):e(null,null)},function(r){o.project.datasources||(o.project.datasources=[]),o.project.datasources.forEach(function(r){r.url&&t.DataSource.LoadData(o.$http,r,function(){"dynamic"===r.type&&o.checkDataSourceSubscriptions(r);for(var t in r.sensors){var i=r.sensors[t];if(null!=i.propertyTypeKey&&o.propertyTypeData.hasOwnProperty(i.propertyTypeKey))i.propertyType=o.propertyTypeData[i.propertyTypeKey];else{var a="sensor-"+e.Helpers.getGuid(),s={};s.title=t,i.propertyTypeKey=a,o.project.propertyTypeData[a]=s,i.propertyType=s}i.values&&i.values.length>0&&(i.activeValue=i.values[i.values.length-1])}})})}]),this.project.dataSets||(this.project.dataSets=[]),this.project.features=[],this.project.groups&&this.project.groups.length>0&&this.project.groups.forEach(function(e){o.initGroup(e,a),r.startposition&&o.$mapService.zoomToLocation(new L.LatLng(r.startposition.latitude,r.startposition.longitude))}),this.project.connected&&(this.project.layerDirectory||(this.project.layerDirectory="/api/layers"),this.$messageBusService.initConnection("","",function(){o.$messageBusService.subscribe("keyupdate",function(e,t){if("key"===t.action){var r="keys/"+t.data.keyId;o.findSensorSet(r,function(e){var r=(new Date).getTime();t.data.item.hasOwnProperty("time")?r=t.data.item.time:(e.timestamps=[],e.values=[]),e.addValue((new Date).getTime(),t.data.item),e.activeValue=t.data.item})}})})),i.dynamic&&(this.directoryHandle||(this.directoryHandle=this.$messageBusService.serverSubscribe("","directory",function(e,t){if("subscribed"!==t.action){if("layer"===t.action&&t.data&&t.data.item&&o.openSingleProject===!1){var r=t.data.item;if(r){var a=o.findLayer(r.id);a&&(o.$messageBusService.notify("New update available for layer ",r.title),a.enabled&&a.layerSource.refreshLayer(a))}}if("project"===t.action&&t.data&&t.data.item){var s=t.data.item;if(s){var n=o.project.id===s.id;n||o.openSingleProject?(o.$messageBusService.notify("New update available for project ",s.title),o.openProject(i,null,s)):(o.$messageBusService.notify("New project available",s.title),s.url&&"json"!==s.url.substring(s.url.length-4)&&(s.url="/data"+s.url+".json"),o.solution.projects.some(function(e){return e.title===s.title})?console.log("Project already exists ("+s.title+")"):o.solution.projects.push({title:s.title,url:s.url,dynamic:!0}))}}}})),this.$messageBusService.getConnection(this.project.id)||this.$messageBusService.serverSubscribe(this.project.id,"project",function(e,r){"layer-update"===r.action&&r.data.layer.forEach(function(e){var i;e.groupId?i=o.findGroupById(e.groupId):e.groupId="main",i?(i.clustering=r.data.group.clustering,i.clusterLevel=r.data.group.clusterLevel):(i=new t.ProjectGroup,i.id=e.groupId,i.title=r.data.group.title,i.clustering=r.data.group.clustering,i.clusterLevel=r.data.group.clusterLevel,o.project.groups.push(i),o.initGroup(i));var a=!1,s=0;if(i.layers.forEach(function(t,r){t.id===e.id&&(a=!0,s=r)}),a){var n=i.styles;o.lastSelectedFeature&&o.lastSelectedFeature.isSelected&&o.selectFeature(o.lastSelectedFeature),e.layerSource||(e.layerSource=o.layerSources[e.type.toLowerCase()]),e.group=i,o.removeLayer(i.layers[s]),o.addLayer(i.layers[s],function(){n&&n.length>0&&o.setStyle({feature:{featureTypeName:e.url+"#"+e.defaultFeatureType,layer:e},property:n[0].property,key:n[0].title,meta:n[0].meta},!1,null,n[0])})}else i.layers.push(e),o.initLayer(i,e),e.layerSource||(e.layerSource=o.layerSources[e.type.toLowerCase()]),e.layerSource.refreshLayer(i.layers[i.layers.length-1]);"$apply"!=o.$rootScope.$root.$$phase&&"$digest"!=o.$rootScope.$root.$$phase&&o.$rootScope.$apply()}),"layer-remove"===r.action&&r.data.forEach(function(e){var t;e.groupId?t=o.findGroupById(e.groupId):e.groupId="main",null!=t&&(t.layers.forEach(function(t){t.id==e.id&&o.removeLayer(t,!0)}),0==t.layers.length&&o.removeGroup(t))})})),r.hasOwnProperty("collapseAllLayers")&&r.collapseAllLayers===!0&&("$apply"!=this.$rootScope.$root.$$phase&&"$digest"!=this.$rootScope.$root.$$phase&&this.$rootScope.$apply(),this.collapseAll()),this.$messageBusService.publish("project","loaded",this.project),this.project.dashboards&&this.project.dashboards.length>0){var l=this.project.dashboards[Object.keys(this.project.dashboards)[0]];this.startDashboardId&&this.findDashboardById(this.startDashboardId)&&(l=this.findDashboardById(this.startDashboardId)),this.$messageBusService.publish("dashboard-main","activated",l)}},i.prototype.toggleLayer=function(e){e.group.oneLayerActive&&this.findLoadedLayer(e.id)&&(e.enabled=!1),e.enabled?this.addLayer(e):this.removeLayer(e)},i.prototype.removeGroup=function(e){var t=this;e.layers&&e.layers.forEach(function(e){e.enabled&&t.removeLayer(e,!0)}),e.ndx=null,this.project.groups=this.project.groups.filter(function(t){return t!=e}),"$apply"!=this.$rootScope.$root.$$phase&&"$digest"!=this.$rootScope.$root.$$phase&&this.$rootScope.$apply()},i.prototype.initGroup=function(t,i){var a=this;if(null==t.id&&(t.id=e.Helpers.getGuid()),t.ndx=crossfilter([]),t.styles&&t.styles.length>0){t.styles[0].id}if(null==t.styles&&(t.styles=[]),null==t.filters&&(t.filters=[]),t.markers={},null!=t.languages&&this.currentLocale in t.languages){var o=t.languages[this.currentLocale];o.title&&(t.title=o.title),o.description&&(t.description=o.description)}t.clustering?(t.cluster=new L.MarkerClusterGroup({maxClusterRadius:function(e){return e>18?2:t.maxClusterRadius||80},disableClusteringAtZoom:t.clusterLevel||0}),t.cluster.on("clustermouseover",function(e){if(0===e.layer._childClusters.length){var t=e.layer.getAllChildMarkers();if(t[0]&&t[0].hasOwnProperty("feature")){var i=t[0].feature,o=a.getActions(i,r.Hover);o.forEach(function(e){"show"===e.title.toLowerCase()&&e.callback(i,a)})}}}),t.cluster.on("clustermouseout",function(e){if(0===e.layer._childClusters.length){var t=e.layer.getAllChildMarkers();if(t[0]&&t[0].hasOwnProperty("feature")){var i=t[0].feature,o=a.getActions(i,r.Hover);o.forEach(function(e){"hide"===e.title.toLowerCase()&&e.callback(i,a)})}}}),this.map.map.addLayer(t.cluster)):(t.vectors=new L.LayerGroup,this.map.map.addLayer(t.vectors)),t.layers||(t.layers=[]),t.layers.forEach(function(e){a.initLayer(t,e,i)}),t.styles.forEach(function(t){null!=t.id&&(t.id=e.Helpers.getGuid())}),t.filters.forEach(function(t){null!=t.id&&(t.id=e.Helpers.getGuid())})},i.prototype.initLayer=function(t,r,i){if(null==r.id&&(r.id=e.Helpers.getGuid()),r.type=r.type?r.type.toLowerCase():"geojson",r.gui={},r.renderType=r.renderType?r.renderType.toLowerCase():r.type,"dynamicgeojson"===r.type&&(r.isDynamic=!0),null==r.reference&&(r.reference=r.id),null==r.title&&(r.title=r.id),null!=r.languages&&this.currentLocale in r.languages){var a=r.languages[this.currentLocale];a.title&&(r.title=a.title),a.description&&(r.description=a.description)}r.group=t,r.groupId||(r.groupId=t.id),(r.enabled||i&&i.indexOf(r.reference.toLowerCase())>=0)&&(r.enabled=!0,this.addLayer(r))},i.prototype.checkDataSourceSubscriptions=function(e){var t=this;for(var r in e.sensors)this.$messageBusService.serverSubscribe(r,"sensor",function(r,i){if("sensor-update"===i.action){var a=i.data[0],o=e.sensors[a.sensor];if(null!=o){for(o.timestamps.push(a.date),o.values.push(a.value);o.timestamps.length>30;)o.timestamps.shift(),o.values.shift();o.activeValue=a.value,t.$messageBusService.publish("sensor-"+e.id+"/"+a.sensor,"update",o.activeValue),"$apply"!=t.$rootScope.$root.$$phase&&"$digest"!=t.$rootScope.$root.$$phase&&t.$rootScope.$apply()}}})},i.prototype.checkSubscriptions=function(){var e=this;this.project.datasources.forEach(function(t){t.url&&"dynamic"===t.type&&e.checkDataSourceSubscriptions(t)})},i.prototype.closeProject=function(){var e=this;null!=this.project&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){t.enabled&&e.removeLayer(t)})})},i.prototype.findSensorSet=function(e,r){var i=e.split("/");if(2==i.length){var a=i[0],o=i[1],s=this.project.datasources.filter(function(e){return e.id===a});if(0===s.length){var n=new t.DataSource;n.id=a,n.type="dynamic",n.sensors={},s.push(n),this.project.datasources.push(n)}if(n=s[0],n.sensors.hasOwnProperty(o))r(n.sensors[o]);else{var l=new t.SensorSet;l.id=o,l.title=o,l.timestamps=[],l.values=[],n.sensors[o]=l,r(l)}}return null},i.prototype.getPropertyValues=function(e,t){var r=[],i=[];return i=this.selectedFeatures.length>1?this.selectedFeatures:e.group.filterResult?e.group.filterResult:e.data.features,i&&i.forEach(function(t){t.layerId===e.id&&r.push(t.properties)}),0===r.length&&(r=e.data.features),r},i.prototype.calculatePropertyInfo=function(e,r){var i=this,a=new t.PropertyInfo;a.count=0;var o=0,s=0;if(e.layers.forEach(function(e){e.enabled&&i.project.features.forEach(function(t){if(t.layerId===e.id&&t.properties.hasOwnProperty(r)){var i=t.properties[r],n=Number(i);isNaN(n)||(a.count+=1,o+=n,s+=n*n,(null==a.max||n>a.max)&&(a.max=n),(null==a.min||n<a.min)&&(a.min=n))}})}),isNaN(o)||0==a.count||(a.mean=o/a.count,a.varience=s/a.count-a.mean*a.mean,a.sd=Math.sqrt(a.varience)),this.propertyTypeData.hasOwnProperty(r)){this.propertyTypeData[r]}return a},i.prototype.updateFilterGroupCount=function(e){null!=e.filterResult&&$("#filtergroupcount_"+e.id).text(e.filterResult.length+" objecten geselecteerd")},i.prototype.trackGeometry=function(e,t){var r="~geometry",i={ts:(new Date).getTime(),prop:r,value:e.geometry};e.propertiesOld[r]=JSON.parse(JSON.stringify(e.geometry)),e.logs.hasOwnProperty(r)||(e.logs[r]=[]),t.hasOwnProperty(r)||(t[r]=[]),e.logs[r].push(i),t[r].push(i),e.gui.lastUpdate=i.ts},i.prototype.trackPropertyLog=function(e,t,r){var i={ts:(new Date).getTime(),prop:t,value:e.properties[t]};e.propertiesOld[t]=JSON.parse(JSON.stringify(e.properties[t])),e.logs.hasOwnProperty(t)||(e.logs[t]=[]),r.hasOwnProperty(t)||(r[t]=[]),e.logs[t].push(i),r[t].push(i),e.gui.lastUpdate=i.ts},i.prototype.trackFeature=function(e){var t={};for(var r in e.properties)e.propertiesOld.hasOwnProperty(r)?JSON.stringify(e.propertiesOld[r])!=JSON.stringify(e.properties[r])&&this.trackPropertyLog(e,r,t):this.trackPropertyLog(e,r,t);return JSON.stringify(e.propertiesOld["~geometry"])!=JSON.stringify(e.geometry)&&this.trackGeometry(e,t),t},i.prototype.isLocked=function(e){return e.gui.hasOwnProperty("lock")||e.gui.hasOwnProperty("editMode")&&e.gui.editMode},i.prototype.lockFeature=function(e){return e.gui.hasOwnProperty("lock")?!1:(e.gui.lock=!0,!0)},i.prototype.unlockFeature=function(e){delete e.gui.lock},i.prototype.saveFeature=function(e,r){if(void 0===r&&(r=!1),e.properties.updated=(new Date).getTime(),e.layer.isDynamic)if(e.layer.useLog){var i=this.trackFeature(e),s=new a;s.layerId=e.layerId,s.action=o.updateLog,s.item={featureId:e.id,logs:i},this.$messageBusService.serverSendMessageAction("layer",s)}else{var s=new a;s.layerId=e.layerId,s.action=o.updateFeature,s.item=t.Feature.serialize(e),this.$messageBusService.serverSendMessageAction("layer",s)}},i.prototype.updateMapFilter=function(e){this.activeMapRenderer.updateMapFilter(e),this.$messageBusService.publish("timeline","updateFeatures",e.id)},i.prototype.resetMapFilter=function(e){var t=this;$.each(e.markers,function(r,i){if(e.clustering){var a=e.cluster.hasLayer(i);a||e.cluster.addLayer(i)}else{var o=t.map.map.hasLayer(i);o||t.map.map.addLayer(i)}})},i.$inject=["$location","$compile","$translate","messageBusService","mapService","$rootScope","geoService","$http"],i}();t.LayerService=i;var a=function(){function e(){}return e}();t.LayerUpdate=a,function(e){e[e.updateFeature=0]="updateFeature",e[e.updateLog=1]="updateLog",e[e.deleteFeature=2]="deleteFeature"}(t.LayerUpdateAction||(t.LayerUpdateAction={}));var o=t.LayerUpdateAction,s="csComp";try{t.myModule=angular.module(s)}catch(n){t.myModule=angular.module(s,[])}t.myModule.service("layerService",e.Services.LayerService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var MatrixAction;!function(e){var t=function(){function e(){this.id="MatrixActionModel"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.getFeatureActions=function(e){return[]},e.prototype.getFeatureHoverActions=function(e){if(!e)return[];var t={title:"show"};t.callback=this.showContour;var r={title:"hide"};return r.callback=this.hideContour,[t,r]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.showContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour);var r=t.getFeatureType(e);if(r&&r.hasOwnProperty("contourProperty")&&e.properties.hasOwnProperty(r.contourProperty)){var i=JSON.parse(e.properties[r.contourProperty]);t.currentContour=L.geoJson(i),t.currentContour.addTo(t.map.map)}},e.prototype.hideContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour)},e.prototype.init=function(e){console.log("init ContourActionService")},e}();e.MatrixActionModel=t}(MatrixAction||(MatrixAction={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function r(e,t,r){var i=this;this.$localStorageService=e,this.$timeout=t,this.$messageBusService=r,this.mapVisible=!0,this.timelineVisible=!1,this.rightMenuVisible=!0,this.initExpertMode(),this.baseLayers={},this.initMap(),r.subscribe("timeline",function(e,t){switch(e){case"isEnabled":i.timelineVisible=t,i.timelineVisible&&i.$timeout(function(){i.$messageBusService.publish("timeline","loadProjectTimeRange")},100)}}),r.subscribe("map",function(e,t){switch(e){case"setextent":i.map.fitBounds(new L.LatLngBounds(t.southWest,t.northEast),{paddingTopLeft:new L.Point(370,50)})}})}return r.prototype.initExpertMode=function(){var i=this;this.expertMode=this.$localStorageService.get(r.expertModeKey),this.expertMode||(this.expertMode=t.Expertise.Expert,this.$messageBusService.subscribe("project",function(e,t){switch(e){case"loaded":null!=t&&"undefined"!=typeof t.expertMode&&i.$messageBusService.publish("expertMode","newExpertise",t.expertMode)}})),this.$messageBusService.subscribe("expertMode",function(t,r){"newExpertise"===t&&(i.expertMode=r,i.$localStorageService.set(e.Services.MapService.expertModeKey,r))})},Object.defineProperty(r.prototype,"isExpert",{get:function(){return this.expertMode===t.Expertise.Expert||this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isIntermediate",{get:function(){return this.expertMode===t.Expertise.Expert||this.expertMode===t.Expertise.Intermediate||this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isAdminExpert",{get:function(){return this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),r.prototype.initMap=function(){},
r.prototype.getBaselayer=function(e){var t=this.baseLayers[e];return t},r.prototype.changeBaseLayer=function(e){var t=this.getBaselayer(e);this.activeBaseLayer=t,this.activeBaseLayerId=e},r.prototype.invalidate=function(){this.map.invalidateSize(!0)},r.prototype.zoomToLocation=function(e,t){this.map.setView(e,t||14)},r.prototype.zoomTo=function(e,t){var r=this;void 0===t&&(t=14);var i;if("POINT"==e.geometry.type.toUpperCase())i=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),this.map.setView(i,t);else{var a;e.geometry.type.toUpperCase().indexOf("MULTI")<0?a=this.getBoundingBox(e.geometry.coordinates[0]):(a=[1e3,-1e3,1e3,-1e3],e.geometry.coordinates.forEach(function(e){var t=r.getBoundingBox(e[0]);a=[Math.min(a[0],t[0]),Math.max(a[1],t[1]),Math.min(a[2],t[2]),Math.max(a[3],t[3])]}));var o=.05,s=L.latLng(Math.min(a[2],a[3]),Math.min(a[0],a[1])-o),n=L.latLng(Math.max(a[2],a[3]),Math.max(a[0],a[1])+o);this.map.fitBounds(new L.LatLngBounds(s,n))}this.$messageBusService.publish("sidebar","show"),this.$messageBusService.publish("feature","onFeatureSelect",e)},r.prototype.getBoundingBox=function(e){return e.reduce(function(e,t){return[Math.min(e[0],t[0]),Math.max(e[1],t[0]),Math.min(e[2],t[1]),Math.max(e[3],t[1])]},[1e3,-1e3,1e3,-1e3])},r.prototype.getMap=function(){return this.map},r.expertModeKey="expertMode",r.$inject=["localStorageService","$timeout","messageBusService"],r}();t.MapService=r;var i="csComp";try{t.myModule=angular.module(i)}catch(a){t.myModule=angular.module(i,[])}t.myModule.service("mapService",e.Services.MapService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(e,t){this.$scope=e,this.$mapService=t,e.vm=this,e.location=new L.LatLng(0,0)}return e.prototype.doSearch=function(){if(0===this.$scope.location.lat&&0===this.$scope.location.lng)alert("Directive did not update the location property in parent controller.");else{var e=new L.LatLng(this.$scope.location.lat,this.$scope.location.lng);this.$mapService.zoomToLocation(e)}},e.$inject=["$scope","mapService"],e}();e.SearchFormCtrl=t}(t=e.Search||(e.Search={}))}(csComp||(csComp={}));var Dashboard;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("whenReady",["$interpolate",function(e){return{restrict:"A",priority:Number.MIN_VALUE,link:function(t,r,i){function a(e){e.forEach(function(e){t.$eval(e)})}var o=i.whenReady.split(";"),s=!1,n=!1;0!==i.whenReady.trim().length&&(i.waitForInterpolation&&t.$eval(i.waitForInterpolation)&&(s=!0),i.readyCheck&&(n=!0),s||n?requestAnimationFrame(function l(){var c=!1,p=!1;c=s&&r.text().indexOf(e.startSymbol())>=0?!1:!0,p=n&&!t.$eval(i.readyCheck)?!1:!0,c&&p?a(o):requestAnimationFrame(l)}):a(o))}}}]),e.myModule.directive("dashboardirective",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{container:"="},templateUrl:"directives/DashboardDirectives/Dashboard/Dashboard.tpl.html",link:function(e,r,i){angular.element(t).bind("resize",function(){e.$apply()}),e.container=i.container,e.initDashboard()},replace:!1,transclude:!0,controller:e.DashboardCtrl}}])}(Dashboard||(Dashboard={}));var Dashboard;!function(e){var t=function(){function e(e,t,r,i,a,o,s,n){var l=this;this.$scope=e,this.$compile=t,this.$layerService=r,this.$mapService=i,this.$messageBusService=a,this.$dashboardService=o,this.$templateCache=s,this.$timeout=n,e.vm=this,a.subscribe("project",function(t,r){"loaded"===t&&(e.dashboard=null)}),e.initDashboard=function(){a.subscribe("dashboard-"+e.container,function(t,i){switch(l.project=r.project,l.project.activeDashboard=i,t){case"activated":e.dashboard=i,l.updateDashboard()}}),l.$messageBusService.subscribe("expertMode",function(e,t){"newExpertise"===e&&setTimeout(function(){if(l.project&&l.project.activeDashboard){var e=l.project.activeDashboard;!l.$mapService.isIntermediate||e.hasOwnProperty("showTimeline")&&e.showTimeline!==!0?l.$messageBusService.publish("timeline","isEnabled",!1):l.$messageBusService.publish("timeline","isEnabled",!0)}},50)})}}return e.prototype.toggleWidget=function(e){e.canCollapse&&(e.collapse=!e.collapse)},e.prototype.updateWidget=function(e){if(console.log("updating widget "+e.directive),!e._initialized||!this.$scope.dashboard._initialized){e._initialized=!0;var t,r=this.$scope;r.widget=e,t=e.template?this.$compile(this.$templateCache.get(e.template))(r):e.url?this.$compile("<div>url</div>")(this.$scope):e.directive?this.$compile("<"+e.directive+"></"+e.directive+">")(r):this.$compile("<h1>hoi</h1>")(this.$scope);var i=function(){};if(t){t.resize(i);var a=$("#"+e.elementId);a.empty(),a.append(t)}"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()}},e.prototype.toggleInteract=function(e){e._interaction=!e._interaction,e._interaction?interact("#"+e.elementId+"-parent").draggable(!0):interact("#"+e.elementId+"-parent").draggable(!1)},e.prototype.checkMap=function(){if(this.$scope.dashboard.showMap!=this.$layerService.visual.mapVisible&&(this.$scope.dashboard.showMap?this.$layerService.visual.mapVisible=!0:this.$layerService.visual.mapVisible=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()),this.$scope.dashboard.viewBounds&&(console.log("set bound"),this.$layerService.activeMapRenderer.fitBounds(this.$scope.dashboard.viewBounds)),this.$scope.dashboard.showMap&&this.$scope.dashboard.baselayer){var e=this.$layerService.$mapService.getBaselayer(this.$scope.dashboard.baselayer);this.$layerService.activeMapRenderer.changeBaseLayer(e),this.$layerService.$mapService.changeBaseLayer(this.$scope.dashboard.baselayer)}},e.prototype.checkLayers=function(){var e=this,t=this.$layerService.project.activeDashboard;t.visiblelayers&&t.visiblelayers.length>0&&this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){r.enabled&&-1==t.visiblelayers.indexOf(r.reference)&&(e.$layerService.removeLayer(r),r.enabled=!1),!r.enabled&&t.visiblelayers.indexOf(r.reference)>=0&&(e.$layerService.addLayer(r),r.enabled=!0)})})},e.prototype.checkViewbound=function(){var e=this.$layerService.project.activeDashboard;e.viewBounds&&this.$layerService.activeMapRenderer.fitBounds(e.viewBounds)},e.prototype.checkTimeline=function(){this.$scope.dashboard.showTimeline!=this.$mapService.timelineVisible&&(this.$scope.dashboard.showTimeline&&this.$mapService.isIntermediate?this.$mapService.timelineVisible=!0:this.$mapService.timelineVisible=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply())},e.prototype.setValue=function(e,t){if(!t||t.indexOf("%")>=0)return t;var r=parseInt(t.replace("px",""));return r+=e,r+"px"},e.prototype.removeWidget=function(e){this.$scope.dashboard.widgets=this.$scope.dashboard.widgets.filter(function(t){return t!=e})},e.prototype.isReady=function(e){var t=this;this.updateWidget(e),setTimeout(function(){e._ijs||(e._ijs=interact("#"+e.elementId+"-parent").resizable({inertia:!0}).on("down",function(r){e._interaction&&(e._isMoving=!0),t.$dashboardService.activeWidget!=e}).on("up",function(t){return e._isMoving=!1}).on("dragmove",function(r){e.left||!e.left&&""!==e.left?(e.left=t.setValue(r.dx,e.left),e.width&&""!==e.width?e.right="":e.right=t.setValue(-r.dx,e.right)):(e.right&&""!==e.right||(e.right="1000px"),e.right=t.setValue(-r.dx,e.right)),e.top&&""!==e.top?(e.top=t.setValue(r.dy,e.top),e.bottom&&(e.height?e.bottom="":e.bottom=t.setValue(-r.dy,e.bottom))):e.bottom=t.setValue(-r.dy,e.bottom),"$apply"!=t.$scope.$root.$$phase&&"$digest"!=t.$scope.$root.$$phase&&t.$scope.$apply()}).on("resizemove",function(r){e.height=t.setValue(r.dy,e.height),e.left&&e.right?e.right=t.setValue(-r.dx,e.right):(e.width||(e.width="300px"),e.width=t.setValue(r.dx,e.width)),"$apply"!=t.$scope.$root.$$phase&&"$digest"!=t.$scope.$root.$$phase&&t.$scope.$apply()}))},10)},e.prototype.updateDashboard=function(){var e=this,t=this.$scope.dashboard;t&&(this.checkMap(),this.checkTimeline(),this.checkLayers(),this.checkViewbound(),this.$mapService.isAdminExpert||(this.$layerService.visual.leftPanelVisible=t.showLeftmenu,this.$layerService.visual.rightPanelVisible=t.showRightmenu),this.$timeout(function(){t.widgets.forEach(function(t){t._initialized=!1,e.updateWidget(t)}),t._initialized=!0,e.$scope.$watchCollection("dashboard.widgets",function(t){e.$scope.dashboard.widgets.forEach(function(t){e.updateWidget(t)})})},100),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply())},e.$inject=["$scope","$compile","layerService","mapService","messageBusService","dashboardService","$templateCache","$timeout"],e}();e.DashboardCtrl=t}(Dashboard||(Dashboard={}));var DashboarHeaderdSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardHeaderSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/DashboardSelection/DashboardHeaderSelection.tpl.html",replace:!0,transclude:!0,controller:e.DashboardHeaderSelectionCtrl}}])}(DashboarHeaderdSelection||(DashboarHeaderdSelection={}));var DashboarHeaderdSelection;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this}return e.prototype.childDashboards=function(e){var t=this.$layerService.project.dashboards.filter(function(t){return t.parents&&t.parents.indexOf(e.id)>-1});return t},e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.DashboardHeaderSelectionCtrl=t}(DashboarHeaderdSelection||(DashboarHeaderdSelection={}));var DashboardSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/DashboardSelection/DashboardSelection.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.DashboardSelectionCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(DashboardSelection||(DashboardSelection={}));var DashboardSelection;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this,this.$messageBusService.subscribe("project",function(e,t){o.style="default",o.selectStyle()})}return e.prototype.initDrag=function(e){var t,r,i=this;interact("#widgettype-"+e).draggable({max:1/0}).on("dragstart",function(e){t=0,r=0,e.interaction.x=parseInt(e.target.getAttribute("data-x"),10)||0,e.interaction.y=parseInt(e.target.getAttribute("data-y"),10)||0,e.target.style.width="300px",e.target.style.height="300px"}).on("dragmove",function(e){e.interaction.x+=e.dx,e.interaction.y+=e.dy,e.target.style.left=e.interaction.x+"px",e.target.style.top=e.interaction.y+"px"}).on("dragend",function(t){setTimeout(function(){var r={};r.directive=e,r.id=csComp.Helpers.getGuid(),r.left=t.clientX-350+"px",r.top=t.clientY-50+"px",r.data={},r.width="300px",r.height="300px",r.style=i.style,r.enabled=!0,csComp.Services.Dashboard.addNewWidget(r,i.$layerService.project.activeDashboard,i.$layerService.solution),i.$dashboardService.editWidget(r)},100),t.target.setAttribute("data-x",0),t.target.setAttribute("data-y",0),t.target.style.left="0px",t.target.style.top="0px",t.target.style.width="75px",t.target.style.height="75px",console.log(e)})},e.prototype.startWidgetEdit=function(e){this.$dashboardService.editWidget(e)},e.prototype.startDashboardEdit=function(e){var t=new csComp.Services.RightPanelTab;t.container="dashboard",t.data=e,t.directive="dashboardedit",this.$messageBusService.publish("rightpanel","activate",t),this.$layerService.project.dashboards.forEach(function(t){t.id!==e.id&&(t.editMode=!1,t.disabled=!0)}),this.$dashboardService.stopEditWidget()},e.prototype.stopDashboardEdit=function(e){this.$layerService.project.dashboards.forEach(function(e){e.disabled=!1,e.editMode=!1}),this.$dashboardService.stopEditWidget()},e.prototype.stopEdit=function(){this.stopDashboardEdit(this.$layerService.project.activeDashboard)},e.prototype.startEdit=function(){},e.prototype.widgetHighlight=function(e){e.hover=!0},e.prototype.widgetStopHighlight=function(e){e.hover=!1},e.prototype.addDashboard=function(e){var t=csComp.Helpers.getGuid(),r=new csComp.Services.Dashboard;r.id=t,r.showLeftmenu=!0,r.showMap=!0,r.name="New Dashboard",this.$layerService.project.dashboards.push(r)},e.prototype.removeDashboard=function(e){this.$layerService.project.dashboards=this.$layerService.project.dashboards.filter(function(t){return t.id!==e})},e.prototype.selectStyle=function(){this.$scope.widgetStyle=this.$layerService.solution.widgetStyles[this.style],console.log(this.$scope.widgetStyle)},e.prototype.publishDashboardUpdate=function(){this.$messageBusService.publish("dashboard","onDashboardSelected",this.$layerService.project.activeDashboard)},e.prototype.selectDashboard=function(e){var t=this;for(var r in this.$layerService.project.dashboards)this.$layerService.project.dashboards[r].editMode=!1;e&&("$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply(),setTimeout(function(){t.publishDashboardUpdate()},100))},e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.DashboardSelectionCtrl=t}(DashboardSelection||(DashboardSelection={}));var DashboardEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/WidgetEdit/DashboardEdit.tpl.html",replace:!0,transclude:!0,controller:e.DashboardEditCtrl}}])}(DashboardEdit||(DashboardEdit={}));var DashboardEdit;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.scope=e,e.vm=this,this.dashboard=e.$parent.data,this.dashboard.parents&&this.dashboard.parents.length>0&&(this.parent=this.dashboard.parents[0]),this.updateHasParent(),console.log(this.$dashboardService.widgetTypes)}return e.prototype.updateHasParent=function(){},e.prototype.toggleTimeline=function(){this.checkTimeline(),this.$layerService.project.dashboards},e.prototype.toggleLegend=function(){this.checkLegend(),this.$layerService.project.dashboards},e.prototype.setExtent=function(){this.dashboard.viewBounds=this.$layerService.activeMapRenderer.getExtent(),console.log("set extent")},e.prototype.setVisibleLayers=function(){this.dashboard.visiblelayers=[];for(var e in this.$layerService.loadedLayers)this.dashboard.visiblelayers.push(e)},e.prototype.setBaseLayer=function(){this.dashboard.baselayer=this.$mapService.activeBaseLayerId},e.prototype.toggleMap=function(){var e=this;setTimeout(function(){e.checkMap()},100)},e.prototype.checkMap=function(){var e=this.$layerService.project.activeDashboard;if(e.showMap!=this.$layerService.visual.mapVisible&&(e.showMap?this.$layerService.visual.mapVisible=!0:this.$layerService.visual.mapVisible=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()),e.showMap&&this.dashboard.baselayer){var t=this.$layerService.$mapService.getBaselayer(this.dashboard.baselayer);this.$layerService.activeMapRenderer.changeBaseLayer(t),this.$layerService.$mapService.changeBaseLayer(this.dashboard.baselayer),this.$layerService.$mapService.changeBaseLayer(this.dashboard.baselayer)}},e.prototype.checkTimeline=function(){var e=this.$layerService.project.activeDashboard;if(e.timeline){var t=new Date(e.timeline.start),r=new Date;e.timeline.end&&(r=new Date(e.timeline.end)),this.$messageBusService.publish("timeline","updateTimerange",{start:t,end:r})}e.showTimeline!=this.$mapService.timelineVisible&&(e.showTimeline?this.$mapService.timelineVisible=!0:this.$mapService.timelineVisible=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply())},e.prototype.checkLegend=function(){var e=this.$layerService.project.activeDashboard;if(!e.showLegend){var t=-1;e.widgets.forEach(function(e,r){"legend"===e.id&&(t=r)}),t>-1&&e.widgets.splice(t,1)}this.$dashboardService.selectDashboard(e,"main"),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.DashboardEditCtrl=t}(DashboardEdit||(DashboardEdit={}));var WidgetEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("widgetedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/WidgetEdit/WidgetEdit.tpl.html",replace:!0,transclude:!0,controller:e.WidgetEditCtrl}}])}(WidgetEdit||(WidgetEdit={}));var WidgetEdit;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.mapService=t,this.layerService=r,this.messageBusService=i,this.dashboardService=a,this.scope=e,e.vm=this,e.widget=a.activeWidget}return e.prototype.selectStyle=function(){var e=this.$scope.widget.style;"custom"===e?(this.$scope.widget.customStyle=JSON.parse(JSON.stringify(this.$scope.widget.effectiveStyle)),this.$scope.widget.effectiveStyle=this.$scope.widget.customStyle):(this.$scope.widget.effectiveStyle=this.layerService.solution.widgetStyles[e],this.$scope.widget.customStyle=null)},e.prototype.removeWidget=function(e){e.parentDashboard.widgets=e.parentDashboard.widgets.filter(function(t){return e.id!=t.id}),this.dashboardService.deactivateTabContainer("widget-content"),this.dashboardService.deactivateTabContainer("widget")},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.WidgetEditCtrl=t}(WidgetEdit||(WidgetEdit={}));var FeatureTypeEditor;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureTypeEditor",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{featureTypeId:"="},templateUrl:"directives/Editors/FeatureTypeEditor/FeatureTypeEditor.tpl.html",replace:!0,transclude:!0,controller:e.FeatureTypeEditorCtrl}}]).directive("errSrc",function(){return{link:function(e,t,r){t.bind("error",function(){r.src!=r.errSrc&&r.$set("src",r.errSrc)})}}})}(FeatureTypeEditor||(FeatureTypeEditor={}));var FeatureTypeEditor;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$scope.vm=this,this.$scope.$root.hasOwnProperty("data")?(e.featureType=e.$parent.$parent.vm.featureType,console.log("feature type editor"),console.log(e.featureType)):console.log("no feature type")}return e.prototype.updateFeatureTypes=function(e){console.log("updating .."),this.$layerService.updateFeatureTypes(e)},e.$inject=["$scope","layerService","messageBusService"],e}();e.FeatureTypeEditorCtrl=t}(FeatureTypeEditor||(FeatureTypeEditor={}));var FeatureTypes;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featuretypes",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/Editors/FeatureTypeEditor/FeatureTypes.tpl.html",replace:!0,transclude:!0,controller:e.FeatureTypesCtrl}}]).directive("errSrc",function(){return{link:function(e,t,r){t.bind("error",function(){r.src!=r.errSrc&&r.$set("src",r.errSrc)})}}})}(FeatureTypes||(FeatureTypes={}));var FeatureTypes;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$scope.vm=this,this.$scope.$root.hasOwnProperty("data")&&(e.data=e.$root.data,this.selectedResourceUrl=e.data.layer.typeUrl,this.selectResource()),console.log(this.$scope)}return e.prototype.updateFeatureTypes=function(e){this.$layerService.updateFeatureTypes(e)},e.prototype.selectResource=function(){this.$layerService.typesResources.hasOwnProperty(this.selectedResourceUrl)&&(this.selectedResource=this.$layerService.typesResources[this.selectedResourceUrl])},e.$inject=["$scope","layerService","messageBusService"],e}();e.FeatureTypesCtrl=t}(FeatureTypes||(FeatureTypes={}));var GroupEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("groupedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Editors/GroupEditor/GroupEdit.tpl.html",replace:!0,transclude:!0,controller:e.GroupEditCtrl}}])}(GroupEdit||(GroupEdit={}));var GroupEdit;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.noLayerSelected=!0,this.scope=e,e.vm=this,e.group=e.$parent.data,console.log(e.group),this.updateLayers(),this.$messageBusService.subscribe("layer",function(){o.updateLayers()})}return e.prototype.updateLayers=function(){this.noLayerSelected=this.$scope.group.layers.some(function(e){return e.enabled})},e.prototype.removeGroup=function(){this.$layerService.removeGroup(this.$scope.group)},e.prototype.toggleClustering=function(){console.log("toggle clustering")},e.prototype.updateOws=function(){this.$scope.group.loadLayersFromOWS()},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.GroupEditCtrl=t}(GroupEdit||(GroupEdit={}));var LayerEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layeredit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Editors/LayerEditor/LayerEdit.tpl.html",replace:!1,transclude:!0,controller:e.LayerEditCtrl}}])}(LayerEdit||(LayerEdit={}));var LayerEdit;!function(e){var t=function(){function e(e,t,r,i,a,o){this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.scope=e,e.vm=this,this.layer=e.$parent.data,this.getTypes()}return e.prototype.addLayer=function(){},e.prototype.removeLayer=function(){this.$layerService.removeLayer(this.layer,!0)},e.prototype.addFeatureType=function(){var e=this;this.layer.typeUrl&&this.$layerService.loadTypeResources(this.layer.typeUrl,this.layer.dynamicResource||!1,function(){if(e.$layerService.typesResources.hasOwnProperty(e.layer.typeUrl)){var t=e.$layerService.typesResources[e.layer.typeUrl],r={},i=e.layer.typeUrl+"#"+e.layer.defaultFeatureType;if(r.id=e.layer.defaultFeatureType,r.name=r.id,r.style=csComp.Helpers.getDefaultFeatureStyle(null),!t.featureTypes.hasOwnProperty(i)){var r={};r.id=e.layer.defaultFeatureType,r.name=r.id,e.$layerService._featureTypes[i]=r,t.featureTypes[r.id]=r}}})},e.prototype.getTypes=function(){var e=this;console.log("its me babe"),this.$http.get(this.layer.typeUrl).success(function(t){setTimeout(function(){e.availabeTypes=t.featureTypes,console.log(e.availabeTypes)},0)}).error(function(){console.log("LayerEditCtl: error with $http")})},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.LayerEditCtrl=t}(LayerEdit||(LayerEdit={}));var PropertyTypes;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("propertytypes",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/Editors/PropertyTypeEditor/PropertyTypes.tpl.html",replace:!0,transclude:!0,controller:e.PropertyTypesCtrl}}]).directive("ngEnter",function(){return function(e,t,r){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(r.ngEnter)}),t.preventDefault())})}})}(PropertyTypes||(PropertyTypes={}));var PropertyTypes;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.editModeMessageReceived=function(e){switch(e){case"enable":i.$messageBusService.publish("sidebar","showEdit"),i.$scope.vm=i,i.$scope.propertyTypes=i.$layerService.project.propertyTypeData;break;case"disable":i.$messageBusService.publish("sidebar","hideEdit")}"$apply"!=i.$scope.$root.$$phase&&"$digest"!=i.$scope.$root.$$phase&&i.$scope.$apply()},this.sidebarMessageReceived=function(e){switch(e){case"toggle":i.$scope.showMenu=!i.$scope.showMenu;break;case"show":i.$scope.showMenu=!0;break;case"showEdit":i.$scope.showMenuEdit=!0;break;case"hide":i.$scope.showMenu=!1;break;case"hideEdit":i.$scope.showMenuEdit=!1}"$apply"!=i.$scope.$root.$$phase&&"$digest"!=i.$scope.$root.$$phase&&i.$scope.$apply()},console.log("prop editor"),this.$scope.vm=this,this.$scope.showMenu=!1,this.$scope.showMenuEdit=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply(),this.$messageBusService.subscribe("editmode",this.editModeMessageReceived),this.$messageBusService.subscribe("sidebar",this.sidebarMessageReceived),e.getSections=function(){var t=i.selectedResource.propertyTypeData,r=new Array;for(var a in t){var o=!0;if(void 0!=t[a].section){0==r.length&&r.push(t[a].section);for(var s in r)t[a].section==r[s]&&(o=!1);o&&r.push(t[a].section)}}e.sections=r},e.addSection=function(t){var r=e.sections,i=!0;for(var a in r)t==r[a]&&(i=!1);i&&e.sections.push(t)},e.filterProperty=function(t){var r=i.selectedResource.propertyTypeData,a=new Array;if(void 0==t){for(var o in r)a.push(r[o]);e.propertyTypes=a}else{var s;void 0!==t.propertyTypeKeys&&(s=t.propertyTypeKeys.split(";"));for(var n in s)for(var l in r)r.hasOwnProperty(l)&&s[n]==r[l].label&&a.push(r[l]);e.propertyTypes=a}}}return e.prototype.selectResource=function(){this.$layerService.typesResources.hasOwnProperty(this.selectedResourceUrl)&&(this.selectedResource=this.$layerService.typesResources[this.selectedResourceUrl])},e.$inject=["$scope","layerService","messageBusService"],e}();e.PropertyTypesCtrl=t}(PropertyTypes||(PropertyTypes={}));var ChartsWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("chartsEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Charts/Charts-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var l=e.$parent;this.widget=l.data,e.data=this.widget.data,this.loadChart()}return e.prototype.setupEditor=function(){this.editor=ace.edit("vegaeditor"),this.editor.getSession().setMode("ace/mode/json"),this.editor.setValue(JSON.stringify(this.$scope.data.spec,null,"	")),this.editor.clearSelection(),this.editor.focus()},e.prototype.loadChart=function(){this.$scope.spec=JSON.stringify(this.$scope.data.spec)},e.prototype.updateChart=function(){this.$scope.data.spec=JSON.parse(this.editor.getValue()),this.refreshChart(),this.editor.focus()},e.prototype.refreshChart=function(){var e=this;vg.parse.spec(this.$scope.data.spec,function(t){t({el:"#vis"+e.$scope.data._id}).update()})},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.ChartsEditCtrl=i}(ChartsWidget||(ChartsWidget={}));var ChartsWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("charts",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Charts/Charts.tpl.html",replace:!0,transclude:!1,controller:e.ChartCtrl}}])}(ChartsWidget||(ChartsWidget={}));var ChartsWidget;!function(e){var t=function(){function e(){}return e}();e.ChartData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,this.$dashboardService=o,this.defaultSpec={width:300,height:200,padding:{top:10,left:30,bottom:30,right:10},data:[{name:"table",values:[{x:1,y:28},{x:2,y:55},{x:3,y:43},{x:4,y:91},{x:5,y:81},{x:6,y:53},{x:7,y:19},{x:8,y:87},{x:9,y:52},{x:10,y:48},{x:11,y:24},{x:12,y:49},{x:13,y:87},{x:14,y:66},{x:15,y:17},{x:16,y:27},{x:17,y:68},{x:18,y:16},{x:19,y:49},{x:20,y:15}]}],scales:[{name:"x",type:"ordinal",range:"width",domain:{data:"table",field:"x"}},{name:"y",type:"linear",range:"height",domain:{data:"table",field:"y"},nice:!0}],axes:[{type:"x",scale:"x"},{type:"y",scale:"y"}],marks:[{type:"rect",from:{data:"table"},properties:{enter:{x:{scale:"x",field:"x"},width:{scale:"x",band:!0,offset:-1},y:{scale:"y",field:"y"},y2:{scale:"y",value:0}},update:{fill:{value:"steelblue"}},hover:{fill:{value:"red"}}}}]},e.vm=this;var n=e.$parent;this.widget=n.widget,e.data=this.widget.data,e.data._id=this.widget.id,$("#"+this.widget.elementId).on("remove",function(){s.generator&&s.generator.stop()})}return e.prototype.initChart=function(){var e=this.$scope.data,t=e.spec;if(e.lite&&(t=vl.compile(e.spec)),t){vg.embed("#vis"+e._id,t,function(t,r){e._view=t})}},e.prototype.updateChart=function(){var e=this.$scope.data,t=e.spec;e.lite&&(t=vl.compile(e.spec)),vg.parse.spec(t,function(t){t({el:"#vis"+e._id}).update()}),e._view.update()},e.prototype.startChart=function(){var e=this,t=this.$scope.data;if(!t.spec&&t.generator){if(t.generator.type&&this.$dashboardService.chartGenerators.hasOwnProperty(t.generator.type))return this.generator=this.$dashboardService.chartGenerators[t.generator.type](),void this.generator.start(this)}else t.spec||(t.spec=this.defaultSpec),this.initChart(),t.key&&(this.keyHandle=this.$layerService.$messageBusService.serverSubscribe(t.key,"key",function(r,i){switch(i.action){case"key":i.data.item.hasOwnProperty("values")?t.spec.data=i.data.item:t.spec=i.data.item,e.updateChart()}}))},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService","dashboardService"],e}();e.ChartCtrl=r}(ChartsWidget||(ChartsWidget={}));var Indicators;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("indicatorsEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Indicators/Indicators-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function t(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var l=e.$parent;this.widget=l.data,this.propertyTypes=[],e.data=this.widget.data,this.indicatorVisuals={},this.indicatorVisuals.bullet={id:"bullet",title:"Bullet chart",input:{}},this.indicatorVisuals.circular={id:"circular",title:"Circular",input:{value:{type:"expression","default":"~['value']"},min:{type:"expression","default":0},max:{type:"expression","default":0}}},this.indicatorVisuals.sparkline={id:"sparkline",title:"Sparkline",input:{property:{type:"string","default":"value"},height:{type:"string","default":"50"}}},this.indicatorVisuals.bar={id:"bar",title:"Bar chart",input:{}},this.indicatorVisuals.singlevalue={id:"singlevalue",title:"Value",input:{value:{type:"expression","default":"~['value']"}}}}return t.prototype.colorUpdated=function(e,t){t.color=e},t.prototype.updatePropertyTypes=function(e){var t=this.$layerService._featureTypes[e.featureTypeName];t&&(this.propertyTypeData=csComp.Helpers.getPropertyTypes(t,this.$layerService.propertyTypeData));
},t.prototype.moveUp=function(e){this.$scope.data.indicators.indexOf(e)},t.prototype.deleteIndicator=function(e){this.$scope.data.indicators=this.$scope.data.indicators.filter(function(t){return t.id!=e})},t.prototype.updateIndicator=function(e){e.propertyTypes=[],e.propertyTypeTitles=[],this.propertyTypes.forEach(function(t){e.propertyTypes.push(t.label),e.propertyTypeTitles.push(t.title)}),this.$layerService.lastSelectedFeature&&"feature"===e.source&&this.$messageBus.publish("feature","onUpdateWithLastSelected",{indicator:e,feature:void 0}),e._toggleUpdate=!e._toggleUpdate,this.updateVisual(e),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.initIndicator=function(e){this.updateVisual(e)},t.prototype.updateVisual=function(e){e.inputs||(e.inputs={});var t={};for(var r in this.indicatorVisuals[e.visual].input)if(e.inputs&&e.inputs.hasOwnProperty(r))t[r]=e.inputs[r];else{var i=this.indicatorVisuals[e.visual].input;t[r]=i[r]["default"]}e.inputs=t},t.prototype.addIndicator=function(){var t=new e.indicator;t.title="New Indicator",t.visual="circular",t.sensor="",t.source="feature",t.featureTypeName="",t.propertyTypes=[],this.updateVisual(t),this.$scope.data.indicators||(this.$scope.data.indicators=[]),this.$scope.data.indicators.push(t),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.sensorChanged=function(e){var t=e.sensor.split("/");t.length>1&&this.$layerService.project.datasources.forEach(function(r){r.id===t[0]&&r.sensors.hasOwnProperty(t[1])&&(e._sensorSet=r.sensors[t[1]])}),e._toggleUpdate=!e._toggleUpdate,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},t.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],t}();e.IndicatorsEditCtrl=i}(Indicators||(Indicators={}));var Indicators;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("indicators",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Indicators/Indicators.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.IndicatorsCtrl}}]).filter("datasource",function(){return function(e,t){if(!e)return"";var r=t.$parent.$eval(e.replace("~","i._value"));return r}})}(Indicators||(Indicators={}));var Indicators;!function(e){var t=function(){function e(){this.orientation="vertical"}return e}();e.indicatorData=t;var r=function(){function e(){this.inputs={},this._result={},this._toggleUpdate=!0,this.indicatorWidth=200}return e}();e.indicator=r;var i=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,this.$dashboardService=o,this.$translate=s,e.vm=this;var l=e.$parent;l.widget&&(this.widget=l.widget,this.widget._ctrl=this,this.checkLayers(),this.$messageBus.subscribe("layer",function(e){n.checkLayers()}),e.data=this.widget.data,"undefined"!=typeof e.data.indicators&&e.data.indicators.forEach(function(e){e.id="circ-"+csComp.Helpers.getGuid()}),t(function(){return n.checkLayers()}))}return e.prototype.forceUpdateIndicator=function(e,t){var r=this;setTimeout(function(){e._value=t,e._result={},r.$scope.$apply();for(var i in e.inputs)e._result[i]=e.inputs[i];r.$scope.$apply()},0)},e.prototype.updateIndicator=function(e){var t=this.$layerService.project.timeLine.focus;this.$layerService.findSensorSet(e.sensor,function(r){e._sensorSet=r,e._focusTime=t,e._sensorSet.propertyType&&e._sensorSet.propertyType.legend&&(e.color=csComp.Helpers.getColorFromLegend(e._sensorSet.activeValue,e._sensorSet.propertyType.legend))})},e.prototype.startEdit=function(){},e.prototype.checkLayers=function(){var e=this;if(this.$layerService.visual.mapVisible){var t=this.$layerService.project.timeLine.focus;this.$scope.data&&this.$scope.data.indicators&&this.$scope.data.indicators.forEach(function(r){if(r._focusTime=t,null!=r.layer){var i=r.layer.split("/"),a=e.$layerService.findLayer(i[0]);null!=a&&(i.length>1?r.isActive=a.enabled&&a.group.styles.some(function(e){return e.property==i[1]}):r.isActive=a.enabled)}})}},e.prototype.selectIndicator=function(e){if("undefined"!=e.dashboard){var t=this.$layerService.project.dashboards.filter(function(t){return t.id===e.dashboard});t.length>0&&this.$dashboardService.selectDashboard(t[0],"main")}if(this.$layerService.visual.mapVisible){if(null!=e.layer){var r=e.layer.split("/"),i=this.$layerService.findLayer(r[0]);null!=i&&(i.enabled?this.$layerService.checkLayerLegend(i,r[1]):(r.length>1&&(i.defaultLegendProperty=r[1]),this.$layerService.addLayer(i)))}this.checkLayers()}},e.prototype.indicatorInit=function(e,t){var r=this;switch(t.Math=Math,e.source){case"feature":this.$messageBus.subscribe("feature",function(t,i){switch(t){case"onFeatureSelect":r.selectFeature(i,e);break;case"onUpdateWithLastSelected":var a,o=i.indicator;r.$layerService.lastSelectedFeature&&(a=r.$layerService.lastSelectedFeature),r.selectFeature(a,o)}});break;case"sensor":null!=e.sensor&&(this.$layerService.$messageBusService.serverSubscribe(e.sensor,"key",function(t,i){switch(i.action){case"key":r.forceUpdateIndicator(e,e._sensorSet.activeValue)}}),this.updateIndicator(e))}},e.prototype.selectFeature=function(e,t){if(console.log("select feature called"),console.log(e),!t._sensorSet){var r=new csComp.Services.SensorSet;r.propertyType={title:""},t._sensorSet=r}if(t.hasOwnProperty("featureTypeName")&&e.featureTypeName===t.featureTypeName){t.propertyTypes;this.forceUpdateIndicator(t,e.properties),t._toggleUpdate=!t._toggleUpdate}"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService","dashboardService","$translate"],e}();e.IndicatorsCtrl=i}(Indicators||(Indicators={}));var IFrameWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("iframewidgetEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/IFrameWidget/IFrame-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t){this.$scope=e,this.$sce=t,e.vm=this;var r=e.$parent;this.widget=r.data,e.data=this.widget.data,this.update()}return e.prototype.update=function(){this.$scope.data._safeurl=this.$sce.trustAsResourceUrl(this.$scope.data.url)},e.$inject=["$scope","$sce"],e}();e.IFrameEditCtrl=i}(IFrameWidget||(IFrameWidget={}));var IFrameWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("iframewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/IFrameWidget/IFrameWidget.tpl.html",replace:!0,transclude:!1,controller:e.IFrameWidgetCtrl}}])}(IFrameWidget||(IFrameWidget={}));var IFrameWidget;!function(e){var t=function(){function e(){}return e}();e.IFrameWidgetData=t;var r=function(){function e(e,t){this.$scope=e,this.$sce=t,e.vm=this;var r=e.$parent;this.widget=r.widget,e.data=this.widget.data}return e.prototype.update=function(){this.$scope.data._safeurl=this.$sce.trustAsResourceUrl(this.$scope.data.url)},e.$inject=["$scope","$sce"],e}();e.IFrameWidgetCtrl=r}(IFrameWidget||(IFrameWidget={}));var AreaFilter;!function(e){var t=function(){function e(){this.id="AreaFilterModel"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.getFeatureActions=function(e){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":var t={title:"Set as area filter"};t.callback=this.setAsFilter;var r={title:"Reset area filter"};return r.callback=this.resetFilter,[t,r];default:return void console.log("Feature type name: "+e.featureTypeName)}},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.setAsFilter=function(e,t){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":t.setFeatureAreaFilter(e)}},e.prototype.resetFilter=function(e,t){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":t.resetFeatureAreaFilter()}},e.prototype.init=function(e){console.log("init AreaFilterActionService"),this.layerService=e},e}();e.AreaFilterModel=t}(AreaFilter||(AreaFilter={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,a("REMOVE").then(function(t){e.removeString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initAreaFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),t})}return e.prototype.setAreaFilter=function(e){"Polygon"===e.geometry.type?this.isInsideFunction=csComp.Helpers.GeoExtensions.pointInsidePolygon:"MultiPolygon"===e.geometry.type?this.isInsideFunction=csComp.Helpers.GeoExtensions.pointInsideMultiPolygon:this.isInsideFunction=function(){return!1}},e.prototype.initAreaFilter=function(){var e=this,t=this.$scope.filter,r=(t.value,t.group),i="filter_"+t.id;this.setAreaFilter(t.value),this.dcChart=dc.pieChart("#"+i),this.$scope.$apply();var a=r.ndx.dimension(function(e){if(e.id&&e.layer&&e.layer.group&&e.layer.group.markers&&e.layer.group.markers.hasOwnProperty(e.id)){var t=e.layer.group.markers[e.id];return t.feature.geometry.coordinates}return null});t.dimension=a,this.helperDim=crossfilter([{title:"inside"},{title:"outside"}]).dimension(function(e){return e.title}),this.helperGroup=this.helperDim.group(function(e){return e}),this.dcChart.width(175).height(200).slicesCap(4).innerRadius(0).dimension(this.helperDim).group(this.helperGroup).legend(dc.legend()).renderLabel(!0).label(function(e){return e.value}).on("renderlet",function(t){e.updateAreaFilter(e.$scope.filter.value,!1)}),this.updateAreaFilter(this.$scope.filter.value)},e.prototype.updateAreaFilter=function(e,t){var r=this;if(void 0===t&&(t=!0),e){var i=this.$scope.filter;if(i.dimension){var a=i.group;this.setAreaFilter(e),i.dimension.filterFunction(function(t){return null!=t?r.isInsideFunction(t,e.geometry.coordinates):!1}),this.helperGroup.all().forEach(function(e){"inside"===e.key&&(e.value=i.dimension.top(1/0).length),"outside"===e.key&&(e.value=i.dimension.groupAll().value()-i.dimension.top(1/0).length)}),this.isEmpty=!this.helperGroup.all().some(function(e){return 0!==e.value}),a.filterResult=i.dimension.top(1/0),t&&(this.$layerService.updateMapFilter(a),dc.renderAll())}}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.AreaFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,e.editMode=!0,a("REMOVE").then(function(t){e.removeString=t}),a("CREATE_SCATTER").then(function(t){e.createScatterString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initBarFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),e.filter.group.filters.forEach(function(r){"bar"==r.filterType&&r.property!=e.filter.property&&t.push([e.createScatterString+" "+r.title,function(){return o.createScatter(r)}])}),t})}return e.prototype.createScatter=function(e){this.$layerService.createScatterFilter(this.$scope.filter.group,this.$scope.filter.property,e.property)},e.prototype.displayFilterRange=function(e,t){+e>+t&&(e=t);var r=this.$scope.filter;r.rangex[0]<e?r.from=e:r.from=r.rangex[0],r.rangex[1]>t?r.to=t:r.to=r.rangex[1],this.$scope.$apply()},e.prototype.initBarFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.dcChart=dc.barChart("#"+i),this.$scope.$apply();var a=this.$layerService.calculatePropertyInfo(r,t.property),o=20,s=a.min,n=a.max;t.rangex[0]=s,t.rangex[1]=n,t.from=s,t.to=n;var l=(n-s)/o,c=r.ndx.dimension(function(e){if(e.properties.hasOwnProperty(t.property)){if(null!=e.properties[t.property]){var r=parseFloat(e.properties[t.property]);return r>=s&&n>=r?Math.floor(r/l)*l:null}return null}return null});t.dimension=c;var p=c.group();this.dcChart.width(275).height(110).dimension(c).group(p).transitionDuration(10).centerBar(!0).gap(5).elasticY(!0).x(d3.scale.linear().domain([s,n]).range([-1,o+1])).filterPrinter(function(t){var r="";if(t.length>0){var i=t[0];e.displayFilterRange(parseFloat(i[0]).toFixed(2),parseFloat(i[1]).toFixed(2)),r+=i[0]}return r}).on("renderlet",function(t){var i=(t.hasFilter(),"");if(t.filters.length>0){var a=t.filters[0];e.displayFilterRange(+a[0].toFixed(2),(+a[1]).toFixed(2)),i+=a[0]}dc.events.trigger(function(){e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){console.log("yes"),r.filterResult=c.top(1/0),e.$layerService.updateMapFilter(r)},100)}),this.dcChart.selectAll(),this.dcChart.xUnits(function(){return 13}),this.dcChart.yAxis().ticks(5),this.dcChart.xAxis().ticks(5),dc.renderAll(),this.updateRange()},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group)},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){var t=e.$scope.filter,r=t.group;e.displayFilterRange(e.$scope.filter.from,e.$scope.filter.to),e.dcChart.filterAll(),e.dcChart.filter(dc.filters.RangedFilter(e.$scope.filter.from,e.$scope.filter.to)),e.dcChart.render(),dc.redrawAll(),r.filterResult=t.dimension.top(1/0),e.$layerService.updateMapFilter(e.$scope.filter.group),e.$scope.$apply()},0)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.BarFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initBoolFilter(),e.$watch("filter.value",function(){i.updateBoolFilter()}))}return e.prototype.initBoolFilter=function(){var e=this.$scope.filter,t=e.group,r=t.ndx.dimension(function(t){return t.properties.hasOwnProperty(e.property)?t.properties[e.property]:null});e.dimension=r,e.group=t,r.filterFunction(function(e){return!1})},e.prototype.updateBoolFilter=function(){var e=this.$scope.filter;if(e.dimension){var t=e.group;e.dimension.filterFunction(function(t){return null!=t?t=e.value:!1}),t.filterResult=e.dimension.top(1/0),this.$layerService.updateMapFilter(t),dc.renderAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.BoolFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this["switch"]="after",e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initTextFilter(),this.subHandle=r.subscribe("timeline",function(e){switch(e){case"focusChange":i.updateTextFilter()}}),e.$watch("vm.switch",function(){i.updateTextFilter()}))}return e.prototype.select=function(){},e.prototype.check=function(e){if(null!=e){var t=Date.parse(e);switch(this["switch"]){case"before":return t>=this.$layerService.project.timeLine.focus;case"after":return t<=this.$layerService.project.timeLine.focus;case"range":return t>=this.$layerService.project.timeLine.start&&t<=this.$layerService.project.timeLine.end}}return!1},e.prototype.initTextFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i=r.ndx.dimension(function(e){return e.properties.hasOwnProperty(t.property)?e.properties[t.property]:null});t.dimension=i,t.group=r,this.$layerService.project.timeLine.focusDate,i.filterFunction(function(t){return e.check(t)})},e.prototype.updateTextFilter=function(){var e=this,t=this.$scope.filter;if(t.dimension){var r=t.group;t.dimension.filterFunction(function(t){return e.check(t)}),r.filterResult=t.dimension.top(1/0),this.$layerService.updateMapFilter(r),dc.renderAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.DateFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,a("REMOVE").then(function(t){e.removeString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initLocationFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),t})}return e.prototype.setLocationFilter=function(){var e=this;if(this.locationFilter)this.locationFilter.isEnabled()?this.locationFilter.disable():this.locationFilter.enable();else{var t=this.$layerService.map.map.getBounds();t=t.pad(-.75),this.locationFilter=new L.LocationFilter({bounds:t}).addTo(this.$layerService.map.map),this.$scope.filter.value=t,this.locationFilter.on("change",function(t){e.updateLocationFilter(t.bounds)}),this.locationFilter.on("enabled",function(t){e.updateLocationFilter(t.bounds)}),this.locationFilter.on("disabled",function(e){}),this.locationFilter.enable(),this.updateLocationFilter(this.locationFilter.getBounds())}},e.prototype.initLocationFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.setLocationFilter(),this.dcChart=dc.pieChart("#"+i),this.$scope.$apply();var a=r.ndx.dimension(function(e){if(e.id&&e.layer&&e.layer.group&&e.layer.group.markers&&e.layer.group.markers.hasOwnProperty(e.id)){var t=e.layer.group.markers[e.id];if(t.getBounds)return t.getBounds();if(t.getLatLng)return new L.LatLngBounds(t.getLatLng(),t.getLatLng())}return null});t.dimension=a,this.helperDim=crossfilter([{title:"inside"},{title:"outside"}]).dimension(function(e){return e.title}),this.helperGroup=this.helperDim.group(function(e){return e}),this.dcChart.width(175).height(200).slicesCap(4).innerRadius(0).dimension(this.helperDim).group(this.helperGroup).legend(dc.legend()).renderLabel(!0).label(function(e){return e.value}).on("renderlet",function(t){e.updateLocationFilter(e.locationFilter.getBounds(),!1)}),this.updateLocationFilter(this.$scope.filter.value)},e.prototype.updateLocationFilter=function(e,t){void 0===t&&(t=!0);var r=this.$scope.filter;if(r.dimension&&this.locationFilter.isEnabled()){var i=r.group;r.dimension.filterFunction(function(t){return null!=t?e.contains(t):!1}),this.helperGroup.all().forEach(function(e){"inside"===e.key&&(e.value=r.dimension.top(1/0).length),"outside"===e.key&&(e.value=r.dimension.groupAll().value()-r.dimension.top(1/0).length)}),this.isEmpty=!this.helperGroup.all().some(function(e){return 0!==e.value}),i.filterResult=r.dimension.top(1/0),t&&(this.$layerService.updateMapFilter(i),dc.renderAll())}},e.prototype.remove=function(){this.$scope.filter&&(this.locationFilter.disable(),this.$layerService.removeFilter(this.$scope.filter))},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.LocationFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,e.vm=this;var o=e.$parent.$parent;o.hasOwnProperty("filter")&&(e.filter=o.filter),e&&e.filter&&(setTimeout(function(){return a.initRowFilter()}),e.options=function(){var t=[];return t.push(["remove",function(){return a.remove()}]),e.filter.group.filters.forEach(function(r){"bar"==r.filterType&&r.property!=e.filter.property&&t.push(["create scatter with "+r.title,function(){return a.createScatter(r)}])}),t})}return e.prototype.createScatter=function(e){this.$layerService.createScatterFilter(this.$scope.filter.group,this.$scope.filter.property,e.property)},e.prototype.displayFilterRange=function(e,t){var r=this.$scope.filter;r.from=e,r.to=t,this.$scope.$apply()},e.prototype.initRowFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.dcChart=dc.rowChart("#"+i),this.$scope.$apply();var a=r.ndx.dimension(function(e){return e.properties.hasOwnProperty(t.property)&&null!=e.properties[t.property]?e.properties[t.property]:null});t.dimension=a;var o=a.group().reduceCount();this.dcChart.width(275).height(110).dimension(a).group(o).transitionDuration(100).gap(5).on("filtered",function(t){t.hasFilter();dc.events.trigger(function(){r.filterResult=a.top(1/0),e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){e.$layerService.updateMapFilter(r)},100)}),dc.renderAll()},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout"],e}();e.RowFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,e.vm=this;var o=e.$parent.$parent;o.hasOwnProperty("filter")&&(e.filter=o.filter),e&&e.filter&&(setTimeout(function(){return a.addScatterFilter()}),e.options=function(){var t=[];return t.push(["remove",function(){return a.remove()}]),e.filter.group.filters.forEach(function(r){"bar"==r.filterType&&r.property!=e.filter.property&&t.push(["create scatter with "+r.title,function(){return a.remove()}])}),t})}return e.prototype.displayFilterRange=function(e,t){var r=this.$scope.filter;r.from=e,r.to=t,this.$scope.$apply()},e.prototype.initBarFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.dcChart=dc.barChart("#"+i),this.$scope.$apply();var a=$("#fsfrom_"+t.id),o=$("#fsto_"+t.id),s=this.$layerService.calculatePropertyInfo(r,t.property),n=20,l=s.min,c=s.max+.01*(s.max-s.min),p=(c-l)/n,u=r.ndx.dimension(function(e){if(e.properties.hasOwnProperty(t.property)){if(null!=e.properties[t.property]){var r=parseFloat(e.properties[t.property]);return r>=l&&c>=r?Math.floor(r/p)*p:null}return null}return null});t.dimension=u;var h=u.group();this.dcChart.width(275).height(110).dimension(u).group(h).transitionDuration(100).centerBar(!0).gap(5).elasticY(!0).x(d3.scale.linear().domain([l,c]).range([-1,n+1])).filterPrinter(function(t){var r="";if(t.length>0){var i=t[0];e.displayFilterRange(i[0].toFixed(2),i[1].toFixed(2)),r+=i[0]}return r}).on("filtered",function(t){t.hasFilter();dc.events.trigger(function(){r.filterResult=u.top(1/0),e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){e.$layerService.updateMapFilter(r)},100)}),this.dcChart.xUnits(function(){return 13}),a.on("change",function(){if($.isNumeric(a.val())){var t=parseFloat(a.val()),r=e.dcChart.filters();r.length>0&&(r[0][0]=t,e.dcChart.filter(r[0]),e.dcChart.render(),dc.redrawAll())}}),o.on("change",function(){if($.isNumeric(o.val())){var t=parseFloat(o.val()),r=e.dcChart.filters();r.length>0&&(r[0][1]=t,e.dcChart.filter(r[0]),u.filter(r[0]),dc.renderAll())}}),this.dcChart.yAxis().ticks(5),this.dcChart.xAxis().ticks(5),dc.renderAll()},e.prototype.addScatterFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i=this.$layerService.calculatePropertyInfo(r,t.property),a=(this.$layerService.calculatePropertyInfo(r,t.property2),"filter_"+t.id),a="filter_"+t.id;this.dcChart=dc.scatterPlot("#"+a);var o=r.ndx.dimension(function(e){if(e.properties.hasOwnProperty(t.property)){if(null!=e.properties[t.property]){var r=parseFloat(e.properties[t.property]),a=parseFloat(e.properties[t.property2]);if(r>=i.min&&r<=i.max)return[r,a]}return[0,0]}return null});t.dimension=o;var s=o.group();this.dcChart.width(275).height(190).dimension(o).group(s).x(d3.scale.linear().domain([i.min,i.max])).yAxisLabel(t.property2).xAxisLabel(t.property).on("filtered",function(t){t.hasFilter();dc.events.trigger(function(){r.filterResult=o.top(1/0),e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){e.$layerService.updateMapFilter(r)},100)}),this.dcChart.xUnits(function(){return 13}),this.dcChart.yAxis().ticks(15),this.dcChart.xAxis().ticks(15),this.dcChart.render()},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout"],e}();e.ScatterFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("txt2",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/TextFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.TextFilterCtrl}}]).directive("boolFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/BoolFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.BoolFilterCtrl}}]).directive("barFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/BarFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.BarFilterCtrl}}]).directive("scatterFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/ScatterFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.ScatterFilterCtrl}}]).directive("dateFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/DateFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.DateFilterCtrl}}]).directive("locationFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/LocationFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LocationFilterCtrl}}]).directive("areaFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/AreaFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.AreaFilterCtrl}}])}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initTextFilter(),e.$watch("filter.stringValue",function(){i.updateTextFilter()}))}return e.prototype.initTextFilter=function(){var e=this.$scope.filter,t=e.group,r=t.ndx.dimension(function(t){return t.properties.hasOwnProperty(e.property)?t.properties[e.property]:null});e.dimension=r,e.group=t,r.filterFunction(function(t){return null!=t&&"function"==typeof t.toLowerCase?t.toLowerCase().indexOf(e.stringValue.toLowerCase())>-1:!1})},e.prototype.updateTextFilter=function(){var e=this.$scope.filter;if(e.dimension){var t=e.group;null==e.stringValue||""===e.stringValue?e.dimension.filterAll():e.dimension.filterFunction(function(t){return null!=t&&"function"==typeof t.toLowerCase?t.toLowerCase().indexOf(e.stringValue.toLowerCase())>-1:!1}),t.filterResult=e.dimension.top(1/0),this.$layerService.updateMapFilter(t),dc.redrawAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.TextFilterCtrl=t}(Filters||(Filters={}));var Markdown;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("markdownwidgetEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/MarkdownWidget/Markdown-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var l=e.$parent;this.widget=l.data,e.data=this.widget.data}return e.prototype.updateText=function(){this.$scope.data.mdText=this.$scope.data.content},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.MarkdownEditCtrl=i}(Markdown||(Markdown={}));var MarkdownWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("markdownwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/MarkdownWidget/MarkdownWidget.tpl.html",replace:!0,transclude:!1,controller:e.MarkdownWidgetCtrl}}])}(MarkdownWidget||(MarkdownWidget={}));var MarkdownWidget;!function(e){var t=function(){function e(){}return e}();e.MarkdownWidgetData=t;var r=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var s=e.$parent;this.widget=s.widget,e.data=this.widget.data,e.data.mdText=e.data.content,e.minimized=!1,"undefined"!=typeof e.data.featureTypeName&&"undefined"!=typeof e.data.dynamicProperties&&e.data.dynamicProperties.length>0&&(this.parentWidget=$("#"+this.widget.elementId).parent(),this.parentWidget.hide(),this.$messageBus.subscribe("feature",function(e,t){switch(e){case"onFeatureDeselect":case"onFeatureSelect":o.selectFeature(t)}})),"undefined"!=typeof e.data.url&&$.get(e.data.url,function(r){t(function(){e.data.content=e.data.mdText=r},0)})}return e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},e.prototype.replaceAll=function(e,t,r){return e.replace(new RegExp(this.escapeRegExp(t),"g"),r)},e.prototype.selectFeature=function(e){var t=this;return e&&e.isSelected&&e.featureTypeName===this.$scope.data.featureTypeName?void this.$timeout(function(){var r=t.$scope.data.content,i=0;t.$scope.data.dynamicProperties.forEach(function(a){
var o="{{"+i++ +"}}",s="";if(e.properties.hasOwnProperty(a)){var n=t.$layerService.getPropertyType(e,a);s=csComp.Helpers.convertPropertyInfo(n,e.properties[a])}r=t.replaceAll(r,o,s)}),t.parentWidget.show(),t.$scope.data.mdText=r},0):void this.parentWidget.hide()},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.MarkdownWidgetCtrl=r}(MarkdownWidget||(MarkdownWidget={}));var NavigatorWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("navigatorwidgetEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/MarkdownWidget/Markdown-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var l=e.$parent;this.widget=l.data,e.data=this.widget.data}return e.prototype.updateText=function(){this.$scope.data.mdText=this.$scope.data.content},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.MarkdownEditCtrl=i}(NavigatorWidget||(NavigatorWidget={}));var NavigatorWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("navigatorwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Navigator/NavigatorWidget.tpl.html",replace:!0,transclude:!1,controller:e.NavigatorWidgetCtrl}}])}(NavigatorWidget||(NavigatorWidget={}));var NavigatorWidget;!function(e){var t=function(){function e(){}return e}();e.NavigatorWidgetData=t;var r=function(){function e(e,t,r,i,a){this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var o=e.$parent;this.widget=o.widget,this.widget.data&&(e.data=this.widget.data),"undefined"!=typeof e.data.featureTypeName&&"undefined"!=typeof e.data.dynamicProperties&&e.data.dynamicProperties.length>0&&(this.parentWidget=$("#"+this.widget.elementId).parent(),this.parentWidget.hide())}return e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.NavigatorWidgetCtrl=r}(NavigatorWidget||(NavigatorWidget={}));var MCAWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mcawidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/MCAWidget/MCAWidget.tpl.html",replace:!0,transclude:!1,controller:e.MCAWidgetCtrl}}])}(MCAWidget||(MCAWidget={}));var MCAWidget;!function(e){var t=function(){function e(){}return e}();e.MCAWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$controller=r,this.$layerService=i,this.$messageBus=a,this.$mapService=o,e.vm=this;var n=e.$parent;this.widget=n.widget,e.data=this.widget.data,"undefined"!=typeof e.data.layerId&&(this.parentWidget=$("#"+this.widget.elementId).parent(),this.parentWidget.hide(),this.$messageBus.subscribe("layer",function(e,t){switch(e){case"activated":case"deactivate":s.activateLayer(t)}}))}return e.prototype.activateLayer=function(e){var t=this;return this.mcaScope=this.getMcaScope(),this.mcaScope?e.id!==this.$scope.data.layerId||e.id===this.$scope.data.layerId&&!e.enabled?void this.parentWidget.hide():void this.$timeout(function(){t.parentWidget.show()},0):void 0},e.prototype.getMcaScope=function(){var e=angular.element('div[id="mca"]');if(!e)return void console.log("Mca element not found.");var t=e.scope();return t?(this.$scope.data.availableMcas=t.vm.availableMcas,t):void console.log("Mca controller scope not found.")},e.prototype.setMcaAsStyle=function(e){if(!this.mcaScope||!this.mcaScope.vm.mca)return void console.log("Mca controller scope not found.");var t=this.mcaScope.vm;if(!t.showFeature)return void this.$messageBus.notifyWithTranslation("SELECT_A_FEATURE","SELECT_FEATURE_FOR_STYLE");if(t.properties.length>0){var r=t.availableMcas.length;r>=e&&(t.mca=t.availableMcas[e],t.updateMca()),console.log("Set mca style."),t.setStyle(t.properties[0])}},e.$inject=["$scope","$timeout","$controller","layerService","messageBusService","mapService"],e}();e.MCAWidgetCtrl=r}(MCAWidget||(MCAWidget={}));var SimState;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simstateEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimState/SimState.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,e.vm=this}return e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimStateEditCtrl=i}(SimState||(SimState={}));var SimState;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simstate",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimState/SimState.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,this.states={},e.vm=this,r.serverSubscribe("Sim.SimState.","key",function(e,t){t&&t.hasOwnProperty("data")&&t.data.hasOwnProperty("item")&&a.$timeout(function(){var e=t.data.item;"Exit"===e.state?delete a.states[e.id]:a.states[e.name]=e},0)})}return e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimStateCtrl=i}(SimState||(SimState={}));var PostMan;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("postmanEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/PostMan/PostMan-edit.tpl.html",replace:!0,transclude:!1,controller:e.PostManEditCtrl}}])}(PostMan||(PostMan={}));var PostMan;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("postman",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/PostMan/PostMan.tpl.html",replace:!0,transclude:!1,controller:e.PostManCtrl}}])}(PostMan||(PostMan={}));var PostMan;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,e.vm=this;var a=e.$parent;e.data=a.widget.data,e.data.messages&&(e.selectedMessage=e.data.messages[0])}return e.prototype.execute=function(){var e=this;if(this.$scope.selectedMessage){var t=this.$scope.selectedMessage;switch(this.result="",t.httpMethod.name.toUpperCase()){case"POST":this.$http.post(t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t});break;case"PUT":this.$http.put(t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t});break;case"GET":this.$http.get(t.url,t.message).success(function(t){e.result="Result: "+t}).error(function(t){e.result="Error: "+t});break;case"DELETE":this.$http["delete"](t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t})}}},e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.PostManCtrl=t}(PostMan||(PostMan={}));var PostMan;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$timeout=t,this.$messageBus=r,this.$dashboardService=i,e.vm=this,e.methods=[{name:"GET"},{name:"PUT"},{name:"POST"},{name:"DELETE"}];var a=e.$parent;this.widget=a.data,e.data=this.widget.data,e.data.messages?e.selectedMessage=e.data.messages[0]:(e.data.messages=[],this.addMessage())}return e.prototype.addMessage=function(){this.$scope.selectedMessage={name:"New message...",httpMethod:this.$scope.methods[2]},this.$scope.data.messages.push(this.$scope.selectedMessage)},e.prototype.deleteMessage=function(){if(this.$scope.selectedMessage){var e=this.$scope.data.messages.indexOf(this.$scope.selectedMessage);0>e||(this.$scope.data.messages.slice(e,1),0===this.$scope.data.messages.length?this.addMessage():this.$scope.selectedMessage=this.$scope.data.messages[0])}},e.$inject=["$scope","$timeout","messageBusService","dashboardService"],e}();e.PostManEditCtrl=t}(PostMan||(PostMan={}));var SimTimeController;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simtimecontrollerEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimTimeController/SimTimeController-edit.tpl.html",replace:!0,transclude:!1,controller:e.SimTimeControllerEditCtrl}}])}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simtimecontroller",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimTimeController/SimTimeController.tpl.html",replace:!0,transclude:!1,controller:e.SimTimeControllerCtrl}}])}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){!function(e){e[e.Stopped=0]="Stopped",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused"}(e.PlayState||(e.PlayState={}));var t=e.PlayState;!function(e){e[e.Start=0]="Start",e[e.Pause=1]="Pause",e[e.Stop=2]="Stop",e[e.Run=3]="Run",e[e.Finish=4]="Finish",e[e.Exit=5]="Exit"}(e.SimCommand||(e.SimCommand={}));var r=e.SimCommand,i=function(){function e(e,i,a,o){var s=this;this.$scope=e,this.$http=i,this.messageBusService=a,this.$timeout=o,this.speed=1,this.startTime=new Date,this.time=this.startTime,this.isOpen=!1,this.timeOptions={readonlyInput:!1,showMeridian:!1},this.isPlaying=!1,this.isPaused=!1,this.isStopped=!0,e.vm=this;var n=e.$parent;this.editorData=n.widget.data,this.httpMethod="POST",this.editorData.hasOwnProperty("httpMethod")&&this.editorData.httpMethod.hasOwnProperty("name")&&(this.httpMethod=this.editorData.httpMethod.name.toUpperCase()),this.url=this.editorData.url||"api/keys/simTime",this.fsm=new FSM.FiniteStateMachine(t.Stopped),this.fsm.from(t.Stopped).to(t.Playing).on(r.Start),this.fsm.from(t.Playing).to(t.Stopped).on(r.Stop),this.fsm.from(t.Playing).to(t.Paused).on(r.Pause),this.fsm.from(t.Paused).to(t.Stopped).on(r.Stop),this.fsm.from(t.Paused).to(t.Playing).on(r.Start),this.fsm.onTransition=function(e,r){console.log("Moving from "+t[e]+" to "+t[r]+".")},this.fsm.onEnter(t.Stopped,function(e){return s.$timeout(function(){s.isStopped=!0,s.isPlaying=!1,s.isPaused=!1},0),s.sendSimTimeMessage(r.Stop),!0}),this.fsm.onEnter(t.Playing,function(e){return s.$timeout(function(){s.isPlaying=!0,s.isStopped=!1,s.isPaused=!1},0),s.sendSimTimeMessage(r.Start),!0}),this.fsm.onEnter(t.Paused,function(e){return s.$timeout(function(){s.isPaused=!0,s.isStopped=!1,s.isPlaying=!1},0),s.sendSimTimeMessage(r.Pause),!0}),i.get(this.url).then(function(e){}),console.log("Simtimecontroller constructed")}return e.prototype.subscribeToSimTime=function(){var e=this;this.messageBusHandle=this.messageBusService.serverSubscribe("Sim.SimTime","key",function(t,r){r&&r.hasOwnProperty("data")&&r.data.hasOwnProperty("item")&&r.data.item&&e.$timeout(function(){r.data.item.hasOwnProperty("simTime")?e.time=new Date(+r.data.item.simTime):e.time=new Date(r.data.item),isNaN(e.time.getTime())?console.log("ERROR processing Sim.SimTime message! Received: (input: "+JSON.stringify(r.data.item,null,2)):e.messageBusService.publish("timeline","setFocus",e.time)},0)})},e.prototype.play=function(){this.messageBusHandle||this.subscribeToSimTime(),this.fsm.trigger(r.Start)},e.prototype.pause=function(){this.fsm.trigger(r.Pause)},e.prototype.stop=function(){this.messageBusHandle&&(this.messageBusService.serverUnsubscribe(this.messageBusHandle),this.messageBusHandle=null),this.fsm.trigger(r.Stop)},e.prototype.increaseSpeed=function(){this.speed*=2,this.speedChanged()},e.prototype.decreaseSpeed=function(){this.speed/=2,this.speedChanged()},e.prototype.setSpeed=function(e){this.speed=e,this.speedChanged()},e.prototype.setTime=function(e){this.fsm.currentState===t.Stopped&&(this.startTime=this.time=new Date(e))},e.prototype.openCalendar=function(e){e.preventDefault(),e.stopPropagation(),this.isOpen=!0},e.prototype.speedChanged=function(){this.fsm.currentState===t.Playing&&this.sendSimTimeMessage(r.Start)},e.prototype.sendSimTimeMessage=function(e){var t={simTime:this.time.valueOf().toString(),simSpeed:this.speed.toString(),simCmd:r[e],type:"simTime"};switch(this.httpMethod){case"POST":this.$http.post(this.url,t).error(function(e){return alert("Failed to deliver message: "+JSON.stringify({err:e}))});break;case"PUT":this.$http.put(this.url,t).error(function(e){return alert("Failed to deliver message: "+JSON.stringify({err:e}))})}},e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimTimeControllerCtrl=i}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$timeout=t,this.$messageBus=r,this.$dashboardService=i,e.vm=this,e.methods=[{name:"GET"},{name:"PUT"},{name:"POST"},{name:"DELETE"}];var a=e.$parent;this.widget=a.data,e.data=this.widget.data,e.data.httpMethod||(e.data.httpMethod=e.methods[2]),e.data.url||(e.data.url="api/keys/simTime")}return e.$inject=["$scope","$timeout","messageBusService","dashboardService"],e}();e.SimTimeControllerEditCtrl=t}(SimTimeController||(SimTimeController={}));var L;!function(e){function t(e,t,i){return new r(e,t,i)}var r=e.Class.extend({initialize:function(t,r,i){this._layer=r,this._userDrawFunc=t,e.Util.setOptions(this,i)},drawing:function(e){return this._userDrawFunc=e,this},params:function(t){return e.Util.setOptions(this,t),this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=e.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){var r=this;this._map=t,this._canvas=e.DomUtil.create("canvas","leaflet-overlay-layer");var i=this._map.getSize();this._canvas.width=i.x,this._canvas.height=i.y,this._context=this._canvas.getContext("2d"),this._popup=null,this.onMouseMoveDelay=_.throttle(function(t){var i=r._getCanvasPos(),a=r._context.getImageData(t.x-i.left,t.y-i.top,1,1).data;if(a[0]+a[1]+a[2]>0){var o=r._map.containerPointToLatLng(new e.Point(t.x-i.left,t.y-i.top)),s=Math.floor((o.lat-r.options.topLeftLat)/r.options.deltaLat),n=Math.floor((o.lng-r.options.topLeftLon)/r.options.deltaLon),l="";s>=0&&s<r.options.data.length&&n>=0&&n<r.options.data[0].length&&(l=String.format("{0:0.00}",r.options.data[s][n])),r._layer.dataSourceParameters.legendStringFormat?l=String.format(r._layer.dataSourceParameters.legendStringFormat,l):null;var c="<table><td>"+l+"</td></tr></table>";r._popup&&r._map._popup&&r._map._popup._isOpen?r._popup.setLatLng(r._map.containerPointToLatLng(new e.Point(t.x,t.y))).setContent(c):r._popup=e.popup({offset:new e.Point(-25,-15),closeOnClick:!0,autoPan:!1,className:"featureTooltip"}).setLatLng(r._map.containerPointToLatLng(new e.Point(t.x,t.y))).setContent(c).openOn(r._map)}else r._map.closePopup(r._popup),r._popup=null},500),t.getPanes().overlayPane.addEventListener("mousemove",this.onMouseMoveDelay);var a=this._map.options.zoomAnimation&&e.Browser.any3d;e.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(a?"animated":"hide")),t._panes.overlayPane.firstChild?t._panes.overlayPane.insertBefore(this._canvas,t._panes.overlayPane.firstChild):t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.on("resize",this._resize,this),t.options.zoomAnimation&&e.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("resize",this._resize,this),e.getPanes().overlayPane.removeEventListener("mousemove",this.onMouseMoveDelay),e.closePopup(this._popup),this._popup=null,e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this),this._canvas=null},addTo:function(e){return e.addLayer(this),this},_getCanvasPos:function(){for(var e=this._canvas,t=0,r=0;e&&"BODY"!=e.tagName;)t+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent;return{top:t,left:r}},_resize:function(e){this._canvas.width=e.newSize.x,this._canvas.height=e.newSize.y},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);e.DomUtil.setPosition(this._canvas,t),this._redraw()},_redraw:function(){var e=this._map.getSize(),t=this._map.getBounds(),r=180*e.x/(20037508.34*(t.getEast()-t.getWest())),i=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,this._layer,{canvas:this._canvas,bounds:t,size:e,zoomScale:r,zoom:i,options:this.options}),this._frame=null},_animateZoom:function(t){var r=this._map.getZoomScale(t.zoom),i=this._map._getCenterOffset(t.center)._multiplyBy(-r).subtract(this._map._getMapPanePos());this._canvas.style[e.DomUtil.TRANSFORM]=e.DomUtil.getTranslateString(i)+" scale("+r+")"}});e.canvasOverlay=t}(L||(L={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t,r){t.mapLayer=new L.LayerGroup,e.map.map.addLayer(t.mapLayer),t.data&&t.data.features&&t.data.features.forEach(function(e){var i=r.addFeature(e);i&&(t.group.markers[e.id]=i)})},e.remove=function(e,t){var r=t.group;if(r.clustering){var i=r.cluster;e.project.features.forEach(function(e){if(e.layerId===t.id)try{i.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id]}catch(r){}})}else if(e.project.features.forEach(function(e){e.layerId===t.id&&t.group.markers.hasOwnProperty(e.id)&&delete t.group.markers[e.id]}),e.map.map&&t.mapLayer)try{e.map.map.removeLayer(t.mapLayer)}catch(a){}},e}();e.GeojsonRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(){}return r.render=function(i,a){var o,s=a.dataSourceParameters,n=[];if("number"==typeof s.contourLevels){o=[];for(var l=s.contourLevels,c=(s.maxThreshold-s.minThreshold)/l,p=s.minThreshold+c/2;p<s.maxThreshold;p+=c)o.push(Math.round(10*p)/10)}else o=s.contourLevels;var u=new t.GroupStyle(i.$translate);u.id=e.Helpers.getGuid(),u.title=s.legendDescription?s.legendDescription:a.title,u.meta=null,u.visualAspect="fillColor",u.availableAspects=["fillColor"],u.info={min:0,max:0,count:0,mean:0,varience:0,sd:0},u.fixedColorRange=!0,u.enabled=!0,u.group=a.group,s.legend?(u.property="",u.canSelectColor=!1,u.colors=["#ffffff","#000000"],u.activeLegend=s.legend,u.activeLegend.legendEntries.forEach(function(e){n.push({val:e.value,color:e.color})})):(u.property="gridlayer",u.canSelectColor=!0,u.colors=[s.minColor?s.minColor:"#00fbff",s.maxColor?s.maxColor:"#0400ff"],u.activeLegend={legendKind:"interpolated",description:u.title,visualAspect:"fillColor",legendEntries:[]}),i.saveStyle(a.group,u);var h=L.canvasOverlay(r.drawFunction,a,{data:a.data,noDataValue:s.noDataValue,topLeftLat:s.startLat,topLeftLon:s.startLon,deltaLat:s.deltaLat,deltaLon:s.deltaLon,min:s.minThreshold,max:s.maxThreshold,minColor:u.colors[0],maxColor:u.colors[1],areColorsUpdated:!1,levels:o,legend:n,opacity:a.opacity?+a.opacity/100:.3});a.mapLayer=new L.LayerGroup,i.map.map.addLayer(a.mapLayer),a.mapLayer.addLayer(h)},r.drawFunction=function(e,t,r){var i=this._map,a=r.options,o=a.data;if(o){var s=o.length,n=o[0].length,l=r.size,c=a.legend;if(0===c.length||a.areColorsUpdated){c=[],"#"!==a.minColor[0]&&(a.minColor=ColorExt.Utils.colorNameToHex(a.minColor)),"#"!==a.maxColor[0]&&(a.maxColor=ColorExt.Utils.colorNameToHex(a.maxColor));for(var p=ColorExt.Utils.rgbToHue(a.minColor),u=ColorExt.Utils.rgbToHue(a.maxColor),h=0;h<a.levels.length;h++){var d=a.levels[h];c.push({val:d,color:ColorExt.Utils.toColor(d,a.levels[0],a.levels[a.levels.length-1],p,u)})}t.group.styles&&t.group.styles.length>0&&(t.group.styles[0].activeLegend={legendKind:"interpolated",description:t.group.styles[0].title,visualAspect:"fillColor",legendEntries:[]},c.forEach(function(e){var r={label:String.format(t.dataSourceParameters.legendStringFormat||"{0:00}",e.val),value:e.val,color:e.color};t.group.styles[0].activeLegend.legendEntries.push(r)})),e.options.legend=a.legend=c,a.areColorsUpdated=!1}var f=a.min||Number.MIN_VALUE,y=a.max||Number.MAX_VALUE,m=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat,a.topLeftLon)),g=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat+s*a.deltaLat,a.topLeftLon+n*a.deltaLon)),v=m.x,S=m.y,$=(g.x-m.x)/n,b=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat+a.deltaLat,a.topLeftLon)),w=b.y-m.y,T=r.canvas.getContext("2d");if(T.clearRect(0,0,l.x,l.y),!(v>l.x||S>l.y||g.x<0||g.y<0)){var E=0,C=s,M=n;-$>v&&(E=-Math.ceil(v/$),v+=E*$),g.x>l.x&&(M-=Math.floor((g.x-l.x)/$)),g.y>l.y&&w>0&&(C-=Math.floor((g.y-l.y)/w));var F=a.noDataValue;T.globalAlpha=a.opacity||.3,console.time("process");for(var P=S,x=a.topLeftLat,O=0;C>O;O++){x+=a.deltaLat;var D=i.latLngToContainerPoint(new L.LatLng(x,a.topLeftLon)).y;if(w=D-P,-w>=P||0===w)P=D;else{for(var k=v,A=E;M>A;A++){var I=o[O][A];if(I===F||f>I||I>y)k+=$;else{var R=c.reduce(function(e,t){return Math.abs(t.val-I)<Math.abs(e.val-I)?t:e});T.fillStyle=R.color,T.fillRect(k,P,$,w),k+=$}}P=D}}console.timeEnd("process")}}},r}();t.GridLayerRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t,r){if(!t.quickRefresh||1!=t.quickRefresh){(new Date).getTime();if(t.isLoading=!0,t.group.clustering){var i=L.geoJson(t.data,{pointToLayer:function(e,t){return r.createFeature(e)},onEachFeature:function(e,i){t.group.markers[e.id]=i,i.on({mouseover:function(e){return r.showFeatureTooltip(e,t.group)},mouseout:function(e){return r.hideFeatureTooltip(e)}})}});t.group.cluster.addLayer(i)}else{if(t.mapLayer=new L.LayerGroup,e.map.map.addLayer(t.mapLayer),t.data&&t.data.features)var a=L.geoJson(t.data,{onEachFeature:function(e,i){t.group.markers[e.id]=i,i.on({mouseover:function(e){return r.showFeatureTooltip(e,t.group)},mouseout:function(e){return r.hideFeatureTooltip(e)},mousemove:function(e){return r.updateFeatureTooltip(e)},click:function(t){r.selectFeature(e)}})},style:function(e,r){return t.group.markers[e.id]=r,e.effectiveStyle},pointToLayer:function(e,t){return r.createFeature(e)}});else var a=L.geoJson([]);e.project.features.forEach(function(r){if(r.layerId===t.id){var i=e.getFeatureType(r);r.properties.Name=r.properties[i.style.nameLabel]}}),t.mapLayer.addLayer(a),t.isLoading=!1;(new Date).getTime()}}},e}();e.HeatmapRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){}return t.render=function(t,r){var i=r.url;if(r.timeDependent){var a=t.project.timeLine.focus;if(r.timeResolution){var o=r.timeResolution;a=Math.floor(a/o)*o}var s=new Date(0);s.setUTCSeconds(a/1e3);var n=s.yyyymmdd(),l=s.getHours(),c=s.getMinutes(),p=s.getSeconds(),u=e.Utils.twoDigitStr(l)+e.Utils.twoDigitStr(c)+e.Utils.twoDigitStr(p);i+="&time="+n+u}else r.disableCache&&(r.cacheKey=(new Date).getTime().toString(),i+="&cache="+r.cacheKey);var h=L.tileLayer(i,{attribution:r.description});r.mapLayer=new L.LayerGroup,h.setOpacity(r.opacity/100),t.map.map.addLayer(r.mapLayer),r.mapLayer.addLayer(h),h.on("loading",function(e){r.isLoading=!0,t.$rootScope.$apply(),"$apply"!=t.$rootScope.$$phase&&"$digest"!=t.$rootScope.$$phase&&t.$rootScope.$apply()}),h.on("load",function(e){r.isLoading=!1,"$apply"!=t.$rootScope.$$phase&&"$digest"!=t.$rootScope.$$phase&&t.$rootScope.$apply()}),r.isLoading=!0},t}();t.TileLayerRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t){var r=L.tileLayer.wms(t.url,{layers:t.wmsLayers,opacity:t.opacity/100,format:"image/png",transparent:!0,attribution:t.description,tiled:!0});t.mapLayer=new L.LayerGroup,e.map.map.addLayer(t.mapLayer),t.mapLayer.addLayer(r),r.on("loading",function(r){t.isLoading=!0,e.$rootScope.$apply(),"$apply"!=e.$rootScope.$$phase&&"$digest"!=e.$rootScope.$$phase&&e.$rootScope.$apply()}),r.on("load",function(r){t.isLoading=!1,"$apply"!=e.$rootScope.$$phase&&"$digest"!=e.$rootScope.$$phase&&e.$rootScope.$apply()}),t.isLoading=!0},e}();e.WmsRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function r(e){this.service=e,this.title="database",this.requiresLayer=!1}return r.prototype.refreshLayer=function(e){this.service.removeLayer(e),this.service.addLayer(e)},r.prototype.addLayer=function(e,t){this.baseAddLayer(e,t)},r.prototype.fitMap=function(t){var r=e.Helpers.GeoExtensions.getBoundingBox(this.layer.data);this.service.$messageBusService.publish("map","setextent",r)},r.prototype.layerMenuOptions=function(e){var t=this;return[["Fit map",function(r){return t.fitMap(e)}],null,["Refresh",function(r){return t.refreshLayer(e)}]]},r.prototype.baseAddLayer=function(e,r){var i=this;if(this.layer=e,e.data&&e.data.features&&!e.BBOX){e.count=0,e.isLoading=!1;var a=this.service.findLayer(e.id);a&&(a.isLoading=!1,a.enabled=!0),e.data.features.forEach(function(t){i.service.initFeature(t,e,!1,!1)}),"$apply"!=this.service.$rootScope.$root.$$phase&&"$digest"!=this.service.$rootScope.$root.$$phase&&this.service.$rootScope.$apply(),r(e)}else async.series([function(r){e.renderType="geojson",e.isLoading=!0,e.BBOX&&delete e.BBOX;var a;i.service.$mapService.map.getZoom()<16?(console.log("Zoom level too low, zoom in to show contours"),a=new L.LatLngBounds(new L.LatLng(99,99),new L.LatLng(99.00001,99.00001))):a=i.service.$mapService.map.getBounds();var o=[[[a.getSouthWest().lng,a.getSouthWest().lat],[a.getNorthWest().lng,a.getNorthWest().lat],[a.getNorthEast().lng,a.getNorthEast().lat],[a.getSouthEast().lng,a.getSouthEast().lat],[a.getSouthWest().lng,a.getSouthWest().lat]]],s=JSON.stringify({type:"Polygon",coordinates:o,crs:{type:"name",properties:{name:"EPSG:4326"}}}),n={bounds:s,layer:t.ProjectLayer.serializeableData(e)};$.ajax({type:"POST",url:e.url,data:JSON.stringify(n),contentType:"application/json",dataType:"json",success:function(e){console.log("Requested bag contours")},error:function(){i.service.$messageBusService.publish("layer","error",e)}})},function(){r(e)}])},r.prototype.removeLayer=function(e){var t=this.service.findLayer(e.id);t&&(t.enabled=!1),e.data.features={}},r}();t.DatabaseSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(){function t(e,t){this.service=e,this.title="geojson",this.requiresLayer=!1,this.$http=t}return t.prototype.refreshLayer=function(e){var t=e.enabled;this.service.removeLayer(e),this.service.addLayer(e),e.enabled=t},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),this.baseAddLayer(e,t,r)},t.prototype.fitMap=function(t){var r=e.Helpers.GeoExtensions.getBoundingBox(t.data);this.service.$messageBusService.publish("map","setextent",r)},t.prototype.layerMenuOptions=function(e){var t=this;return[["Fit map",function(r){return t.fitMap(e)}],null,["Refresh",function(r){return t.refreshLayer(e)}]]},t.prototype.baseAddLayer=function(e,t,r){var i=this;void 0===r&&(r=null),null!=r&&console.log("we got him"),this.layer=e,async.series([function(t){if(e.renderType="geojson",r)e.enabled=!0,i.initLayer(r,e),t(null,null);else{e.isLoading=!0;var a=e.url.replace("[BBOX]",e.BBOX);e.useProxy&&(a="/api/proxy?url="+a),i.$http.get(a).success(function(r){e.count=0,e.isLoading=!1,e.enabled=!0,i.initLayer(r,e),i.layer.fitToMap&&i.fitMap(i.layer),t(null,null)}).error(function(){e.count=0,e.isLoading=!1,e.enabled=!1,e.isConnected=!1,i.service.$messageBusService.notify("ERROR loading "+e.title,"\nwhile loading: "+a),t(null,null)})}},function(){t(e)}])},t.prototype.initLayer=function(t,r){var i=this;if("topojson"===r.type.toLowerCase()&&(t=e.Helpers.GeoExtensions.convertTopoToGeoJson(t)),("accessibility"===r.id.toLowerCase()||"tripplanner"===r.id.toLowerCase())&&(r.disableMoveSelectionToFront=!0,this.processAccessibilityReply(t,r,function(e){t=r.data,r=e})),t.featureTypes)for(var a in t.featureTypes)if(t.featureTypes.hasOwnProperty(a)){var o=t.featureTypes[a];a=r.url+"#"+a,this.service._featureTypes[a]=o}t.timestamps&&(r.timestamps=t.timestamps),r.data=t,r.data.geometries&&!r.data.features&&(r.data.features=r.data.geometries),r.data.features.forEach(function(e){i.service.initFeature(e,r,!1,!1)}),r.isTransparent=!1,(r.minZoom||r.maxZoom)&&(r.minZoom||(r.minZoom=0),r.maxZoom||(r.maxZoom=25),r.zoomHandle=this.service.$messageBusService.subscribe("map",function(e,t){!e||!t||"zoom"!==e||0>t||(t<r.minZoom||t>r.maxZoom?r.isTransparent||(r.isTransparent=!0,i.service.updateLayerFeatures(r)):r.isTransparent&&(r.isTransparent=!1,i.service.updateLayerFeatures(r)))})),this.service.$messageBusService.publish("timeline","updateFeatures")},t.prototype.removeLayer=function(e){if(e.isTransparent=!1,e.zoomHandle&&this.service.$messageBusService.unsubscribe(e.zoomHandle),e.fitToMap){if(!this.service.solution.viewBounds)return;this.service.$messageBusService.publish("map","setextent",this.service.solution.viewBounds)}},t.prototype.processAccessibilityReply=function(t,r,i){if(t.hasOwnProperty("error"))return console.log("Error in opentripplanner: "+t.error.msg),void i(r);var a,o=e.Helpers.parseUrlParameters(r.url,"?","&","=");if(o.hasOwnProperty("fromPlace")){var s=o.fromPlace.split("%2C");(isNaN(+s[0])||isNaN(+s[1]))&&i(r),a=new L.LatLng(+s[0],+s[1])}var n=t;if(n.hasOwnProperty("features")){var l=new Date(Date.now());if(n.features.forEach(function(e){e.properties.seconds=e.properties.time,e.properties.time=1e3*e.properties.seconds,e.properties.arriveTime=new Date(l.getTime()+e.properties.time).toISOString(),e.properties.latlng=[a.lat,a.lng]}),r.hasOwnProperty("data")&&r.data.hasOwnProperty("features")){for(var c=0;c<r.data.features.length;c++){var p=r.data.features[c];p.properties.hasOwnProperty("latlng")&&p.properties.latlng[0]===a.lat&&p.properties.latlng[1]===a.lng&&r.data.features.splice(c--,1)}n.features.forEach(function(e){r.data.features.push(e)})}else r.count=0,r.data=n}else{var u=n.plan.from,h=n.plan.to;r.data={},r.data.type="FeatureCollection",r.data.features=[],n.plan.itineraries.forEach(function(t){var i=new L.Polyline([]),a=[],o=-1;t.legs.forEach(function(t){var r=L.Polyline.fromEncoded(t.legGeometry.points);r.getLatLngs().forEach(function(e){i.addLatLng(e)});var s={mode:t.mode,start:new Date(t.startTime).toISOString(),arrive:new Date(t.endTime).toISOString(),duration:e.Helpers.convertPropertyInfo({type:"duration"},1e3*+t.duration)};t.agencyName?s.agency=t.agencyName:null,t.routeShortName?s.route=t.routeShortName:null,t.routeLongName?s.routeName=t.routeLongName:null,"WALK"!==t.mode&&"BICYCLE"!==t.mode&&(o+=1),a.push(s)});var s=i.toGeoJSON();r.data.features.push(e.Helpers.GeoExtensions.createLineFeature(s.geometry.coordinates,{fromLoc:u.name,toLoc:h.name,duration:1e3*+t.duration,startTime:new Date(t.startTime).toISOString(),arriveTime:new Date(t.endTime).toISOString(),legs:a,transfers:o>=0?o:0}))})}i(r)},t}();t.GeoJsonSource=r;var i=function(r){function i(e,t){r.call(this,e,t),this.service=e,this.title="dynamicgeojson"}return __extends(i,r),i.prototype.updateFeatureByProperty=function(e,t,r,i){var a=this;void 0===i&&(i=null);try{var o=this.layer.data.features;if(null==o)return;var s=!1;if(o.some(function(i){return i.hasOwnProperty(e)&&i[e]===t?(i.properties=r.properties,i.geometry=r.geometry,a.service.calculateFeatureStyle(i),a.service.updateFeature(i),s=!0,a.service.$messageBusService.notify(a.layer.title,r.properties.Name+" updated"),!0):!1}),!s)if(i&&i.data&&i.data.features){i.data.features.push(r),this.service.initFeature(r,i,!1);this.service.activeMapRenderer.addFeature(r);i.showFeatureNotifications&&this.service.$messageBusService.notify(i.title,r.properties.Name+" added");
}else{o.push(r),this.service.initFeature(r,this.layer);this.service.activeMapRenderer.addFeature(r);i.showFeatureNotifications&&this.service.$messageBusService.notify(this.layer.title,r.properties.Name+" added")}}catch(n){console.log("error")}},i.prototype.deleteFeatureByProperty=function(e,t,r){var i=this;try{var a=this.layer.data.features;if(null==a)return;var o=!1;if(a.some(function(a){return null!=a.properties&&a.properties.hasOwnProperty(e)&&a.properties[e]===t?(a.properties=r.properties,a.geometry=r.geometry,i.service.calculateFeatureStyle(a),i.service.updateFeature(a),o=!0,!0):!1}),!o){a.push(r),this.service.initFeature(r,this.layer);this.service.activeMapRenderer.createFeature(r)}}catch(s){console.log("error")}},i.prototype.initSubscriptions=function(e){var r=this;e.serverHandle=this.service.$messageBusService.serverSubscribe(e.id,"layer",function(i,a){switch(console.log("action:"+a.action),a.action){case"unsubscribed":r.service.$rootScope.$apply(function(){e.isConnected=!1});break;case"subscribed":e.isConnected=!0;break;case"layer":if(null!=a.data)try{var o=a.data;switch(o.action){case t.LayerUpdateAction.updateLog:var s=o.featureId,n=o.item,l=r.layer.data.features;l.forEach(function(e){if(e.id===s){e.logs||(e.logs={});for(var t in n)e.logs.hasOwnProperty(t)||(e.logs[t]=[]),n[t].forEach(function(r){return e.logs[t].push(r)});return r.service.$rootScope.$apply(function(){r.service.updateLog(e)}),!0}return!1});break;case t.LayerUpdateAction.updateFeature:var c=o.item;e.id===o.layerId&&r.service.$rootScope.$apply(function(){r.updateFeatureByProperty("id",c.id,c,e)});break;case t.LayerUpdateAction.deleteFeature:var p=r.service.findFeature(e,o.featureId);p&&(r.service.$messageBusService.notify(r.layer.title,p.properties.Name+" removed"),r.service.removeFeature(p,!1)),o.featureId}}catch(u){console.warn("Error updating feature: "+JSON.stringify(u,null,2))}}})},i.prototype.addLayer=function(e,t,r){var i=this;void 0===r&&(r=null),e.isDynamic=!0,this.baseAddLayer(e,function(e){t(e),e.enabled&&i.initSubscriptions(e)},r)},i.prototype.removeLayer=function(e){e.isConnected=!1,e.gui.editing&&this.stopAddingFeatures(e),this.service.$messageBusService.serverUnsubscribe(e.serverHandle)},i.prototype.layerMenuOptions=function(e){var t=this,r=[["Fit map",function(r){return t.fitMap(e)}]];return r},i.prototype.startAddingFeatures=function(e){this.service.project.groups.forEach(function(t){var r=!1;t.layers.forEach(function(t){t===e?(r=!0,t.gui.editing=!0):t.gui.editing=!1}),t.gui.editing=r}),this.service.editing=!0,this.initAvailableFeatureTypes(e)},i.prototype.initAvailableFeatureTypes=function(t){var r={};if(t&&t.typeUrl&&this.service.typesResources.hasOwnProperty(t.typeUrl))for(var i in this.service.typesResources[this.layer.typeUrl].featureTypes){var a=this.service.typesResources[this.layer.typeUrl].featureTypes[i];"point"===a.style.drawingMode.toLowerCase()&&(r[i]=this.service.typesResources[this.layer.typeUrl].featureTypes[i],r[i].u=e.Helpers.getImageUri(i))}t.gui.featureTypes=r},i.prototype.stopAddingFeatures=function(e){delete e.gui.featureTypes,this.service.project.groups.forEach(function(e){delete e.gui.editing,e.layers.forEach(function(e){e.gui.editing=!1})}),this.service.editing=!1},i}(r);t.DynamicGeoJsonSource=i;var a=function(e){function t(t,r){e.call(this,t,r),this.service=t,this.title="esrijson"}return __extends(t,e),t.prototype.addLayer=function(e,t){var r=this;e.renderType="geojson",e.isLoading=!0,this.$http({url:"/api/proxy",method:"GET",params:{url:e.url}}).success(function(t){var i=new esriJsonConverter.esriJsonConverter,a=i.toGeoJson(JSON.parse(t));console.log(a),e.data=a,e.data.geometries&&!e.data.features&&(e.data.features=e.data.geometries),e.data.features.forEach(function(t){r.service.initFeature(t,e,!1,!1)}),r.service.$messageBusService.publish("timeline","updateFeatures")}).error(function(e){console.log("EsriJsonSource called $HTTP with errors: "+e)})["finally"](function(){e.isLoading=!1,t(e)})},t}(r);t.EsriJsonSource=a}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(t){function r(e,r){t.call(this,e,r),this.service=e,this.title="grid"}return __extends(r,t),r.prototype.addLayer=function(t,r){var i=this;if(this.layer=t,"undefined"==typeof t.dataSourceParameters)throw new Error("Undefined IGridData data property in GridDataSource.");this.gridParams=t.dataSourceParameters,this.gridParams.useContour?this.convertDataToFeatureCollection=this.convertDataToIsoLines:this.convertDataToFeatureCollection=this.convertDataToPolygonGrid,t.isLoading=!0,$.get(t.url,function(a,o){async.series([function(r){if(t.count=0,"undefined"!=typeof i.gridParams.gridType&&"esri"===i.gridParams.gridType&&i.convertEsriHeaderToGridParams(a),"gridlayer"===t.renderType)return t.data=i.convertDataToGrid(a,i.gridParams),t.isLoading=!1,void r(null,null);var o=i.convertDataToFeatureCollection(a,i.gridParams);if(o.fc.features.length>1e4&&console.warn("Grid is very big! Number of features: "+o.fc.features.length),0===o.fc.features.length)return i.service.$messageBusService.notify("Warning","Data loaded successfully, but all points are outside the specified range.",e.Services.NotifyLocation.TopRight,e.Services.NotifyType.Error),t.isLoading=!1,void r(null,null);t.data=o.fc,t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries);t.data.features.length-1;t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),t.isLoading=!1,r(null,null)},function(){r(t)}])}).fail(function(e){t.isLoading=!1,console.log("Failed loading layer "+t.title+" due to "+e+".")})},r.prototype.convertEsriHeaderToGridParams=function(t){var r=this,i=/(\S*)\s*([\d-.]*)/,a=this.getData(t);if(a){var o,s,n=a.split("\n",6),l=!1;switch(this.gridParams.skipLines=0,n.forEach(function(e){var t=e.match(i);if(3===t.length){r.gridParams.skipLines++;var a=+t[2];switch(t[1].toLowerCase()){case"ncols":r.gridParams.columns=a;break;case"nrows":r.gridParams.rows=a;break;case"xllcorner":o=a;break;case"yllcorner":s=a;break;case"xllcenter":o=a,l=!0;break;case"yllcenter":s=a,l=!0;break;case"cellsize":r.gridParams.deltaLon=a,r.gridParams.deltaLat=-a;break;case"nodata_value":r.gridParams.noDataValue=a}}}),l?(this.gridParams.startLon=o,this.gridParams.startLat=s):(this.gridParams.startLon=o+this.gridParams.deltaLon/2,this.gridParams.startLat=s-this.gridParams.deltaLat/2),this.gridParams.projection||"wgs84"){case"rd":case"RD":var c=e.Helpers.GeoExtensions.convertRDToWGS84(this.gridParams.startLon,this.gridParams.startLat-(this.gridParams.rows-1)*this.gridParams.deltaLat),p=e.Helpers.GeoExtensions.convertRDToWGS84(this.gridParams.startLon+(this.gridParams.columns-1)*this.gridParams.deltaLon,this.gridParams.startLat);this.gridParams.deltaLon=(p.longitude-c.longitude)/(this.gridParams.columns-1),this.gridParams.deltaLat=(p.latitude-c.latitude)/(this.gridParams.rows-1),this.gridParams.startLon=c.longitude,this.gridParams.startLat=c.latitude;break;case"WGS84":case"wgs84":this.gridParams.startLat-=(this.gridParams.rows-1)*this.gridParams.deltaLat;break;default:throw new Error("Current projection is not supported!")}}},r.prototype.getData=function(e){return"string"==typeof e?e:e.hasOwnProperty("data")&&"string"==typeof e.data?e.data:(console.log("GridDataSource error: could not read grid data!"),"")},r.prototype.convertDataToGrid=function(e,t){var r=this.getData(e);if(r){var i=(t.propertyName||"v",t.noDataValue||-9999,t.skipLinesAfterComment),a=t.skipSpacesFromLine,o=t.skipFirstRow||!1,s=t.skipFirstColumn||!1,n=t.separatorCharacter||" ",l=new RegExp("[^"+n+"]+","g"),c=(t.deltaLon,t.deltaLat,t.startLat,t.startLon,t.maxThreshold||-Number.MAX_VALUE),p=t.minThreshold||Number.MAX_VALUE,u=r.split("\n"),h=0,d=[];t.skipLines&&u.splice(0,t.skipLines);var f=t.rows||Number.MAX_VALUE;return u.forEach(function(e){if(t.commentCharacter&&e.substr(0,1)===t.commentCharacter)return void console.log(e);if(i&&i>0)return void i--;if(o)return void(o=!1);if(f--,0>f)return d;var r;r=a?e.substr(a).match(l):e.match(l),s&&r.length>1&&(r=r.splice(1)),!r||!t.skipFirstColumn&&r.length<t.columns||(d[h]=[],r.forEach(function(e){return d[h].push(+e)}),c=Math.max.apply(Math,[c].concat(d[h])),p=Math.min.apply(Math,[p].concat(d[h])),h++)}),t.maxThreshold=c,t.minThreshold=p,d}},r.prototype.convertDataToIsoLines=function(t,r){var i=this.convertDataToGrid(t,r),a=r.propertyName||"v",o=[],s=[],n=r.startLat,l=r.startLon,c=r.deltaLat,p=r.deltaLon,u=r.maxThreshold,h=r.minThreshold;i.forEach(function(e){s.push(n),n+=c}),i[0].forEach(function(e){o.push(l),l+=p,l>180&&(l-=360)});var d,f,y=[],m=new e.Helpers.Conrec;if("undefined"==typeof r.contourLevels)d=10;else{var g=r.contourLevels;"number"==typeof g?d=g:(f=g,d=g.length)}if("undefined"==typeof f){f=[];for(var v=(u-h)/d,S=h+v/2;u>S;S+=v)f.push(Math.round(10*S)/10)}m.contour(i,0,i.length-1,0,i[0].length-1,s,o,d,f,r.noDataValue||-9999);var $=m.contourList;$.forEach(function(e){var t={};t[a]=e.level;var r={type:"Feature",geometry:{type:"Polygon"},properties:t},i=[];r.geometry.coordinates=[i],e.forEach(function(e){i.push([e.y,e.x])}),y.push(r)});var b="# Number of features above the threshold: "+y.length+".\r\n";return{fc:e.Helpers.GeoExtensions.createFeatureCollection(y),desc:b}},r.prototype.convertDataToPolygonGrid=function(t,r){var i=r.propertyName||"v",a=this.convertDataToGrid(t,r),o=r.startLat,s=r.deltaLat,n=r.deltaLon,l=r.noDataValue,c=r.minThreshold||-Number.MAX_VALUE,p=r.maxThreshold||Number.MAX_VALUE,u=[];a.forEach(function(t){var a=r.startLon;t.forEach(function(t){var r=+t;if(r!==l&&r>=c&&p>=r){var h={};h[i]=r;var d=[a,o+s],f=[a+n,o+s],y=[a,o],m=[a+n,o],g=e.Helpers.GeoExtensions.createPolygonFeature([[d,f,m,y,d]],h);u.push(g)}a+=n,a>180&&(a-=360)}),o+=s});var h="# Number of features above the threshold: "+u.length+".\r\n";return{fc:e.Helpers.GeoExtensions.createFeatureCollection(u),desc:h}},r}(e.Services.GeoJsonSource);t.GridDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){"use strict";var t=function(){function t(e){this.service=e,this.title="heatmap",this.requiresLayer=!0,this.heatmapModel=new Heatmap.HeatmapModel("ProjectHeatmap")}return t.prototype.refreshLayer=function(e){this.generateHeatmap(e)},t.prototype.layerMenuOptions=function(e){return null},t.prototype.addLayer=function(e,t,r){var i=this;void 0===r&&(r=null),async.series([function(t){if(e.renderType="heatmap",e.isLoading=!0,e.quickRefresh&&1==e.quickRefresh){if(i.heatmapModel.deserialize(e),i.heatmapModel.id=e.id,i.heatmapModel.updateWeights(),e.heatmapItems){var r={};i.heatmapModel.heatmapItems.forEach(function(e){r[e.toString()]=e.weight});var a=i.heatmapModel.heatmapSettings.intensityScale/3*(i.heatmapModel.heatmapSettings.intensityScale/3);i.service.project.features.forEach(function(e){if(e.properties.hasOwnProperty("intensities")&&e.properties.hasOwnProperty("contributors")){var t=JSON.parse(e.properties.intensities),o=0;for(var s in t)t.hasOwnProperty(s)&&(o+=t[s]*r[s]*a);e.properties.totalIntensity=o,i.service.calculateFeatureStyle(e),i.service.activeMapRenderer.updateFeature(e)}})}}else i.generateHeatmap(e),e.enabled=!0,i.enableProjectLayer(e);e.isLoading=!1,t(null,null)},function(){t(e)}])},t.prototype.removeLayer=function(e){delete this.heatmapModel,this.heatmapModel=new Heatmap.HeatmapModel("ProjectHeatmap"),e.enabled=!1,e.data=JSON,this.enableProjectLayer(e)},t.prototype.enableProjectLayer=function(e){e.id&&this.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.id==e.id&&(t.enabled=e.enabled,0==t.enabled&&(e.data=JSON))})})},t.prototype.getRequiredLayers=function(e){var t=this,r=[];return e.heatmapSettings&&e.heatmapSettings.referenceList&&e.heatmapSettings.referenceList.forEach(function(e){t.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.reference==e&&r.push(t)})})}),r},t.prototype.getFeatureTypes=function(e){var t=[];return e.heatmapItems.forEach(function(e){t.push(e.featureType.name)}),t},t.prototype.generateHeatmap=function(t){var r=this;console.log("Generating heatmap");var i=L.geoJson([]);this.heatmapModel.deserialize(t),this.heatmapModel.id=t.id;var a=this.service.$mapService.getMap().getZoom();if(!(a<this.heatmapModel.heatmapSettings.minZoom||a>this.heatmapModel.heatmapSettings.maxZoom)){this.heatmapModel.updateWeights(),this.heatmapModel.calculate(this.service,this.service.$mapService,i);var o=(new Date).getTime();if(t.data=i.toGeoJSON(),t.data&&t.data.features&&(t.data.features.forEach(function(e){r.service.initFeature(e,t,!1,!1),r.service.activeMapRenderer.addFeature(e)}),t.data.features[0])){var s=new FeatureProps.CallOutProperty("totalIntensity","0","totalIntensity",!0,!0,t.data.features[0],!1,!1),n=new e.PropertyInfo;n.count=t.data.features.length,n.max=1,n.min=-1,n.mean=0,n.varience=.67,n.sd=Math.sqrt(n.varience),this.service.setStyle(s,!1,n)}var l=(new Date).getTime();console.log("Init and style features in "+(l-o).toFixed(1)+" ms")}},t}();e.HeatmapSource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function t(e,t){this.service=e,this.title="hierarchy",this.requiresLayer=!0,this.$http=t}return t.prototype.refreshLayer=function(e){this.service.removeLayer(e),this.service.addLayer(e)},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),this.baseAddLayer(e,t)},t.prototype.fitMap=function(t){var r=e.Helpers.GeoExtensions.getBoundingBox(this.layer.data);this.service.$messageBusService.publish("map","setextent",r)},t.prototype.layerMenuOptions=function(e){var t=this;return[["Fit map",function(r){return t.fitMap(e)}],null,["Refresh",function(r){return t.refreshLayer(e)}]]},t.prototype.getRequiredLayers=function(e){var t=this,r=[];return e.hierarchySettings&&e.hierarchySettings.referenceList&&e.hierarchySettings.referenceList.forEach(function(e){t.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.reference==e&&r.push(t)})})}),r},t.prototype.baseAddLayer=function(t,r){var i=this;this.layer=t,async.series([function(r){t.renderType="geojson",t.isLoading=!0,i.$http.get(t.url).success(function(a){if(t.count=0,t.isLoading=!1,"topojson"===t.type.toLowerCase()&&(a=e.Helpers.GeoExtensions.convertTopoToGeoJson(a)),a.featureTypes)for(var o in a.featureTypes)if(a.featureTypes.hasOwnProperty(o)){var s=a.featureTypes[o];o=t.id+"_"+o,i.service._featureTypes[o]=s}a.timestamps&&(t.timestamps=a.timestamps),t.data=a,t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries),t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),i.service.$messageBusService.publish("timeline","updateFeatures"),r(null,null)}).error(function(){t.count=0,t.isLoading=!1,i.service.$messageBusService.notify("ERROR loading "+t.title,"\nwhile loading: "+t.url),i.service.$messageBusService.publish("layer","error",t),r(null,null)})},function(){r(t)}])},t.prototype.removeLayer=function(e){},t}();t.HierarchySource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(e){function t(t,r){e.call(this,t,r),this.service=t,this.title="kml"}return __extends(t,e),t.prototype.get=function(e,t){return e.getElementsByTagName(t)},t.prototype.attr=function(e,t){return e.getAttribute(t)},t.prototype.addLayer=function(e,t){var r=this;this.layer=e,e.renderType="geojson",e.isLoading=!0,$.ajax(e.url).done(function(i){switch(e.count=0,e.isLoading=!1,e.type.toLowerCase()){case"kml":r.convertKmlToGeoJSON(e,i);break;case"gpx":r.convertGpxToGeoJSON(e,i)}t(e)}).fail(function(i){e.isLoading=!1,r.service.$messageBusService.notify("ERROR loading "+e.title,i),r.service.$messageBusService.publish("layer","error",e),t(e)})},t.prototype.convertGpxToGeoJSON=function(e,t){var r=toGeoJSON.gpx(t);this.initLayer(r,e)},t.prototype.convertKmlToGeoJSON=function(e,t){for(var r=this,i=toGeoJSON.kml(t),a={},o=this.get(t,"Style"),s=this.get(t,"StyleMap"),n=0;n<o.length;n++)a["#"+this.attr(o[n],"id")]=o[n];for(var n=0;n<s.length;n++){var l=s[n],c=this.get(l,"Pair");if(c)for(var p=0;p<c.length;p++){var u=c[p],h=this.get(u,"key");if(h&&0!==h.length&&"normal"===h[0].childNodes[0].nodeValue){var d=this.get(u,"styleUrl");if(d&&d.length>0){var f="#"+this.attr(l,"id"),y=d[0].childNodes[0].nodeValue;a[f]=a[y]}break}}}i.features.forEach(function(t){if(t.properties.hasOwnProperty("styleUrl")){var i=t.properties.styleUrl,o=e.typeUrl+i;if(t.properties.featureTypeId=i.substring(1),delete t.properties.styleUrl,delete t.properties.styleHash,!r.service._featureTypes.hasOwnProperty(o)){var s=a[i];r.service._featureTypes[o]={name:o,showAllProperties:!1,style:{fillColor:r.getFillColor(s),strokeColor:r.getLineColor(s),strokeWidth:r.getLineWidth(s),stroke:!0,iconUri:r.getIcon(e,s)}}}}}),this.initLayer(i,e)},t.prototype.getIcon=function(e,t){try{var r=t.getElementsByTagName("href")[0].childNodes[0].nodeValue;return r.match(/^http/i)?r:e.url.substr(0,e.url.lastIndexOf("/")+1)+r}catch(i){return""}},t.prototype.getLineColor=function(e){try{return"#"+e.getElementsByTagName("LineStyle")[0].getElementsByTagName("color")[0].childNodes[0].nodeValue}catch(t){return"#000000"}},t.prototype.getLineWidth=function(e){try{return+e.getElementsByTagName("LineStyle")[0].getElementsByTagName("width")[0].childNodes[0].nodeValue}catch(t){return 1}},t.prototype.getFillColor=function(e){try{return"#"+e.getElementsByTagName("PolyStyle")[0].getElementsByTagName("color")[0].childNodes[0].nodeValue}catch(t){return"#ff0000"}},t}(e.Services.GeoJsonSource);t.KmlDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};L.Terminator=L.Polygon.extend({options:{color:"#00",opacity:.5,fillColor:"#00",fillOpacity:.5,resolution:2,showNight:!0},initialize:function(e){this.version="0.1.0",this._R2D=180/Math.PI,this._D2R=Math.PI/180,L.Util.setOptions(this,e);var t=this._compute(this.options.showNight,this.options.time||null);this.setLatLngs(t)},setTime:function(e){this.options.time=e;var t=this._compute(this.options.showNight,e||null);this.setLatLngs(t)},_sunEclipticPosition:function(e){var t=e-2451545,r=280.46+.9856474*t;r%=360;var i=357.528+.9856003*t;i%=360;var a=r+1.915*Math.sin(i*this._D2R)+.02*Math.sin(2*i*this._D2R),o=1.00014-.01671*Math.cos(i*this._D2R)-.0014*Math.cos(2*i*this._D2R);return{lambda:a,R:o}},_eclipticObliquity:function(e){var t=e-2451545,r=t/36525,i=23.43929111-r*(46.836769/3600-r*(1831e-7/3600+r*(5.565e-7-r*(1.6e-10-4.34e-8*r/3600))));return i},_sunEquatorialPosition:function(e,t){var r=Math.atan(Math.cos(t*this._D2R)*Math.tan(e*this._D2R))*this._R2D,i=Math.asin(Math.sin(t*this._D2R)*Math.sin(e*this._D2R))*this._R2D,a=90*Math.floor(e/90),o=90*Math.floor(r/90);return r+=a-o,{alpha:r,delta:i}},_hourAngle:function(e,t,r){var i=r+e/15;return 15*i-t.alpha},_latitude:function(e,t){var r=Math.atan(-Math.cos(e*this._D2R)/Math.tan(t.delta*this._D2R))*this._R2D;return r},_compute:function(e,t){if(null==t)var r=new Date;else var r=new Date(t);for(var i,a,o=r.getJulian(),s=r.getGMST(),n=[],l=this._sunEclipticPosition(o),c=this._eclipticObliquity(o),p=this._sunEquatorialPosition(l.lambda,c),u=0;u<=720*this.options.resolution;u++){var h=-360+u/this.options.resolution;i=this._hourAngle(h,p,s),a=this._latitude(i,p),n[u+1]=[a,h]}return e?p.delta<0?(n[0]=[90,-360],n[n.length]=[90,360]):(n[0]=[-90,-360],n[n.length]=[-90,360]):p.delta<0?(n[0]=[-90,-360],n[n.length]=[-90,360]):(n[0]=[90,-360],n[n.length]=[90,360]),n}});var csComp;!function(e){var t;!function(t){"use strict";var r=function(t){function r(e,r){t.call(this,e,r),this.service=e,this.title="Day Night regions on the Earth"}return __extends(r,t),r.prototype.addLayer=function(t,r){var i=this;this.layer=t,t.isLoading=!0,t.count=0;var a=!0,o=0;if("undefined"!=typeof t.dataSourceParameters){var s=t.dataSourceParameters;"undefined"!=typeof s.showNight&&(a=s.showNight),"undefined"!=typeof s.value&&(o=s.value)}var n=new L.Terminator({showNight:a}),l=n.toGeoJSON();a?(l.properties.Name="Night",l.properties.night_intensity=o):(l.properties.Name="Day",l.properties.day_intensity=o);var c=[];c.push({type:"Feature",geometry:l.geometry,properties:l.properties}),t.data=e.Helpers.GeoExtensions.createFeatureCollection(c),t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries),t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),t.isLoading=!1,r(t)},r}(e.Services.GeoJsonSource);t.NightDayDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(e){function t(t,r){e.call(this,t,r),this.service=t,this.title="RSS datasource"}return __extends(t,e),t.prototype.addLayer=function(e,t){var r=this;this.layer=e,e.type="geojson",e.isLoading=!0,e.count=0,this.$http({url:"/api/rss",method:"GET",params:{url:e.url}}).success(function(i){e.data=i,e.data.geometries&&!e.data.features&&(e.data.features=e.data.geometries),e.data.features.forEach(function(t){r.service.initFeature(t,e,!1,!1)}),r.service.$messageBusService.publish("timeline","updateFeatures"),e.isLoading=!1,t(e)}).error(function(){console.log("RssDataSource called $HTTP with errors...")})},t}(e.Services.GeoJsonSource);t.RssDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function t(e){this.service=e,this.title="tilelayer",this.requiresLayer=!1,this.prevDateTimes={}}return t.prototype.refreshLayer=function(t){if(t.mapLayer.getLayers().length>0){var r=t.mapLayer.getLayers()[0],i=t.url;if(t.timeDependent){var a=this.service.project.timeLine.focus;if(t.timeResolution){var o=t.timeResolution;a=Math.floor(a/o)*o}var s=new Date(0);s.setUTCSeconds(a/1e3);var n=s.yyyymmdd(),l=s.getHours(),c=s.getMinutes(),p=s.getSeconds(),u=n+e.Utils.twoDigitStr(l)+e.Utils.twoDigitStr(c)+e.Utils.twoDigitStr(p);if(u===this.prevDateTimes[t.id])return;this.prevDateTimes[t.id]=u,i+="&time="+u}else t.disableCache&&(t.cacheKey=(new Date).getTime().toString(),i+="&cache="+t.cacheKey);r.setUrl(i)}},t.prototype.layerMenuOptions=function(e){var t=this;return[["Refresh",function(r){return t.refreshLayer(e)}]]},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),e.renderType="tilelayer",t(e)},t.prototype.removeLayer=function(e){},t}();t.TileLayerSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){"use strict";var t=function(){function e(e){this.service=e,this.title="wms",this.requiresLayer=!1}return e.prototype.refreshLayer=function(e){},e.prototype.layerMenuOptions=function(e){return null},e.prototype.addLayer=function(e,t,r){void 0===r&&(r=null);L.tileLayer.wms(e.url,{layers:e.wmsLayers,opacity:e.opacity/100,format:"image/png",transparent:!0,attribution:e.description});e.renderType="wms",t(e)},e.prototype.removeLayer=function(e){},e}();e.WmsSource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.title="cesium",this.features={}}return t.prototype.init=function(e){this.service=e},t.prototype.enable=function(){var e=this;this.viewer=new Cesium.Viewer("map",{selectionIndicator:!1,infoBox:!1,scene3DOnly:!0,sceneModePicker:!1,fullscreenButton:!1,homeButton:!1,baseLayerPicker:!1,animation:!1,timeline:!1,navigationHelpButton:!1}),this.camera=this.viewer.camera,this.scene=this.viewer.scene,setTimeout(function(){for(var t=0;t<e.service.project.features.length;++t)e.addFeature(e.service.project.features[t])},0),this.setUpMouseHandlers(),this.fitBounds(this.service.$mapService.maxBounds),this.changeBaseLayer(this.service.$mapService.activeBaseLayer)},t.prototype.getLatLon=function(e,t){return{lat:53,lon:5}},t.prototype.refreshLayer=function(){},t.prototype.getExtent=function(){var e={};return e},t.prototype.getZoom=function(){return 0},t.prototype.fitBounds=function(e){var t=Cesium.Ellipsoid.WGS84;if(e){var r=Cesium.Math.toRadians(e.southWest[1]),i=Cesium.Math.toRadians(e.southWest[0]),a=Cesium.Math.toRadians(e.northEast[1]),o=Cesium.Math.toRadians(e.northEast[0]),s=new Cesium.Rectangle(r,i,a,o);this.camera.viewRectangle(s,t)}},t.prototype.setUpMouseHandlers=function(){var e=this,t=new Cesium.ScreenSpaceEventHandler(this.scene.canvas);t.setInputAction(function(t){var r=e.scene.pick(t.position);Cesium.defined(r)&&void 0!==r.id&&void 0!==r.id.feature&&e.service.selectFeature(r.id.feature)},Cesium.ScreenSpaceEventType.LEFT_CLICK),t.setInputAction(function(t){var r=e.scene.pick(t.endPosition);Cesium.defined(r)&&void 0!==r.id&&void 0!==r.id.feature?e.showFeatureTooltip(r.id.feature,t.endPosition):$(".cesiumPopup").fadeOut("fast").remove()},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},t.prototype.disable=function(){this.viewer.destroy()},t.prototype.changeBaseLayer=function(e){if(void 0===e.cesium_url)alert("This layer is not cesium compatible");else{switch(e.cesium_maptype.toUpperCase()){case"ARCGIS":var t=new Cesium.ArcGisMapServerImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxZoom});break;case"OPENSTREETMAP":var t=new Cesium.OpenStreetMapImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxZoom});break;case"WEBMAPTILE":var t=new Cesium.WebMapTileServiceImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxZoom});break;case"TILEMAP":var t=new Cesium.TileMapServiceImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxZoom});break;default:alert("unknown maptype: "+e.cesium_maptype)}this.viewer.imageryLayers.addImageryProvider(t)}},t.prototype.showFeatureTooltip=function(t,r){if(void 0===this.popupShownFor||t.id!=this.popupShownFor.id){$(".cesiumPopup").fadeOut("fast").remove(),this.popupShownFor=t;var i=t.layer,a=i.group,o=t.properties.Name,s=o?o.length:1,n="<td colspan='3'>"+o+"</td></tr>";null!=a.filters&&a.filters.length>0&&a.filters.forEach(function(r){if(t.properties.hasOwnProperty(r.property)){var i=t.properties[r.property];if(i){var a=i.toString().length;null!=r.meta&&(i=e.Helpers.convertPropertyInfo(r.meta,i),"bbcode"!==r.meta.type&&(a=i.toString().length)),s=Math.max(s,a+r.title.length),n+="<tr><td><div class='smallFilterIcon'></td><td>"+r.title+"</td><td>"+i+"</td></tr>"}}}),null!=a.styles&&a.styles.length>0&&a.styles.forEach(function(r){if(null!=a.filters&&0===a.filters.filter(function(e){return e.property===r.property}).length&&t.properties.hasOwnProperty(r.property)){var i=t.properties[r.property],o=i.toString().length;null!=r.meta&&(i=e.Helpers.convertPropertyInfo(r.meta,i),"bbcode"!==r.meta.type&&(o=i.toString().length));var l=r.title?r.title.length:10;s=Math.max(s,o+l),n+="<tr><td><div class='smallStyleIcon'></td><td>"+r.title+"</td><td>"+i+"</td></tr>"}});var l=Math.max(Math.min(7*s+15,250),130);n="<table style='width:"+l+"px;'>"+n+"</table>",this.popup=$("<div class='cesiumPopup featureTooltip'></div>").html(n).css({position:"absolute",top:r.y-30,left:r.x-l/2-30,width:l}).hide().fadeIn("fast"),$("body").append(this.popup)}},t.prototype.addLayer=function(e){var t=this,r=jQuery.Deferred();switch(e.renderType){case"geojson":setTimeout(function(){e.data.features.forEach(function(e){t.addFeature(e)}),r.resolve()},0);break;case"wms":var i=this.viewer.imageryLayers.addImageryProvider(new Cesium.WebMapServiceImageryProvider({url:e.url,layers:e.wmsLayers,parameters:{format:"image/png",transparent:!0}}));i.id=e.id,i.alpha=e.opacity/100,r.resolve();break;default:alert("unknown layertype: "+e.type),r.resolve()}return r.promise()},t.prototype.removeLayer=function(e){var t=this,r=jQuery.Deferred();switch(e.type.toUpperCase()){case"GEOJSON":case"DYNAMICGEOJSON":case"TOPOJSON":setTimeout(function(){e.data.features.forEach(function(e){t.removeFeature(e)}),r.resolve()},0);break;case"WMS":this.viewer.imageryLayers._layers.forEach(function(r){r.id==e.id&&t.viewer.imageryLayers.remove(r)}),r.resolve();break;default:alert("unknown layertype: "+e.type),r.resolve()}return r.promise()},t.prototype.updateMapFilter=function(e){var t=this,r=jQuery.Deferred();return setTimeout(function(){t.viewer.entities.values.forEach(function(t){var r;e.filterResult&&(r=e.filterResult.filter(function(e){return e.id===t.feature.id}).length>0),r?t.show=!0:t.show=!1}),r.resolve()},0),r.promise()},t.prototype.addGroup=function(e){console.log("addGroup called")},t.prototype.removeGroup=function(e){console.log("removeGroup called")},t.prototype.removeFeature=function(e){var t=this,r=[];this.viewer.entities.values.forEach(function(t){t.feature.id===e.id&&r.push(t)}),r.forEach(function(e){t.viewer.entities.remove(e)})},t.prototype.removeFeatures=function(e){var t=this,r=jQuery.Deferred();return setTimeout(function(){var i=[];t.viewer.entities.values.forEach(function(t){e.forEach(function(e){t.feature.id===e.id&&t.show(!1)})}),i.forEach(function(e){t.viewer.entities.remove(e)}),r.resolve()},0),r.promise()},t.prototype.updateFeature=function(e){var t=this;this.viewer.entities.values.forEach(function(r){r.feature.id===e.id&&t.updateEntity(r,e)})},t.prototype.updateEntity=function(e,t){var r=void 0===t.properties.mediaan_hoogte?t.effectiveStyle.height:t.properties.mediaan_hoogte;switch(void 0!==t.fType.style.iconUri&&void 0!==e.billboard&&(e.billboard.width=t.effectiveStyle.iconWidth,e.billboard.height=t.effectiveStyle.iconHeight),t.geometry.type.toUpperCase()){case"POINT":case"MULTIPOINT":e.position=Cesium.Cartesian3.fromDegrees(t.geometry.coordinates[0],t.geometry.coordinates[1],t.geometry.coordinates[2]),e.point.position=Cesium.Cartesian3.fromDegrees(t.geometry.coordinates[0],t.geometry.coordinates[1],t.geometry.coordinates[2]),e.point.color=Cesium.Color.fromCssColorString(t.effectiveStyle.fillColor),e.point.outlineColor=Cesium.Color.fromCssColorString(t.effectiveStyle.strokeColor),e.point.outlineWidth=t.effectiveStyle.strokeWidth;break;case"POLYGON":case"MULTIPOLYGON":e.polygon.material=Cesium.Color.fromCssColorString(t.effectiveStyle.fillColor),e.polygon.outlineColor=Cesium.Color.fromCssColorString(t.effectiveStyle.strokeColor),e.polygon.outlineWidth=t.effectiveStyle.strokeWidth,e.polygon.extrudedHeight=r;break;case"LINESTRING":case"MULTILINESTRING":e.polyline.material=Cesium.Color.fromCssColorString(t.effectiveStyle.fillColor),e.polyline.width=t.effectiveStyle.strokeWidth;break;default:alert("unknown geometry type: "+t.geometry.type)}},t.prototype.addFeature=function(e){this.createFeature(e)},t.prototype.selectFeature=function(e){console.log("CesiumRenderer warning: selectFeature is not implemented!")},t.prototype.createFeature=function(e){var t=this.viewer.entities.getOrCreateEntity(e.id);t.feature=e,void 0!==e.properties.Name&&(t.name=e.properties.Name);var r=void 0===e.properties.mediaan_hoogte?e.effectiveStyle.height:e.properties.mediaan_hoogte,i=5;switch(void 0!==e.fType.style.iconUri&&(t.billboard={image:e.fType.style.iconUri,width:e.effectiveStyle.iconWidth,height:e.effectiveStyle.iconHeight},i=35),e.geometry.type.toUpperCase()){case"POINT":t.position=Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[2]),t.point={pixelSize:i,position:Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[2]),color:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),
outlineColor:Cesium.Color.fromCssColorString(e.effectiveStyle.strokeColor),outlineWidth:e.effectiveStyle.strokeWidth};break;case"MULTIPOINT":for(var a=0;a<e.geometry.coordinates.length;a++){var o=new Cesium.Entity;o.feature=e,o.point={pixelSize:i,position:Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[a][0],e.geometry.coordinates[a][1],e.geometry.coordinates[a][2]),color:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),outlineColor:Cesium.Color.fromCssColorString(e.effectiveStyle.strokeColor),outlineWidth:e.effectiveStyle.strokeWidth},this.viewer.entities.add(o)}this.viewer.entities.remove(t);break;case"POLYGON":t.polygon=new Cesium.PolygonGraphics({hierarchy:this.createPolygon(e.geometry.coordinates).hierarchy,material:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),outline:!0,outlineColor:Cesium.Color.fromCssColorString(e.effectiveStyle.strokeColor),outlineWidth:e.effectiveStyle.strokeWidth,extrudedHeight:r,perPositionHeight:!0});break;case"MULTIPOLYGON":for(var s=this.createMultiPolygon(e.geometry.coordinates),a=0;a<s.length;++a){var o=new Cesium.Entity;o.feature=e;var n=new Cesium.PolygonGraphics({hierarchy:s[a].hierarchy,material:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),outline:!0,outlineColor:Cesium.Color.fromCssColorString(e.effectiveStyle.strokeColor),outlineWidth:e.effectiveStyle.strokeWidth,extrudedHeight:r,perPositionHeight:!0});o.polygon=n,this.viewer.entities.add(o)}this.viewer.entities.remove(t);break;case"LINESTRING":t.polyline=new Cesium.PolylineGraphics({positions:this.coordinatesArrayToCartesianArray(e.geometry.coordinates),material:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),width:e.effectiveStyle.strokeWidth});break;case"MULTILINESTRING":for(var a=0;a<e.geometry.coordinates.length;a++){var o=new Cesium.Entity;o.feature=e,t.polyline=new Cesium.PolylineGraphics({positions:this.coordinatesArrayToCartesianArray(e.geometry.coordinates[a]),material:Cesium.Color.fromCssColorString(e.effectiveStyle.fillColor),width:e.effectiveStyle.strokeWidth}),this.viewer.entities.add(o)}this.viewer.entities.remove(t);break;default:alert("unknown geometry type: "+e.geometry.type)}if("3Dmodel"===e.properties.FeatureTypeId){var l=e.effectiveStyle.modelUri||e.properties.modelUri||"",c=e.effectiveStyle.modelScale||e.properties.modelScale||1,p=e.effectiveStyle.modelMinimumPixelSize||e.properties.modelMinimumPixelSize||32;t.model=new Cesium.ModelGraphics({uri:l,scale:c,minimumPixelSize:p}),void 0!==t.billboard&&(t.billboard.show=!1),void 0!==t.point&&(t.point.show=!1)}if(void 0!==e.properties.Track){var u=Cesium.Transforms.headingPitchRollQuaternion(Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[2]),Cesium.Math.toRadians(e.properties.Track),0,0);t.orientation=u}return t},t.prototype.createPolygon=function(e){if(0!==e.length&&0!==e[0].length){for(var t=new Cesium.PolygonGraphics,r=[],i=1,a=e.length;a>i;i++)r.push(new Cesium.PolygonHierarchy(this.coordinatesArrayToCartesianArray(e[i])));var o=this.coordinatesArrayToCartesianArray(e[0]);return t.hierarchy=new Cesium.PolygonHierarchy(o,r),t}},t.prototype.createMultiPolygon=function(e){for(var t=[],r=0;r<e.length;r++)t.push(this.createPolygon(e[r]));return t},t.prototype.coordinatesArrayToCartesianArray=function(e){for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=this.defaultCrsFunction(e[r]);return t},t.prototype.defaultCrsFunction=function(e){return Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2])},t}();t.CesiumRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(){this.title="leaflet",this.cntrlIsPressed=!1}return r.prototype.init=function(e){var t=this;this.service=e,this.$messageBusService=e.$messageBusService,$(document).keydown(function(e){t.cntrlIsPressed=e.ctrlKey}),$(document).keyup(function(){t.cntrlIsPressed=!1})},r.prototype.enable=function(){var e=this;1===$("map").length&&(this.service.$mapService.map=L.map("map",{zoomControl:!1,maxZoom:19,attributionControl:!0}),this.map=this.service.$mapService.map,this.service.$mapService.map.on("moveend",function(t,r){var i=e.service.$mapService.map.getBounds();e.$messageBusService.publish("mapbbox","update",i.toBBoxString());var a={southWest:[i.getSouthWest().lat,i.getSouthWest().lng],northEast:[i.getNorthEast().lat,i.getNorthEast().lng]};e.service.$mapService.maxBounds=a}),this.service.$mapService.map.on("zoomend",function(t,r){var i=e.service.$mapService.map.getZoom();e.$messageBusService.publish("map","zoom",i)}))},r.prototype.getLatLon=function(e,t){var r=this.map.containerPointToLatLng(new L.Point(e,t));return{lat:r.lat,lon:r.lng}},r.prototype.getExtent=function(){var e={};if(this.map){var t=this.map.getBounds(),r=t.getSouthWest(),i=t.getNorthEast();e.southWest=[r.lat,r.lng],e.northEast=[i.lat,i.lng]}return e},r.prototype.fitBounds=function(e){var t=L.latLng(e.southWest[0],e.southWest[1]),r=L.latLng(e.northEast[0],e.northEast[1]),i=L.latLngBounds(t,r);try{this.service.$mapService.map.fitBounds(i)}catch(a){}},r.prototype.getZoom=function(){return this.service.$mapService.map.getZoom()},r.prototype.disable=function(){this.service.$mapService.map.remove(),this.service.$mapService.map=null,$("#map").empty()},r.prototype.refreshLayer=function(){},r.prototype.addGroup=function(e){e.clustering?(e.cluster=new L.MarkerClusterGroup({maxClusterRadius:function(t){return t>18?2:e.maxClusterRadius||80},disableClusteringAtZoom:e.clusterLevel||0}),this.service.map.map.addLayer(e.cluster)):(e.vectors=new L.LayerGroup,this.service.map.map.addLayer(e.vectors))},r.prototype.removeLayer=function(e){switch(e.renderType){case"geojson":t.GeojsonRenderer.remove(this.service,e);break;default:this.service.map.map&&e.mapLayer&&this.service.map.map.removeLayer(e.mapLayer)}},r.prototype.changeBaseLayer=function(e){e!=this.service.$mapService.activeBaseLayer&&(this.baseLayer&&this.service.map.map.removeLayer(this.baseLayer),this.baseLayer=this.createBaseLayer(e),this.service.map.map.addLayer(this.baseLayer),this.service.map.map.setZoom(this.service.map.map.getZoom()),this.service.map.map.fire("baselayerchange",{layer:this.baseLayer}))},r.prototype.createBaseLayer=function(e){var t={noWrap:!0};t.subtitle=e.subtitle,t.preview=e.preview,null!=e.subdomains&&(t.subdomains=e.subdomains),null!=e.maxZoom&&(t.maxZoom=e.maxZoom),null!=e.minZoom&&(t.minZoom=e.minZoom),null!=e.attribution&&(t.attribution=e.attribution),null!=e.id&&(t.id=e.id);var r=L.tileLayer(e.url,t);return r},r.prototype.getLeafletStyle=function(e){var t={fillColor:e.fillColor,weight:e.strokeWidth,opacity:e.opacity,fillOpacity:e.fillOpacity};return t.color="undefined"!=typeof e.stroke&&e.stroke===!1?e.fillColor:e.strokeColor,t},r.prototype.addLayer=function(e){switch(e.renderType){case"geojson":t.GeojsonRenderer.render(this.service,e,this);break;case"tilelayer":t.TileLayerRenderer.render(this.service,e);break;case"wms":t.WmsRenderer.render(this.service,e);break;case"gridlayer":t.GridLayerRenderer.render(this.service,e);break;case"heatmap":t.HeatmapRenderer.render(this.service,e,this)}},r.prototype.updateMapFilter=function(e){var t=this;$.each(e.markers,function(r,i){var a;if(e.filterResult&&(a=e.filterResult.filter(function(e){return e.id===r}).length>0),e.clustering){var o=e.cluster.hasLayer(i);!a&&o&&e.cluster.removeLayer(i),a&&!o&&e.cluster.addLayer(i)}else{var s=t.service.map.map.hasLayer(i);!a&&s&&t.service.map.map.removeLayer(i),a&&!s&&t.service.map.map.addLayer(i)}})},r.prototype.removeGroup=function(e){},r.prototype.removeFeature=function(e){var t=e.layer;switch(t.renderType){case"geojson":var r=t.group;if(r.clustering){var i=r.cluster;try{i.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id]}catch(a){}}else t.group.markers.hasOwnProperty(e.id)&&(t.mapLayer.removeLayer(t.group.markers[e.id]),t.group.vectors.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id])}},r.prototype.updateFeature=function(e){if(null!=e.layer.group){var t=e.layer.group.markers[e.id];null!=t&&("Point"===e.geometry.type?(t.setIcon(this.getPointIcon(e)),t.setLatLng(new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]))):(t.setStyle(this.getLeafletStyle(e.effectiveStyle)),e.isSelected&&e.layer&&!e.layer.disableMoveSelectionToFront&&e.layer.group&&(e.layer.group.clustering&&e.layer.group.cluster&&e.layer.group.cluster.hasLayer(t)||e.layer.group.markers.hasOwnProperty(t.feature.id))&&t.bringToFront()),e.layer.isDynamic&&t.dragging&&(this.canDrag(e)?t.dragging.enable():t.dragging.disable()))}},r.prototype.selectFeature=function(e){e.gui.hasOwnProperty("dragged")?delete e.gui.dragged:this.service.selectFeature(e,this.cntrlIsPressed)},r.prototype.addFeature=function(e){var t=this;if(null!=e.geometry){var r=this.createFeature(e),i=e.layer;return i.group.markers[e.id]=r,r.on({mouseover:function(e){return t.showFeatureTooltip(e,i.group)},mouseout:function(e){return t.hideFeatureTooltip(e)},mousemove:function(e){return t.updateFeatureTooltip(e)},click:function(r){t.selectFeature(e)}}),r.feature=e,i.group.clustering&&i.group.cluster?i.group.cluster.addLayer(r):i.mapLayer&&i.mapLayer.addLayer(r),r}return null},r.prototype.canDrag=function(e){return e.gui.hasOwnProperty("editMode")&&1==e.gui.editMode},r.prototype.createFeature=function(e){var r,i=this;switch(e.geometry.type){case"Point":var a=this.getPointIcon(e);r=new L.Marker(new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),{icon:a,draggable:this.canDrag(e)}),r.on("contextmenu",function(r){i.service._activeContextMenu=i.service.getActions(e,t.ActionType.Context);var a=$("#map-contextmenu-button"),o=$("#map-contextmenu");a.dropdown("toggle");var s=i.map.getSize();r.originalEvent.x<s.x/2?o.css("left",r.originalEvent.x+5):o.css("left",r.originalEvent.x-5-o.width()),r.originalEvent.y<s.y/2?o.css("top",r.originalEvent.y-35):o.css("top",r.originalEvent.y-70-o.height()),"$apply"!=i.service.$rootScope.$$phase&&"$digest"!=i.service.$rootScope.$$phase&&i.service.$rootScope.$apply()}),r.on("dragstart",function(t){e.gui.dragged=!0}),r.on("dragend",function(t){var r=t.target,i=r.getLatLng();e.geometry.coordinates=[i.lng,i.lat]});break;default:r=L.GeoJSON.geometryToLayer(e),r.setStyle(this.getLeafletStyle(e.effectiveStyle)),r.on("contextmenu",function(r){i.service._activeContextMenu=i.service.getActions(e,t.ActionType.Context);var a=$("#map-contextmenu-button"),o=$("#map-contextmenu");a.dropdown("toggle");var s=i.map.getSize();r.originalEvent.x<s.x/2?o.css("left",r.originalEvent.x+5):o.css("left",r.originalEvent.x-5-o.width()),r.originalEvent.y<s.y/2?o.css("top",r.originalEvent.y-35):o.css("top",r.originalEvent.y-70-o.height()),"$apply"!=i.service.$rootScope.$$phase&&"$digest"!=i.service.$rootScope.$$phase&&i.service.$rootScope.$apply()})}return r.feature=e,e.layer.group.markers[e.id]=r,r},r.prototype.getPointIcon=function(t){var r;if(null!=t.htmlStyle)r=new L.DivIcon({className:"",iconSize:new L.Point(t.effectiveStyle.iconWidth,t.effectiveStyle.iconHeight),html:t.htmlStyle});else{var i=e.Helpers.createIconHtml(t,this.service.getFeatureType(t));r=new L.DivIcon({className:"",iconSize:new L.Point(i.iconPlusBorderWidth,i.iconPlusBorderHeight),html:i.html})}return r},r.prototype.showFeatureTooltip=function(r,i){var a=this,o=r.target,s=o.feature,n=o.feature.properties.Name,l=n?n.length:1,c="<td colspan='3'>"+n+"</td></tr>";null!=i.filters&&i.filters.length>0&&i.filters.forEach(function(t){if(s.properties.hasOwnProperty(t.property)){var r=s.properties[t.property];if(r){var i=r.toString().length;null!=t.meta&&(r=e.Helpers.convertPropertyInfo(t.meta,r),"bbcode"!==t.meta.type&&(i=r.toString().length)),l=Math.max(l,i+t.title.length),c+="<tr><td><div class='smallFilterIcon'></td><td>"+t.title+"</td><td>"+r+"</td></tr>"}}}),null!=i.styles&&i.styles.length>0&&i.styles.forEach(function(t){if(null!=i.filters&&0===i.filters.filter(function(e){return e.property===t.property}).length&&s.properties.hasOwnProperty(t.property)){var r=s.properties[t.property],a=r.toString().length;null!=t.meta&&(r=e.Helpers.convertPropertyInfo(t.meta,r),"bbcode"!==t.meta.type&&(a=r.toString().length));var o=t.title?t.title.length:10;l=Math.max(l,a+o),c+="<tr><td><div class='smallStyleIcon'></td><td>"+t.title+"</td><td>"+r+"</td></tr>"}});var p=Math.max(Math.min(7*l+15,250),130);c="<table style='width:"+p+"px;'>"+c+"</table>",this.popup=L.popup({offset:new L.Point(-p/2-40,-5),closeOnClick:!0,autoPan:!1,className:"featureTooltip"}).setLatLng(r.latlng).setContent(c).openOn(this.service.map.map);var u=this.service.getActions(s,t.ActionType.Hover);u.forEach(function(e){"show"===e.title.toLowerCase()&&e.callback(s,a.service)})},r.prototype.hideFeatureTooltip=function(e){var r=this;this.popup&&this.service.map.map&&(this.service.map.map.closePopup(this.popup),this.popup=null);var i=e.target,a=i.feature;if(a){var o=this.service.getActions(a,t.ActionType.Hover);o.forEach(function(e){"hide"===e.title.toLowerCase()&&e.callback(a,r.service)})}},r.prototype.updateFeatureTooltip=function(e){null!=this.popup&&null!=e.latlng&&this.popup.setLatLng(e.latlng)},r}();t.LeafletRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));